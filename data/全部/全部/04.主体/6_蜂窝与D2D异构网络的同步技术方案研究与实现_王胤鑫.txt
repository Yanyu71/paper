第一章绪论


1.1 TD-LTE简介

伴随着3G 的逐渐普及以及互联网的飞速发展，移动数据业务和移动互联网 应用的发展进入了新的阶段，人们不再满足于简单的语音通信和短消息业务，对 多样化的数据业务的需求更是与日俱增。移动数据业务流量出现爆炸性增长，视 频通话，联网游戏，网上冲浪等新型移动数据业务对移动带宽提出了更高的要求，
对于人们未来的业务需求；2Mb/s的WCDMA    R99传输速率和14.4Mb/s的R5
HSDPA 的峰值速率已远远不能满足。随着移动数据业务和移动互联网应用的进 一步发展，移动网络数据流量增长会更快，对实时性等网络性能要求更高，亟需 通过新一代通信标准和技术来进行承载。
LTE]2   ,即通用移动通信系统(Universal Mobile Telecommunications System, UMTS)  技术的长期演进 (Long Term Evolution,LTE)项目，是3GPP 近两年来  启动的最大的新技术研发项目。这种通信技术以OFDM/FDMA   为核心，系统带  宽最大可达20MHz、 峰值速率可超过200Mbit/s、 传输时延大大降低，频谱效率  也可以达3GPPR6 标准的3~5倍。 LTE 是通信业界的一项重大革新，预计在未
来很长一段时间内，LTE 作为最具影响力和竞争力的宽带移动通信技术标准之一， 将受到越来越广泛的关注和重视。 TD-LTE 作为 LTE 的时分模式技术，具有
“GAS”优势：“G”(Global,全球化),“A”(Asymmetric,非对称)和“S”(Synergetic, 共融性),更适合未来移动业务的应用。与第三代移动通倍相比较， TD-LTE 在  物理层、空口高层协议和网络架构等方面做出了重要技术革新，在系统容量带宽、 部署灵活性、频谱利用率、峰值速率、传输时延和业务质量及效率等方面具备较  大优势。

1.2   混合蜂窝网络中D2D  通 信

随着蜂窝无线移动通信系统的飞速发展，移动用户的数量急剧增加，给通信 领域带来了机遇。然而用户需求也越来越高，带来机遇的同时也带来了更大的压  力和挑战。传统的以授权为基础的频谱分配方式在资源分配灵活性以及频谱使用 率方面已经逐渐无法满足快速增长的无线通信业务需求。与此同时，随着业务的 增多和业务越来越复杂，移动设备的能量损耗问题突显，目前移动电池的发展速



1



(C)1994-2022   China   Academic   Journal   Electronic   Publishing   House.All   rights   reserved.    http://www.cnki.net

度还满足不了终端设备能量消耗需求日益增长的速度，亟需低能量消耗的通信技 术出现。
在LTE-A[3]项目中要求提供新的通信技术来达到IMT-Advanced 提出的要 求，提供更高的传输速率和系统带宽。Device-to-Device(D2D,设备直通技术)技 术应运而生，在蜂窝网络中的D2D 技术可以大大提高频谱利用率和通信效率。 D2D 直通通信是一种短距离的通信业务，能够实现各终端间不经过基站转发而 直接进行数据传输通信。与传统的蜂窝通信模式相比， D2D 通信由于其特性，
非常适用于相互距离较近的终端间使用，它的出现带来了许多有利影响。首先， D2D 用户利用认知无线电能力可以重用蜂窝通信的频谱资源实现不经过基站的  直联通信，从而提高无线资源利用率；其次，数据传输不经过中间基站的转发也  能大幅缩短通信传输时延，时延减小大约50%;另外，由于各终端用户间距离  比较近，因此对传输功率的需求也很低，可以减轻对终端的能量消耗等，相比于  传统通信模式，两个终端用户间使用D2D 通信模式可以节约大概44%的能量。 混合蜂窝与端到端网络是基于此基础提出来的网络系统，该异构网络由蜂窝网络  和D2D 网络组成，在该异构网络中不仅支持蜂窝通信，还支持D2D 直通通信。 因此由D2D 系统与蜂窝系统混合而成的异构网络，不但能够提高频谱利用率，  扩大蜂窝容量，而且具有高容量、低能耗、延时短等优点，更具高效性，具有很  高的价值和潜力，是未来移动通信中很具影响力的一种业务技术。
LTE 系统中需要保证各UE 上行信号到达基站时具有正交性，因此需要保证 LTE 信号在各UE 接收端的定时时钟一致。各UE 与基站间的距离并不相同，信 号的传输存在时延等误差，为保持时钟一致性，可以通过控制上行时钟提前量(TA: Timing Advance)来实现，即与基站的距离相对较近的UE, 可以将TA 设置的小  一些，相对晚一些发送；而与基站的距离相对较远的终端UE, 可以将TA 设置  的大一些，使其相对早一点发送，这样就可以保证即使各个终端UE 距离不同， 但发送的信号都能够同一时间到达基站，从而均与基站保持同步。然而对于混合 蜂窝与端到端网络，D2D 用户收发数据不经过基站而是在D2D 用户间直接进行， 上行信号接收端不是基站而是终端用户，要让D2D 用户实现准确的发送接收数  据信息，应该通过D2D 用户间的时间提前量(TA D2D)来保持用户间同步。因此 异构网络中由于包括了蜂窝系统和D2D 系统两种系统，通信的模式将不仅仅是  只有蜂窝系统时以基站为同步源的蜂窝通信。异构网络将会存在不同的同步源， 也因而存在多种同步技术，多种通信模式。为保证异构网络中D2D 通信的顺利 进行，必须要决策选择D2D 设备的同步源，选择正确的同步模式和技术。因而  同步机制将是异构网络中D2D 通信中极为关键的问题。

2



(C)1994-2022   China   Academic   Journal   Electronic   Publishing   House.All   rights   reserved.    http://www.cnki.net


1.3 LTE 系统下D2D 通信系统总体架构





图1 - 1  系统总体结构
本文的研究依托于 《LTE 系统下设备直通技术》课题， LTE 系统下D2D 通 信系统的总体架构如图1-1所示④:整个系统由上自下由APP 应用层， Scheduler
调度器， PHY 物理层， USRP 射频前端几个主要模块组成。
APP 应用层用于实现实际业务，如视频传输等，可借助于VLC 等软件实现。
Scheduler调度器不仅需要连接应用层 (APP) 和物理层 (PHY)  之间的数据 通路，实现业务数据的传输，还需在数据传输的过程中，需要实现资源调度以及 对等实体的信令流程通信控制等。调度器大致可以划分为五个独立的功能实体， 分别是TUN 虚拟网卡， Resource Map无线资源位图， RLCTX  发送链路RLC 实
体， RLCRX  接收链路RLC 实体， HARQ  混合重传控制。
PHY 层是系统物理层，负责链路的处理，包括发送和接收两大部分，发送
包括编码、调制等模块，接收包括同步、解码、解扰等模块。

3



(C)1994-2022   China   Academic   Journal   Electronic   Publishing   House.All   rights   reserved.   http:// www.cnki.net


USRP 层是系统的底层硬件层，使用USRP 模拟D2D 终端，实现系统中数
据的收发等功能。

1.4  论文主要工作安排

由于目前对LTE 系统下D2D 技术的研究还停留在理论研究阶段，因此除了 理论推导与仿真之外， D2D 技术还缺乏真实环境中的实践验证。本文依托LTE  系统下设备直通技术的研究课题，对蜂窝与D2D 异构网络中的同步方案进行了 设计与实现，为实现LTE 系统下设备直通技术提供了稳定的同步方案。本论文
的主要工作安排如下：
第二章：对蜂窝与D2D 异构网络中同步源和相应同步技术进行了分析和介
绍。
第三章：对蜂窝与D2D 异构网络中复杂多变的通信场景进行了详细的分析， 包括双终端场景，多终端场景，以及场景变化等多种情形，为设计与实现蜂窝与  D2D 异构网络的同步方案提供了依据。
第四章：选择设计模式中的状态模式作为蜂窝与D2D 异构网络中的同步方 案，分别对上行状态机和下行状态机各自的静态部分和动态部分进行了详细分析
与设计，从而完成该异构网络中同步状态机的完整设计
第五章：根据第四章的设计，采用多线程技术，详细描述系统中与同步状态 机相关的线程中各部分实体具体功能，通过通信接收线程和通信发送线程实现静 态同步状态机，在此基础上，通过同步监测线程实现同步状态机的状态变迁。最 后展示了使用依据本文所设计的同步方案，即同步状态机的D2D 通信系统在不
同场景中的业务传输等；
第六章：对全文作出总结，并对进一步研究改进作出了

















4



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net

第二章 蜂窝与D2D异构网络中的同步技术


2.1 异构网络D2D 通信同步源

由蜂窝通信网络与D2D 通信网络组成的混合异构网络中，如图2-1所示的 场景，对于D2D 终端，其同步源有如下三类：蜂窝基站、邻近其它D2D 终端、 邻近蜂窝上行用户。
1)蜂窝基站
与蜂窝基站建立同步关系，可以从蜂窝基站获取小区信息，从而确定小区资 源占用情况，实现与蜂窝系统资源共用，避免D2D 终端通信与蜂窝系统的干扰。 与之对应的同步技术为传统的下行cell同步技术。
2)邻近D2D 终端
与邻近D2D 终端建立同步关系，可以保证在没有基站覆盖环境下， D2D 终 端间的定时相同，从而实现D2D 终端间的通信。与之对应的同步技术为上行D2D  Sync 同步技术，该技术的核心为在上行特殊子帧的后两个符号传输D2D 同步信 号以及D2D 同步信息。
3)邻近蜂窝用户
与邻近蜂窝用户建立同步关系，可以获取蜂窝用户的定时提前量TA 从而避 免D2D 通信对蜂窝系统中蜂窝用户正常通信的干扰。与之对应的同步技术为上 行Cell UE 同步技术。



图2-1 异构网络示意图

5


(C)1994-2022 China Academic Journal Electronic Publishing House.Allrights reserved. http://www.cnkinet


2.2 蜂窝下行Cell同步技术

2.2.1 Cell:同步搜索.
在LTE 物理层协议中规定， LTE 系统中有504个唯一的物理层小区ID。 物 理层小区ID 分为168个唯一的物理层小区ID 组N%, 对应基站站址。每个组包
含三个唯一的组内小区IDN8, 对应扇区地址。这样唯一的物理层小区ID 可以表
示为：                 。因此我们可以由 PSS 序列检测得到N 器，由SSS 序
列检测：               定小区ID。 在 TDD 的帧结构中，标准规定常规CP 和
扩展CP 条件下，在第一号和第六号子帧的第3个OFDM  符号插入了主同步序 列，在第零号和第五号子帧的最后一个OFDM  符号插入了辅同步序列，分别占
用带宽中间的72个子载波(6个RB 块)。
1)时间同步6
Cell时间同步检测的基本原理是使用本地同步序列和接收信号进行相关，获 得相关峰值，通过对峰值的判定，判断出同步信号的位置。 TD—LTE 系统中的 时域同步检测可以分为两个步骤：首先检测主同步信号，然后根据主同步与辅同 步信号的位置关系，再进行辅同步信号检测。由于子帧CP 类型可能是常规CP,
也可能是扩展CP, 因此PSS 和 SSS 之间的距离存在两种可能，需要终端采用盲 检的方式识别。因此本系统中Cell时间定位将通过PSS 序列检测实现。在检测
PSS 之前，首先进行CP 的检测，确定符号头。检测进来的半帧数据中相关值最
大的144点，从而确定一个CP 的位置，然后将此位置附近的1024点均做相关  操作，将相关值与阈值(最大相关值的一半)做比较，通过查看相关值超过阈值 的个数的多少确定CP 类型。之后进行 PSS 相关检测，确定PSS 序列所在位置  再根据CP 类型，就可以确定 PSS 所在子帧的帧头，从而计算出无线帧头，确定 时间定位值。
时间同步搜索过程如下图所示：



CP 检测，粗粒度确 定符号头


CP 类型检测，
确 定cp长度


PSS相关检
测，精粒
度确定当
前子帧头


下一步操作： SSS检
测模块等


基于CP和PSS的同步跟踪


图2-2  Cell时间同步搜索过程示意图



6



(C)1994-2022    China   Academic   Journal   Electronic   Publishing   House.All   rights   reserved.   http://www.cnki.net

2)频率同步
由于收发硬件设备的本地载频之间存在偏差，以及信道多普勒频移等影响， 信号会存在频率的偏移。子载波间隔的整数倍偏移和小数倍偏移是频率偏移可能 存在的两种情况。为了保证下行信号接收的正确性，在小区搜索过程中，不仅需 要完成时间同步，还需对频率进行同步，从而保证收发两端信号频率的一致性。 频率同步可通过辅同步信号序列SSS、CP 信号和导频信号进行频偏估计，从而  对频率偏移进行纠正校验。
小数倍频偏估计的具体算法有多种，其原理基本相同：在发送端发送两个相
同的序列，经过信道传输后，如果存在频率偏移，那么两个发送时间不同的信号 之间会存在相位差，通过计算这个相位差就可以得到偏移量。
频率同步搜索过程如下图所示：


图2-3 Cell频率同步搜索过程示意图


2.3  Cell同步跟踪

1)时域跟踪
时域跟踪算法主要采用主同步信号 (PSS) 自相关检测：利用同步捕获检测 到的接受数据中PSS 序列的根指数，然后用本地产生相对应的PSS 副本与接收 到的PSS 信号进行相关运算。
2)频域跟踪
频偏可能包括两种17,一种是小数倍频偏， 一种是整数倍频偏。整数倍频偏 的存在会造成频域数据错位，如果不进行补偿会导致0.5的误码率。而小数倍频 偏会破坏子载波间的正交性，引起码间干扰，增加误码率。 LTE 系统的子载波间 隔为15kHz, 几乎不存在出现整数倍频偏的可能，因此我们这里只考虑小数倍频 偏的检测。
小数倍频偏估计有多种方式18,在LTE 系统中可以利用经典的基于CP 的
ML 算法、主同步信号或导频进行频偏估计。小数倍频偏可以采用ML 算法进行


7


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

估计，借助CP 相关运算结果，可以有效控制计算复杂度，所以本实现频率检测 估计是采用包含导频信号的OFDM  的 CP 做相关运算。
在存在小数倍频偏的情况下，可以得到循环前缀L 长的相关运算表达式如


公式所示








(2-1)

公式中d 表示 OFDM 符号起始位， L 表示CP 长度， N 表示OFDM 符号长 度， Af 是相邻样点间的频偏值，其估计值按下式取得

(2-2)
该算法的估计范围为-1/2到1/2子载波间隔，即-7.5kHz 到+7.5kHz,   对超过
此范围的频偏，该算法无法精确估计，因此只适合用来估计小数倍的频偏。
同步跟踪算法的估计结果将通过与时间同步算法中相同的滤波器进行滤波  处理，然后再用于频率补偿。由于同步跟踪的精确程度同样会对频率误差估计的 精度造成影响，频偏估计是以时间同步为前提的，时间同步跟踪处于稳定状态时， 频率跟踪也一定处于相对稳定的状态，时间同步误差较大，需要快速调整时，频 率误差也会有很大波动，需要进一步调整。因此频率跟踪过程使用与时间同步跟 踪过程完全一致的环路滤波器参数调整规则，该规则的定义以时间同步的稳定性
为基础。

2.4  D2D Sync 同步技术

2.4.1  D2D Sync信道
D2D-Sync 子信道用于帮助终端搜索附近的用户终端，并使要进行D2D 通信  的两个互盲的D2D 终端建立D2D 通信同步，以及所需的相关广播信息(SyncInfo), 这些信息包括对方的ID  ( 或IP 地址)、 TDD 配置、帧号/子帧号、同步来源、时  间提前量(TA) 调整指令等。实际上，两个D2D UE 间一旦通过接收对方D2D-Sync    完成了同步，也就完成了相互间的D2D 终端发现过程。
为了避免干扰， D2D-Sync 信道使用的是从LTE 物理上行共享信道
19)(Physical  Uplink  Shared  CHannel,PUSCH) 频谱资源中保留的资源(D2D-Sync  所使用的资源为特殊子帧中的上行最后两个符号的保护边带),即特殊子帧的最 后两个符号的保护边带 (GB),  如图2-4所示。其中，最后一个符号用于传输同
步信号，同步信号采取蜂窝上行通信的RS 信号设计，且全部用户的RS 信号所

8



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

用序列都相同以减小同步计算量；倒数第二个符号用于传输广播信息(SyncInfo),
采取蜂窝上行PUSCH  技术，但因数据量较少(几十bit), 为减小实现复杂度，
信道编码方式采用卷积码而不是上行链路的Turbo 码。
网络中所有D2D 终端都会在D2D-Sync 信道中发送自身的D2D-Sync 信息(同 步信号以及广播信息SyncInfo), 不 同D2D 终端对D2D-Sync 资源采取时分复用 的方式，以避免终端之间发生冲突。每个D2D 终端都周期性的占用某些无线帧 中 的D2D-Sync 信道资源发送自己的D2D-Sync 信号。取N=8 个无线帧为周期(考 虑演示系统最多要求8个D2D 终端同时工作，因此取了8个无线帧作为周期),
在 D2D 终端系统中维护无线帧号 (FrameNumber)。   根据下式

SFNOffset       =       FrameNumber%N       =ID%N                              (2-3)
计算各D2D 终端的时域偏移位置SFNOffset, 由 于N 个 D2D 终端的ID 各 不相同，将SFNOffset 分配给不同D2D 终端时，使处在同一区域中的邻近D2D
终端在不同的无线帧中发送S 子帧同步以避免冲突。


0	1	2	3	4	5	6	7	8	9	10	11	12	13




图2-4 D2D Sync资源使用
9


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net




2.4.2  Sync同步搜索
1) 时间同步
D2D Sync同步根据一无线帧的数据(10ms), 先用CP 相关找到无线帧中符 号的起始位置，之后取出符号中的2048个samples与本地的RS 序列作循环相关， 由于S 子帧1、6中的RS 序列不一致，故需产生两种不同的 RS 本地序列，每个 符号需与这两种RS 序列做循环相关，找出S 子帧中有RS 序列的符号的起始位  置，同时根据RS 序列的不同确定这是头5ms 还是尾5ms 的特殊子帧，从而确定 无线帧的起始位置，得到时间同步。
2) 频率同步
得到 S 子帧中RS 序列符号的起始位置后，取该符号的CP 以及符号中最后 144个sample, 做相关求和，计算出频偏，从而得到频率同步。
2.4.3  Sync同步跟踪
由于各D2D 终端设备中的晶振存在差异，这种差异会使两终端的时间存在 微小偏差，随着通信时间的推移，这种微小偏差会进行累计，导致终端间的时间 偏差越来越大，导致链路处理性能下降，解码正确率大大降低，影响通信性能。 因此需要Sync 同步跟踪来进行细同步维持。
1) 时域跟踪
利用 Sync 同步信号的相关性。根据最大似然检测原理，将接收信号与本地 信号进行互相关运算，然后进行峰值检测，可以得到同步信号所在的OFDM  符  号的时域起始位置。由于终端间经过同步搜索的粗同步后，已基本保持同步(可  能偏差几个或十几个samples), 根据子帧结构取出同步信号所在的OFDM  符号  	(2048点数据),只对该符号进行相关即可。通过相关找到同步符号的起始位置 从而确定两终端的时间偏差。
2) 频域跟踪
频偏检测采用CP 相关的频偏检测算法。利用特殊子帧的倒数第三个symhol (即存放广播信息的符号)的时域数据进行CP 相关，获取频域偏移值。

2.5 蜂窝上行Cell UE 同步技术

混合蜂窝与D2D 异构网络中可能存在蜂窝上行用户进行蜂窝通信，此时需避 免蜂窝通信和D2D通信之间的干扰。这就要求与蜂窝上行用户建立同步关系，获 取其相对与基站的定时提前量TA。 蜂窝上行Cell  E 同步主要目的是获取提前

10



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net

量TA, 因此只关注时域即可，并且由于蜂窝上行Cell UE同步需要在已建立下
行Cell 同步的基础上，相当于实时监测，因此不存在同步搜索和同步跟踪之分。
在蜂窝上行用户所发送的PUSCH 信号中，最能有效用于同步检测的是PUSCH RS 序列，其为CAZAC 序列有良好的同步、异步相关性。 CellUE 同步技术就是在 蜂窝同步的基础上，由蜂窝同步获取RB 起始位置等同步信息，生成PUSCH RS
本地序列，利用PUSCH RS的 CAZAC 性质进行同步检测。
在目前D2D 系统中，PSS 检测和S 子帧的D2D-Sync信道的RS 序列检测都是 CAZAC序列，采用了时域相关算法(原理是循环相关)。时域相关算法的快速实 现是利用 FFT/IFFT 实现循环相关。蜂窝用户 PUSCH RS 的同步检测也将运用 FFT/IFFT 的循环卷积快速算法实现。具体方案如下图所示：


1200个载波数据

PUSCH RS本地序列 (L CRB*12个载波)
依据RB START确定起始位置


加保护边带、2048点IFFT


时域本地序列(2048点)          补零 (N 点)
往前追加N个数据 2048个RS时域数据

2048+N点FFT


复共轭
2048+N点FFT
点乘

2048+N点IFFT

搜索相关峰



图2-5 Cell UE同步过程




11


(C)1994-2022   China   Academic   Journal   Electronic   Publishing   House.All   rights   reserved.    http://www.cnki.net


2.6 本章小结

本章围绕混合蜂窝与D2D 异构网络中的同步源，首先分析了同步源的种类 包括D2D 终端同步源， Cell蜂窝基站同步源， Cell蜂窝上行用户UE 同步源及  其各自特性。在此基础上，与同步源对应，分别介绍了蜂窝下行Cell同步技术， D2D Sync同步技术和蜂窝上行Cell UE同步技术。对于蜂窝下行Cell同步技术， 分别介绍了时域和频域的粗同步技术即同步搜索技术，以及时域和频域的细同步 技术即同步跟踪技术。对于D2D Sync同步技术，首先介绍了用于D2D 之间完 成Sync 同步的Sync 信道，并以此为基础，分别介绍了时域和频域的同步搜索技
术和同步跟踪技术。对于 Cell UE同步技术，则介绍了获取Cell UE提前量TA
的原理和流程。
本章对各同步技术类型进行了总体介绍，是设计和实现混合蜂窝与D2D 异 构网络中同步方案的基础，对依据各同步技术的原理已实现的各同步模块进行方
案设计和综合调用，是混合蜂窝与D2D 异构网络中同步方案的主要研究内容。

































12



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net

第三章 蜂窝与D2D异构网络中的同步场景分析


由 D2D 直通通信系统和蜂窝系统组成的混合异构网络[0,由于覆盖环境复 杂多变，同步源也多种多样，通信场景多样多变。在本章，首先详细介绍了该异 构网络中，对于双D2D 终端存在的几种基础场景，即基础通信模式，并讨论了 各基础场景间的互相切换。进而引出了三终端通信场景和复杂多终端场景，并对 多终端可能存在的通信场景进行了详细分析和讨论。

3.1 双终端基础通信场景

双终端即只有两个D2D 终端互相通信，是通信网络中最简单也是最基础的 场景，是多终端通信的基础。因此本节先对由D2D 直通通信系统和蜂窝系统组 成的混合异构网络中的双终端可能存在的场景进行详细分析，并给出其之间的转 移切换条件。
3.1.1 D2D 自组织通信
D2D ·直通通信需要满足在无网络覆盖的环境下可以进行稳定通信。这对于 某些场景极其有用，例如遇到地震等自然灾害时，通信设施受损，无法进行正常 蜂窝通信，此时D2D 自组织模式通信将体现出其极大的优势。
对于由蜂窝网络和 D2D 自组织网络组成的异构网络，此种通信场景退化成 只有D2D 自组织网络的通信，是D2D 终端互相通信最简单的一种情形。即外界 没有蜂窝基站与上行蜂窝终端，此时D2D 自组织网络不必考虑与蜂窝网络的干
扰等一系列问题，只需D2D.终端间建立同步关系进行D2D 通信。
在D2D 自组织模式下， D2D 终端之间依靠发送Sync 同步信号进行同步。 需要确定一个D2D 终端为主机，周围其他D2D 终端均与主机建立同步关系，以 主机的时间定时为基准对齐。主机的确定是由D2D 终端接入网络的顺序确定， 最先接入网络的D2D 终端由于在接入开机时D2D  Sync 同步搜索发现失败，因 此将本机作为D2D 网络的主机。而随后接入的D2D 终端，在开机搜索时 Sync 同步发现成功，可以搜索到之前存在的D2D 主机，因此确定同步关系成为其从 机，与其同步对齐。
如图3-1 所示，该种情形下对于 D2D 终端1,其最先接入网络，因此成为 D2D 网络的主机，以自身时间为基准定时。而对于 D2D 终端2,其接入网络时 网络中已存在主机，因此成为D2D 终端1的从机，其上行采用Sync 同步解出的 时频和频偏结果进行时间对齐和频域补偿，下行则以上行为基准。为更好的与蜂


13


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net


窝网络共存，即使通信环境无蜂窝网络覆盖，也采用预提前机制， D2D  主机和
从机上行也都需采用LTE 协议标准的提前量TA 相对于下行提前发送和接收。
该通信场景是异构网络各种通信场景总最简单最基础的一种，当网络中覆盖
情况出现变化时，该通信场景可以切换到其它相应通信场景。

图3-1 双终端D2D 自组织通信
3.1.2 全蜂窝覆盖通信
当异构网络为全蜂窝基站覆盖，即各D2D 终端均能搜索发现蜂窝基站信号， 为了与蜂窝系统共用资源并且避免与蜂窝通信的干扰，此时异构网络中两个D2D   终端应分别与基站进行同步，同步定时均以基站为基准。在该场景中，下行应采  用下行Cell同步解出的时频和频偏结果进行时间对齐和频域补偿，上行则以下  行为基准。通过预提前机制，上行采用LTE 协议标准的提前量TA 相对于下行提
前发送和接收。

图3-2 双终端全蜂窝基站覆盖通信





14



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net

3.1.3 全 Cell UE覆盖通信
当异构网络中不仅存在全蜂窝基站覆盖，还存在上行Cell UE信号全覆盖， 即各 D2D 终端均能搜索发现蜂窝基站信号和上行Cell UE信号，此时两个D2D   .终端不仅需要分别与基站进行下行Cell 同步，还需要与Cell UE建立同步获取上  行Cell UE的时间提前量TA,从而避免D2D 通信系统和蜂窝系统间的互相干扰。  对于时偏，下行采用下行Cell同步解出的时偏，上行在下行对齐的基础上，使  用 Cell UE同步解出的提前量TA 相对于下行提前发送和接收。对于频偏则使用
下行Cell同步解出频偏结果进行频域补偿即可。
蜂窝基站

蜂窝用户
图3-3 双终端全蜂窝Cell UE覆盖通信
3.1.4  半蜂窝覆盖通信
当异构网络场景为部分有蜂窝信号覆盖，而部分无蜂窝信号覆盖时，如图 3-4所示，对于处于蜂窝网络覆盖下的D2D 终端2,其与基站建立同步关系。而 处于无蜂窝网络覆盖下的D2D 终端1则通过Sync 同步与处于网络覆盖下的D2D  终端2建立同步关系，相当于D2D 终端1的根同步源也是蜂窝基站， D2D 终端 2起到了一个中继作用。在该种通信场景中，由预提前机制D2D 终 端 1 和D2D  终端2上行均采用LTE 协议标准的提前量TA 相对于下行提前发送和接收。对于 频偏 D2D 终端1使用Sync 同步解出的频偏结果进行频域补偿，而D2D 终端2
则使用下行Cell同步解出频偏结果进行频域补偿。









15


(C)1994-2022    China   Academic   Journal   Electronic   Publishing   House.All   rights   reserved.   http:/\www.cnki.net


北京邮电大学工学硕士学位论文


图3-4 双终端半蜂窝基站覆盖通信
3.1.5 半 Cell UE半蜂窝覆盖通信

当异构网络场景为部分有蜂窝信号覆盖和Cell UE信号覆盖，而部分无蜂窝 信号和Cell UE信号覆盖时，如图3-5所示，对于处于蜂窝网络覆盖下的D2D 终 端2,其下行与基站建立同步关系。上行则基于下行对齐的基础上，通过与Cell UE 建立同步获取CellUE 的时间提前量TA, 并使用TA 相对于下行提前发送和 接收。而对于处于无蜂窝网络覆盖下的D2D 终端1则通过Sync 同步与处于网络 覆盖下的D2D 终端建立同步关系，其上行相对于下行提前发送和接收的提前量 TA 通过与D2D 终端2建立的Sync 同步中的带外信息Synclnfo获取。在该场景
中 D2D 终端1的下行根同步源也是蜂窝基站，D2D 终端2起到了一个中继作用，
频偏的情形与3.1.4所讨论的场景相同。
















图3-5 双终端半Cell UE半蜂窝覆盖通信



16



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net

3.1.6  半 Cell UE 覆盖通信

当异构网络场景为全蜂窝信号覆盖但Cell UE信号为半覆盖时，如图3-6所 示，对于处于Cell UE信号覆盖下的D2D 终端2,其下行与基站建立同步关系。 上行则基于下行对齐的基础上，通过与Cell UE建立同步获取Cell UE的时间提 前量TA, 并使用TA 相对于下行提前发送和接收。而对于处于无Cell UE覆盖下  的 D2D 终端1,下行也通过Cell 同步与蜂窝基站同步对齐，而上行则在下行对
齐的基础上，通过解析D2D 终端2发送的带外Sync 同步信息获取提前量TA,
并通过TA 使得上行相对于下行提前发送和接收从而避免与蜂窝网络的干扰。在 该场景中D2D 终端1和2的下行根同步源均是蜂窝基站，但对于上行， D2D 终 端2起到了一个中继传播蜂窝网络TA 的作用。对于频偏D2D 终 端 1 和D2D 终
端2均使用下行Cell同步解出的频偏进行频率补偿即可。


蜂窝用户
图3-6 双终端半Cell UE覆盖通信

3.1.7  双终端通信中的场景切换
之前讨论了异构网络中双终端的几种基础通信场景，基础通信场景并不是一 直保持不变，随着异构网络中覆盖情况的变化，各基础通信场景之间均可以互相
转移切换。
对于基础场景1 (D2D  自组织通信),结合图3-1所示，其向其它场景切换的
条件如下表所示：




17


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved. http://www.cnki.net

表3-1 基础场景1切换条件


基础场景1向其他场景切换条件
基础场景 ·2
(全蜂窝基站覆盖通信)	蜂窝基站信号接入网络，且D2D终端(D2D终端1,D2D终端2)均可 发现基站信号
基础场景3
(全Cell UE覆盖通信)	Cell UE信号接入网络，且D2D终端(D2D终端1,D2D终端2)均可发 现基站信号和Cell UE信号
基础场景4
(半蜂窝覆盖通信)	蜂窝基站信号接入网络，但只有部分D2D终端(D2D终端2)可发现基 站信号
基础场景5
(半Cell UE半蜂窝覆盖通信)	蜂窝基站信号和CellUE信号接入网络，但只有部分D2D终端(D2D终 端2)可发现Cell UE信号和基站信号
基础场景6
(半Cell UE覆盖通信)	蜂窝基站信号和Cell UE信号接入网络，D2D终端(D2D终端1,D2D 终端2)均可发现基站信号，但只有部分D2D终端(D2D终端2)可发 现Cell UE信号

基础场景1 (D2D  自组织通信)作为异构网络中最简单最基础的通信场景， 其原有覆盖条件为网络不存在蜂窝基站信号和Cell UE信号，因此其切换条件可 以概括为蜂窝基站信号和Cell UE信号的新接入。对于双终端，两个终端的覆盖
情况可能不同，根据覆盖情况可以确定向何种场景切换。
对于基础场景2(全蜂窝基站覆盖通信),结合图3-2所示，其向其它场景切 换的条件如下表所示：
表3 - 2 基础场景2切换条件


基础场景2向其他场景切换条件
基础场景1
(D2D自组织通信)	网络中失去蜂窝基站信号，即D2D终端(D2D终端1,D2D终端2)均 无法搜索发现基站信号
基础场景3
(全Cell UE覆盖通信)	Cell UE信号接入网络，且D2D终端(D2D终端1,D2D终端2)均可发 现Cell UE信号
基础场景4
(半蜂窝覆盖通信)	部分D2D终端(D2D终端1)失去基站信号
基础场景5
(半Cell UE半蜂窝覆盖通信)	网络中部分D2D终端(D2D终端1)失去基站信号，部分D2D终端(D2D 终端2)可发现新接入的Cell UE信号
基础场景6
(半Cell UE覆盖通信)	Cell UE信号接入网络，但只有部分D2D终端(D2D终端2)可发现Cell UE信号

基础场景2(全蜂窝基站覆盖通信),其原有覆盖条件为网络中全部D2D 终 端 (D2D  终 端 1 和D2D 终端2)均处于蜂窝基站信号覆盖下，因此切换条件可 以概括为 Cell UE信号的接入以及蜂窝基站信号的失去(部分D2D 终端失去基
站信号或网络中全部D2D 终端均失去基站信号)。
对于基础场景3(全Cell UE覆盖通信),结合图3-3所示，其向其它场景切

18



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net


换的条件如下表所示：
表3-3 基础场景3切换条件


基础场景3向其他场景切换条件
基础场景1
(D2D自组织通信)	网络中失去蜂窝基站信号和Cell UE信号，即D2D终端(D2D终端1, D2D终端2)均无法搜索发现基站信号和Cell UE信号
基础场景2
(全蜂窝覆盖通信)	网络中失去Cell UE信号，即D2D终端(D2D终端1,D2D终端2)均 无法搜索发现Cell UE信号
基础场景4
(半蜂窝覆盖通信)	网络中失去Cell UE信号，部分D2D终端(D2D终端1)基站信号也丢 失
基础场景5
(半Cell UE半蜂窝覆盖通信)	网络中部分D2D终端(D2D终端1)失去基站信号和Cell UE信号
基础场景6
(半Cell UE覆盖通信)	网络中部分D2D终端(D2D终端1)失去Cell UE信号

基础场景3(全 Cell UE覆盖通信)是双终端各场景中覆盖环境最复杂的一 种，其原有覆盖条件为网络中全部D2D 终 端 (D2D  终 端 1 和D2D 终 端 2 ) 均 处 于蜂窝基站信号和Cell UE信号覆盖下，因此其切条件换可以概括为Cell UE信  号以及蜂窝基站信号覆盖情况的失去(部分D2D 终端或网络中全部D2D 终端失
去基站信号或Cell UE 信号)。
对于基础场景4(半蜂窝网络覆盖通信),结合图3-4所示，其向其它场景切
换的条件如下表所示：
表3-4 基础场景4切换条件


基础场景4向其他场景切换条件 ·
基础场景1
(D2D自组织通信)	网络中失去蜂窝基站信号，即D2D终端(D2D终端1,D2D终端2)均 无法搜索发现基站信号
基础场景2
(全蜂窝覆盖通信)	网络中所有D2D终端(D2D终端1,D2D终端2)均能发现基站信号
基础场景3
(全Cell UE覆盖通信)	网络中所有D2D终端(D2D终端1,D2D终端2)均能发现基站信号和 Cell UE信号
基础场景5
(半Cell UE半蜂窝覆盖通信)	网络中已处于基站信号覆盖下的D2D终端(D2D终端2)发现Cell UE · 信号
基础场景6
(半Cell UE覆盖通信)	网络中所有D2D终端均能发现基站信号，且部分D2D终端(D2D终端2) 发现Cell UE信号


基础场景4(半蜂窝网络覆盖通信),其原有覆盖条件为网络中部分 D2D 终 端 (D2D  终端2)处于蜂窝基站信号覆盖下，因此该基础场景的切换条件可以概 括为 Cell UE信号的接入以及蜂窝基站信号覆盖情况的变化(D2D  终端1发现蜂
窝基站信号或D2D 终端2失去原有蜂窝基站信号覆盖)。

19


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net


对于基础场景5(半Cell UE半蜂窝覆盖通信),结合图3-5所示，其向其它
场景切换的条件如下表所示：
表3-5 基础场景5切换条件


基础场景5向其他场景切换条件
基础场景1
(D2D自组织通信)	网络中失去蜂窝基站信号和Cell UE信号，即D2D终端(D2D终端1, D2D终端2)均无法搜索发现基站信号和Cell UE信号
基础场景2
(全蜂窝覆盖通信)	网络中所有D2D终端(D2D终端1,D2D终端2)均能发现基站信号， 但D2D终端均失去Cell UE信号
基础场景3
(全Cell UE覆盖通信)	网络中所有D2D终端(D2D终端1,D2D终端2)均能发现基站信号和 Cell UE信号
基础场景4
(半蜂窝覆盖通信)	网络中失去Cell UE信号，即D2D终端(D2D终端2)无法搜索发现Cell UE信号
基础场景6
(半Cell UE覆盖通信)	网络中所有D2D终端(D2D终端1,D2D终端2)均能发现基站信号


基础场景5(半Cell UE半蜂窝覆盖通信),其原有覆盖条件为网络中部分 D2D 终 端 (D2D  终端2)处于蜂窝基站信号和Cell UE 信号覆盖下，因此其切换 可以概括为Cell UE信号和蜂窝基站信号对于D2D 终端1的接入情况和Cell UE
信号和蜂窝基站信号对于D2D 终端2的失去情况。
对于基础场景6(半Cell UE覆盖通信),结合图3-6所示，其向其它场景切
换的条件如下表所示：
表3-6 基础场景6切换条件


基础模式6向其他场景切换条件
基础场景1
(D2D自组织通信)	网络中失去蜂窝基站信号和Cell UE信号，即D2D终端(D2D终端1, D2D终端2)均无法搜索发现基站信号和Cell UE信号
基础场景2
(全蜂窝覆盖通信)	网络中所有D2D终端(D2D终端1,D2D终端2)均能发现基站信号， 但D2D终端均失去Cell UE信号
基础场景3
(全Cell UE覆盖通信)	网络中所有D2D终端(D2D终端1,D2D终端2)均能发现基站信号和 Cell UE信号
基础场景4
(半蜂窝覆盖通信)	网络中失去Cell UE信号，即D2D终端2无法搜索发现Cell UE信号
基础场景5
(半Cell UE半蜂窝覆盖通信)	网络中部分D2D终端(D2D终端1)失去基站信号

基础场景6(半Cell UE 覆盖通信),其原有覆盖条件为网络中全部D2D 终
端 (D2D  终 端 1 和D2D 终端2)均处于蜂窝基站信号覆盖下，网络中部分D2D

20



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

终端(D2D 终端1)处于Cell UE信号覆盖下，因此其切换条件可以概括为对于D2D  终端1,Cell UE信号的接入和蜂窝基站信号的失去以及对于D2D 终端2,Cell UE
信号和蜂窝基站信号的失去。

3.2 多终端场景

异构网络中可能并不只存在两个终端，在网络中，很有可能存在多台 D2D  终端互联的情况，而每一台D2D 终端所处覆盖环境可能并不相同。在3.1 节探 讨的双终端场景的基础上，可以将多终端网络分解成多个双终端通信基础场景的 组合。而多终端场景其本质是双终端场景的基础上，新接入一个或多个 D2D 终
端，在本节，将介绍几种典型的多终端场景。
3.2.1 三终端场景
三终端场景本质是在双终端的通信场景基础上，新接入一个D2D 终端。新 接入的D2D 终端其所处的覆盖情况可能存在很多种，因此其接入后三个终端所
构成的网络通信场景也将不同。
首先讨论最简单的D2D 自组织通信模式。当原双终端场景为基础场景1
(D2D  自组织通信),新接入也无基站信号覆盖和Cell UE信号覆盖的D2D 终端 (D2D 终端3),接入后可能构成以下几种三终端的通信场景：
1) 三终端场景1:



图3-7 三终端场景1示意图
如上图所示，D2D 终端1和D2D 终端2稳定运行在3.1.1讨论的场景中(D2D  自组织通信), D2D 终端1为主机， D2D 终端2为D2D 终端1的从机， D2D 终 端 1 以自身定时为基准，而D2D 终端2以D2D 终端1的定时为基准。此时新接 入D2D 终端3,接入时， D2D 终端3的sync 同步发现情况为同时可以发现作为
网络中同步主机的D2D 终端1和从机的D2D 终端2,此时为了提高同步的稳定

21



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net


性，D2D 终端3应该优先与D2D 终端1建立同步关系，并以D2D 终端1的定时 为基准，此时D2D 终端1和D2D 终端3构成了另一个子双终端通信场景。在该 场景中三个 D2D 终端之间均可以互相发现，任意两者之间可以互相进行D2D 通
信。
2)三终端场景2:


图3-8 三终端场景2示意图
如图3-8所示，D2D 终端1和D2D 终端2稳定运行在3.1.1讨论的场景中(D2D  自组织通信)。此时新接入D2D 终端3,接入时， D2D. 终端3的sync 同步发现 情况为只能够发现作为网络中同步从机的D2D 终端2,此时D2D 终端3别无选 择的只能与D2D 终端2建立同步关系，以D2D 终端2的定时为基准。在该场景 D2D 终端1和2,2和3之间可以互相发现，可以直接进行D2D 通信，而D2D
终端1和D2D 终端3之间则需要D2D 终端2作为中继，通过路由算法进行通信。
3)三终端场景.3:

图3-9 三终端场景3示意图
如图3-9所示，D2D 终端1和D2D 终端2稳定运行在3.1.1讨论的场景中(D2D 自组织通信),D2D 终端1为主机， D2D 终 端 2 为D2D 终端1 的从机， D2D 终


22



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved. http://www.cnki.net

端 1 以自身定时为基准，而D2D 终端2以D2D 终端1的定时为基准。此时新接 入 D2D 终端3,接入时， D2D 终 端 3 的sync 同步发现情况为只能够发现作为网 络中同步主机的D2D 终端1,此时D2D 终端3只能与D2D 终端1建立同步关系， 以 D2D 终端1的定时为基准。在该场景D2D 终端1和2,1和3之间可以互相 发现，可以直接进行D2D 通信，而D2D 终 端 2 和D2D 终端3之间则需要D2D
终端1作为中继，通过路由算法进行通信。
之前讨论的三个三终端场景条件都是新接入的D2D 终端3无基站信号覆盖 和 Cell UE信号覆盖，接入后三个终端组成的网络依然只是D2D 自组织网络，
下面将介绍当新接入的D2D 终端3有覆盖情况的场景。
4)三终端场景4:







图3-10 三终端场景4示意图
如上图所示，D2D 终端1和D2D 终端2稳定运行在3.1.1讨论的场景中(D2D  自组织通信), D2D 终端1为主机， D2D 终端2为D2D 终端1的从机， D2D 终 端 1 以自身定时为基准，而D2D 终 端 2 以D2D 终端1 的定时为基准。此时新接 入D2D 终端3, D2D 终端3在接入时，可以发现基站信号和CellUE 信号(也 可能不存在Cell UE信号，途中虚线框表示),此时D2D 终端1,2和3的syne 同 步发现情况为均能发现彼此，在这种场景下， D2D 终端3应与蜂窝基站下行通  过 cell同步建立同步关系，而D2D 终端1和D2D 终端2则应抛弃之前建立的同 步关系，重新与D2D 终端3建立同步关系，成为D2D 终端3的从机，根同步源 由 D2D 终端上升为蜂窝基站，从而从D2D 自组织通信切换成与蜂窝网络共存的 异构网络通信状态。在该三终端场景中可以分解成终端1和终端3,终端2和终端 3两个双终端基础场景4或者基础场景5,这3个D2D 终端可以互相发现，可以
直接进行D2D 通信。
23


(C)1994-2022 China Academic Journal Electronic Publishing House. All rights reserved. htp:/www.cnkinet


5)三终端场景5:

图3-11 三终端场景5示意图
如上图所示，D2D 终端1和D2D 终端2稳定运行在3.1.1讨论的场景中(D2D  自组织通信), D2D 终端1为主机， D2D 终 端 2 为D2D 终端1的从机， D2D 终 端1以自身定时为基准，而D2D 终 端 2 以D2D 终端1的定时为基准。此时新接 入D2D 终端3,D2D 终端3在接入时，可以发现基站信号和Cell UE信号(也  可能不存在Cell UE信号，途中虚线框表示),此时Sync 同步发现情况为D2D
终端2可以发现1和3,而1和3则只能发现2,不能发现彼此。在这种场景下， D2D 终端3应与蜂窝基站下行通过cell同步建立同步关系，而D2D 终端2则应 抛弃之前与1建立的同步关系，重新与D2D 终端3建立同步关系，成为D2D 终 端3的从机， D2D 终端1则抛弃D2D 网络主机身份，与D2D 终端2建立同步关 系，成为D2D 终端2的从机。 D2D 终端1和2的根同步源由D2D 终端上升为蜂
窝基站，从而从D2D 自组织通信切换成与蜂窝网络共存的异构网络通信状态。
该场景可以分解成终端1和终端2构成的双终端基础场景1和终端2和终端3  构成的双终端基础场景4或者基础场景5。在该场景中1和2,2和3之间可以直
接进行D2D 通信，1和3之间则需要通过2的中继和路由算法进行通信。
3.2.2  复杂多终端场景
相对于三终端，复杂多终端即多于三个终端组成的异构网络其实只是接入了 更多的终端，其原理是相同的，网络中任意两个可通信的终端之间均可以看做之
前提出的双终端基础场景之一。











24



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net








图3-12 复杂多终端场景示意图
图3-12展示了一种多终端场景，如图所示，其可以看做是D2D 终 端 1 和  D2D 终端2组成的双终端基础场景与D2D 终 端 3 和D2D 终端4组成的双终端基 础场景的融合。原本D2D 终端1为主机， D2D 终 端 2 为D2D 终端1的从机，
D2D 终端1以自身定时为基准，而D2D 终 端 2 以D2D 终端1的定时为基准。在 接入 D2D 终 端 3 和D2D 终端4之后D2D 终端2则应抛弃之前与1建立的同步 关系，重新与D2D 终端3建立同步关系，成为D2D 终端3的从机， D2D 终 端 1 则抛弃D2D 网络主机身份，与D2D 终端2建立同步关系，成为D2D 终端2的  从机。D2D 终端1和2的根同步源由D2D 终端上升为蜂窝基站，从而从D2D  自
组织通信切换成与蜂窝网络共存的异构网络通信状态。在该场景中相邻的D2D
终端之间可以直接进行D2D 通信，不相邻的则需要通过中继和路由算法进行通
信。
以上的讨论都是在D2D 终端1和D2D 终端2运行在双终端基础场景1(D2D  自组织通信)的基础上，对于不是双终端基础场景1 的情况，多终端场景的原理  相同，都可以分解成各个子双终端场景，只是分解后不是D2D 双终端基础场景 1(D2D   自组织通信)而已。对于复杂多终端场景，其接入情况还有非常多种，
但原理完全相同，在此不再赘述。




25


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

3.3  异构网络同步定时

根据异构网络中覆盖情况和场景的不同，对于同步定时机制可以分为两大类： 一是无蜂窝网络覆盖下的D2D 自组织网络同步定时，二是与蜂窝网络共存时的  同步定时。前者是以D2D 自组织网络中的D2D 主机为定时基准，而后者则是以  共存的蜂窝网络中的基站为定时基准Ⅲ]。
3.3.1 D2D 自组织网络同步定时
当没有蜂窝网络覆盖时，即D2D 通信为自组织模式，通信场景如图3-1所 示。即系统中存在两个D2D 终端，其中D2D 终端1为主机，其定时以自身为基 准。D2D 终端2为从机，其定时关系以D2D 终端1为基准，通过与D2D 终端1 建立上行Sync 同步进行定时调整。
对于无蜂窝网络覆盖的D2D 自组织模式，其定时关系如图3-13所示。此时 对于D2D 终端2,其与D2D 终端1建立sync同步，而用于建立和维持sync同  步的sync子帧是在特殊子帧的上行部分传输，因此其上行定时会和D2D 终端1 上行对齐。在该网络中，各个D2D 中东上行相对下行有一个提前量TA.对于主  机D2D 终端1,该值设为LTE 协议中规定的标准默认值；对于从机D2D 终端2,  为保持与同步主机的一致，该值通过Sync 同步时解析由主机D2D 终端1传输的 带外同步信息而获得。 D2D 终端2在上行已与D2D 终端1定时对齐的基础上， 根据提前量TA 可完成下行与同步主机下行的定时对齐。

----时间方向---- →

图3-13  D2D 自组织网络同步定时示意图



26



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net

3.3.2 蜂窝网络与D2D 网络共存时同步定时
当有蜂窝网络覆盖时， D2D 自组织网络和蜂窝网络构成混合异构网络。通 信场景根据覆盖情况的不同，可能为基础场景 等。系统中存在两个D2D 终端， 由于两个终端之间互相传输本身就会存在传播时延，导致终端上行接收定时和  D2D 数据传输真实定时之间存在差异。但是实际上， LTE 系统的普通循环前缀 的长度为4.6875μs[12], 该时间对应的传输距离为1406.25 m, 考虑到信号传输 的往返，理论上来说当收发终端的距离在700m 以内时，大致可认为其同步误差 是可以被 LTE 系统的OFDM  普通循环前缀所覆盖。700m 对于终端之间的直通 通信是相当理想的距离，完全满足“邻近”的概念。因此，对于LTE 系统的D2D  通信来说，当基站信号覆盖时。当各终端均与基站通过下行cell同步进行定时对 齐，即可认为各终端之间是同步的。对于上行，将相比于下行有一个提前量TA  当有蜂窝上行用户信号存在时，该值通过与上行蜂窝用户进行同步而获取；当系 统中不存在蜂窝上行用户信号时，该值设为LTE 协议中规定的标准默认值。D2D  各终端在下行已与基站定时对齐的基础上，根据提前量TA 可完成D2D 终端之
间上行的定时对齐。



基站下行传输定时

上行蜂窝用户传输
定时
上行相对于下行提前量：
D2D终端1上行传输
即D2D传输定时


D2D帧到达终端2真
实定时
一定时课差
D2D终端2上行传输
即D2D传输定时

-时间方向--

图3-13 蜂窝与D2D 混合网络同步定时示意图









27


(C)1994-2022   China   Academic   Journal   Electronic   Publishing   House.All   rights   reserved.    http://www.cnki.net

3.4 本章小结

本章对D2D 直通通信系统和蜂窝系统组成的混合异构网络可能存在的各种 通信场景进行了非常详细的分析。首先详细介绍了该异构网络中，双D2D 终端 可能存在的几种基础场景，并分析了各基础场景间的互相切换。之后在双终端的 基础上分析了三终端通信场景，和复杂多终端场景，它们都是以双终端基础场景 为基础，这是多终端场景的根本原理：即任意多终端场景均可以看成多个双终端 基础场景的融合。最后，根据之前的场景分析，对异构网络中同步定时进行了讨 论分析，根据有无蜂窝网络覆盖，可以将异构网络中的定时机制分为两大类，即 D2D 自组织网络的同步定时和混合蜂窝与D2D 自组织网络的同步定时。本章的 分析为下一章同步状态机的设计与实现奠定了良好基础。





































28



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net


第四章同步状态机设计
第四章 同步状态机设计


4.1 状态设计模式

1970年，建筑设计大师亚力山大在《建筑的永恒之道》里最早提出了“设 计模式”的概念：模式是一条由三个部分组成的通用规则：它表示了一个特定环 境、 一类问题和一个解决方案之间的关系。每一个模式描述了一个不断重复发生 的问题，以及该问题解决方案的核心设计。虽然《建筑的永恒之道》是针对建筑 领域的，但亚力山大的观点实际上适用于所有的工程设计领域，其中也包括软件 设计领域。
1)创建型
该类型用于当创建对象时根据特定场景，由程序来确定创建对象的方式，而 不再由我们直接实例化对象，从而保证更大的性能、更好的架构优势。创建型模 式主要有简单工厂模式、工厂方法、抽象工厂模式、单例模式、生成器模式和原 型模式。
2)结构型
该类型用于将多个实例对象组织成更大的结构。结构型模式主要有适配器模
式、桥接模式、组合器模式、装饰器模式、门面模式、亨元模式和代理模式。
3)行为型
该类型用于系统间各对象的通信，以及如何控制复杂系统中流程。行为型模 ‘式主要有状态模式、命令模式、解释器模式、迭代器模式、中介者模式、备忘录 模式、观察者模式、策略模式、模板模式和访问者模式。
状态模式是一种行为型的设计模式，其具体实现为有限状态机(FSM),适用于 对复杂系统的行为建模。由第三章的分析可以看出混合蜂窝与D2D 异构网络中的 同步系统相当复杂，通信场景多样，而且会不断变化，非常适用于状态模式。因 此对于混合蜂窝与D2D 异构网络中的同步方案，将采用状态模式的设计模式，实 现同步状态机。
由第三章中异构网络的同步定时分析可知，由于CellUE 的上行定时信息与   基站的定时信息有偏移，因此同步状态机必须分为上行状态机和下行状态机。上   行子状态机和下行子状态机均有各自的子状态，并且都包括静态和动态两大部分。 静态指外界覆盖环境稳定不变化，系统中状态稳定运行；动态指外界覆盖环境变  化时状态变化，即状态间转移。



29



(C)1994-2022   China   Academic   Journal   Electronic   Publishing   House.All   rights   reserved.    http://www.cnki.net


4.2 系统中状态标志和同步信息

异构网络中状态机的设计需要一些状态标志和状态信息来表征各同步信息
以及状态信息[13]。
4.2.1 状态标志
在该异构网络中有三种同步信号，根据这三种信号，物理层的子同步标志有
如下三种：
● CELL  STATE(指示与外部蜂窝小区的同步关系，取值为Idle 和 Active,  Active代表蜂窝小区同步信号存在， Idle代表不存在),该值可通过下 Cell同步获取：
● D2D  STATE(指示与邻近D2D 终端的同步关系，取值为Idle 和 Active,
Active代表邻近D2D 终端的同步信号存在， Idle代表不存在),该值可
通过上行D2D Sync同步获取；
● UE  STATE (指示与邻近蜂窝用户的上行信号的同步关系，取值为Idle
和Active,Active代表蜂窝用户的上行同步信号存在，Idle代表不存在),
. ·“ 该值可通过上行蜂窝UE 同步获取。
4.2.2  同步信息
D2D 通信系统中的同步信息主要是通过Sync 同步中的带外SyncInfo信息进
行传输。本方案设计SyncInfo中传输以下同步信息114:
●  ID:   D2D终端本机ID。
●  SYNC  ID:本机与之建立同步关系，成为其从机的D2D 终 端ID,  该信息 _
表征本机以哪个D2D 终端为直接定时基准建立同步关系，对于D2D 主
机，该值为本机ID。
●  SYNC  ID  ORG:   本机定时基准的根源D2D 终端ID 。该信息表征本机 _    _
与以哪个D2D 终端为根源定时基准建立同步关系，即如果存在中继的 情况，中继的源头D2D 终端ID。 对于D2D 主机，该值为本机ID
●  SYNC  UL  ORG:  上行的根源同步源类型，表征本机上行定时基准的同 _     _
步源类型。
●  TA: 本机的上行提前量TA。








30



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net

4.3 静态状态机设计

4.3.1 下行静态状态机设计
对于D2D '终端下行；根据有无蜂窝覆盖其同步定时方式只有两个：与蜂窝 基站同步定时；根据上行Sync 同步定时和提前量进行下行定时。对于这两种定 时方式，若同时存在，即存在蜂窝基站信号覆盖时，为避免干扰与蜂窝网络共享 资源， D2D 下行应首选与蜂窝基站下行定时对齐，同步优先级理应为蜂窝基站  同步定时高于基于上行sync定时的下行定时。
因此，对于下行状态机，可以设置两个状态15]:
STATE DL=D2D Mode:    自组状态，外界无基站同步信号覆盖，下行定时
方式为由上行Sync同步定时对齐而自动对齐，需要状态标志CELL STATE 为Idle。
STATE DL=Cell Mode:   基站状态，在基站信号覆盖下，下行时频偏信息 由下行Cell同步获取，下行与基站下行定时对齐，需要状态标志CELL STATE
为Active。
师
表.4-1 下行状态机各状态与状态标志决策条件


D2D STATE	CELL STATE	UE STATE
D2D Mode	Active	Idle	Idle
Cell Mode	Active/Idle	Active	Active/Idle
4.3.2  上行静态状态机设计
上行状态机相对于下行状态机较为复杂，根据上行时偏值和提前量 TA 的来 源上行的同步定时方式根据优先级从低到高应有如下几个：以自身为定时，即  D2D 网络主机；以其他D2D 终端为定时基准，即D2D 从机；在下行与基站定时 的基础上，以默认TA 相对于下行定时；在下行与基站定时的基础上，与Cell UE 建立同步关系，获取Cell UE提前量TA, 从而确定上行定时。
这个优先级顺序是为了使异构网络中D2D 通信和蜂窝通信尽可能减小互相 干扰，提高同步准确性。即当存在蜂窝基站时， D2D 各终端应优先选择均以基 站为定时基准，在此基础上，当存在Cell UE时，应与其同步从而获取提前量TA。
根据以上分析，上行状态机STATE UL 应有如下子状态：
STATE UL=D2D Master Mode:D2D     自组主机状态，不和任何同步源建立 同步关系，以本机为定时， TA 获取方式为默认值，上行部分以LTE 协议要求的 标准默认提前量相对于下行进行提前发送与接收。此状态对应状态标志
CELL STATE,D2D STATE    和 UE STATE  均为 Idle。


31



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net

STATE UL=D2D Slave Mode;   D2D自组从机状态，此时只存在邻近D2D
终端同步信号， D2D 终端上行部分与邻近D2D 终端通过Sync同步建立同步关  系，并通过解析Sync带外信息获取D2D 同步源上行提前量信息。如若存在多   D2D 终端同步信号，则根据优先级选取最高优先级的邻近D2D 终端同步信号。
TA 获取方式为通过SyncInfo获取，上行部分以通过Sync 同步解析出的提  前量TA 相对于下行进行提前发送与接收。此状态对应状态标志D2D STATE 为 Active, CELL STATE 和UE STATE 为 Idle。
STATE UL=Cell Slave Mode: 基站从机状态。此时存在基站信号，没有  cellUE存在。此时D2D 终端上行和下行采用cell同步时偏值。TA 获取方式为默 认值，上行采用LTE 协议标准的提前量相对于下行提前发送和接收。此状态对 应状态标志CELL STATE 为Active,UE STATE 为 Idle,D2D STATE 为 Idle  或Active均可。
STATE UL=UE Slave Mode:  基站与Cell UE信号同时存在。此时D2D 终 端下行采用Cell同步时偏值，与基站下行定时对齐。 TA 则通过Cell UE 同步获 取。此状态对应状态标志CELL STATE 和UE STATE 均为Active,D2D STATE 为Idle或 Active均可。
表4-2 上行状态机各状态与状态标志决策条件


D2D ST
ATE	CELL ST
ATE	UE STA
TE
TA
D2D Master
Mode	Idle	Idle	Idle	默认值
D2D Slave M
ode
Active	Idle	Idle	　SyncInfo 获取
Cell Slave M
ode	Active
/Idle
Active	Idle	默认值
UE Slave Mo
de	　Active /Idle
Active
Active	UE同步获
取

4.4  动态状态机设计

异构网络中外界覆盖环境在不断实时变化，上行和下行的同步定时状态也在 不断的变化。因此通过对外界覆盖环境进行实时监测，获取 CELL STATE,

32



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

UE STATE  和 D2D STATE  三个状态标志的实时信息，根据4.2节中确定的静态 状态机的各状态条件进行决策判定，决定状态机下一状态，进行状态切换，从而
决策D2D 终端上行状态机和下行状态机是否需要动态变化[16]。
4.4.1 下行动态状态机设计
根据异构网络的覆盖情况，当CELL STATE,UE STATE     和 D2D STATE
三个状态标志发生变化时，下行状态机也根据决策进行状态变迁。由下图所示，
下行状态机的状态变迁有两种变迁条件：
a) CELL STATE:Idle->Active。  即网络中出现蜂窝基站信号，该状态变迁条件 是 D2D Mode    >Cell Mode状态变迁的变迁条件。
b) CELL STATE:Active   >Idle。即网络中丢失蜂窝基站信号，该状态变迁条件 是 Cell Mode->D2D Mode   状态变迁的变迁条件。


图4-1 下行状态机状态转移图
4.4.2  上行动态状态机设计

由于蜂窝上行用户UE 的存在，上行状态机相对于下行会较为复杂，状态的 变迁也更为多样。随着异构网络覆盖情况的实时变化，根据CELL STATE,
D2D STATE  和 UE STATE  状态标志变量实时决策上行状态机的状态变迁。由图
4-2和43所示，当状态标志CELL STATE,D2D STATE     和 UE STATE  发生变
化时，状态机的变化可以根据同步优先级的高低分为状态的升迁或者降迁，升迁 是指新的同步源 (D2D 终端，蜂窝基站或cellUE) 接入，降迁是指失去现有的 同步源。
1. 上行状态机升迁
上行状态机的升迁有多种变迁场景，图4-2展示了上行状态机各状态之间的
升迁转移情况，各状态升迁所需的变迁条件有如下四种：
a)    CELL  STATE:Idle->Active。
33


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net


北京邮电大学工学硕士学位论文
即网络中出现蜂窝基站信号，该状态变迁条件是 D2D Master Mode  > Cell Slave Mode和 D2D Slave Mode>Cell Slave Mode  两种状态变迁的变迁 条件。
b)    UE  STATE:Idle->Active。
即网络中出现 UE 上行用户信号，该状态变迁条件是 Cell Slave Mode > UE Slave Mode 状态变迁的变迁条件。
c) CELL STATE 和 UE STATE:Idle->Active。
即网络中同时出现蜂窝基站信号和 UE 上行用户信号，该状态变迁条件是
D2D Master Mode  ->UE Slave Mode和 D2D Slave Mode   ->UE Slave Mode
两种状态变迁的变迁条件。
d) 发现更高优先级的D2D 终端[17]。
该变迁条件有两种判断条件， 一是根据SyncInfo 中传输的SYNC UL ORG
信息，当发现根源同步源是具有更高优先级的D2D 终端时，被认定符合发现更 高优先级的D2D 终端。二是根据SYNC UL ORG   信息判定发现的D2D 终端根 源同步源和本机的根源同步源种类是否均是D2D 终端，若是，则再根据SyncInfo 中传输的SYNC ID ORG  信息，判断根源同步源的ID 号，如果发现根源同步源 ID 号更高的D2D 终端，则被认定发现更高优先级的 D2D 终端。第一种判断条 件，可以用于处理有蜂窝网络覆盖的场景，第二种判断条件则可以用于处理D2D  自组织网络下的场景，例如当两个处于D2D Master Mode 的 D2D 终端从不能互 相发现到能够互相发现时(该场景可能为两个D2D 终端由远及近接近),应有一 个处于D2D Master Mode 的终端抛弃本机主机模式，升迁为D2D Slave Mode,
保证网络中只有一个主机定时基准，从而实现D2D 通信。由于两个D2D 终端是 同优先级，确立任意一个为主机，另一个为从机即可，因此可以根据ID 号来确 定。该状态变迁条件是D2D Master Mode  >  D2D Slave Mode和 D2D Slave  Mode   >D2D Slave Mode两种状态变迁的变迁条件，对于后者，该变迁并不改 变本机同步模式，但会更改本机的同步源，即发现更高优先级的 D2D 终端时， 抛弃目前 D2D 同步源，而与新发现的更高优先级的D2D 终端建立同步关系，并 运行在D2D Slave Mode。
e) 发现干扰功率更高的上行蜂窝用户UE。
在通信系统中Stack高层会实时对蜂窝系统进行干扰测量并下发测量结果到 物理层。当测量结果显示有更高干扰功率的蜂窝UE 出现时，则应与其建立同步 关系，获取提前量TA, 从而减少D2D 系统和蜂窝系统之间的干扰。





34



(C)1994-2022   China   Academic   Journal   Electronic   Publishing   House.All   rights   reserved.    http://www.cnki.net

(d)





D2D  Master  Mode
_          _


(d)


D2D  Slave  Mode)






(c)


(a)
(c)


(a)






UE Slave  Mode
_       _


—


Cell Slave Mode
_       _



(e)
图4-2 上行状态机状态升迁图
2. 上行状态机降迁
上行状态机的降迁也有多种状态变迁场景，图4-3展示了上行状态机各状态
之间的降迁转移情况，各状态降迁所需的变迁条件有如下三种：
a)   D2D   STATE:Active   ->Idle。
即丢失各 D2D  终端同步信号，该状态变迁条件是 D2D   Slave Mode  ->
D2D Master Mode状态变迁的变迁条件。
b) D2D STATE:Active->Active, 但丢失现D2D 同步源。
该状态变迁条件是D2D  Slave  Mode  >  D2D  Slave  Mode状态变迁的变 迁条件，该变迁并不改变本机同步模式，但会更改本机的同步源，即根据SyncInfo 中传输的 D2D 终端ID 信息判定是否丢失现D2D 终端同步源，若丢失，则选择 其他D2D 终端作为同步源重新建立同步关系。
c)    CELL   STATE:Active   ->Idle。
即 网 络 中 丢 失 基 站 信 号 ， 该 状 态 变 迁 条 件 是 Cell Slave Mode -> D2D Master Mode和 Cell Slave Mode ->D2D Slave Mode两种状态变迁的变 迁条件。由于 UE 同步是在 CELL  同步基础上，因此当与基站失步也会导致和 UE 失步，因此该状态变迁条件也是 UE Slave Mode -> D2D Master Mode 和 UE Slave Mode ->D2D Slave Mode两种状态变迁的变迁条件。
d)    UE  STATE:Active   ->Idle。

35



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net


北京邮电大学工学硕士学位论文
即网络中丢失 UE 上行用户信号，该状态变迁条件是 UE Slave Mode  >
Cell Slave Mode状态变迁的变迁条件。
e) UE STATE:Active->Active, 但丢失现UE 同步源
该状态变迁条件是UE Slave Mode   >UE Slave. Mode状态变迁的变迁条 件，该变迁并不改变本机上行同步模式，但会更改本机上行的同步源，会选取新 的UE 作为同步源获取提前量TA。

、





D2D Master Mode
_         _



—


02D Slave Mode)






(6)


(c)
(c)


气 ·
(c)





UE Slave Mode                    (d)—                   Cell  Slave  Mode,

(e)
图4-3 上行状态机状态降迁图

4.5  本章小结

本章以第三章对由蜂窝网络和 D2D 网络组成的异构网络中各场景的分析为  基础；对该异构网络同步状态机进行了设计。状态模式是常用的行为型设计模式， 适用于复杂的行为系统，非常适合于该异构网络中的同步方案。首先设计了用于  辅助同步状态机的系统中状态标志和同步信息，为同步状态机的设计提供支持。 在此基础上，分别分析了上行和下行各状态及决策条件，从而设计了上行静态状  态机和下行静态状态机。进而分析各状态之间的迁移条件，设计了上行动态状态  机和下行动态状态机，从而完成异构网络通信系统的同步状态机的完整设计，为  下一章的实现提供了理论依据和指导。


36



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

第五章 同步状态机软件架构与实现


5.1 同步状态机软件总体架构

5.1.1    多线程技术[18]
进程是一个拥有资源的独立单元也是一个可独立调度和分配资源的基本单  元。由于这两个特性，进程可以成为一个独立运行的基本单元，从而为进程的并 发执行提供了基础，即多进程可实现并发执行。但是进程同时是一个复杂的基本 单元，系统为每一个进程必须进行创建进程、撤销进程、进程切换等一系列操作。 操作系统中进程的使用可以提高资源的利用率和系统吞吐量，但由于进程是一个 资源的拥有者，因而在创建进程、撤销进程和切换进程等操作中，操作系统必须 为这些付出较大的时空开销。也因如此，在系统中进程的数目不宜过多，进程间
的切换频率也不宜过高，这也就限制了系统的并发性。
为进一步提高系统的并发性，提升效率和性能，操作系统中引入了线程。线 程不再是资源的拥有者，其被定义为进程中的异步代码路径，线程间共享它们所
属进程的内存和资源，多线程技术具有增强响应能力、减少系统开销等优势。
为实现异构网络中 D2D 终端直通通信技术，提高其性能，将采用多核多线 程技术。而作为实现异构网络中 D2D 终端直通通信技术的基础，:同步状态机的
实现也将采用多核多线程技术.
5.1.2总体架构
同步状态机的实现将涉及三个线程[19][20]:通信接收线程，通信发送线程和
同步监测线程。
其软件总体架构如下图5-1所示，通信接收线程主要负责D2D 通信接收处理。 其中包括同步搜索模块，状态决策模块，通信处理模块，同步跟踪模块等。通信   接收线程会周期性触发同步监测线程，同步监测线程使用由接收线程传输来的通   信数据进行同步搜索，以达到实时监测覆盖环境情况，获取同步搜索结果，并在   接收主线程同步跟踪结果的基础上，进行状态决策，判定覆盖环境是否变化，是   否需要状态变迁，之后把结果发送到通信接收线程和通信发送线程，如需要变迁，  则通信接收线程和通信发送线程会根据决策结果变迁上行和下行状态机状态，维
持系统稳定可靠运行。







37


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net




图5-1 同步状态机软件总体架构


5.2     各 同 步 搜 索 与 跟 踪 模 块 接 口

5.2.1    Cell 下行同步搜索模块
Cell 同步搜索模块对应的函数为Cell Search,该函数的接口如下：
Cell  Search(int16  t*        RxData,     Cell  Sync  Res*        Cell  Search  Out)
表5-1 Sync Search函数接口


名字	I/O	数据类型	描述
RxData	I	int16 t*	接收数据
Cell Search Ou
t	O	Cell Sync
Res*	频偏值
其中Cell Search Out是一类型为Cell Sync Res 的结构体的指针，其指向存 储类型为Cell Sync Res 的数组，根据系统设计，若存在多小区，每次同步搜索
会返回小区功率最大的三个小区同步搜索结果，因此该数组大小设定为3.
Cell Sync Res 结构体定义如表5-2所示：




38



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

表5-2 Cell Sync Res结构体定义


名字	数据类型	描述
cell ID	uint8 t	小区ID
cell Foffset	uint8 t	频偏值
cell Toffset	uint8 t	时偏值
cell Power	uint8 t	小区功率
5.2.2 Cell下行同步跟踪模块
Cell同步跟踪模块对应的函数为Cell Tracking,该函数的接口如下：
Cell  Tracking(int16  t*data  Input,uint8  t                        sub  Frm,int32  t
cell  Track  Foffset,int32  t           cell  Track  Toffset)
表5-3 Sync Tracking函数接口


名字	I/O	数据类型	描述
data Input	I	int16 t*	输入数据
sub Frm	I	uint8 t	子帧号

cell Track Foffset	O	int32 t	频偏

cell Track Toffset	O	int32 t	时偏
5.2.3  Sync 同步搜索模块
Sync 同步搜索模块对应的函数为Sync Search,该函数的接口如下：
Sync  Search(int16  t*RxData,             int16  t*sync  Foffset,int16  t*sync  Toffset,
SyncInfo      sync  Info)
表5-4 Sync Search函数接口


名字	I/O	数据类型	描述
RxData	I	int16 t*	接收数据
sync Foffset	O	int16 t	频偏值
sync Toffset	O	int16 t	时偏值
sync Info	O	Struct	带外同步信息
其中sync Info是一类型为Synclnfo 的结构体，用于在带外传输Sync 同步
的同步信息。该结构体根据4.2.2节的设计，其定义如表5-4所示：


39


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net


北京邮电大学工学硕士学位论文
表5-5 SyncInfo结构体定义


名字	数据类型	描述
rX ID	uint8 t	对方ID
rx SYNC ID	uint8 t	对方Sync直接同步源
ID

SYNC ID ORG	uint8 t	对方Sync根源同步源
ID

SYNC UL ORG	uint8 t	对方根源同步源种类
rx TA	int32 t	对方提前量TA
5.2.4  Sync 同步跟踪模块
Sync同步跟踪模块对应的函数为Sync Tracking,该函数的接口如下：
Sync  Tracking(int16  t*data  Input,uint8  t       sub  Frm,int32  t
sync  Track Foffset,int32 t sync  Track  Toffset)
表5-6 Sync Tracking函数接口


名字	I/O	数据类型	描述
data Input	I	int16 t*	输入数据
sub Frm	I	uint8 t	子帧号

sync Track Foffset	O	int32 t	频偏


sync Track Toffset
O	int32 t	时偏
5.2.5    UE 蜂窝用户上行同步搜索模块
表5-7 PUSCH Sync Search函数接口


名字	I/O	数据类型	描述
RxData	I	int16 t*	接收数据
pusch Toffset	O	int32 t	时偏
pusch Foffset	O	int32 t	频偏
Sync 同步跟踪模块对应的函数为Sync Tracking,该函数的接口如下：



40



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

PUSCH  Sync  Search(int¹6 t* RxData,    int32 t pusch Toffset,int32 t
pusch  Foffset)
对于 UE 同步搜索，其还需在Cell 同步的基础上，从Stack层获取控制信息。 该控制信息为PUSCH  Sync  Ctrl 结构体，该结构体的定义如下表所示：
表5-8 PUSCH Sync Ctrl结构体定义


名字	数据类型	描述
radio Frame	int16 t	系统帧号
sub Frame	int8 t	子帧号
num UE	uint8 t	UE数量
RB Start[5]	uint8 t	RB起始位置
RB Len[5]	uint8 t	RB长度
UE Power[5]	int8 t	干扰功率
UE ID[5	uint16 t	RNTI ID号
其中RB Start等数组的长度设定为5是由本系统高层方案所设计，根据千
扰功率，最多只使用5个干扰最大的UE 来进行干扰避免等处理。

5.3  通信接收线程

通信接收线程是D2D 直通通信系统中的核心线程之一，其负责通信同步的 建立，通信接收数据的处理，同步的跟踪等。通信接收数据处理模块包括解资源 映射，解扰，解码等子模块，在本文中，主要讨论与同步状态机相关的模块，因 此对通信接收数据处理模块不进行详细分析。通信接收线程中，同步搜索模块， 同步决策模块，同步跟踪模块是与同步状态机重要模块，这三个模块共同完成了 静态同步状态机的建立与维持。
5.3.1 通信接收线程同步搜索模块
通信接收线程中的同步搜索模块用于D2D 终端开机时，建立同步关系[21]。 由于UE 同步搜索时建立在 Cell 下行同步的基础上，在开机时必然还没有建立 Cell同步，因此在通信接收线程中的同步搜索模块中并不进行UE 同步搜索，其 架构如图5-2所示，同步搜索模块中的流程是串行模式，首先从USRP 层获取接 收的无线帧数据，之后先进行Cell下行同步搜索，即调用Cell Search函数，若 搜索成功，将状态标志CELL STATE  置为 Active, 并将同步搜索得到的结果存 入存储Cell同步结果的Buffer中。之后进行Sync 同步搜索，即调用Sync Search 函数，若搜索成功，将状态标志D2D STATE 置为Active,并将结果存入存储Sync

41


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net



图5-2 通信接收线程中同步搜索模块架构

由于所设计的异构网络，最多存在8个D2D 终端，每个终端在不同无线真 依次发送Sync 同步信号，因此，至少需要连续做8次Sync 同步搜索才能确定搜 索到相应D2D 终端。而Cell下行同步搜索，采取迭代方式，也需要多次搜索才 能给出准确结果，因此本方案设计为循环进行24次同步搜索，将每次结果存入
相应Buffer中，在同步决策模块中进行决策。
5.3.2  通信接收线程同步决策模块
经过同步搜索模块后， Cell 同步和 Sync 同步搜索的结果已经存储在对应 Buffer中，同步决策模块获取相应的搜索结果信息，根据状态机的状态条件，进
行联合决策，并根据决策结果建立同步关系。
同步决策模块总体逻辑和流程如图5-3所示，同步决策模块由两部分组成， 一  是状态决策，根据状态标志和第四章分析的状态条件，完成上行状态和下行状态  的判定；二是同步建立，在状态机状态已确定的基础上，对存储于Buffer中的同  步搜索结果数据，采用相应选择算法，完成同步建立。首先判定状态标志  CELL STATE, 若为Active, 则网络中存在基站，将上行和下行置为相应状态，并  通过下行同步结果选择算法选择可靠的搜索结果完成同步建立。若为Idle, 则继  续判定状态标志D2D STATE,   若为Active, 则可同步发现其他D2D 终端，根据  上行Sync 步结果选择算法选择优先级最高的D2D 终端和搜索结果完成同步建立。
若依然为 Idle, 则确立本机为D2D 网络主机，以自身定时为基准建立同步。






42



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net


状态决策






图5-3 通信接收线程中同步决策模块架构

由5.3.1小节已知存储同步结果的Buffer有两个， 一个用于存储Cell下行同 步搜索的结果，另一个用于存储 Sync 同步搜索的结果。用于存储同步结果的
Buffer的结构如下：
1) Cell同步搜索结果Buffer
根据5.2.1小节所介绍，小区同步搜索函数 Cell Search 函数的输出是一个存 储类型为Cell Sync Res大小为3的数组。由于同步搜索模块会循环24次，因
此设计一个二维数组Sync Res Buffer[24][3]用于存储Cell同步搜索的结果。
2) Sync 同步搜索结果Buffer
由5.2.3节所介绍的Sycn Search同步函数的接口，本方案设计Sync Res 结  构体作为存储Sync 同步搜索结果的数据类型，由于同步搜索模块会循环24次， 因此使用以该结构体为存储类型，大小为24的数组Sync Res Buffer[24]作为
Sync同步搜索结果Buffer。





43


(C)1994-2022  China  Academic  Journal  Electronic  Publishing  House.Allrights  reserved.  http://www.cnkinet

表5-10 Sync Res结构体定义


名字	数据类型	描述
sync Foffset	int16 t	频偏值
sync Toffset	int16 t	时偏值
syne Info	Struct	带外同步信息
当同步搜索模块循环24次后，将对同步状态进行决策，而此时各同步Buffer
会存有24次搜索结果的缓存数据，需要适当算法选择相应结果。
3) Cell同步搜索结果选择算法
Sync 同步搜索结果算法的过程如图5-5所示：


图5-4 Cell同步搜索结果选择算法过程示意

首先根据Buffer中数据，进行功率的判定比较，对每次搜索返回的三个结果 选择功率最大的结果。其次根据小区ID,统计24次搜索结果中，同一小区出现的 次数，即频率，选择出现次数最多的小区作为同步源。最后根据所确定的同步源 小区 ID 对每次结果进行取均值操作作为最后系统用于建立同步关系的时偏和频
偏值。
4) Sync 同步搜索结果算法
Sync 同步搜索结果算法的过程如图5-5所示，首先根据 Buffer 中 SyncInfo 数据的ID 信息，统计每个D2D 终端成功被发现的次数，由于循环24次，相当 于每个D2D 终端最多可以被发现3次，因此如果某D2D 终端被成功发现两次以
上，则认为是稳定存在的备选同步源。当存在多个稳定备选D2D 终端同步源时，

44



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

则根据第四章所确定的同步优先级选择根同步源优先级为相对最高的 D2D 终端 作为本机直接同步源，并根据其 ID 选择 Buffer 中存储的与该同步源进行 Sync 同步所获取的时偏和频偏值，并分别做取均值处理作为最后系统用于建立同步关 系的时偏和频偏值。
经过同步决策模块后， D2D 终端已完成开机同步搜索和建立，在此基础上， 通过发送和接收链路处理模块则可完成基本的D2D 直通通信。


图5 - 5 .Sync 同步搜索结果选择算法过程示意

5.3.3 同步跟踪模块
D2D 终端开机阶段会调用同步搜索和同步决策模块，建立同步关系。建立 同步关系之后，在通信过程中，要实时跟踪同步源，维持与同步源同步的准确性 和稳定性。
同步跟踪模块的架构如图5-6所示，跟踪模块首先根据子帧号，判定子帧类 别。如若该帧是特殊子帧，即传输Sync同步信号的子帧，则判定上行所处状态，  上行状态若是D2D Slave Mode,则调用Sync 同步跟踪函数，获取同步跟踪结果 用于调整时偏和频偏，从而维持定时准确和频率对齐准确。如若该帧是下行子帧， 即包含下行同步信号的子帧，则判定下行所处状态，下行状态若是 Cell Slave Mode,则调用Cell同步跟踪函数，获取同步跟踪结果用于调整时偏和 频偏，从而维持定时准确和频率对齐准确。


45



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net


北京邮电大学工学硕士学位论文


图5-6 Syn同步跟踪模块流程

跟踪的目的是维持同步的准确性和稳定性，所以无论是Sync 同步跟踪还是 Cell同步跟踪，所得同步跟踪结果(时偏和频偏)在没有足够高可靠性的保证下 不应直接作用于系统同步状态。经过开机的同步建立后，同步跟踪属于细同步， 同步跟踪结果无论是时偏还是频偏均应稳定在一定范围内，对于超出该范围内的 时偏和频偏，即认为是不可靠的，将其舍弃。根据经验值，本方案设置时偏范围 为-10到10为可靠范围，即samples偏移范围在10个以内；频偏范围为-1000到 1000为可靠范围，即频率偏移范围在1000以内。在本系统中，将采用可靠性范 围内取均值方法来保证作用于时间调整和频率调整的时偏和频偏值的正确性和
可靠性。该方法的具体流程如图5-7所示：
1)判定同步跟踪结果可靠性。
若时偏和频偏结果均在可靠性范围内，则将本次同步跟踪结果存入缓存 Buffer中，否则时偏和频偏只要有一个不在可靠性范围内，则抛弃本次同步跟踪
结果。
2)同步跟踪结果缓存。
按序依次将可靠的同步跟踪结果存入 Buffer 中，本方案设置 Buffer 大小为 10,当Buffer 已满，从Buffer首地址重新存储，相当于更新Buffer。 图所示的
情况为已第二次轮询到Buffer位置6,此时将结果16替换结果6,更新缓存Buffer。
3)取均值计算时偏和频偏。
在 Buffer中存有多次同步跟踪结果，当本次同步跟踪结束后，即使本次跟踪
结果被认为是可靠的，也不直接使用本次同步跟踪结果用于调整时偏和频偏，而

46



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net

是通过 Buffer中的缓存结果联合计算，每次分别计算整个缓存 Buffer中时偏和
频偏数据的平均值作为最后的输出，用于调整系统同步状态，维持系统同步的准

图5-7 同步跟踪结果处理流程

5.4 通信发送线程

通信发送线程负责 D2D 终端直通通信发送数据的处理等，同步的搜索和跟 踪等并不在该线程中调用，因此发送线程中只有 Synclnfo 发送是与同步状态机
相关联的。
对于5.3节中设计的SyncInfo结构体，并不能直接用于传输。系统中数据的 传输是以8位数据传输，由于带外资源非常紧缺，因此将 Synclnfo 中的信息通
过高四位和低四位拼接的方法进行打包传输。
将 Synclnfo 中的信息A 和信息B 可以按下式合并成一个SyncMessage 变 量
用于传输：

SyncMessage   =A>>4|B(5- 1)
合并后， A 占高四位， B 占第四位。通过该方案的处理，用于发送的SyncInfo
存储情况如下图5-8所示。



47


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net


Sync   Message
图5-8 同步发送线程中 SyncInfo的存储


5.5 同步监测线程

在通信接收线程和通信发送线程中，完成了系统同步状态机的静态状态机部 分，当覆盖环境稳定无变化时，混合异构网络的通信系统可以稳定运行。但是当 覆盖环境出现变化时，则不能满足通信需求，因此，引入同步监测线程来实现同
步状态间的变迁，即同步状态机中的动态状态机部分。
由图5-1所示，同步监测线程主要由同步搜索模块和同步决策模块构成，在 5.3节中介绍了通信接收线程中的同步搜索模块和同步决策模块，其之间有一定
相似性，但不完全相同。
5.5.1 同步监测线程同步搜索模块
同步监测线程中的同步搜索模块相对于通信接收线程中的同步搜索模块，加
入了UE 上行同步搜索。同步监测线程中的同步搜索模块的架构如下图：
















48



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved. http://www.cnki.net



图5-9 同步监测线程中同步搜索模块架构

其原理与之前介绍的通信接收线程中的同步搜索模块相同，只是新增一个上
行UE 同步搜索和相应的同步结果Buffer, 在此不再赘述。
5.5.2  同步监测线程同步决策模块
同步监测线程中的同步决策模块相对于通信接收线程中的同步决策模块，在 根据同步搜索得到到的状态标志进行状态决策后，需要加入状态变迁操作122]。 同步监测线程中的同步决策模块的架构如图5- 10所示，该同步决策模块由两部 分组成， 一是状态决策，根据实时状态标志和第四章分析的状态条件，完成上行 状态和下行状态的判定，与通信接收线程中同步决策模块不同的是，首先需要判 定状态标志UE STATE,   这是由于在通信接收线程中已完成同步的建立，因此如 果已与基站建立同步关系，则在同步监测线程中可以完成 UE  同步搜索。若为 Active, 则 STATE UL   为 UE Slave Mode,   若 为Idle, 则之后的判定流程与通信 接收线程中状态决策模块相同。二是状态变迁，在已得到实时状态的基础上，实 时状态已确定的基础上，与当前系统运行状态比较，如若二者相同，则维持当前 系统状态，否则根据状态条件进行状态变迁，并根据状态选择相应Buffer 中 的 同
步搜索结果重新建立同步关系。




49


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net



图5-10 同步监测线程中同步决策模块架构

5.3.2中介绍了用于存储 Cell同步搜索结果和 Sync 同步搜索结果的 Buffer 结构，以及对应的结果选择算法流程。由于UE 同步搜索的引入，同步监测线程 中还需新增一个用于存储UE 同步搜索结果的Buffer, 以及与之对应的同步结果
选择算法。
由5.2.3节所介绍的PUSCH Sync Search 同步函数的接口，本方案设计
PUSCH Sync Res 结构体作为存储蜂窝UE 同步搜索结果的数据类型，由于同步
搜索模块会循环24次，因此使用以该结构体为存储类型，大小为24的数组
Sync Res Buffer[24]作为Sync 同步搜索结果Buffer。
表5-11 PUSCH Sync Res结构体定义


名字	数据类型	描述
sync Foffset	int16 t	频偏值
sync Toffset	int16 t	时偏值
UE Power	int8 t	UE干扰功率
UE ID	int16 t	ID号
与 Cell 同步结果选择算法和 Sync 同步结果选择算法不同的是，在得到由


50



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.    http://www.cnki.net


Stack 层下发的 PUSCH Sync Ctrl  控制信息后，需要首先进行同步选择。即当 PUSCH Sync Ctrl 包含多个UE 信息时，为了提高系统效率，并不对每个UE 都 进行同步，而是根据干扰功率选择干扰功率最大的UE 进行蜂窝UE 同步，并将 结果封装成PUSCH Sync Res   格式存入相应Buffer。 当24次搜索进行完毕后， 再根据 Buffer 中缓存的同步数据，根据出现次数即频率，选择出现频率最高的 UE 作为上行UE 同步源，这样，就选择出了干扰功率最大而出现频率又最高的 UE 用户作为上行 UE 同步源，与其建立同步获取 TA 信息。该方法的过程如下
图所示：
控制信息

功率判定



UE Buffer数据


∵
均值处理



时频偏结果输出

图5-11 UE 同步搜索结果选择算法过程示意

同步监测线程的引入实现了状态机的状态变迁，完成了动态状态机的工作，
至此，整个异构网络中的同步状态机功能已全部完整实现。

5.6  业务展示

在系统同步状态机功能完成后，辅以应用层，可以在不同覆盖情况下使用  D2D 终端来进行实际业务传输。本节将通过《LTE 系统下设备直通技术的研究》 课题的演示系统，简单展示常见的视频传输业务与文件拷贝业务，进而验证同步
方案的正确性。
演示系统的主界面如图5-12所示，图中左半部分界面是该通信场景中一些 参数，如目前所用频点为2.36Mhz, 所观察的对象为D2D3 号机。主界面的右半
部分则是目前通信场景拓扑结构，可以看出目前通信模式为基站覆盖下并由蜂窝


51


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved. http://www.cnki.net

上行用户覆盖的D2D 通信，该种场景将涉及三种同步技术，可以很好的验证同
步方案。



D2D 通富决示于色
说置费题说备
活跃D2D设备：
D2D3
可拉测轻离设备
取 消 理 测
系统旁歌说置
半控制
当前使用频点：2.36e+09
幽前视式：基站横式



检游洁果：

策略切换
当前策略：Advanced-RRM




谨置        君吐操失率


课言：中文英文
展示运
anpkae  dwnlnk  yic  al  ym  ddom

D2D¹





CellID:332



CeuelD:6219


图5-12 演示系统主界面
演示系统的同步方案结果展示界面如图5-13、5-14、5-15所示，可以设置观 察何种同步的结果，设置观察频率，观察对象等。在5-12所示的场景中，对D2D3  进行观察，图5-13、5-14、5-15分别展示了Cell同步、 Sync 同步和Cell UE 同
步的结果。

上行同步下行周步D2D 同步



三







Higc            com
图5-13下行Cell同步结果展示



52



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net


由图5- 13所示， Cell 同步的时偏结果在经过粗同步后，稳定于50 Sample。
而频偏结果也稳定于-600 hz 附近，证明在该场景中， Cell 同步正常。
上行同步下行同步D2D 同步

图5-14 Sync同步结果展示
由图5- 14所示，Sync 同步的时偏结果在经过粗同步后，也稳定于50Sample。
这是因为在该种场景中，各D2D 终端下行已经与基站对齐，因此Sync 同步结果 自然也应稳定。 Sync 同步的频偏结果也稳定于-700 hz 附近，证明在该场景中，
Sync 同步也正常。


图5-15 Cell UE同步结果展示
由图5- 15所示， Cell UE 同步的时偏结果稳定于-675 Sample, 即检测出蜂窝 用户的提前量TA 值为675,该TA 值可以使得D2D 终端上行与Cell UE上行对
齐，进而避免互相干扰。




53


(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

xangyinxingltshost  rhamelrensyindmgpp.te  t
文件(F) 编 胺(E) 责看[V| 假察(5)   3 7 登 9 ]




8220t


应 用 程 序 置 织
rtp://332.168.40.0:5004
Audio   Ydeo   Teols   view   Help


ehest2swangi
medla       player



Media         lnformation
Smerai  ptro  thentna  Sadke  benls  9
Current  media /stream statistics



Dexoded Payed
Lost
Decoded  D:sgtayed Lost
Media  data  size Input  bitrate
Demuxed   data   size
Daiscarded      tarapted)    Dmapped ldiscontinued)
-        Output/wrtten.Sent
Sert


04 bumen
19208              hta
31945     tamd
14   frain85


145054   KiB

。
0    packet
0   xin
0  kbhs





图5-16 VLC 视频直播效果
图5- 16展示了在5- 12所示的场景中，两个D2D 终端通过VLC 视频播放器 进行的视频直播传输业务效果。从图中可以看到，视频画面清晰稳定，可以很好
的实现高清视频直播。


图5-17文件拷贝效果图
图5- 17则展示了在5- 12所示的场景中，两个 D2D 终端通过SCP 命令进行 终端间文件传输业务效果，从图中可以看出使用本同步方案的D2D 通信系统可
以达到1.4MB/s 的传输速度。
在实际业务中视频与文件拷贝具有很强的代表性。视频直播要求传输时延有  所保障，否则会造成观影效果不流畅，丢帧卡帧等影响。而文件传输对时延要求  相对低，更看重吞吐率。通过两种业务在不同覆盖条件下的测试，我们有理由相  信当前的D2D 通信无论在D2D 自组织网络中还是与蜂窝基站共存的异构网络中，
均能稳定高效运行，所设计的同步方案，即同步状态机具有良好的实践效果。

54



(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net

5.7 本章小结

本章具体实现了第四章所设计的异构网络同步状态机。 LTE 系统下 D2D 通 信应采用多线程技术，其中和同步状态机相关的三个线程为通信接收线程，通信 发送线程和同步监测线程。本章首先介绍了已实现的各同步技术模块的接口，在 此基础上对与同步状态机相关的三个线程分别进行了状态机相应部分的实现。通 信接收线程和通信发送线程完成了同步状态机中静态状态机的功能，其中通信接 收线程包括同步搜索模块，同步决策模块，同步跟踪模块。前两者完成了 D2D  终端的同步建立功能，同步跟踪模块则实现了对现有同步的维持。通信发送模块 则完成了Sync 同步信息 Synclnfo 的拼装和发送。在已建立同步关系的基础上， 同步监测线程通过同步搜索模块和同步决策模块，根据状态机的状态转移条件， 实现了动态状态机的相应功能，从而完成了混合蜂窝与 D2D 异构网络中完整同 步状态机的实现。最后，通过业务展示，验证了所设计的混合蜂窝与D2D 异构 网络同步方案，即同步状态机的正确性与稳定性。


































55



(C)1994-2022   China   Academic   Journal   Electronic   Publishing   House.All   rights   reserved.    http://www.cnki.net


























































56



(C)1994-2022  China  Academic  Journal  Electronic  Publishing  House.All  rights  reserved.    http://www.cnki.net
