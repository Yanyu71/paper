第一章绪论
1.1	论文研究背景及意义
自GPS被开发并应用至今，基于位置的无线定位的研究成果一直都在不停发 展壮大。但GPS定位终端需要在相对空旷的地方才能实现精准的定位，如果定位 终端位于复杂的室内环境会使信号由于多径、衍射的影响，加快信号衰减的速度, 降低定位的精度，增加定位误差，甚至无法扫描到有效信号。因此，就目前的定 位需求来说，要求研究者通过改进技术和算法，开发出符合室内环境定位精度要 求的定位系统。现在的情况是已有很多专家学者正在研究和开拓有价值的室内环 境下的定位系统,这些系统弥补了 GPS定位在室内复杂环境下无法正常发挥作用 的问题，给定位系统的改进和完善带来巨大的帮助，甚至在日常的工作和学习生 活中也发挥着巨大作用。
随着移动互联网的普及，尤其是智能手机和平板电脑的在市场的热卖，促进 了 Wi-Fi热点的普及，这使得许多依赖无线局域网Wi-Fi的研究和应用得到极大 的发展前景，比如室内导航、位置共享服务、商品推荐、人流密集度管控、消息 推送、信息采集和验证等等。目前，更多的人体会到了 Wi-Fi技术给生活提供的 方便，这便给基于Wi-Fi的应用开发和技术革新带来了强有力的支持。如果说 GPS卫星定位系统是一次科技的进化，那么基于Wi-Fi的室内定位系统的普及标 志着万物互联时代的开启。
互联网时代的开启带动了电子市场的蓬勃发展，市场的需求则进一步刺激技 术的发展和革新，这种市场上良性循环的系统在室内定位技术的研究与应用中同 样适用。基于位置服务的需求将带动互联网定位技术不断更新，各种算法、产品 在需求的催化下不断优化，为无线定位应用能够正式在互联网市场占有一席之地 而发光发热。未来，定位技术可以与物联网相结合，在大型公共场所的人群疏散、 线路导航，物流管理，交通拥堵预警等方面开发应用，既可以加强社会生产力， 提高效率，又可以便民囚。相信不久以后，将有越来越多的企业和个人通过使用 Wi-Fi定位产品，在生活中获得更加便捷、有趣、智能的体验，切身感受定位技 术带来的积极影响。
1.	2国内外的研究现状
1
1.2	. 1云计算的研究现状
最先提出比较可行的云计算理论体系的国家是美国，而国内在云计算方向的 起步则较晚。一些比较成熟的云计算平台都有自己独特的理论根据和复杂架构， 诸如 EC2、AWS、Google Apps Engine、Yahoo Application PlatformBlue Cloud> Windows AzureSales Force、iCloud^ vCloud、Hadoop 等⑵。数据挖掘的效率和 准确性是衡量这些云计算平台竞争力的关键，也是带动云计算技术发展的重要因 素之一。各家云计算公司为了发展自己的数据中心采用了各式各样的手段提供数 据挖掘服务，包括组织开放式数据中心，开发智能数据挖掘工具等等。其中，以 Hadoop平台为基础的数据挖掘服务利用其分布式集群，在数据挖掘方面能够实 现对大规模日志文件的并行分析和搜索，在数据挖掘工具的开发上有着明显的优 势。许多国内外的公司也都以Hadoop平台为蓝本组建自己的云计算平台，目标 在于给企业提供更好的数据挖掘智能化工具。
在国内，云计算技术刚刚起步，相关的理论体系还没有真正建立起来，这种 情况给互联网发展带来了一定的阻力。2011年，政府为了促进国内的云计算体 系发展，加快云计算平台的建设，倡导各大中型企业投入人力物力加快云计算平 台的发展和普及。虽然有为数不少的国有、私有公司开展云计算方面的相关业务 并且初见成效,甚至有实力的企业已经推出自己的云计算产品，但是与国外相比, 云计算服务的发展尚处在萌芽阶段。毫无疑问的是，云计算技术正在蓬勃发展， 因为它们具有传统运算系统无可比拟的数据挖掘效率和能力。这种出色的大数据 挖掘能力和海量数据处理的解决方案可以帮助大中型企业实现业务的高效运转， 其商业价值不可估计。百度、阿里、腾讯等互联网巨头也在积极建设云平台，实 现海量数据的分布式存储及数据产品应用，通过数据挖掘和深度学习等前沿技术 开发新的数据挖掘工具，其优点着重体现在电商推荐、企业级数据管理、潜在价 值开发、潜在危险预警等相关项目。在北京、上海、天津和重庆等较为发达的地 区，已经架设有数个数据中心作为试点进行着大数据挖掘的研究。
1. 2. 2无线定位技术研究现状
目前，室内定位系统被广泛地应用于地理信息系统网、机器人自动行走定位 区及作为其他复杂定位系统的组成部分⑶。由于大多数无线定位技术会依赖成本 高昂的硬件来保证定位精度的可靠性，而Wi-Fi定位系统则利用现成的无线覆盖 网络规避了成本和能耗方面的缺陷。根据有关数据统计，截止到2014年中国移 动通信用户约13亿，其中有8亿用户已经接入了移动互联网⑹。更由于智能手 机的普及，Wi-Fi热点的普及受到各方面的重视，政府以及企业通过设置Wi-Fi
2
节点使信号全城覆盖，在超市、博物馆、办公室等公共场所都能扫描到可用的 Wi-Fi热点。借助现成的网络覆盖面积和大量使用人群，Wi-Fi定位服务享有受 众面广和迅速普及的巨大优势。目前，Wi-Fi无线定位技术主要分为几何法、近 似法和场景分析法三大类，其中几何法又分为基于信号接收强度(RSSI)和基于 其他信号特征两种，代表性的技术是TOA|TDOA| AOA?,但这些算法都要使 用额外的硬件设备才能完成系统架设，无法满足市场上对定位服务的基本要求。
基于Wi-Fi的定位系统根据是否需要将RSSI映射成距离分为匹配算法和测 距算法两种。其中，根据位置指纹定位是匹配算法的一种，此方法在应用中需要 在训练阶段耗费较多的资源构建位置数据库，时间复杂度和空间复杂度都比较 高，工作量以及成本十分巨大。而且，定位环境一旦发生变化会导致位置指纹数 据库失效，需要重新进行离线训练，直到数据库完全更新才可以重新实现定位功 能，所以说匹配方法应用局限性较大。
基于测距的定位方法本质都是对距离方程进行求解。在方程求解的研究中， 前人在无噪声干扰的理想环境下证实：理想条件下的信号衰减模型近似呈三次方 程冈。利用此函数使用几何法定位，误差达到3米左右。但他的实验对环境的要 求过于严苛，许多参数和结论不经过大量的实验是无法确定的，因此适用性较弱， 不能直接应用于实际。一部分研究者通过统计学的角度分析每个AP节点间的距 离与RSSI的相关性，进而利用这种潜在关系预测目标的位置⑶。在这个理论中 利用SVM算法在分类回归上的优势，可以实现较好的预测结果，但他的实验只 是在预先设定好的应用场景，并且设置的几个参考AP节点下进行的，当场景或 者参考节点发生变化则定位算法也会失效，因此也不具有很强的实用性。还有一 些国外的研究者认为，通过部署密集的短距离信号发生和接收装置，可以对终端 进行全方面的位置模拟，从而实现定位【回。这种方法虽然没有训练过程，效率 很高，但该方法只能在较小的实验空间下使用，一旦超出实验区域就无法进行定 位，有很大的局限性且需要部署很多的嗅探设备，推广起来十分困难。
大量的实验证明，实验中AP节点的分布情况和部署密度是影响定位精度的 主要因素口1】。本文提出的定位方法解决了上述难题，在实际应用中只需保证定位 区域不存在信号盲区，并且周边部署的参考节点不至于过少就可以实现约3米的 定位精度。与大多数室内定位方法不同，该方法对部署密度要求不高，对AP节 点的位置依赖度低，能耗较低，拓展性较好。经过系统的测试表明，该算法预测 的位置绝大部分的误差在三米内，平均误差不到两米，能够满足大部分公共区域 对精度的要求。
3
1.3研究的主要内容
本文对Wi-Fi定位算法的关键技术进行了详细地分析和说明，结合Hadoop 云平台的关键技术，深入研究了 Hadoop平台下利用MapReduce设计模式对Wi-Fi 定位系统的实现和优化改进。这主要包括：
⑴对传统Wi-Fi定位算法的原理、方法及流程进行了研究，重点介绍了基 于信号强度的测距算法的相关原理和定位模型，并对算法的性能进行客观评估。
(2)重点介绍了改进的Wi-Fi定位算法的相关原理和定位模型。结合Wi-Fi 数据的特点和MapReduce并行化处理优势，引入局部线性回归和位置加权的概 念，提出基于MapReduce的改进Wi-Fi测距定位算法，并对算法本身进行了测 试，证明了测试结果符合预期的要求。
(3)简单阐述了基于Hadoop云计算的原理和基本应用，对Hadoop在应用过 程中需要注意的环节进行了标注和说明。着重介绍了 MapReduce编程思想和使 用场景，结合定位系统的实际应用对实验中使用MapReduce进行编程的部分进 行了详细描述。
(4)搭建基于Hadoop平台的Wi-Fi室内定位系统，完成从系统设计到最终测 试的全过程，对实验环境进行描述，搭建测试服务器，开发测试APP,从测试数 据分析系统的效率和可靠性。最后，展示实验成果，总结实验中出现的问题和不 足，探索更加科学、更加优化的研究方案。
1.4论文的结构安排
论文的结构大致分为两大部分，共六章。第一部分主要阐述文章的理论研究 及公式推导，第二部分主要说明定位系统设计的全过程，给出系统的设计流程和 部分功能模块的伪代码，最终列出实验数据和测试结果。各章节的具体安排如下：
第一章是绪论，主要阐述室内定位系统的研究背景，结合研究过程中的重点 和难点，对文章研究内容的意义进行说明。
第二章是综述，主要列举了常见的室内定位手段，并分别说明了各种算法存 在的问题，由此引出文章研究的课题，着重对该研究如何解决上述问题的原理进 行描述和简单证明。
第三章是定位算法的说明和验证，简单介绍了 Wi-Fi信号强度的影响因素， 重点对位置指纹匹配法和经典三角定位法进行说明，总结上述算法的不足和优势 加以改进，提出了局部线性回归和位置加权的理论和实现流程。
第四章是定位系统的设计和实现部分，主要是根据系统的定位模块来介绍系 统各个功能模块是如何设计和实现的。
4
第五章是实验，首先对实验环境进行详细的描述，接着说明搭建实验平台全 过程，然后结合系统和测试数据集对各功能模块以及系统的整体性能展开测试。 最终，用实验数据说明系统的性能已达到预期要求。
第六章是结论，总结研究成果，对系统的优势进行详细说明，着重对系统存 在的问题和解决方案进行介绍，提出优化后的实验过程。
5
第二章无线定位技术概述
2.1无线定位基本概念
为了保证后面几章说明能够相对简便，首先要在这一节定义几个无线定位的 几个概念。文中称不明确位置的Wi-Fi为未知的AP节点，称位置已经明确知道 的Wi-Fi为已知的AP节点，称实验测试过程中采集数据的位置为采集节点，称 需要预测的位置为待测节点。定位的基本步骤是通过在大量的采集节点采集训练 用数据集，利用公式推导RSSI与距离的映射公式，并对距离、预测范围等进行 模拟预测，在精度达标后将算法应用于测试系统，然后再通过研究的改进算法来 预测待测节点的位置，反复调参得到最优解。
2. 2无线定位性能评价指标
由于无线定位系统的差异性，为了评价每种定位系统的优劣，需要有一些相 同的定位评价指标，为此总结了几种常用的评价指标如下口幻：
(1)位置的预测精度。预测精度是评价一个定位系统好坏的主要评价标准， 一般由定位系统运行时的误差来量化。误差的量化方式有多种，比如均方误差、 绝对误差、相对误差等，实验中默认使用式(2-1)作为定位系统性能的评价指标。
小=2)2	(2-1)
(2)准确性。定位的准确性要求是定位精度要求的延伸，目的是在给出定位 绝对误差的同时还要给出一个预测区域，该区域表示预测的结果即使有偏差，也 不会超出这个范围。范围越小且越精确则系统的准确性越好。
(3)通信距离。通信距离表示定位的覆盖范围，是衡量定位系统实用性的重 要指标。一般地，在保障准确度和精度符合要求的基础上，定位系统的覆盖范围 越大越好，它表示待测节点能够实施定位的通信范围或信号的传播距离。
(4)成本。定位系统的成本主要包括硬件的购买成本和软件的开发成本，是 衡量定位系统商业价值的重要指标之一。软件的开发成本主要在于定位算法复杂 度、定位执行时间等方面。衡量一个定位系统的好坏，很大程度上取决于该系统 能否在较短的时间内显示较为精准的定位结果。
2. 3常见的无线网络定位系统
(1)按照定位算法执行的平台不同可以将系统分为两种，一种是运算过程全
6
部在手机客户端上运行的无线定位系统，一种是运算过程在服务器上运行的无线 定位系统。下面对两种方案进行简单描述。
①客户端的无线定位系统。手机接收来自多个参考节点的信号强度等有效信 息，按照特殊关键字在服务器的数据库查找相应的有用信息，比如参考节点的坐 标、A值、距离映射函数等，然后在手机客户端进行数据的整合并预测计算结果。 最主要的运算过程全部由客户端执行，是最常见的定位系统运行模式，其最典型 的应用是在GPS定位系统。
②服务端的无线定位系统。客户端接收来自参考节点的Wi-Fi信息并将信息 上传至服务器集群，充分利用集群的运算能力迅速得到定位结果并反馈到手机客 户端，最终由客户端进行结果的呈现，实现定位。由于这种定位系统相对较为迅 速，并且给手机带来的负担较小，所以基于Wi-Fi的室内定位系统都采用基于服 务器端的定位技术。其原理如图2-1所示。
a 2-1基于服务端的无线定位系统
(2)根据实现系统的硬件不同可以将定位系统分为几种，包括GPS卫星定位、 ZigBee定位、Wi-Fi定位、RFID定位、基站定位等。每种定位系统都有自身的 优势和缺陷，在研究中对上述技术作了简单的介绍和总结，方便在对比中找到最 优的定位方案。
①GPS定位系统。GPS定位主要原理是使用TDOA算法进行测距定位，它 利用高精度的同步时钟，解决了 TDOA因时钟不同步而引发的精度不高的问题。 GPS接收器通过时间差来计算终端与卫星之间的距离,再依靠三边定位法来预测
7
目标位置，最后转化为经纬度并在地图上显示目标的位置。
②ZigBee定位系统。ZigBee是一种以IEEE 802.15.4为标准的WSN协议， 基于此协议的位置传感器进行组网后，各传感器之间便可以互相通信。利用这种 方式组建的定位网络，不仅功耗低、成本低，而且具有较好的鲁棒性和较高的定 位精度，唯一的缺点是这种组网定位的方式仅限于小范围内的定位，不适用于大 型空间或复杂环境的定位。这种定位系统被广泛应用在餐厅、矿山、隧道、深井 等相对狭窄且封闭的环境内，如图2-2所示。
图2-2 Zigbee智能餐厅定位系统
③Wi-Fi定位系统。Wi-Fi网络中的参考节点通过不断发送无线电信号使无 线网络覆盖整个实验区域，系统根据不同区域内不同位置的信号特征来实现位置 的预测。Wi-Fi定位系统可以利用一切以IEEE 802.11为标准的网络，实现系统 的扩展和定位功能的实现。由于基于Wi-Fi的定位系统良好的扩展性和适用性， 使得该系统已成为目前室内定位的主流。如图2-3所示，传统的WiFi无线定位 系统由无线AP、智能终端、服务器、无线网络等部分组成。
源MAC地址	消息内容
图2-3 WiFi无线定住系统
8
©RFID定位系统。RFID定位系统使用有源或无源标签，通过定时发送并接 收信号，读取位置信息数据实现定位。该方法定位的响应时间短，定位精度高， 唯一的问题是覆盖范围小，仅适用于部分空间较小的场景。
⑤基站定位系统。基站定位系统的原理相对简单，实际上就是当一个无线设 备接入基站后，该基站就会返回给终端一个特有的标识，终端利用这个标识就被 大致定位到该基站负责的区域内。但因为精度较低，在实际应用时一般作为辅助 的定位系统。
综上所述，定位系统的研究方向有很多，并且每一种系统都有自身的优势和 缺陷。此外，随着光通信和水声通信等领域的研究逐渐被应用到无线定位中，基 于远红外和水声的定位方法也在其他应用领域中实现，但这些系统都有自身的局 限性。未来的无线定位系统必将与卫星导航技术相结合，从而发挥各自的优势， 实现精准的、连续的、具有场景普适性的定位系统。
2.4基于WiFi的室内定位技术
2. 4. 1技术简介
Wi-Fi技术实际上是基于IEEE 802.11标准无线网络技术的延伸，是一种成 熟的无线IP传输技术。由于Wi-Fi自身具有低能耗，高带宽且容易联网的特点， 使得这项发明诞生之初就获得广泛的支持和好评，并且在互联网浪潮方兴未艾的 当下得到广泛的传播和普及。
网络传输协议规定了物理层和控制层的通信标准，控制层从宏观上调控物理 层数据的输入和输出。而Wi-Fi互联网中各AP点都拥有自己的MAC地址，这 就保证了各AP点之间可以通过互相验证MAC地址保证通信的合法性，并藉由物 理层实现数据的传输。因此，由大量AP点构成的Wi-Fi无线网络便成为一个只 要有AP节点就能覆盖到该区域的巨大网络。理论上，当其中一个节点接收到其 他AP发来的数据后，可以通过合法的方式将这份数据传输给任何和自己相联的 设备，其中媒体和以太网骨干一起形成一个互联网系统。
然而，通过控制层建立起的联系只是理论上的“互联”，实际上要真正实现 互相通信光靠已知MAC地址是不够的。大量的AP节点之间是否能实现通信还 需要看这些AP点是否处在同一个区域，这个区域的组成规则则是根据各AP点 设置的BSSID决定的。如果两个AP节点拥有同一个网段的BSSID则两个节点 之间就能实现基本的无线通信服务，但这个通信距离是受限的，通过大量AP组 成一个区域就可以逐渐扩大无线通信的范围。
另外，在Wi-Fi互联网中还有一部分AP拥有着类似集线器一样的功能，这
9
些AP点往往处于网络中心的位置，负责对其他AP节点之间传输的数据进行收 集和分类，保证数据安全、迅速地到达目的地。通过这些特殊的AP节点，无线 终端可以快速和容易地连接到网络，并且使网络本身的强大的信息共享和交互能 力大大增强了。
2. 4. 2主流的Wi-Fi定位系统
借助Wi-Fi网络展开定位首先要保证待测节点能够扫描到AP节点发射的无 线信号，接着通过解析无线信号获取该AP节点的有用信息，如RSSI、BSSID、 时间、位置信息等。当AP节点的BSSID通过服务器的验证后，便可以通过算 法对AP节点的位置信息进行解读，从而获得待测节点和该AP节点之间的位置 关联。当每一个AP节点都与待测节点建立位置关联以后，整合所有信息即能大 致判断待测节点所在的位置了。系统网络示意图如图2-4所示。
图2-4 Wi-Fi定位系统
基于Wi-Fi的定位系统有很多种，主要分两类，一类是纯粹依靠Wi-Fi网络 进行定位的系统，另一类则是以Wi-Fi技术为主，其他技术为辅的定位系统。以 下简单列举几种基于Wi-Fi网络的定位系统：
(1) WiFi-RFID定位系统
RFID实际上是一种特殊的AP节点，与一般AP节点不同的是RFID的构造 相对简单，没有复杂的路由和天线等组成部件，只由具有唯一标识的简单芯片构 成。这种芯片通过周期性的向周围发送信号并接收来自其他终端发送的信号来确 定待测节点的位置，其定位原理与一般的AP节点没有区别。由于这种设备小巧、 便宜且容易大量部署，因此可以在小型且开阔的空间实现精准定位。它的缺点是, 芯片本身是通过电磁感应获取信息的，因此在无线电信号较多的复杂环境下，芯 片容易受到强烈的干扰使定位出现较大的误差。而且由于芯片自身功率有限，信 号无法传播很远，因此只能在较小的空间下使用这种定位系统。如图2-5所示, Wi-Fi结合其他定位元件，如：RFID、Zigbee、蓝牙等组成的定位系统，更加灵
10
活多变，能够在适应更加复杂的室内环境的同时保证较高的精度。
图2-5 Wi-Fi混合定位系统
(2)位置指纹匹配定位系统
位置指纹匹配定位系统纯粹依赖Wi-Fi网络实现定位，算法本身其实是将预 测位置转化为分类模型。在模型中，每一个位置都被看成是一种分类结果，模型 根据采集数据中各个特征的属性值来对这份数据样本进行分类，分类结果就是预 测的位置。为了节省分类的时间，定位系统一般会花费较多的时间来构建位置指 纹的特征数据库，以便在定位阶段可以直接与数据库已有的分类结果进行匹配， 节省运算的时间。这种系统的精度较高，效率一般，最大的缺陷就是建立指纹数 据库需要花费大量的时间，而且需要花费较大的空间来支撑这个数据库。图2-6 是位置指纹匹配算法的流程示意图。
11
图2-6位置指纹匹配算法流程示意图
(3)	WiFi-RTLS定位系统
RTLS定位系统是一种实时的描点定位系统。工作原理是在具有密集的AP 节点覆盖的Wi-Fi网络空间中，终端周期性地可以采集到充分多的位置信息，综 合每一个已知AP节点的位置信息和RSSI信息，就可以实现快速定位并在地图 上以描点的形式给出目标的位置，当目标出现不合理的移动轨迹时，系统还可以 自动做出修改，重新判定目标的位置。该系统的优点是快速，并且有自我更正的 功能。缺点是过于追求速度而导致定位精度不高。
(4)	WiFi-RADAR 定位系统
RADAR定位系统的工作原理类似于基站的小区定位，即根据待测节点距哪 个AP节点最近就大致定位到该AP节点附近。有别于基站定位精度非常低，由 于Wi-Fi网络的AP节点一般是非常多的，因而定位可以选择的位置也就变得密 集了，通过密集的AP节点分布可以将待测节点定位到不远的AP节点位置。此 外，系统经过不断的改良，在参考点是已知的情况下，移动终端以固定的功率和 频率向多个参考点处发射无线电信号，基站确定接收信号强度并建立整个Wi-Fi 网络覆盖范围下待测节点位置的概率分布图。通过计算各位置的概率可以估计终 端的最终位置。该系统具有容易布置而不需要额外的硬件支持的优点。缺点是定
12
位精度过于依赖AP节点的部署密度，如果密度不够，则精度不高。
2.5 Wi-Fi定位算法简介
定位算法是Wi-Fi定位系统的核心，优秀的算法不仅可以提升定位精度，还 可以提高定位系统的执行效率，节约时间成本。定位算法的分类方式有很多，文 中大致将算法分为两种，一种是匹配算法，另一种是测距算法。
(1)匹配算法是通过预先设定一组特征向量，当待测节点扫描当地AP节点 的信号获取数据后，经过数据预处理也将得到一个特征向量。如果该向量与预先 设定的某个特征向量相似，则可以判定待测节点就在预先测试的某一个位置附 近，进而达到预测位置的目的。根据这个原理，常用的匹配算法包括Centroid 算法、RSSI位置指纹匹配算法和非定形算法等。
(2)需要测距的定位算法的实现一般包括两步。第一步是测量待测节点相对 于参考点的距离或方向；第二步是定位阶段基于测量的距离利用几何关系计算要 待测节点的坐标。第一个阶段相当于是训练阶段，主要目的是获取使误差最小的 位置信息与距离的映射函数；第二个阶段是定位阶段，利用三个不共线的圆必有 相交的一点或区域的特性，结合训练阶段的距离公式即可实现定位，训练阶段和 定位阶段的实现方式如下：
①训练阶段：实际应用中可以将信号接收和发送的时间、信号强度、信号接 收的角度等AP节点的信息换算成待测节点与AP节点的距离。根据换算方式的 不同则出现了几种不同的测距算法，比如TOA、TDOA和AOA等技术。但工程 中使用最多的还是基于RSSI与距离映射的函数。大部分关于测距算法的研究都 是围绕RSSI与距离的映射关系开展的，而三角定位法、三边定位法都是基于这 -映射关系而产生的。在本文中，同样也将使用基于RSSI的测距技术用于设计 测距阶段的算法。
②定位阶段：事实上，定位算法的主要区别是定位阶段的执行方法不同。在 本文中，我们提出了局部线性回归和位置加权相结合的定位方法，并使用梯度下 降迭代方法来解方程，计算待测节点的坐标。
研究中通过广泛调研，对匹配算法和测距算法的优劣进行了详细的评估，下 面将依次介绍匹配算法的Centroid质心算法和RSSI位置指纹匹配算法，以及测 距算法的三边测量法和ToA、TDoA、AoA算法。
2. 5. 1 Centroid 质心算法
质心算法的工作原理如图2T所示，由空间中n个AP节点组成一个闭合的 立方体区域，然后根据区域内各部分的“密度”大小找到其“质心”。立方体的
13
密度由待测节点扫描各AP节点的RSSI决定，质心则是预测的待测节点位置。
图2-7质心算法原理图
图2-7中的空心圆表示待测节点，实心圆表示已知的AP节点，黑色实线表示由 AP节点组成的多边形，图中只展示了二维空间的情况，若是在三维空间中区域 的形状更加复杂一些。预测待测节点的坐标公式如下：
（丫'，了）=（之看/〃，£%/〃）	（2-2）
1=1	7=1
在上述公式中，基本上是将已知AP节点的坐标进行加和求平均，得到的结 果满足于各AP节点与待测节点间发射接收的信号强度相差不大的情况。当待测 节点扫描到的RSSI并不呈现高斯分布时，则上述公式就不适用了。因此，质心 算法虽然计算简单，很容易实现，精度略高于基站定位，但误差还是太大，尤其 是在室内环境下，这种误差就大的难以接受了。前人也对质心算法进行了一些改 进，基本思想就是对RSSI值进行量化使得整个空间随信号强度的疏密产生物理 密度的变化，再根据物理学的质心计算公式运算得到预测坐标。利用上述思想改 良后的算法，定位精度可以得到显著提高。
2. 5. 2 RSSI位置指纹匹配算法
位置指纹匹配算法是匹配算法的一个核心分支，该算法之所以被称为位置指 纹算法是源于每个人的指纹都是唯一的标识，当一个人的指纹被录入数据库之 后，只要找到相似的指纹几乎就等同于知道这个人的全部信息了。位置指纹匹配 算法正是利用各AP节点在空间中某处的信号强度组成的向量可以作为“指纹” 对该位置进行唯一标识，建立“指纹”数据库，以便在定位阶段可以迅速找到匹 配向量来确定待测节点的位置，其模型如图2-8所示。
14
(1)训练阶段：目标是创建位置指纹特征数据库，数据库应记录在实验环境 中所有参考位置下接收的各AP点的RSSI值，同时关联每个AP的MAC地址， RSSI值和SSDD,构成存储在位置指纹特征数据库中的位置信息三元组。
/1\ m AP.AP,-…AP,
(X.. y.)
J 保存
匹配算法---预测位置
定位阶段
图2-8基于位置指纹匹配的定住算法模型
(2)定位阶段：用户可以通过扫描所有AP接入点的RSSI值，并使用MAC 地址和RSSI值作为特征向量。当待测节点的输入向量与指纹数据库中的特征向 量匹配时，便可以输出该特征向量对应的坐标作为待测节点的预测结果。
基于RSSI的位置指纹匹配算法在定位阶段计算量相对较小，但是构建特征 数据库是非常耗时的，因为有必要重复地收集大量的数据。
2. 5. 3 RSSI三边定位算法
基于接收信号强度(RSSD的定位方法：通过观察Wi-Fi信号强度和接收点 到发射点的距离，可以发现随着接收点逐渐从发射点远离，测量信号强度随之降 低。如果AP节点和待测节点的距离过远，则无法扫描到信号口刃。因此，前人根 据信号强度与距离的映射关系，通过大量的实验验证得到了一个在理想的室内环 境下成立的信号强度与距离的关系式：
K=R—10y.log(4)+ X0	(2-3)
式中，Ri是接收端在距离发射端心处获取到的AP节点的信号强度，单位是此； R是常值，表示待测节点与已知AP节点在距离为d的情况下，待测节点测得的
信号强度值d是两个节点的距离，为了方便计算，这里设成1米；7是路径损耗 指数；儿是信道噪声。这种信号模型在较小区域相对接近于室内定位技术的理论 值，因此大部分定位系统都是基于RSSI测距法的。原理如图2-9所示。
图2-9三边定位算法原理
2.	5. 4 ToA 算法
基于到达时间(TOA)的定位方法，指通过测量从信号传输到信号到达的时 间，再根据无线电信号的传播速度将时间转化为路程，最后从路程的大小判断待 测节点的位置。其工作原理与三边定位法相似，只不过是从RSSI映射到距离的 过程改为从传播时间映射到距离的过程，如图2-10所示。
图2-10 T0A算法原理
16
图中的黑色实心圆表示已知的AP节点，中间的白色圆点表示待测节点，黑 色实线表示时间映射的距离，外围的三个大圆表示分别由三个距离为半径画出的 预测范围。从几何学中不共线的三个圆心必可存在一个公共交点可知，当三个己 知AP到待测节点的距离已知时，则必可以找到一个交点或一片相交的区域，研 究中把这个点或区域当作待测节点最有可能出现的位置。根据已知AP节点的坐 标，可建立如下方程组(2-4)：
^x-xa)2 + (y-yj2 =da
\ yl(x-xb)2 + (y-yb)2 = db	(2-4)
\^l(x-xc)2+(y-yc)2 =dc
由式(2-4)可得到T节点的坐标，如式(2-5)为：
工)2(约一匕)丫卜:—+	呼+%―/]
<y J、2(x& -x°) 2(券-、x； -x： + y； -y： + d； -d； /
2. 5. 5 TDoA 算法
基于TDOA的定位方法实质上是对TOA算法的改良，由于TOA算法需要 AP节点之间的时间与待测节点的时间必须严格意义上的同步，否则微小的异步 偏差将导致预测结果产生巨大的差异。为了规避这种风险，一些研究者提出利用 一次发射、一次接收的方法计算两个节点之间的距离。举个例子，当已知节点A 向节点B发送信号X,发送时刻记为ti,节点B在接收到信号后随即向节点A 发送信号Y,接收信号Y的时刻为t2。由此可知两个节点之间传播两次信号的时 间为利用该时间差就可以计算已知节点到待测节点的距离了。因此，TDOA 算法巧妙地避免了时间同步问题对定位的负面影响，其定位精度也要优于TOA, 算法的工作原理如图2T1所示。
17
图2T1 TDOA算法原理
2. 5. 6 AoA 算法
基于AOA的定位算法实际上是对三边定位法的变形，其核心思想是通过节 点之间的角度在空间平面内绘制直线，相交点即为待测节点的位置。虽然这种方 法看似非常简单且容易理解，但在工程上实现起来却非常困难。首先信号到达节 点时的角度与接收天线的方向有很大关系，而在一般情况下待测节点的天线方向 并不确定且无法预测；其次，AOA算法在二维空间中实现较为容易，而在三维 空间下，直线之间存在平行、相交和异面三种关系，想要通过直线是否相交判断 待测节点的位置是极为困难的。综上所述，AOA算法的理论体系尚未完全形成, 而且对天线的要求极高，不适用于所有终端，导致该方法的平均精度不高。原理 如图2-12所示。
图2-12 A0A算法原理
AOA算法的解方程可根据三角形的几何关系获得，如式(2-6)所示:
18
d、2 -八 cos% + r? cosy2
,9=(X-X])2+(＞一乂)2
\2 =(x-x2)2 + (j/-j/2)2
"12 = (丫1 - 々A +(71 - %)?
(2-6)
2.	6本章小结
本章主要介绍当前在室内定位技术当中的研究现状，介绍了无线网络定位的 核心思想和基本定义，简单总结了定位算法好坏的评价标准，对几种目前已有的 定位体系的性能进行说明，并且深入介绍了几种基于Wi-Fi技术的定位系统。基 于上述说明，最后着重介绍了 Centroid、RSSL TOA、TDOA和AOA这几种主 流的定位技术和算法，并着重阐述了基于RSSI的三边定位算法。
19
第三章 基于局部线性回归和位置加权的WiFi定位算法设计
3.1	RSSI信号传播模型
在复杂室内环境下，无线电信号容易产生波动，RSSI测量数据的统计特性 变得复杂多变，研究噪声识别和消除的问题和如何提高RSSI定位估计的精度变 得非常有挑战性。室内环境噪声的偏差往往是动态变化的，因此利用离线测试样 本进行局部线性回归的定位估计方法，可以较好地估计信号传播模型，使误差最 小化。
3.	1. 1传播模型的核心公式
在第二章中提到无线信号在空气中传播时有随距离增大而逐渐衰弱的关系。 大量的实验表明，在理想的室内环境中，信号强度与距离的映射关系会受到路径 损耗和高斯噪声的影响，函数整体的曲线类似于对数函数，并且会围绕一定的均 值上下波动。公式如下：
d K=R-10y.log(^) + Xb a
(3-1)
式中，Ri是接收端在距离发射端di处获取到的AP节点的信号强度，单位是dB； R 是常值，表示待测节点与已知AP节点在距离为d的情况下，待测节点测得的信号 强度值d是两个节点的距离，为了方便计算，这里设成1米；，是路径损耗指数； 儿是信道噪声。目前已有的测距方法大部分是通过采集大量的实验数据，利用大 尺度路径衰减模型得到强度R和距离d之间的关系曲线，其时间、运算量及通信开 销很大。研究中结合梯度下降原理和局部线性回归算法，只需要采集少量的数据 建立数据集，通过计算机迭代计算建立RSSI值和距离的映射关系，大大节省了 采集数据过程的开销。
3.1.2局部线性回归算法
局部线性回归算法是最常用的非参数估计方法，它的优点包括：较高的渐近 效率、较强的适应设计能力和较小的估计误差。
假定在无噪声环境下采集的数据集为口=｛（5（11）,（「2,（12）,...,（血/）｝,其中n是接 收端在距离发射端&处的RSSI测量值。根据式（3-1）可知，输入r何得到距离的 预测值f（a）,预测f（n）的关系式为：
R-rt + Xa
(3-2)
20
其中预测值f(n)与真实值di之间存在误差，这是由参数R和7的变化导致的， 误差记为损失函数J(R/)。通过迭代计算的方式估计特征参数R和，的值，使损失 函数最小化，即minJ(凡丫)。
1 加
/年)—ar	(3-3)
Z i=l
其中。，是权值变化速率，r是待测样本的输入值。利用梯度下降原理 进行R、，的迭代运算，经过一定次数的迭代运算后可以得到最适应输入值r的特 征参数R和，。如图3T所示为一个梯度下降过程的三维图像，可以看出利用迭代 过程函数逐渐趋于最优的参数解，其中颜色表示空间的高度，黑色实线表示函数 值梯度下降的路径，红色箭头指向的凹处是函数J的局部最优解。
图3-1梯度下降法示例图
21
图3-2梯度下降算法流程
实验中，设置R、，初始参数分别为0和10,迭代次数为500次，得到的拟合 曲线如图3-3所示：（a）是样本数据，（b）是局部线性回归的拟合结果，其中横坐标 是RSSI值，纵坐标是距离d。图中的R-d函数曲线是预测值f（n）的最终估计函数。
图3-3 R=0, /=10,N=500Ht, f(n)的最终估计效果
3.2 WiFi定位算法
3. 2.1测距算法的工作原理
测距算法的核心计算方式源自三边测量法，即以己知AP节点不共线为前提 确定一个交点或者相交的区域，最终预测待测节点的位置坐标，其原理如图3-4
22
所示。基于经典的三边法对距离的映射方法进行了较大的改动，使得测距算法更 加精确。改进后的算法可以更加精准地描绘RSSI与距离的映射关系，从而在已 知AP节点坐标的前提下，只需要待测节点提供AP节点的RSSI就能够使用三边法 实现定位，公式(3-4)准确地表达了上述抽象过程。其中，函数g和h均是有理函 数，为=(4，3),。=—%血)，3(%“通)。当AP节点的位置坐标已知时，式(3-4)可 以简化为式(3-5),即已知AP点的RSSI就能预测目标位置的坐标。
在无噪声环境下，根据图3-3中f(n)函数的拟合结果，距离可以通过接收端的 RSSI值计算得到。然而，在有噪声干扰的环境下确定函数g(Rrf)、h(Rd)的表达式 非常困难。室内环境的变化、AP点的变化、接收天线的方向、地形以及人为因 素的干扰都会导致表达式的不确定性，噪声极大地影响定位精度。因此，研究中 基于统计学理论，提出了一种位置加权的方法来降低噪声对定位精度的影响。
图3-4测距定位原理 产 g(小,。,0)
b=g(%)
3. 2. 2位置加权算法的应用
位置加权算法指在传统测距算法的基础上，考虑到RSSI在噪声影响下的统 计特性，参考不同强度下对应的距离区间具有不同的概率分布，赋予每种结果不 同的权值，通过这种加权方法提高定位的准确度，减弱噪声对定位结果的负面影 响。
由于信道噪声匕的存在，RSSI值和距离区间的映射关系如式(3-6)所示，
23
(3-4)
(3-5)
研究表明，干扰噪声X.服从高斯分布，通过统计样本数据可以对高斯噪声的均值 4和方差非进行无偏估计。噪声的样本方差决定了每个AP点的预测的范围，根据 噪声的概率分布对不同的距离赋加不同的加权系数，系数叠加起来构成位置加权 的结果，如图3-5所示：
尺1-＞。1 = {西 五 2fD2 = {dLd2,d3} R3f D3 = {dLd2}
D4 = {d2,d3,d4} ‘R5.D5 = {d2,d3,d4,d5} R6f Z)6 = {d3,d4,d5} H7 -O7 = {d3,d5}
O8 = {d5}
(3-6)
图3-5位置加权算法示意图
⑥是单一 AP点预测位置的范围和加权系数，（b）是多个AP点预测位置的范围和 加权系数。其中，虚线到AP点圆心的距离是信号传播模型根据输入的RSSI值 输出的距离，两条实线之间的环形区域是目标可能出现的位置范围，样本方差决 定了范围的大小，并且距虚线越远的区域权重越小，反之则权重越大。数字是该 区域下的加权系数，将每一个位置栅格的数字分别累加，可算得每一个区域加权 系数的大小。
24
3. 3实验仿真与结果分析
研究中采用实验验证的形式对定位算法进行评估，同时探究复杂的室内环境 对算法准确性的影响。实验场景选择在北京邮电大学新科研楼三层的某个区域， 为保证实验能够充分模拟复杂的室内环境，该区域包括实验间、走廊、障碍物和 其他无线电信号干扰。
3. 3. 1实验环境
在实验中，根据楼层的结构选择将科研楼三层的西北部分设为实验区，将实 验区分成编号为A1-A9的9个区域，实验区域内总共部署了 12个AP节点，如图3-6 所示，黑色实线代表建筑的墙壁，红色方块代表已知的AP节点，整个实验区均 被无线信号覆盖，室内的无线电信号环境较为复杂。考虑到定位系统的应用性， 实验中采用手机APP的方式采集并上传数据，并选择努比亚z7max型号手机作为 采集设备，操作系统为Android。
图3-6实验区域的AP点部署情况
3. 3.2实验流程
实验分三个步骤进行。第一步是采集测试数据，对数据进行预处理以保证数 据的有效性和可用性；第二步是训练定位模型，利用采集的数据对AP节点之间 距离和RSSI的函数关系进行拟合，充分利用机器学习的方法建立局部线性回归 和位置加权的算法模型；第三步是实验测试，真实模拟应用场景，由终端在多个 待测节点采集信号数据，数据作为输入经过模型的演算得到输出结果，最后对比
25
真实结果给出定位精度并对算法的性能做出评价。
采集测试数据应尽可能保证位置相对平均地分布在地图上，这也是验证算法 适用性强弱的必要条件。在训练定位模型的过程中需要对局部线性回归算法进行 编程实现，通过不断地参数寻优选择性能较好的模型。根据结果的整体准确率和 单点最大误差两个指标来选择最优回归模型。在实际建模中，实验使用Hadoop 进行分布式并行计算，以此提高实验效率。实验测试实际上就是定位阶段，与采 集数据时一样，采样点的位置应尽可能均匀分散，在得到测试结果之后，应该用 测试数据与用其他方法得到的结果进行对比，完成对算法性能的评估。测试样本 点的分布和定位结果如图3-7所示。
图3-7测试样本的定位效果
3.	3. 3误差分析
第二章提到的位置指纹匹配算法在大部分研究者的实验中平均有三米左右 的误差，而且部分单点的测试结果甚至出现偏差超过十米的情况〔即，可见匹配 算法对于数据库的完整程度有着苛刻的要求，数据库越是完整，数据量越大，定 位精度越好，反之则越差。
图3-8对同样场景下匹配算法和测距算法的测试结果进行了对比，改进后的 测距算法的平均误差在3米以内。另外，采用该实验方法得到的最小误差和最大 误差分别是0. 5米和6米，说明该算法具有很好的稳定性和可靠性，可以看出论文 研究的测距算法具有更可靠、更稳定的特点。而传统的测距定位算法对目标位置 的估计普遍存在3米左右的误差，最大误差甚至达到8米，这说明它在复杂的室内 环境下抗干扰能力较弱，并且对AP点的密度有较强的依赖性。
26
“位置加杈 常传统测距
图3-8实验结果数据统计
基于局部线性回归的信号传播模型是该定位方法能够取得良好效果的基础， 此外使用位置加权的方法对原有测距定位方法的改良，对控制误差范围起着重要 作用。更重要的是，由于系统拥有Hadoop的云计算能力，因此测距算法在时间 复杂度方面与匹配算法几乎相等，而测距算法在空间复杂度上则是远远低于匹配 算法的。可见，就工程应用方面来看，文章研究的测距算法比传统的位置指纹匹 配算法具有更加优良的性能。
3.	4本章小结
本章提出了利用机器学习中局部线性回归的理论思想和统计学中的加权方 法，基于Hadoop的云计算能力，实现测距定位的方法。首先是局部线性回归拟 合信号传播模型，降低了建立信号传播模型的复杂度和计算量，使定位过程具有 普适性。然后利用统计分析方法，避免了三边定位方法存在的多个AP节点的定 位圆不共点的问题。最后，利用对比实验对该方法的科学性进行了验证，结果表 明，该方法相对于同类定位方法精度高、可靠性好。
27
第四章 基于MapReduce的WiFi定位系统的改进与实现
4.1设计方案
第四章围绕着如何设计Wi-Fi定位系统的课题进行规划，详细阐述系统从流 程设计到功能实现，从硬件配置到软件开发的全部过程。着重说明了各功能模块 的流程和细节，并且对系统由数据采集并上传WiFi信息列表至后台服务器，再 由服务器完成运算过程返回定位结果的过程展开了详尽的描述。
4.	1. 1设计流程
系统的设计流程根据运行的阶段大致分为三个部分，分别是数据采集阶段对 应的数据采集和整理模块，模型训练阶段对应的算法实现模块，以及定位阶段对 应的服务器定位模块。其中第一部分主要的工作是手机APP的设计和优化，这 一部分有关已知AP节点坐标信息以及RSSI、MAC地址、时间戳等诸多特征数 据集的采集部分，因而十分重要。第二部分则是基于原始数据利用局部线性回归、 位置加权、梯度下降、迭代运算等算法找到各部分的逻辑关系，最后使用 Map-Reduce的编程思想实现实现系统的定位算法，以便能够在Hadoop系统上高 效运行。第二部分是系统的核心研究部分。第三部分是系统的实现，包括搭建服 务器平台，同时利用Hadoop分布式集群的并行计算机制将系统的运算复杂度简 化，为算法的实现提供硬件及软件的支持。
系统的架构则可以分为两层，一层是数据整理功能模块，一层是定位功能模 块。定位模块是数据整理模块的下游，两大模块相对独立。图4-1展示了从数据 整理模块到定位模块的数据传输内容。这种单向传输的方式可以提高系统的稳定 性。
图4-1系统架构流程图
图4-2展示了基于MapReduce的定位系统在服务器端的子模块之间的逻辑关系。
28
室内环境区域划分
图4-2系统功能模块图
系统的两个模块负责不同的功能，这两个模块相对独立，只有数据整理模块 到定位模块的单向数据读取操作。换句话说，定位模块在定位期间仅读取下层模 块数据包，而不会将被处理的数据反馈。这种单向数据读取操作可以大大减少数 据传输的量，节省的带宽则可以用在Map和Reduce过程中，减少算法的运行周 期，减少运算时间，提高定位效率。
为了进一步提高Wi-Fi室内定位的定位效率和定位精度，将训练阶段和定位 阶段的工作相互隔离，保持相互独立，实验将分成两个主要功能模块，以实现良 好的效果。研究中，采用客户端主动定位的方案，利用手机客户端的主动操作上 传采集数据，接收、显示定位结果，如图4-3所示。
图4-3客户端定位流程图
从图中可以看出，手机终端的APP应该具有数据存储、上传和下载能力， 并且可以装载定位软件。为了使定位算法相对容易设计和实现，并且算法复杂度 相对较低，选择在服务器执行定位过程。无论是安卓还是苹果的操作系统都具有 扫描AP节点发射的信号并采集瞬时信号强度的功能，利用这一功能开发第三方
29
的数据传输APP将会更加容易实现。结合实验区域的结构图以及APP上传下载 数据的功能，客户端就能配合服务器端将定位的结果呈现在使用者面前。
4.	1.2系统硬件平台
首先，通过搭建Hadoop实验平台实现服务器的两大功能模块。Hadoop集群 有两种节点，一种是名字节点，一种是数据节点。其中名字节点的任务是控制数 据节点，而数据节点的工作则是存储和使用数据。实验中名字节点和数据节点使 用的机器规格是相同的，主要参数如下：双核3.4GHz CPU、4G内存、150G硬 盘空间，操作系统为CentOS 6.4, Hadoop版本为Hadoop 1.0.2, Java版本为 jdk-7u21-Linux-i586, IDE平台为Eclipse 3.3。各节点采用100M交换机互连，利 用内部局域网进行通信，其中1■台为NameNode,其余10台作为DataNode。
集群由守护进程和任务进程构成，守护进程的工作是监控任务进程是否正常 并且将任务分配给CPU使用率较低的节点，任务进程的工作是对该节点的执行 工作进行监控，必要时进行节点资源的分配操作。一般地，集群只有一个守护进 程却有多个任务进程。任务进程可以说是进程与任务之间的中介，它除了负责执 行任务外，还需要同时使用规定的协议与守护进程和任务进行通信。实际上，为 了方便数据处理的本地化，任务进程和数据节点经常被安排在相同的机器上执 行。Hadoop集群的配置信息如表4-1所示。
表4-1 Hadoop机群信息
机器名	IP地址	用途
NameNode	192. 168. 1. 137	守护进程
DataNodelll	192. 168. 1. 138	任务进程
DataNodell2	192. 168. 1. 139	任务进程

DataNodel20	192. 168. 1. 147	任务进程
在实际环境中搭建的实验硬件平台的主机节点利用路由器、交换机互相连通 并且可以登录外网。实验中系统的定位功能主要集中于服务器端，由于资源有限 并且需要验证系统的通用性，实验没有布设多余的定位AP,而且全部使用目前 实验区域可探测到的AP0
4.	1. 3系统软件部分
系统的软件部分从功能执行的先后顺序上来看，流程如下：
(1)手机打开APP并扫描周边的己知AP节点，采集必要数据。
(2)用户连接外网，登录客户端并向服务端发送数据上传申请，用户终端通 过验证信息取得数据上传资格。
30
(3)等待服务端的处理，收到定位完成的提示后，开启数据下载功能，获取 定位结果。
(4)打开本地地图，将定位结果呈现在电子地图上。
图4-4展示了 Wi-Fi网络、客户端和服务端的数据传输流图。从图中可见原 始数据从Wi-Fi网络流入手机客户端后再打包送到服务端的数据整理模块，在经 过数据的预处理工作后，由定位模块接收数据并将定位信息以表结构存储于 Hadoop文件系统中。最后的定位结果被送到客户端进行呈现，方便使用者在电 子地图上查阅。图4-4的伪代码描述如下：
31
输入参数：定位AP的信息
输出参数：待测点的定位结果
BEGIN
设定常量COUNT为最大数据采集次数：
循环标量ent初始化为0；
RSSI数组rssi 口初始化为0；
WHILE(cnt<C0UNT){
接收连接请求并传输数据；
从缓存中读取数据：
格式化数据并写入定位引擎模块；
调用递归均值算法求RSSI均值；
cnt++；
)
TF(rssi [0]!=0&&rssi[l]!=0Urssi[2] !=0) { 待测点坐标初始化为(0,0);
调用局部线性回归函数计算距离；
调用定位算法函数计算可能的待测坐标； 调用位置加权函数计算待测点坐标；
}
END
4. 2服务器端功能实现
服务器端的功能包括数据的上行下行,算法的运行，结果的输出与更正等等。 以Hadoop系统为基础的后台服务器利用并行式计算以提高运算效率，此外后台 系统需要分为数据整理和定位两大模块。为了使各功能之间的耦合度更低，研究 中将两大模块又分为以下几个子模块，分别是为此需要实现室内环境划分模块、 数据收集模块、数据预处理模块、测距算法模块、实时定位模块和结果修正模块。
4. 2.1室内环境区域划分模块
在空间较大的室内环境中，各个区域内的噪声干扰不尽相同，因而必须对室 内空间进行区域划分，以便定位时易于分类和特殊对待。像超市、博物馆、火车 等室内空间大且人流密集的区域，信号在传播过程受到的干扰也很大，就需要划 分区域时尽可能的缩小每一个最小定位单位的范围；而像公园、体育馆等障碍物 少且人流密度较低的场所，信号强度不会因距离的些许增加而迅速衰减，因而可 以将定位区域划分的较大，这样可以节省前期准备数据的时间。研究中采用直角
32
坐标系标记的网格划分方法，将环境较为复杂、噪声较重的区域按0.5米的间隔 均匀划分室内场景；环境简单且噪声干扰小的区域则以二到三米为间隔进行空间 切割。
对于大的室内空间，人和室内障碍物的密度相对较低。然而对于购物中心， 医院，实验室等区域，由于存在的大量障碍物和复杂交错的各种信号，容易对位 置的判断产生不良影响。因此，数据的采集密度需要根据情况来确定，越是复杂 的环境就越需要部署越多的AP以满足定位要求。实验系统使用基于网格的模块 化分区模型，数据采集点的密度也会根据模块划分的密度进行调整，分割紧凑的 区域采集密度相对较高，反之，采集密度偏低。通常，在1到2米的距离处就设 有采集点；对于人流密度不大的区域，类似于大停车场，采集点的间隔可设置为 3到6米。利用网格化模型划分区域，可以使定位的效率更高，速度更快，大幅 度降低准备阶段的时间成本，在工程应用中具有更好的竞争力。
4. 2. 2数据收集模块
数据收集模块负责将采集的原始数据进行初步的筛选，过滤掉无效、错误的 数据，通过APP终端的程序将原始数据严格按照格式规范进行重新编辑。如表 4-2所示为收集模块部分主要的字段以及字段描述，其中AP的MAC地址被设 置为主键用来区分不同的APo经数据收集模块处理后的数据，按照严格的数据 表结构以文本格式传递到数据预处理模块进行下一步处理。
表4-2采集模块的数据字段表
字段	类型	描述
SSID	char(20)	Wi-Fi服务标识
BSSID	char(20)	主key, MAC地址
X	Double	已知节点的横坐标
Y	Double	已知节点的纵坐标
TimeStamp	int	终端采集数据的时间戳
RSSI	int	终端接收到的信号强度 指示
Sequence	int	MAC帧顺序编号
4. 2. 3数据预处理模块
数据预处理模块的输入来自收集模块上传的数据包。在数据收集过程中，信 号强度有可能突然地增加或减少，甚至无法扫描部分AP中的无线信号，这些数 据都不具有参考性，需要被删减。该模块通过消除大量的波动信号可以直接、有 效地提高定位精度，消除无效数据对定位精度的影响。如表4-3为某一采集区域
33
内的部分数据:
表4-3 Wi-Fi数据列表
SSID	Levell	Level2	Level3	Level4	Level5	Level6
TP-LINK_324	-18	-19	-20	-19	-18	-19
SP605	-49	-52	-53	-55	-52	-55
GuoAllen	-50	-50	-54	-46	・47	\
322wifi	-54	-53	-54	-58	-55	-53
WiFi-D8	-65	-67	-69	-64	-65	-65
表中SSID为“GuoAllen”的AP在采集过程中RSSI本来趋于平稳，信号强 度围绕着-50dBm中心上下波动，突然信号出现强度骤减和陡增的情况，甚至有 一次该AP节点出现无法被勘测到的情况。这种不稳定的信号源在实际应用中是 需要被屏蔽的，通过过滤掉噪声以及无效的数据可以进一步提高系统的稳定性， 甚至能提高定位的精度。除了屏蔽不稳定信号源之外，通过一些有效的过滤算法 也可以将信号的忽增忽减情况进行记录，并加以过滤。如图4-5所示，实验中采 用高斯滤波的方式对数据进行二次处理，尽可能消除奇异噪声对系统的影响。
图4-5预处理流程图
第三章中通过大量仿真实验发现,数据收集的数量越大，滤波的可靠性越好。 另一个影响过滤效果的因素是过滤的循环次数，循环次数越多过滤效果越好，当 循环次数超过一个阈值后，效果就不再有所改善了。图4-6所示为数据预处理模 块的流程图。
34
图4-6代码流程图
下面是数据预处理在执行过程中的循环过滤代码:
For(int i=0;i<3;i++){
if (strcmp(apjnac, ap_macaddr[i +1 ]) ~0) {
cnt[i]++;
rssi[i+l]=rssi;
avg_rssi[i]=avg rssi[i] + (rssi[i+1]-avg rssi[i])/cnt[i];
strcpy(macaddr[i+1], dev mac);
arivetime[i]=tv. tv_sec;
)
printf(n macaddr[%d]:Ox%X\n ", I, macaddr[i]);
4. 2.4测距算法模块
第三章指出室内环境下，AP节点的信号强度会根据距离的增减情况发生变 化。传统的算法对距离和信号强度的处理过于简单，导致建立的RSSI和距离的 映射关系并不准确。而复杂的处理虽然能够使结果变得准确，却要牺牲大量的运
35
算量，连通信的开销也会大大增加口也在测距算法模块中，将利用预处理数据 中的RSSI值作为输入，使用局部线性回归算法对距离作参数估计，建立RSSI值 和该RSSI值的距离的映射关系。线性模型形式简单、易于建模，蕴涵着机器学 习中一些重要的基本思想。由于信道噪声的存在，该映射是一对多的映射关系， 一个RSSI值对应一个距离区间，研究表明，在某个距离下的信道噪声服从高斯 分布。根据信道噪声的概率密度函数可以计算得到当前RSSI对应的距离以及该 距离的概率。
综合上述结论，当测距算法模块接收预处理数据中的一个RSSI值时，将输 出一个以该AP为中点的距离范围，该范围根据统计数据得到。然后，分别计算各 距离的权重系数，保证距离中点近的距离权重系数大，距离越远，权重越小。测 距算法模块流程如图4-7所示。
36
图4-7测距算法模块流程图
虽然使用局部线性回归作为核心算法建立的匹配测距模块具有不错的精度， 但该算法需要反复验证、不断迭代才能确定最终的参数。为了减少训练所需要的 时间，该模块利用Hadoop分布式集群可以使用Map-Reduce思想进行编程的优 势，对预处理数据做并行处理以满足实时定位的时间要求口句。基于Map-Reduce 实现的测距算法模块如图4-8所示。
37
验证集
No-I
No——
图4-8基于Map-Reduce的测距算法模块流程图
4. 2.5实时定位模块
实时定位模块在数据收集、数据预处理、匹配测距等模块对数据作了充分处 理之后，通过预测待测节点的坐标和可能出现的位置范围，最终计算出定位结果。 该模块的主要功能是实现快速准确的定位，通过实时扫描Wi-Fi信号数据，匹配 测距结果，以及执行第一阶段和第二阶段的定位算法实现定位。实时定位模块的 好坏需要从两方面来评价，一是单次定位的平均时长，即时效性；二是定位的精 度。模块如果算法过于复杂则无法满足实时的要求，定位就没有意义，会导致定 位延时；定位算法太简单，则不能满足所需的定位精度。因此，该算法必须实现 实时性和精度要求之间的平衡。通过第三章介绍的基于局部线性回归和位置加权 改进后的定位算法计算，得到当前位置的坐标，流程如图4-9所示。
38
由于实时定位对定位的时间要求很高，所以在运算过程中应减少不必要的数 据转移，全部执行过程应集中在几台服务器中，避免因工作量过度均分而导致数 据迁移，浪费时间。这个阶段采用相应的定位算法来实现，通过对计算后的坐标 进行矫正，最后得到当前位置的坐标。
本定位系统的第一阶段通过三边定位法确定一个或几个定位候补，结合加权 情况对候补区域作轨迹圆，进一步计算候补位置的概率。其中最重要的是计算已 知AP信号覆盖范围，以便在求概率时能够作出适当的加权，流程如图4T0所 ZK o
39
图4-10计算已知AP信号覆盖范围的流程图
该算法的时间复杂度为O(n),空间复杂度为O(n)。第二阶段定位算法采用 位置加权的定位算法，通过统计学将定位问题转化为一个根据最大似然概率求最 优无偏估计的数学问题，并利用加权方法求得位置坐标，即可得到比较精确的待 测节点坐标位置。假设实验区域内能接收到有效Wi-Fi信号的栅格有m个，则 该算法的总体时间复杂度为O(m*n),空间复杂度为O(m+n)。
4. 2. 6结果修正模块
实验结果表明，定位引擎模块获得的定位结果并不总是准确的，定位的坐标 与实际坐标可能发生偏离。主要原因是一些AP的信号发射功率波动较大，对应
40
的RSSI多为无效数据，才导致了错误的结果“刀。为减少误差，提高精度，需要 在实时定位模块之后设置一个结果修正模块。此模块是基于人体在室内环境下移 动的瞬时速度和加速度的原理建立的，通过比较在一段时间内待测节点的位移情 况就能够大致预测到下一次定位的范围区间。若是待测节点超过范围，系统将自 动认定为本次定位无效，申请重新定位；若是没有超过范围，则表示定位结果有 效。结果修正模块流程图如图4-11所示。
开始
扫描当前Wi-Fi 数据
保存定位结果
结束
图4-11结果修正模块流程图
结果修正模块首先接收在实时定位模块的预测结果，然后根据修正后的结果 满足判定与否作出选择。如果定位结果满足要求，则坐标将被存储为新的正确定 位结果；如果定位结果不满足要求，表示发生了定位偏移，则模块自动向系统提 交重定位申请，再次调用定位模块重新定位，重复上述过程。当重复次数超过预 设值，则放弃重定位，直接返回定位结果。
4. 3移动终端模块实现
在定位系统中，移动终端的任务有两个：一是采集并上传数据至服务器，二
41
是下载并显示定位结果。因此，移动终端需要建立两个功能模块分别实现数据采 集和结果显示功能。
移动终端首先要根据实验要求在本地加载实验用的电子地图，记录并存储已 知AP节点的坐标。然后根据室内空间的大小规定采集数据的量，根据实验环境 的复杂程度不同，可以适当增加采集次数。当然，为了采样数据能够有效地反映 出Wi-Fi信号的特点，采集的次数越多越好【网。
由数据采集模块接收的数据包括AP点坐标、位置标识符、所有AP的名称 以及环境中所有采样点中每个AP的Wi-Fi信号强度。这个功能模块是整个系统 建设中工作量最大的部分。系统的建立伴随着大量的数据生成，因此采集后的数 据需要全部上传并在服务器端进行备份，以便后续系统的调用。数据采集的流程 如图4-12所示。
开始
设置当前位置坐标和位置标识
检查手机Wi-Fi状态
扫描当前Vi-Fi信号
存储Wi-Fi数据 ------q-------否
是
图4-12数据采集流程图
结果显示模块以图形化的方式将结果直观地表现出来，因此显示界面需要展 示实验区域的二维地图和预测结果的位置。如图（4T3）所示，终端界面设计了“开 始”和“停止”两个按键分别执行定位和停止定位并返回结果的操作，结果将以
42
栅格地图上的红色方块的形式呈现，圆环则表示目标有可能处在的位置的范围。
图473结果显示模块图
4.	4本章小结
本章制定了系统的设计流程，并且按照设计流程先后对客户端和服务器端的 功能进行详尽的阐述。最后，利用实验室提供的硬件平台和软件开发基础完成了 对基于MapReduce的Wi-Fi定位系统的实现。通过将三角定位法、局部线性回 归和位置加权算法相结合预测最有可能出现的位置坐标。利用Hadoop云平台的 并行计算机制，使用Map-Reduce编程思想实现的算法大大减少了系统实施定位 的时间，把算法的时间复杂度尽量压缩。先后介绍了数据整理模块和定位模块， 详细说明了两大模块及其子模块的实现过程。
43
第五章系统测试
5.1实验环境介绍
第五章讲解的是定位系统的实验测试部分，将分别介绍实验环境和测试的整 体流程。最终将给出实验过程中各模块的测试数据，并基于这些数据给出最后的 测试结果。采用对比同一数据处理模型系统下，各种定位算法的性能的方式，展 现该定位系统的优点和不足。
实验中使用Java语言编程实现了系统的各个模块，并且根据楼层的物理结构 选择将科研楼三层的西北部分设为实验区，实验区域内总共部署了 12个AP节点， 实验选择努比亚z7max型号手机作为采集设备，操作系统为Android。另外，通过 搭建Hadoop实验平台实现服务器的两大功能模块，借助Hadoop强大的并行处理 能力提高系统的运行效率口叫该实验的环境为多间实验室和走廊组成，分别以 墙面为x轴和y轴，西北墙的墙角为坐标原点建立直角坐标系。为了能够充分展现 该系统对于复杂的室内环境具有良好的抗噪声性能，测试的环境拥有各种各样的 噪声干扰，充分模拟真实的楼内环境。
MSE =应自后不宙"	（5-D
式（5-1）是评价定位准确度的计算标准，不指待测节点的横坐标，yj指待测节 点的纵坐标，和则分别指代预测的横坐标和纵坐标。MSE值越小代表精度越 高，反之精度越差因】。
5.	2实验流程
5. 2. 1系统完整性验证实验
系统的完整性验证实验将通过对定位系统输入终端采集的原始数据，检测输 出数据的可用性的方式来验证系统是否完整。在实验过程中，原始数据会分别经 过各模块，按照数据采集功能、数据整理功能、定位模拟的顺序作验证实验。在 完成对系统各部分完整性的验证实验之后，将实验数据进行整理并与预期结果展 开比对。主要的评价标准包括定位效率和定位精度。定位效率的高低需要通过算 法的时间复杂度以及每次定位平均的耗时来衡量；定位的精度，则需要通过待测 节点测量结果与实际结果的MSE值来评估。如表5-1所示。
44
表57定位功能模块的测试结果
测试用例名称	定位功能模块测试
目的	检测定位功能的完整性和定位的效率
类别	功能性测试
执行日期	2016-11-1
测试流程	进入定位界面，点击“开始定位”，统计定位使用的时间并 对结果进行精度分析。
预期结果	在AP覆盖密度大、障碍物少的区域，定位耗时较少，精度 较高，系统具有完整性。
实际结果	时间消耗高于预期，精度符合预期，总体定位效果相较传统 定位算法有明显提升。
结论	测试结果符合预期
5. 2.2系统非功能性测试
系统的非功能性测试旨在查找系统功能之外的问题，即测试是否存在BUGo 测试的内容是监测定位系统长期运行的情况和能耗方面的优化。由于系统在实际 使用中会面临一个问题，就是各种型号的手机在使用同一个系统可能展现出不同 的性能，而实验中的测试却无法将所有型号的手机都做性能测试，因此只能对几 个主流型号的手机进行深入测试，以寻找潜在的问题PL表5-2为非功能性测 试实验的结果。
表5-2测试结果
实验名称	系统性能测试
目的	测试系统的运行性能
类别	性能测试
执行日期	2016-11-24
实验流程	监测定位系统在运行过程中是否存在异常、报错、中 断等问题
预期结果	系统运行时一切正常，并且可以承受长时间高负荷运 转
实际结果	系统运行时未报错，但耗电量较大，部分手机出现轻 微发热现象
结论	测试结果基本满足预期
5. 3定位算法性能对比
测试方案采用本文设计的定位方法和传统的三边法、位置指纹定位法进行性 能对比。根据10个同样的数据源分别计算待测点的坐标，它们的定位结果如表
45
5~3 所 /j< o
表5-3定位精度的测试结果
序号	实际坐标	改进的三边定位算法	三边定位算法	位置指纹匹配算法
1	(4,3)	(3, 10)	(2, 5)	(4, 7)
2	(4, 11)	(2, 13)	(1, 17)	(4, 15)
3	(4, 29)	⑸27)	(6, 20)	(5, 24)
4	(11,29)	(9, 30)	(8, 20)	(10, 16)
5	(14, 33)	(15, 34)	(12,27)	(13,30)
6	(20, 34)	(20, 32)	(18, 30)	(19,31)
7	(31,34)	(32, 36)	(34, 35)	(31,30)
8	(31,24)	(29, 24)	(35, 18)	(27, 17)
9	(29, 20)	(29, 17)	(30, 21)	(24, 15)
10	(34, 19)	(30, 16)	(25, 15)	(30, 14)
MSE	\	3. 4205	6. 7007	6. 4807
通过对比表5-3中三种方法的结果可以看出，本文设计的基于局部线性回归 和位置加权的准确性明显好于其他两种。相比于传统的三边测量法和位置指纹匹 配算法而言，该算法还有很高的可拓展性，可以在数据量较大的时候仍然保持流 畅的运行。
正如第三章所述，传统的位置指纹匹配法必须事先获取每一个区域中每一个 AP对应的RSSI值，而且需要将这些“坐标”存储到数据库中，一旦更新一个 AP点的数据，整个数据库都需要进行更新，维护难度极大PR。而本文设计的定 位算法利用机器学习的思想始终处于训练和学习的状态，即便环境发生改变，系 统也会随环境的改变主动“学习”得到最优解，适应能力极强。
5. 4本章小结
第五章首先介绍了测试的环境，接着就测试的流程展开了详细的讨论，并且 给出了完整性实验和性能测试的数据和结论。根据测试结果和预期结果的对比分 析可知软件功能模块的实现和性能方面基本符合要求。结合第四章对算法时间复 杂度和空间复杂度的分析说明，论文研究中的Wi-Fi室内定位系统具有可靠性高、 时效性强、准确度高、拓展能力强等优点，符合市场和工程应用中的需要。最后， 通过和其他两种算法的比较，基于Map-Reduce的室内定位算法比传统的三边定 位法和位置指纹匹配算法具有更优秀的可用性。
46
第六章总结和分析
本文以基于MapReduce的WiFi定位算法为技术研究对象，系统的阐述了此 类室内定位技术的特点、研究意义和发展现状，针对此定位技术存在的相关问题 进行分析与验证，提出相应的解决方法。最后，设计、开发了一个以实际应用为 目的的基于WiFi信号强度的室内定位系统原型。
论文的主要研究成果在于通过实验室内环境中采样所得的RSSI位置特征数 据，对尽可能影响定位误差的因素进行了系统地分析，为定位算法的设计与定位 系统的部署提供了一定的理论依据。同时根据实际实现过程中遇到的不同情况进 行了总结分析，从不同的角度，用不同的方式将室内环境下WiFi信号波动性较 大对定位精度的影响降到最低，大大地提高了定位的效率、准确性以及精度。经 过实际的测试，系统的运转情况良好，符合预期。
论文多次讲到如何利用Wi-Fi测距定位算法和机器学习的相关理论，结合 Hadoop云计算的先天优势对海量的Wi-Fi数据进行即时处理和实时定位。文中 还使用大量的篇幅来说明无线定位技术的发展前景和意义以及近几年遇到的困 难和挑战。面对技术瓶颈展开了大量的论证和推导，并最终设计完成了基于 MapReduce的Wi-Fi定位系统的雏形。同时，从提高效率和实用性的角度，使用 Hadoop平台实现大规模Wi-Fi数据并行处理。此外，使用机器学习方法可以使 室内环境下的定位精度提高。实际测试后，系统定位误差约2米，其中83%的测 试集样本误差在3米以内，98%的测试集误差在6米以内。
室内定位技术将是未来的一个新的高峰，随着定位方法的不断增加，研究的 不断深入，定位精度甚至可以达到cm级水平，定位技术也将延伸到军事、技术 和人们的普通生活。室内定位技术也将整合各个算法的优势，弥补各方面应用的 缺点，逐渐趋于完善。
（1）随着诸如社交网络和移动电话的发展，对基于位置的服务的需求也在 增加。在户外GPS定位技术已经能够做到非常精确的定位的情况下，可以预见 的是未来的室内定位服务将与室外定位实现无缝定位。无论在什么情况下，人们 都可以享受到所需的定位服务，为人们的生活提供方便。
（2）现在不仅仅是“麦当劳”，“星巴克”等大型餐饮娱乐设施才有Wi-Fi, 许多普通餐厅也已经有Wi-Fi,人们的生活已经离不开无线网络。利用无线网络 的资源开展定位服务无疑将帮助更多人解决生活中的困难和不便。
（3）在诸如地震、火灾、矿难等需要应急救援的紧急区域，快速有效地定 位可以为救援人员提供有力的支持，以最短的时间为需要脱困的人们计划提供准 确的逃生路线。随着技术研究的革新，室内定位技术的发展将逐渐在各领域崭露
47
头角，不断丰富人们的视野。
48
参考文献
[1]李飞.WiFi网络中基于测距的定位算法研究[D].电子科技大学,2013.
[2]杨利娟.基于Hadoop云平台的数据挖掘技术在天气数据的应用研究[D].北 京：北京邮电大学，2015.
[3]	KAWAGUCHI N, YANO M, ISHIDA S, et al. Underground positioning: subway information system using WiFi location technology[C] //Proc of the 10th International Conference on Mobile Data Management: Systems, Services and Middleware. 2009:371-372.
[4]	BISWAS J, VELOSO M. Wi-Fi localization and navigation for autonomous indoor mobile robots[C] //Proc of IEEE International Conference on Robotics and Automation. .2010:4379-4384.
[5]	WOODMAN O, HARLE R. Pedestrian localisation for indoor environmentsfC] //Proc of the 10th International Conference on Ubiquitous Computing. New York: ACM Press, 2008:114-123.
[6]杨波波，张磊.基于WiFi的室内迭代定位算法的研究[J].计算机应用与软 件,2016,33(4):262-264.
[7]	YAMASAKI R, OGINO A, TAMAKI T. TDOA location system for IEEE 802.11b WLAN[C] //Proc of Wireless Communications and Networking Conference, [S. I. ]:IEEE Press, 2005:2338-2343.
[8]	WANG Y JIA X, LEE H K, et al. An indoors wireless positioning system based on wireless local area network infrastructure [C] //Proc of the 6th International Symposium on Satellite Navigation Technology Including Mobile Positioning and Location Services. 2003:21-34.
[9]	BATTITI R, BRUN ATO M, VILLANI A. Statistical learning theory for location fingerprinting in wireless LANs[J]. Computer Networks:the International Journal of Computer and Tel ecommuni cati ons Networking, 2005, 47(6):825-845.
[10]De MORAES L F M, NUNES BAA Calibration-free WLAN location system based on dynamic mapping of signal strength [C] // Proc of the 4th ACM International Workshop on Mobility Management and Wireless Access. New York:ACM Press, 2006:92-99.
[11]TURNER D. On the empirical performance of self-calibrating WiFi location systems [C] // Proc of the 36th IEEE Conference on Local Computer Networks. [S.l.]: EEE Press, 2011:76-84.
[12]李飞.WiFi网络中基于测距的定位算法研究[D].电子科技大学,2013.
[13]王青.WiFi室内定位系统的设计与实现[D].北京:北京交通大学,2014.
[14]桑楠，袁兴中，周瑞.基于SVM分类和回归的WiFi室内定位方法[J].计算 机应用研究,2014,31(6):1820-1823.
[15]王缓缓，胡爱娜.RSSI和距离区间映射的测距方法[J].电子科技大学学 报,2013(6):862-868.
[16]李建江，崔健.MapReduce并行编程模型研究综述[J].电子学报,2011.
口刀吴冲,苏兵.基于改进动态RSSI算法的WIFI室内定位研究[N].常州大学学 报,2014(1).
[18]王鹤.一种基于RSS的室内定位算法研究[J].中国科技论文在线,2010.2-3.
49
[19]Dhruba Borthakur. The Hadoop Distributed File System Architecture and Design[R]. The Apache Foundation,2007.
[20]胡天琨，叶建芳.基于手持设备的室内定位系统设计与实现[J].微型机与应 用，2012(31):1-3.
[21]杨帆，赵冬冬.基于Android平台的WiFi定位[J].电子测量技术,2012(9):9-10.
[22]魏雷.WiFi位置特征定位技术研究及仿真器设计[D].西南交通大学:西南交 通大学,2012.4-5.
50
