第一章绪论
1.1研究背景及意义
随着社会的不断发展，各种网络的规模变得越来越庞大，结构也越来越复杂。 为了维持网络的正常运行，企业不得不派遣巡检人员对网络的线路进行维护和检 查。例如，在通信行业里，成千上万的基站都是通过光纤相连接的。所以，整个 网络的通信质量将依赖于光纤的畅通与否。然而，现实生活中影响影响光纤安全 的因素非常的多，如市政工程等工程的施工、气候地理因素、线路老化及人为破 坏等。为了保障通信网络的畅通，运营商将定期派遣巡检人员对光纤线路进行巡 检。
传统的巡检方式主要通过巡检人员对线路进行巡査，发现潜在的隐患。然而， 这种人工方式存在以下缺陷：第一、管理上的漏洞。巡检人员一般都是独立工作， 无法保证巡检人员的到位率；同时，缺乏信息提示，难以保证巡检的质量。第二、 巡检方式非实时，无法知道巡检人员的实时位置，导致工作效率低。第三、巡检 工作涉及时间的考查时，无法实现，比如盯护，无法监控巡检人员是否一直在工 作岗位上。第四、工作繁重，巡检人员在现场通过纸质文档记录隐患或缺陷。巡 检完成后还需要回到公司将巡检的结果输入到电脑中，这样不仅重复劳动、工作 效率低，而且工作量大，造成输入数据容易出错。
另一方面，随着硬件技术的不断发展，智能手机正一步步走进普通人的生活。 智能手机釆用了开放式的操作系统，开发人员可根据其操作系统提供的接口开发 各种扩展应用程序。这种手机不但具备普通手机的通信功能，同时还具备多媒体 应用、个人信息管理以及通过无线接入互联网浏览网页和电子邮件等功能。
因此，在后PC时代的潮流下，开发基于智能手机的智能巡检系统势在必行。 它能够有效地解决上述传统巡检中存在的问题。第一、智能手机随人而动，可利 用手机的GPS模块获取巡检人员的位置信息，并通过无线网络将位置信息实时 地传输到服务器，服务器端结合地理信息系统（GIS）对数据进行分析与显示， 监督巡检人员的行为，提高巡检的工作效率和质量。第二、智能手机具有很强的 可扩展性。通过其提供的编程接口进行二次开发，同时结合手机的GPS、拍照 及录像等功能，可从多个维度描述隐患信息，对于及时发现问题有很大的帮助。 第三、根据用户上传的隐患信息，监控中心可向智能手机下发相应指令，调度巡 检现场的作业情况，提高巡检的管理效率。第三、在巡检过程中，巡检人员不再 需要带着特殊的定位终端巡检，这不仅给巡检人员带来了方便，同时省去购买特
殊终端也为企业节约了一笔不小的开支。第四、利用智能手机进行巡检，可以显 著降低巡检人员的工作量，避免重复劳动。同时，减小了人为因素的干扰，保证 了数据的正确性；规范化数据格式，有利于数据分析与挖掘。第五、终端提供标 准时间，可以用来考核涉及在岗时间的巡检工作。第六、基于智能手机的智能巡 检系统在实时监控、巡回计划的制定、人员、终端信息管理等方面具有自己突出 的优势，极大的方便了线路巡检工作的监督和管理工作。
Android是一种基于Linux内核的自由及开放源代码的操作系统。具有开源 免费、稳定、可移植性强等特性。据国际数据公司IDC在2012年11月提供的 《世界手机市场跟踪调查季度报告》⑴显示，Android占据全球智能手机操作系 统市场75.5%的份额，远远超过了苹果的I0S、微软的Window Phone等其他系 统,位居全球第一。同时，其在中国市场占有率高达68.4%o可见开发基于Android 操作系统的智能巡检系统乃是大势所趋。
1.2国内外研究现状
自1963年，加拿大建立了世界上第一个基于GIS的巡检系统以来，随着计 算机通信技术的发展以及人们对GIS研究的深入，其应用也越来越广泛。巡检 行业起步于国外，目前已发展得十分成熟，现广泛应用于邮政、地质、物流、电 力、通讯等行业的监测。大多数系统都是建立在GIS之上的，同时结合GPS提 供的位置信息，将巡检结果存储到数据库中。它们之间的主要差异在于信息采集 方式的不同，现目前主流的信息釆集方式有基于条形码识别、基于射频识别、基 于智能手机等。而信息采集方式的选择与具体的行业有密切的关系。
我国巡检系统方面的研究虽然起步较晚，但由于行业的迫切需要，发展迅速。 目前，结合现有的技术及应用环境，开发了一些巡检系统并在实际中发挥了一定 的作用。如北京超图的超级电子地图、中兴通讯的集中电子监控解决方案、北京 灵图的迷你手持等等。然而，与国外巡检系统相比，技术上存在一定的差距，功 能上不够完善；同时，大部分的软件都是基于工业级的PAD,操作系统采用的 是古老和单一的嵌入式系统，导致界面简陋、操作不灵敏且造价昂贵。
1.3论文主要内容
本文主要讨论智能巡检系统中地图模块的设计与实现，在SpringMVC+Ibatis 的开发框架基础上，以MYSQL、HTTP协议、Ajax和百度Map API等技术为基 础，从平台端和Android端两个维度，具体阐述了地图模块中实时监控、线路或 区域的添加、修改、显示等功能的实现。最后结合智能巡检系统中的其他功能模 块对本文所开发模块的进行测试与分析。
第一章绪论。本章介绍智能巡检系统的研究背景及意义，以及国内外的发 展现状，并简要介绍本课题的研究内容。
第二章 课题相关知识。本章介绍智能巡检系统中地图模块开发设计所涉及 的相关技术。介绍了 SpringMVC+Ibatis Web开发框架、百度地图API技术、 Android平台开发技术，给出了本课题采用这些技术进行地图模块开发的理由。
第三章平台端地图模块的设计与实现。本章根据智能巡检系统中管理用户 对地图模块的页面管理和操作的功能需求，结合页面设计的一些原则和要求，以 及JavaScript相关技术，设计和实现了地图模块在平台端的三个功能子模块：实 时监控模块、线路巡回模块、区域巡回模块。
第四章Android端地图模块的设计与实现。本章根据智能系统中巡检人员 对智能终端地图模块的界面管理和操作的功能需求,结合设计的一些基本原则和 要求，从用户体验的角度出发，设计了 Android端地图模块的三大功能子模块： 精确定位到目的地位置模块、实时定位模块、巡检任务显示模块。
第五章模块测试结果及分析。本章将地图模块与智能巡检系统中的其它模 块联合调试，用具体的测试用例说明分析其运行结果。
第七章总结与展望。本章对全文的工作进行简要地总结，思考系统地图模 块的不足或隐患，对进一步的完善指明了方向。
第二章课题相关知识
2. 1 SpringMVC
Spring是为了解决企业应用程序开发繁杂性而创建的一款轻量级开源框架， 具有良好的分层架构和松耦合因。它以控制反转（IoC）和面向切面编程（AOP） 为核心机制，提供了展现层SpringMVC、持久层SpringDAO以及上下文配置文 件Spring Context等众多的企业级应用技术。开发人员可根据需要选择Spring提 供的部分模块，同时，Spring还提供了与其它开源软件的无缝结合。
SpringMVC是由Spring提供的一个基于MVC设计理念的Web框架⑶，内 部具有良好的扩展性，能有效地帮助开发人员处理复杂问题。与其他MVC框架 相比，它具有以下一些与众不同的特点：
,清晰的角色划分。Spring在模型（Model）、视图（View）和控制器 （Controller）方面有着非常明确的划分，各自完成自己相应的功能；
•灵活的应用配置。Spring的核心是控制反转，因此，在具体实现时，也 可以把类当作一个Bean,通过xml文件进行配置；
・视图层是真正意义上的实现无关的，它不强制开发人员使用JSP,它也 支持 FreeMaker、Velocity 等；
•面向切面编程。这是Spring的一"很重要的特性,SpringMVC作为Spring 的一部分，也继承了这个优点。它使得程序员在开发时易于调试。
・提供了许多的控制器接口和实现类。开发人员可根据需要直接使用 Spring提供的实现类或自己实现提供的控制器接口。在方便用户的同时 也为用户提供了很大的自由度。
•强大的标签库，减少HTML文件生成开销，提供标记最大灵活性；
基于上述优点，在智能巡检系统中地图模块的开发时，我们釆用了 SpringMVC作为我们的MVC框架。
SpringMVC主要由分发器（DispatcherServlet）、控制器、模型和视图三部分 构成，主要围绕DispatcherServlet展开。DispatcherServlet负责接收用户的请求并 将其分配给相应的处理器处理。具体工作流程如下：
1.整个流程始于用户发送HTTP请求，Web服务器接受请求，搜索 DispatcherServlet的请求映射路径（在Web.xml文件中给定），判断是否 匹配，如果匹配，则Web容器将该用户的请求交由DispatcherServlet来 负责分发它。

2.用户请求进入后，Dispatcher Servlet根据HanddlerMapping的配置，将用 户请求转发给相应的控制器进行业务处理；
3.Controller进行业务处理之后，返回一个包含了视图逻辑名和模型数据信 息的 ModelAndView 对象给 DispatcherServlet；
4.DispatcherServlet获得的ModelAndView中的视图逻辑名并非真正意义上 的视图对象，需要借助视图解析器(ViewResolver)将其解析成真正要 显示的View对象，譬如，JSPo DispatcherServlet!在获取到真正的视图 对象View之后，将使用该视图对象View对ModelAndView中的模型数
据进行视图渲染。最后，呈现给用户的可能是一个html网页，也可能 是一张图片或一个pdf文档⑸。
控制器
(2)
请求



图2-1 SpringMVC整体框架图
2. 2 I bat i s 框架
Ibatis是一款基于Java的轻量型开源持久层框架，在2001年由Al inton Cegin 发起提出，主要用来完成对关系数据库的对象映射⑹。它对JDBC做了非常轻量 级的隐藏和封装，通过它能够实现以操作对象的方式访问数据库，使得熟悉面向 对象思想的Java开发人员能够很方便地对数据库进行操作。不同于其它的“一 站式”对象关系映射方案，如Hibernate、ApacheOJB等，Ibatis是一种“半自动 化”的对象关系映射实现。所谓“半自动化”是指，Ibatis需要开发人员手动编 写SQL语句，这为系统开发增加了更大的自由度。

Ibatis的持久化是通过XML配置文件来予以实现的。具体地，需要两个配 置文件，一个文件用来配置Ibatis本身的一些属性、缓存机制以及数据源等；另 外一个是映射文件，实现数据表映射到模型层的对象。
Ibatis架构主要由SQLMap和数据访问对象两部分组成。其中，数据访问对 象可使得开发人员通过其提供的接口访问数据库，而不需要知道其数据库访问的 具体实现，减轻了开发人员的工作量。SQLMap作为Ibatis最核心的组件，通过 简便的配置文件将JavaBean、Map实现和基本数据类型包装类等映射成JDBC 的查询对象(PreparedStatement)。其具体的工作流程如下：
1.首先，将对象(包括JavaBean、Map实现、基本数据类型包装类等)作 为一个参数，此参数将用于替换SQL语句(可以是增加语句、查询语 句、修改语句等)中的参数。
2.其次，执行映射后的语句(mapped statement)。SQLMap将根据配置文 件(SqlMap.xml)创建一个查询对象的实例，用上述的参数对象为该查 询对象的实例设定参数值，然后，执行查询对象并从结果集中创建结果 对象。
3.最后，根据操作类型返回不同的结果对象。即，如果执行的是更新操作,
则返回更改的行的个数；如果执行的是查询操作，则返回一个对象或对 象集明



与Hibernate相比，Ibatis具有以下的优点：
-• Ibatis很小并且简单易学；Hibernate则比较复杂，入门的要求比较高。
•灵活性更高。Ibatis对数据的操作全开放，具有很高的灵活性；而Hibernate
的“全自动化”封闭了内核，导致灵活性较低。
・高效率。Ibatis在访问数据库时不需要解析SQL语句，因此，其执行速 度比较快。而且，随着社会的发展，数据量越来越大，用户对性能的要 求也越来越高，Ibatis的“半自动化”使得开发人员可以自己手动编写 高度优化的SQL语句或存储过程来满足系统的性能指标。
综上所述：由Web开发的发展趋势和巡检行业数据量庞大的特征决定了智 能巡检系统在开发时，选择Ibatis作为我们持久层框架。
2.3百度地图API
百度地图API是百度公司于2010年4月推出的一套由Java脚本语言编写的 应用程序接口【刀。它有效地对复杂的底层逻辑进行了封装和隐藏，以简洁明了的 方式提供给开发人员，将全部运算放在百度自身的服务器中运行。基于该程序接 口，通过开发人员的二次开发可以为用户提供功能全面、极具个性化的地图应用 服务。百度地图API突破了传统的“点击一等待”模式，釆用了 Ajax这一局部 刷新技术有效地避免了重复加载地图页面脸。
百度地图API包含了地图类、标记类、折线类、经纬信息、信息窗口类等 构建地图基本功能的接口，提供了诸如美食地点、线路规划、驾车路线等数据服 务，并且其提供的地图服务是全部免费的，任何营利机构或编程的发烧友均可通 过其提供的APL编写JavaScript脚本开发地图功能削9】。下面简要地介绍一下在 智能系统开发时需要用到的类。
•地图类Map
地图类作为百度地图API中最核心的部分，是其他元素的基础，任何其他 元素都是在它的基础上发挥作用的。当用户需要在网页中加载百度地图时，首先 要通过varmap = new BMap.Map(n")来获取一个Map类的实例。然后，根据实际 的需求情况，设定该地图实例的相关属性，如页面地图的中心位置、缩放等级、 是否允许拖拽等等。
表2-1 Map类的常用方法
方法名称	返回值	方法说明
setCenter()	none	指定地图的中心点
enableDragging()	none	打开地图拖拽功能
enableScrollWheelZoom()	none	打开鼠标滚轮放缩
enableDoubleClickZoom()	none	打开双击放大
setMapType!d(maplypeld:
MapTypeld)	none	设置地图类型


•标记类Marker
标记类Marker涉及对地图上某一点的一些相关操作。在初始化标记的位置 信息之后，将该标记添加到百度地图上；同时，可获取标记的相关信息或对标记 添加拖拽、点击等监听函数。
表2-2 Marker类常用方法
方法名称	返回值	方法说明
setClickable(flag： boolean)	none	将当前层设置为可点击。
setDraggable(flag： boolean)	none	允许在地图上拖放标记
setTitle(titl e: string)	none	给标记取名字
set\^sible(visible: boolean)	none	将标记设为可见
,折线类Polyline
折线类Polyline用来在百度地图上绘制折线的地图添加层。


表2-3 Polyline类常用方法
方法名称	返回值	方法说明
setMap(map： Map)	none	在地图上添加折线
setOptions(options： PolylineOptions)	none	设置折线的属性
setPath(path：
MVCArray. <LatLng>|Array. <LatLng>)	none	设置一条路径,path为折线坐标 的有序点列，可以使用一个简单 的LatLng数组或者LatLng的 MVCArray指定此路径。

2. 4 Android
Android是一款由谷歌公司和开放手机联盟领导和开发的基于Linux的开源 操作系统，主要用在智能手机、平板电脑等移动设备上卩％与其它的操作系统 一样，安卓系统也釆用了分层设计。架构如图2-3所示，Android系统总共分为 四层，从上层到底层分别为：应用程序层(Application)、应用程序框架层 (Application Framework)> 系统运行库/运行环境层(Libraries/Android Runtime) 以及 Linux 内核层(Linux Kernel)

•应用程序层(Application)
应用程序位于架构的最顶层，用户通过它与终端进行交互。Android自身预 置了一些常用应用程序以满足用户的基本需求，如桌面(home)、联系人 (contact电话(phone)和浏览器(browsers)等等。此外，用户可以根据自 己的需要到安卓市场下载感兴趣的应用程序。所有的这些应用层序都是基于Java 语言开发的卩41。
,应用程序框架层(Application Framework)
应用程序框架主要包括了 Android系统的一些核心组件。开发人员在实现自 己的程序时，可以直接调用这些组件。它为应用程序的开发提供了公共使用的约 定，确保了程序具有一致的主体结构，同时也简化了开发的流程。
• 系统运行库/运行环境层(Libraries/Android Runtime)
系统运行库主要是一些基于C/C++语言编写实现的原生组件卩I当开发人 员使用应用程序框架进行具体的开发时，安卓系统会自动调用这些库文件来为开 发所用到的各个组件提供支持。系统运行库主要包括：libc、Media Framework、 Webkit、SGL、OpenGLES、Free Type、SQLite 等等。
, Linux 内核层(Linux Kernel)
Linux内核层提供了一些操作系统最核心、最基础的底层管理服务，有效地 封装和隐藏了具体的硬件细节，属于软件和硬件之间的一个抽象层"习。主要包 括了进程和内存管理服务、网络协议栈、驱动模块和安全性等。
10
2. 5小结
本章首先简要地介绍了基于MVC设计理念的SpimgMVC web开发框架， 其次，介绍了 Ibatis持久层框架。比较了它和Hibernate的优缺点，并结合巡检 系统的实际需要，阐述了本课题釆用Ibatis作为持久层的理由。最后，详细介绍 了百度地图API技术和Android开发平台框架，为后续开发工作奠定了基础。
11





























































12


第三章平台端地图模块的设计与实现
3.1实时监控模块的设计与实现
3.1.1实时监控模块的设计
在智能巡检系统中，为了提高巡检人员的巡检效率以及巡检的到位率，管理 人员需要实时的了解包括巡检人员位置等的信息；另外，为了统计巡检人员的工 作业绩，管理人员需査看某巡检人员某一特定时间段的巡检路线。因此，在系统 的整体设计时，我们设计了一个实时监控模块，该模块提供以下的功能：
(1)将巡检人员的巡检路线实时的展现在地图上，便于管理人员监督其工 作的效率以及巡检的到位率。
(2)提供历史轨迹回放，将某些巡检人员某一特定时间段的巡检轨迹展现 在地图上，便于管理人员考核。
在传统的巡检系统中，为了实现上述的功能，通常釆用通过客户端向服务器 发送服务请求，服务器响应客户端的请求并返回当前数据库中的数据信息的方 式。然而，这种实现方式是一种伪实时监控，即为了到达实时监控的效果，客户 端需不断的向服务器发送请求以获取巡检终端最新的数据信息。这种方式有以下 几种弊端：第一、为了达到实时监控的目的，用户需通过不断的刷新页面以向服 务器发送请求来获得用户的最新数据信息，这将导致管理人员工作繁重，不利于 管理人员的操作。第二、这种通过不断发送请求以达到实时监控的方式会导致客 户端和服务器之间存在很大的数据交互，对网络的性能要求较高且存在一定的传 输延时。第三、为了响应客户端的请求，服务器每次将向客户端发送巡检人员的 到目前为止的所有数据信息，这导致服务器和客户端之间存在很大数据传输冗 余。
为了避免上述弊端，在本智能巡检系统中，我们釆用Ajax技术实现服务器 在满足某种特定条件下主动向客户端发送特定的信息数据。具体地，客户端通过 Ajax引擎向服务器发起HTTP请求，服务器接受客户端的请求，并保持HTTP 连接。服务器每隔一个特定的时间段(在本系统中我们设定为每隔一分钟)，査 询数据库中特定巡检终端的数据信息,根据查询结果判断是否有终端新上传的数 据信息，如果有，则将新的数据信息主动发送给所有当前服务的客户端。客户端 的Ajax引擎的响应函数解析服务器推送的数据信息，并最终在地图上展现出来。 釆用Ajax技术的实现方式有以下好处：第一、保证了客户端能够获实时的获取
13
终端的位置信息，达到了实现实时监控的效果。第二、服务器定时主动的发送特 定信息数据，不需要客户端不断发送请求，实现了真正意义上局部刷新。第三、 服务器只向客户端推送巡检终端新上传的GPS信息，最大限度地减小了客户端 与服务器端之间的信息交互量。
在本智能巡检系统中，我们将借助百度地图这一地理化显示工具将巡检人员 的巡检轨迹可视化地展现出来。在实时监控模块的设计中，综合考虑到智能巡检 系统的行业特点以及模块的设计原则，主要包括初始化和实时画点两个部分，具 体的功能设计如下：
初始化部分主要负责：初始化实时监控页面的布局、加载时间选择控件、加 载百度地图、通过Ajax技术与服务器建立HTTP连接、从服务器返回pagebean 信息中解析出的巡检人员的信息并加载到用户选择控件中。其工作流程如图3-1 所示。
（开始'）


HTTP响应
:建立连接并返冋人
员信息
* ,
加载人员信息


图3-1初始化部分算法流程
实时画点部分主要负责：通过Ajax验证管理人员是否选择了监一控对象，若 没有，则弹出提示对话框。将管理人员选择的监控时间段以及监控人员等信息传 递给后台服务器，服务器根据这些信息定时的查询数据库，判断是否有满足条件 的新的数据到来，如果有，返回数据信息给所有服务的客服端，客户端解析收到 的数据信息，通过对百度地图的二次开发将巡检人员的位置等信息实时的展现在 地图上，呈现给管理人员。其工作流程如图3-2所示。
14








客户端调用百度API
与Ajax加载线路
客户端:		r—		i




图3-2实时画点部分算法流程图
3.1.2实时监控模块的实现
根据实时监控模块的设计方案，我们将通过一个页面来实现实时监控模块，
达到实时监控和历史轨迹回放的功能。在智能巡检系统的实际开发中，我们将采
用前面介绍SpringMVC+Ibatis Web开发框架来予以实现。该模块的整体框架如
图3-3所示。
15

gpsintoServiceN gpsinfoServicelm 	uJ
gpsinfoDAO, gpsin
foDaoImpl
图3-3实时监控模块整体框架
具体地，在本模块的实现时，在视图层，我们通过JSP、JavaScript. JSTL 等技术构建了一个lineMonitor.jsp页面和lineMonitor.js脚本用以进行视图解析。 视图的任务就是将控制器返回的模型渲染出来。控制器层的SysDwrCmd类实现 Spring的控制器接口，是连接视图和模型的桥梁，控制着视图和模型之间的交互。 它的功能像是一个分发器，其主要的任务就是接受请求，并派遣某一个模型去处 理该请求，以及派遣某一个视图去呈现返回的数据。Model层，也就是业务逻辑 处理层，用来完成实时监控模块中相应业务逻辑的处理。它是MVC最主要的核 心，表示了该模块的数据，并且还包含了查询、更新和管理这些数据的逻辑处理， 用以提供一个详细而精准的服务。在本系统的开发中，实时监控模块的模型层总 共包括了一个 gpsinfbService 接口、一个 gpsinfoServicelmpl 类、—f' gpsinfoDao 接口、一个gpsinfoDaoImpl类以及相应的DataObject。最后，我们通过Ibatis来 实现持久层，即通过Java和xml完成了 JavaBean和数据库中字段的映射。
下面我们分两部分给出实时监控模块的具体实现步骤：
1-初始化部分的实现
步骤一、时间选择插件的实现
为了实现巡检人员轨迹的历史回放和便于管理人员的操作，我们将在实时监
16

控页面提供时间选择插件。管理人员可以很方便的通过时间插件来选择监控的时 间段。在本系统中，时间插件选择釆取WdatePicker»之所以釆用WdatePicker, 是因为其支持多种浏览器、支持中英文；而且它还可以提供快速选择，即用户最 常选择的5个时间。注意，在使用该插件是，我们首先通过script标记将 WdatePicker引入页面中，用户点击时间选择框时，弹出日历选择插件，管理人 员更根据需要选择时间后点击确认完成时间的选择。其界面如图3-4所示。

时间输入框的代码如下：
<input type="text" name="starttime" id="starttime" onClick="WdatePicker({startDate:'%y-%M-%d %H-%m-%s',dateFmt:'yyyy-MM-dd HH:mm:ss',alwaysUseStartDate:true,maxDate:'#F($dp.$D(\'endtime\')}'))" class="Wdate" ></input>
<input type="text" name="endtime" id="endtime" onClick="WdatePicker((startDate:'%y-%M-%d %H-%m-%s',dateFmt:'yyyy-MM-dd HH:mm:ss',alwaysUseStartDate:true,minDate:'#F($dp.$D(\'starttime\')}'})" dass="Wdate"></input>
第一部分代码实现了开始时间输入框，第二部分代码实现了结束时间输入 框。其中，maxDate:'#F{$dp.$D(\'endtime\')}'和 minDate:'#F{$dp.$D(\'starttime\')}' 分别保证了开始时间的选择范围不得大于结束时间，结束时间的选择范围不得小 于开始时间。
在实际中，考虑到管理人员通常会监控巡检人员当天的路线，根据产品简单、 易操作的设计原则，我们将初始化时间控件的开始时间和结束时间分别为当日的 00:00:00和23:59:59o实现代码如下：
function initialtime()
17
{ var chongdate = new Date();
var myStartTime= chongdate.getYear()+"-"+(chongdate.getMonth()+l)+"-"+ chongdate.getDate()+" 00:00:00"; 〃设置开始时间为当日的 00:00:00 var myEndTime= chongdate.getYear()+"-''-i-(chongdate.getMonthO+1 )+"-"+ chongdate.getDateO+" 23:59:59"; 〃设置结束时间为当日的 23:59:59 document.getElementById("starttime").value=myStartTime;
〃页面中显示开始时间 document.getElementById("endtime*').value=myEndTime;
〃页面中显示结束时间
)
步骤二、加载百度地图
在地图加载这个过程中，首先判断浏览器是否兼容百度地图，若不兼容，则 弹出提示对话框，提醒用户跟新浏览器或者使用其它的浏览器。通过对Object 对象化，设置地图加载时的地图类型、地图中心的初始经纬度、地图的初始大小 等属性。对于展现的地图，我们还增加了对一些操作的监听，使得管理人员能够 随意的拖动地图，通过鼠标的滚轮或键盘缩放地图。同时，还提供了缩略图和比 例尺控件便于估计人员的行程。核心方法如下 function setDriver()(
map = new BMap.Map(docximent.getElementById("map_canvascc"));
//加载百度地图
map.centerAndZoom(new BMap.Point(l 16.452377319336,39.9608879089355),15); map.enableDragging();〃允许对地图进行拖拽 map.enableScrollWheelZoom();//允许通过鼠标滚轮对地图缩放 map.disableDoubleClickZoom();〃关闭通过双击鼠标放大地图的功能 map.enableKeyboard。;//允许用户通过键盘的操作地图 map.enableContinuousZoom();〃启用连续缩放效果 map.enablelnertialDraggingO;//启用地图惯性拖拽
var ctrlnav = new
BMap.NavigationControl({anchor:BMAP ANCHOR_TOP_LEFT,type:BMAP_NAV IGATION_CONTROL_LARGE});
map.addControl(ctrlnav);
var ctrlove = new
BMap.OverviewMapControl( {anchor:BMAP_ANCHOR_BOTTOM_RIGHT,isOpen: 1))； 一
18
map.addControl(ctrlove);
var ctrl_sca = new BMap.ScaleControl((anchor:BMAP_ANCHOR_BOTTOM_LEFT}); map.addControl(ctrlsca);
}
步骤三、与服务器建立HTTP连接，并加载巡检人员信息
客户端浏览器向后台服务器发起HTTP服务请求，以期获取巡检人员信息。 控制层的SysDwrCmd类接受客户端的请求，并根据请求类型指派Model层的 driverinfoService接口及其实现类、driverinfbDao接口及其实现类来处理该请求。 最后，客户端通过Ajax技术将服务器返回的人员信息加载到用户选择框中供管理 人员选择。部分核心代码如下： 控制层的核心代码： public class SysDwrCmd
public List<TDriverinfo> getDriverName() throws Exception
(
TDriverinfbCriteria example = null;
List<TDriverinfb> list = this.driverinfbService.selectByExample(example);
〃调用业务逻辑层的Service查询所有的巡检人员信息
return list;
} }
模型端Service层的核心代码：
public class DriverinfoServicelmpl implements DriverinfoService
.public List<TDriverinfb> selectByExample(TDriverinfoCriteria example)throws
Exception
{return tDriverinfbDAO.selectByExample(example);}
}
Model端Dao层的核心代码：
19
public class TDriverinfbDAOImpl extends SqlMapClientDaoSupport implements TDriverinfoDAO
public List<TDriverinfo> selectByExample(TDriverinfoCriteria example)
(
List<TDriverinfo> list = getSqlMapClientTemplate().queryForList("T_DRIVERINFO.selectByExample", example);
return list;
从上述程序代码中可以看出，我们在SysDwrCmd类中定义了一个 driverinfoServicee它负责处理Controller层中传来的关于巡检人员信息请求，在 该模型构件中我们还定义了一个tDriverinfbDAO,但他并没有在该类中得到一^t* 具体的值。实际上，tDriverinfbDAO将通过Ibatis配置文件映射到MYSQL数据 库中，获取满足条件的数据。在上述过程中，我们釆用了 Spring的注入反转技 术，使得类与类之间的耦合性低，便于编程人员的后期维护和扩展。
2.实时画点部分的实现
步骤一、用户选择插件的实现
为了便于管理人员操作，在选择监控对象时，本文通过Ajax技术设计了一 种用户选择插件。它由下移一个按钮、下移全部按钮、上移一个按钮、上移全部 按钮四部分组成。其界面示意图如下图所示。结合图3-5来解释四个按钮它们分 别的功能，下移一个按钮功能：若用户选中某用户，点击下移一个按钮将会下移 该用户到下面框中，若用户直接点击下移一个按钮则将上面框中置顶的用户下移 到下面框中。下移全部按钮功能:用户点击下移按钮将全部用户下移到下面框中。 类似地，上移一个按钮提供将选择的用户（或下面框中置顶的用户）上移到上面 框中，上移全部按钮将全部下面框中的用户上移到上面框中。
20

迭择司机

» . 1 匚
图3-5用户选择插件界面
在具体实现时，如下移一个按钮，我们需要首先判断上面框中是否存在元素, 然后通过循环判断，将选中的用户下移到下面框中。下移一个按钮的核心代码如 下，其他按钮的实现与按钮类似。
for ( var i = 0; i < oYight.options.length; i++)
{
if (oYight.options[i].selected) //判断用户是否选中该人员
{
var oOption = document.createElement("OPTION");
oOption.setAttribute("text", oYight.options[i].text);//获取人员的名字 oOption.setAttribute("value", oYight .options[i].value);//获取人员的编号 oZeft.add(oOption);//将该人员信息加载到下面框中
}
}
步骤二、服务器定时向客户端推送GPS信息的实现
客户端将管理人员选择的监控对象和监控时间段参数传递给后台服务器，服 务器端的Controller调用业务逻辑层的gpsinfoService和gpsinfoDao来处理该请 求，即根据监控参数定时查询数据库，判断是否有满足条件的数据，如果有，将 该数据发送给返回给客户端。该流程的实现与上述司机信息的查询类似，在此我 们不再赘述。
步骤三、百度地图上线路加载的实现
客户端收到服务器发送的GPS信息，通过Ajax技术和对百度地图API的二 次开发实现巡检轨迹的实时载入。在地图上显示用户线路时，我们要求不同用户 的线路采用不同的颜色，且当用户将鼠标移到GPS点时，将显示该点人员信息、 隐患等信息。在具体实现时，由于每个点包含有六种不同的字段，因此，在解析 服务器返回的数据时，我们应当每隔六个字段提取相应信息。此外，在画轨迹时, 对每一位巡检人员，我们循环读取所有的GPS点，通过比较每个点的司机信息
与巡检人员是否一致来判断该点是否属于这位巡检人员，如果是，则将其存储到 数组中，通过获取的GPS信息数组，选择一种颜色，在地图上画线。具体的代 码
function linemonitors(data)
for (i = 0; i < ptsStr.length-6; i = i + 6)〃循环读取每个点
( lats.push(pareeFloat(ptsStr[i + 2]));//一^ 点的维度信息 lngs.push(parseFloat(ptsStr[i + 3]))；〃一 个点的经度信息 ids.push(ptsStr[i + 5]);〃一个点的人员编号 var point = new BMap.Point(lngs[i/6],lats[i/6]);
createMarker(point,ids[i/6])；〃 每个六个字段表示 _ 个点 latLngs.push(point);
for (i = 0; i != driverid.length; i++)
{ var myLatLng=[];
for (j = 0;j != ids.length; j++)
{if (driverid[i]== ids[j])//循环判断该点是否属于第i位巡检人员
{myLatLng.push(latLngs[j]);}〃将该巡检人员的所有纬度信息存储到数组中
}
drawPolyline(myLatLng,LineColor[i]);//
}
}
3. 2线路巡回模块的设计与实现
3. 2.1线路巡回模块的设计
- 随着社会的不断发展，电信、银行、物流、天然气、邮政、消防等网络的规 模不断扩大，维护工作变的日益重要。为了确保这些线路的正常运行，公司需派 出工作人员到线路上检査，以便及时的发现隐患，釆取相应的措施防患于未然。 例如：在通信行业中，需定期指派巡检人员对基站、易受到人为破坏的光纤线路 进行检查。如果发现问题，巡检人员将通过所携带的智能终端向监控中心上报隐 患以便采取相应的措施，保证通信网络的正常运行。因此，在系统的整体设计时，
22 考虑一个线路巡回模块是很有必要的。
在智能巡检系统中，考虑到线路巡回的需求以及行业的特点，基于用户可操 作、开发人员易维护的原则，线路巡回模块主要包括巡回线路信息和巡回线路计 划两个部分，具体作如下的功能设计：
(1)在线路巡回信息子模块中，用户可通过百度地图这一可视化地理显示 工具制定线路，对己制定好的巡回线路进行修改或者删除，提供通过关键字段快 速查询线路，提供详细查看巡回线路信息。
(2)在线路巡回计划子模块中，用户可以将已制定好的巡回路线指派给相 关的巡检人员，并设置该计划任务执行的开始时间和结束时间。对错误的线路巡 回任务提供修改或删除,提供通过一个或者多个甚至全部关键字段快速查询已制 定好的巡回线路，提供详细查看己制定好的巡回线路计划。
「开始)


图3-6线路巡回模块流程图
根据上述的功能设计，线路巡回模块分成两个页面，一个页面负责巡回线路 信息子模块，另一个页面负责巡回线路计划子模块。在巡回线路信息管理页面， 以列表的形式给出了所有制定好的巡回线路的一些关键信息，当用户双击某一行 时，将在页面下半部分展现制定好的巡检路线。提供了选择框，用户可以通过选 中一个或多个选择框，将对应的巡回线路删除。提供了快速查询功能，用户可通 过线路编号这一关键字段快速的查询线路。此外，还提供了添加线路按钮，点击 它，将跳转到添加线路信息子页面，该子页面借助了百度地图这一可视化地理显 示工具，用户可以很方便的制定巡回线路。在巡回计划管理页面，以列表的形式 列出了所有制定好的巡回线路计划的一些关键信息。当用户双击某一行时，将在 页面的下半部分展现规划好的线路巡回计划。每一行信息前面有一个选择框，用 户可以通过选中一个或多个选择框，将对应的线路巡回计划删除。提供了快速查 询功能，用户可通过一个或多个甚至全部关键字段对线路巡回计划进行过滤与筛
23 选。另外，在页面上设置了一个添加计划按钮，点击该按钮将弹出一个对话框， 用户通过在该对话框中填写相应的信息实现线路巡回计划的制定。
在添加巡回线路过程中，为了直观、方便及精确的制定巡回路线，用户可以 直接在百度地图上双击产生一系列的标记点，用直线连接这些标记点形成用户所 需的线路；同时，允许用户通过拖拽制定好的线路上的标记点来改变线路轨迹； 对于产生的错误的标记点，用户只需在该标记点上双击就可以在地图上取消该标 记点，同时该标记点的前后标记点会自动连接成一条直线。
为了便于用户的查看，在制定巡回线路时，我们还需要添加了一些线路的基 本信息，用以描述该条线路或巡检人员在执行该任务是应当着重查看的地段。具 体地，每一条巡检线路都由线路的基本信息和标记点信息组成。基本信息主要包 括线路的编号，线路的起点、线路的终点、备注信息组成。线路的编号是用户必 须输入的字段，该项作为该条巡回线路在数据表中的主键，是本条线路的唯一标 示。一旦该条线路巡回信息存储到数据库后，线路的编号将无法再更改。标记点 信息为该条线路上的标记点的经纬度信息，当用户通过鼠标双击地图时，会获取 到该点的经纬度信息.我们在页面设计了一个具体信息框，用以显示各个点的经 纬度信息.对于精确度要求很高的线路巡检，用户也可以直接在该具体信息框中输 入标记点的经纬度信息。
在线路巡回模块中，百度地图画线是重点，也是难点。为了实现上述添加线 路的功能，我们必须要使用数组，通过数组来记录各个点的的经纬度、地图标记 等信息。并且按照数组中的经纬度信息来绘制巡回线路，同时通过事件侦听函数 来完成对数组数据的修改，然后通过更新后的数组来重新绘制巡回线路。具体地， 我们需要对在加载到页面的百度地图设置地图双击的监听事件，当用户通过鼠标 双击地图时，将触发该监听事件函数，在该监听事件函数中，我们首先将该点压 入到点数组中，同时，获取该点的经纬度信息，将其拼装成特定的形式存储到经 纬度数组中，然后，调用百度地图API提供的方法对该点添加标记，将该标记 存储到标记数组中，并在地图上显示出来。最后，调用画线函数，在该函数中， 我们首先判断，点数组中是否只存在一个点，如果是，则结束。否则，循环读取 出经纬度数组中的GPS信息，通过调用百度地图API将这些点通过直线连接起 来形成一条巡检线路。在用户的实际操作中，用户有可能在画线时做修改。因此, 为了便于用户的操作和实现对所画的巡检路线进行修改，我们还需要对每一个双 击产生的标记点设置一些其他的监听事件。在本智能巡检系统中，考虑到实际需 求情况。我们将对地图上的标记点设置双击的监听事件和拖拽的监听事件。当用 户对地图上的标记点双击时，将触发该标记点双击监听事件，在该事件中，我们 首先在要清理地图上的图层，眞次，将该标记删除。具体做法是，循环读取标记
24

数组中的数据，将读取出的数据与双击的标记比较，如果是，则该标记点从地图 中移除以及通过数组的spice函数将相对应的点从点数组、标记数组和经纬度数 组中删除。最后，调用画线函数，根据更新后的经纬度数组重新连线。当用户对 地图上的标记点拖拽时，将触发该标记点的拖拽监听事件，在该事件函数中，同 上，我们首先要清理地图上的图层，其次，记录标记点拖拽后的经纬度，循环读 取标记数组中的数据，将读取的数据与拖拽前的标记点比较，找到该标记点在原 来点数组和标记数组中的位置，用拖拽后的标记点及其经纬度替换原来的数据。 最后，调用画线函数，根据更新后的经纬度数组重新画线。

删除标记数组和经纬
度数组中相应的数据
根据经纬度和标记
数组画线
图3-7地图画线算法流程图
在线路巡回模块中，浏览器端与服务器端的交互影响均是通过对数据库表字 段的增加、删除、修改、查询等操作实现的。因此，线路巡回模块中数据库表的 设计是实现线路巡回模块必不可缺的一部分。根据上述的功能需求和业务分析， 我们设计了三张数据库表：巡回线路信息表(T_Patrollineinfo)、巡回线路标记 点信息表(T_P.atrollinepoint)、巡回线路计划信息表(T_Patrolrule)。巡回线路 信息表用来存储一条巡回线路的基本信息，巡回线路标记点信息表用来存储一条
25
巡回线路的GPS信息及其先后顺序，巡回线路计划信息表用来存储一条线路巡 回计划信息。由此可见，一条巡回线路的所有信息是通过两张表的存储来联合表 示的。这么做的好处是可以有效地提高存储效率，因为，在一条巡回线路中，存 在很多个标记点，由于这些标记点都属于同一条巡回线路，因此，它们的基本信 息是一样的。如果通过一张表的存储将会存在很多基本信息的冗余导致存储效率 较低。数据库中表的设计如下所示：
表3-1巡回线路基本信息表
表名	T Patrollineinfo
署主	YDS	　■汶】二1龍;「云
说明
主键	patrollineid
字段名称	　　字段含义	字段类型	默认值	备注
patroll ineid	　　线路的编号	varchar(4)	n	线路的唯i标识
beginpoint	　　线路的起点	varchar(20)		线路的起点信息
endpoint	　　线路的终点	varchar(20)		线路的终点信息
memo	备注	tinytext	If	线路的备注信息
表3-2巡回线路标记点信息表

表名	T Patrol 1 i nepoint
署主	YDS
说明	巡回线"信息表
主键	patrol Line id
字段名称	字段含义	字段类型	默认值	备注
patrollineid	线路编号	varchar(4)		　　线路编号
pointorder	线路点编号	int	0	线路中标记点的 顺序编号
longitude	经度	float	0	　　点的经度
latitude	纬度	float	0	　　点的纬度
表3-3巡回线路计划信息表

表名	T Patrolrule
署主	YDS
说明	土E龙项""二口表
主键	lineplanid
字段名称	　　字段含义	字段类型	　　　默认值	备注
lineplanid	　　计划编号	int
； ■	　　　"""		线路巡回计'划的 唯一标识
driverid	　　司机编号	varchar(4)		执行计划的巡检 人员编号
patrollineid	　　线路编号	varchar(4)		该计划线路编号
starttime	　　开始时间	datetime	2014-01-01
00:00:00	计划开始时间
26

（续上表）
字段名称		字段含义	字段类型	默认值	备注
endtime	结束时间	datetime	2014-01-00
23:59:59	计划结束时间
memo	　　　计划备注	varchar(200)	it	计划的备注信息

3.2.2线路巡回模块的实现
根据上述线路巡回模块的设计需求，我们将分别实现巡回线路信息和巡回线 路计划的添加、删除、查询、修改及详细显示。
1.线路添加的实现
步骤一、加载添加线路信息页面
在巡回线路信息管理页面设置了一个添加线路的按钮，用户通过点击它跳转 到添加线路信息页面。具体地，我们对添加线路按钮设置了一个点击触发事件， 用户点击时将触发该事件，在函数中，写入了 parent.location.href="<umpay:newUrl url='7pm/patrollineinfoAdd.pm7>,+'&start=start"方法»Href 链接的目的是把带有参 数的请求发往服务器端，服务器端根据相应的参数返回了一个添加线路的模型和 视图，客户端解析该模型和视图，为用户呈现出添加线路页面，成功的完成了上 述跳转。在添加线路信息页面的右侧，通过div、textbox> lable、button这些控 件的相应组合形式将巡回线路的基本信息显示出来，并且为了显示的整齐，我们 将上述控件按照相关次序放在一个Table的控件中。基本信息的布局显示如下， 其中，我们设置了一个检验按钮，当用户在文本框中填写完区域编号后，通过点 击该检验按钮向服务器发送査询请求，服务器查询数据库中是否己有此区域编 号，如果有，弹框提示用户已存在此区域编号，请重新输入。
钏摇信息
线路基本指息
孀瞧：
痂席：
—
喩经点：
备注德悬
添加 重養；
图3-8线路基本信息布局
步骤二、地图上巡回线路制定
首先在添加线路页面中，加载百度地图，方法与3.1.2节相同。注意，为了
代码的简洁性和高效性，在本部分，我们需将该地图声明成一个全局变量，方法
27 为window.map = map。对于加载的地图我们设置了双击监听事件。当用户双击 地图时，将触发该事件函数。在该函数中，第一步，将该点存储到点数组中，获 取用户双击地图时点的经纬度信息并拼装成特定的形式存储到经纬度信息数组 中。第二步，对每一个双击地图上的点，我们设计了一个addrong(e.point)函数用 以对该点生成标记和对标记设置相应的监听事件，在addrong (e.point)函数中， 首先，根据传递进来的经纬度参数，通过调用百度地图API提供的方法生成一 个标记，其次，将生成的标记存储到标记数组中，并设置标记的相关属性，比如: 大小、颜色、能否拖拽等。最后，将该标记添加在百度地图的图层上，达到显示 的效果。第三步，调用画线函数drawPolyline(),在该函数中，首先，判断点数 组中是否只存在一个点，如果是，则结束。否则，清除地图上所有的线路图层， 根据经纬度数组中的GPS信息，通过调用百度地图API提供的画线函数画线， 同时，设置该线路的相关属性，如颜色、粗细等，最后将该线路添加到百度地图 的图层上。
在实际情况中，用户在制定线路时，可能需要对线路做一些修改，使得制定 的线路精确性较高。为此，在本系统中，我们考虑了两种操作。一种是当用户双 击标记点时将在地图上删除该标记点，并且标记点的前后标记点自动连接成一条 线路。另一种是用户可以在地图上通过拖拽标记点来改变线路轨迹。为了实现上 述两种功能，我们将对地图上的标记点设置双击的监听事件和拖拽的监听事件。
在上述两种监听事件中，都会涉及到对各种数组中的数据元素进行修改，在 智能巡检系统的开发中，我们将借助数组中的splice函数。splice函数的功能是 在指定的位置对数组中的数据进行修改，它的使用方式为 arrayObject.splice(index,howmany,elementl,	....,elementX) [l3h
当用户对地图上的标记点双击时，将触发该标记点双击监听事件函数。在 该函数中，首先，调用deleteMarker(marker)函数删除该标记，具体地，在 deleteMarker(marker)函数中，循环读取标记数组中的数据，将读取出的数据与传 递进来的参数marker (双击点的标记)比较，如果相等，则调用移岀层方法将该标 记点从地图中移除，并且通过数组的spice函数将相对应的点从相关数组中删除。 即通过markersArray.splice(i, 1)将标记从标记数组中删除，通过latLngs.splice(i, 1) 将该点的经纬度信息从经纬度数组中删除，通过points.splice(2*i,2)该点从点数组 中移除。最后，调用前面提及的画线函数drawPolylineO,根据更新后的经纬度 数组重新连线。
当用户对地图上的标记点拖拽时，将触发该标记点的拖拽监听事件函数。在 该事件函数中，首先，调用relocateMarker(marker,e)函数更新数组。具体地， relocateMarker(marker.e)函数中，循环读取标记数组中的数据，将读取的数据与
28

传递进来的参数marker (拖拽前该点的标记)比较，找到该标记点在原来点数组 和标记数组中的位置，更新数组中相对应的信息。即通过latLngs[i]=e.point;将拖 拽后点经纬度信息更新到经纬度数组中，通过points[2*i]="("+e.point.lat和 points[2*i+l]=e.point.lng+")"将拖拽用拖拽后的标记点更行到点数组中。最后，调 用画线函数drawPolyline(),根据更新后的经纬度数组重新画线。



步骤三、保存巡回线路信息
用户在地图上画好线路后，通过点击确定按钮将线路信息保存到服务器的数
据库中。根据成功与否，给予不同的提示框。



图3-11线路存储提示框
2.线路查询的实现
步骤一、查询按钮的实现
在线路巡回信息管理页面，提供了通过用户设置的查询条件快速查询巡回线 路信息。具体地，通过 <input type="text" name="nametxt"id="nametxt" value="${nametxt}" />在页面中设置了一个文本输入框，用户在该文本匡中输入 线路编号，通过点击查询按钮向服务器端发起查询请求并将线路编号这一参数传
29
递给服务器。另外，我们还设置了一个重置按钮，清除用户设置的查询条件。
线路编号：	§ K香面厂重置I
图3-12区域查询界面
步骤二、服务器接受请求，查询并返回结果
服务器patrollineinfbController接受该请求，指派业务逻辑层的 patrollineinfoService和patrollineinfoDao处理该请求，业务逻辑层根据Ibatis配置 文件链接到数据库。根据参数在数据库中查询，将查询结果拼装成特定的 pageBean□ patrollineinfoController 指定 areainfbView 来解析该模型和视图「门，将 其显示在页面上。该部分的代码实现与3.2.2节的司机信息查询类似。


图3-13煥路查询的信息流程
线路删除、详细显示线路信息、巡回线路计划的增、删、改、查等功能的实 现与上述过程类似，在此不再赘述。
3. 3区域巡回模块的设计与实现
3. 3. 1区域巡回模块的设计
在实际中，一些企业为了保护它的基础设施，通常会在一些重点的区域内设 置宣传标语。例如，在通信行业，运营商会指派巡检人员在某一区域悬挂宣传标 语“爱护光纤，人人有责”。通常，这些宣传区域是由企业的管理者事先规划制 定好的，.然后分配给相关的巡检人员，巡检人员接受该区域宣传任务后，将宣传 标语带到相应的区域。在该区域内寻找一个比较适合的点（例如：人流量最大的
30 地点或该区域内设施损坏频率最严重的地点）悬挂宣传标语。在巡检人员工作的 过程中，随身携带的智能终端会随时向监控中心的服务器上传它的经纬度信息， 服务器根据上传的经纬度信息检测他是否越界。如果越界，服务器将向智能终端 推送通知，提醒巡检人员。另外，巡检人员亦可通过智能终端向监控中心上报作 业情况，以便管理人员了解宣传的作业情况。
基于上述需求分析，在智能巡检系统的设计时，考虑一个区域巡回模块是很 有必要的。在该模块中，我们做如下的功能设计：（1）用户可通过百度地图可视 化地制定区巡回区域。（2）把所有制定好的巡回区域以列表的形式将其关键字段 呈现出来，当用户单击某一具体行时，将详细的展现该巡回区域信息。（3）对已 制定好的巡回区域提供修改和删除。（4）用户可通过一个或多个关键字段的组合 快速查询巡回区域。


图3-14区域巡回模块流程图
在制作巡回区域过程中，为了直观、方便以及精确的制定巡回区域，管理人 员可直接在百度地图上双击产生两个点。其中，第一个点为圆心，第二点为圆上 的一点。通过这两个点，我们可以形成了一个以二者的距离为半径，第一个点为 圆心的圆。用户通过拖动这两个点，可动态的调整区域范围，形成所需巡回区域。
为了便于用户的查看，在制定巡回区域时，我们还需要添加了一些其它信息, 用以描述该巡回区域。具体地，每一个巡回区域都由区域的基本信息和地理化信 息组成。基本信息主要包括区域的编号，区域的名称、宣传内容组成。其中，区 域的编号是用户在制定线路时必须输入的字段，它作为该条巡回区域在数据表中 的主键，是该区域的唯一标示。且一旦该巡回区域信息存储到数据库后，区域的
31
编号将无法更改。区域的名称则是通过文字阐述该区域的地名。宣传内容用来描 述巡检人员在该宣传区域内要进行哪些宣传工作或是宣传标语的悬挂。地理化信 息主要包括该巡回区域的圆心的经纬度信息及该区域的半径。当用户在地图制定 区域时，我们在页面设计了两个信息框，用以动态的显示区域的中心经纬度信息 和区域的半径。对于精确度要求很高的区域巡回，用户也可以直接在这两个信息 框中输入圆心的经纬度和半径。
根据上述区域制定的方法，在制定区域时，我们需要通过计算地图两点之间 的距离来得到圆的半径。即我们需要通过这两点的经纬度信息来计算它们之间的 球面距离。在实际情况中，巡回区域的半径远小于地球半径，因此，在本系统中， 我们不考虑圆心与圆上的点在地球的不同半球上，只考虑两点位于同一半球的情 况。对于地球表面上两点A(w】,jj)、B(w2, j2),其中Wj为纬度，/为经度。 它们之间的球面距离做如下的推导［坷：
如图3-15所示，a、b为A、B两点所在的经线平面，1为地轴，MO、NO 为赤道平面与此二面角的交线，0为地心，地球半径为R ,过A作AC11,过 C 作 DC丄 1, BD〃1。

B

图3・15球面上两点
在 ZiACD 中，AC =7?-cos Wj , DC=7? -cosw2, ZACB=y1 - j2
据余弦定理可得：
AD2 =(R・cos叫T +(R・cos*2)2 —2R2.COs w,cosw2 cos(7j -j2)	(3-1)
•/ DB = DE+BE = J?・ sin 叫 + R • sin w2
又•- AABD^RtA,
/. ab2=ad2+db2
AB2 =2R2 — 2R2 cos叫 cos w2 cos(- J2) + 2J?2 sin叫 sinmz2	(3-2)

在AAOB 中，知道了 AB,且 AO=BO=R» 设ZAOB=。
由余弦定理可得：cos a = coswj cos w2 cos(Jt — j2 )—sin W] sinw2	(3-3)
a = arccos (cosW]COSW2Cos(j] - j2) - sinWjSinWj)	(3-4)
a为A、B两点所成的球心角
A、B两点之间的球面距离即为过A、B两点的大圆的劣弧，即：
球面距离=^^^2俎	(3-5)
特殊情况，当丄=&时，a= W]-w2 =
利用上面的球面距离公式，我们可以通过获取地图上两点的经纬度信息来计 算出以他们作为圆心和圆上的点的圆的半径大小。以区域圆心的经纬度和半径作 为参数，调用百度地图API提供的画圆函数，则可以在地图上画出相应的巡回 区域。具体地，在添加区域巡回信息页面，我们对加载到页面的地图的添加地图 双击监听事件，当用户双击地图时，将触发该监听事件，在该监听事件函数中，首先 判断标记数组中的元素个数，如果大于1个测弹框提示已有两个点；否则，获取 该点的经纬度信息并存储到经纬度数组中，对该点添加标记并存储到标记数组 中。然后，判断标记数组中的元素个数是否等于2,如果是，则读取经纬度度数 组中的这两个经纬度信息，利用上述的球面距离公式，计算出半径，以第一个点 的经纬度和所得半径为参数，调用百度地图API中画圆函数实现区域制定。
在管理人员在实际制定巡回区域时，为了提高精确度，需要动态的调整这两 个点位置。因此，为了便于管理人员的操作和实现对所制定的区域巡回进行修改, 我们还需要对地图上双击产生的标T己点设置一些其他的监听事件。在本系统中， 考虑到用户的实际情况。我们将对地图上的标记点设置双击的监听事件和拖拽的 监听事件。当用户对地图上的标记点双击时，将触发该标记点双击监听事件，在 该事件中，我们首先在要清理地图上的图层，然后，将该标记删除。具体做法是, 循环读取标记数组中的数据，把读取出来的数据与双击的标记比较，判断该标记 在数组中的位置，通过数组的spice函数将对应位置的数据从标记数组和经纬度 数组中删除，并在地图上移除该标记[20][2,]o当用户对地图上的标记点拖拽时， 将触发该标记点的拖拽监听事件，在该事件函数中，同上，我们首先要清理地图 上的图层，其次，记录标记点拖拽后的经纬度，循环读取标记数组中的数据，将 读取出的数据与拖拽前的标记点比较，找到该标记点在标记数组中的具体位置， 用拖拽后的标记点及其经纬度信息更新标记数组和经纬度数组中的数据。最后， 判断更新后的标记数组中的元素个数是否等于2,如果是，以经纬度数组中的数 据为参数，调用地图的画圆方法在地图上制定巡回区域。
33
个数小于
"2个
创建标记 保存经纬度和标记至U —相应数组中
'无拖拽
有拖拽
循环读取标记数组中
的数据
不相等
与拖拽的前的标记 做比较
不相等/ " '
L /与双击的标记做
比较
相等
相等
* ..1
在地图上删除该标记，
添加标记的拖拽和双
击监听事件
i更行经纬義数组和标
记数组对应位置的数
I .据］
冊4除标记数组和经纬
度数组中对应位置的
数据
不是
判断标记数组中元
素是否为z个
是
根据经纬度数组画圆
图3-16巡回区域制定的算法流程
在区域巡回模块中，客户端与服务器端之间的交互影响均是通过对数据库中 相应表的增加、查询、修改、删除等操作实现的。因此，区域巡回模块中数据库 表的设计是实现区域巡回模块必不可缺的一部分。根据上述功能需求和业务分 析，我们设计了一张区域信息表(T_AreaInfo)：保存区域信息，包括唯一标识id、 区域的圆心、区域的半径等重要信息。数据库表的详细设计如下所示：
表3-4巡回区域信息表
表名 署主 说明
回区域信息表

主键
34







































3.3.2区域巡回模块的实现
区域的查询、修改、删除等功能的实现与线路巡回模块类似，不再赘述。区 域添加是该模块中的重点，也是难点。下面我们着重介绍该功能的实现。
步骤一、加载添加区域巡回信息页面
在区域巡回信息管理页面设置了一个添加区域的按钮，用户通过点击它跳转 到添加线路信息页面。具体地，我们对添加线路按钮设置了一个点击触发事件， 用户点击时将触发该事件，在该事件函数中，我们写入了 parent.location.href='<umpay:newUrl url="/pm/areainfoAdd.pm'7>'+'&start=start'方 法。Href链接的目的是为了向服务器发送添加区域的请求，并传递参数给服务 器端，服务器端Controller根据相应的参数调用一个添加线路的模型和视图，解 析该模型和视图，为用户呈现出添加区域巡回信息页面，成功的完成了上述跳转。 在添加区域巡回信息页面的右侧，通过组合运用div、textbox、legend、button 这些控件，将巡回区域的整个信息显示出来，并且为了显示的整齐，我们将上述 控件按照相关次序放在一个Table的控件中。基本信息的布局显示如下图，其中， 我们设置了一个检验按钮，当用户在文本框中填写完区域编号后，通过点击该检 验按钮向服务器发送查询请求，服务器查询数据库中是否己有此区域编号，如果 有，弹框提示用户已存在此区域编号，请重新输入。另外，还设计了区域中心、 区域半径两个文本框，分别用来动态显示所画区域中心的经纬度信息和区域半 径。为了提高精确度，用户也可在这两个文本框中手动输入来制定巡回区域。


图3-17区域巡回信息布局
步骤二：地图上巡回区域的制定
35
首先在添加巡回区域页面初始化时，加载百度地图，实现方法与3丄2节相 同。为了提高代码的简洁性和高效性，在加载方法中，我们将地图变量(map) 声明成一个全局变量，实现方法为window.map = map。对于加载到页面的百度 地图我们设置了双击监听事件函数。当用户双击地图时，将触发该事件函数。在 该函数中：第一步：判断标记数组中的元素个数是否大于1个，如果满足，则弹 框提示用户地图上己具备构成圆条件的两个点，请先双击地图标记取消某一点。 如果不满足，获取用户双击地图时点的经纬度信息并拼装成特定的形式存储到经 纬度信息数组中；同时，对该点调用百度地图API提供的标记生成方法生成标 记并设置标记的相关属性，比如：大小、颜色、能否拖拽等，然后，把标记存储 到标记数组中，最后，将该标记添加在百度地图的图层上，达到显示的效果。第 二步：判断标记数组中的元素个数是否等于2个，如果不是，则继续监听用户第 地图的双击操作哦。如果是，则读取经纬度数组中的2个元素，通过公式3-5计 算出这两点之间的球面距离。第三步，经纬度信息数组中第一个经纬度信息和计 算所得球面距离为半径分别作为区域的圆心和半径，通过调用地图API的画圆 函数实现画圆，同时，设置该圆的相关属性，如圆环的颜色、粗细，区域的填充 颜色等，最后将所得的巡回区域添加到地图的图层上显示出来。
在实际情况中，用户在制定巡回区域过程中，可能需要对区域做一些动态的 调整，使得用户操作简便且制定的区域准确性较高。为此，在本系统中，我们考 虑了两种操作。一种是当用户双击标记点时将在地图上删除该标记点。另一种是 用户可以在地图上通过拖拽标记点来动态调整巡回区域的大小和位置。为了实现 上述两种功能，我们将对地图上的标记点设置双击的监听事件和拖拽的监听事 件。
当用户对地图上的标记点做双击操作时，将触发该标记点的双击监听事件函 数。在该事件函数中，首先，循环读取标记数组中的数据，将读取岀的数据与该 双击点的标记做比较，找到该标记点在标记数组中的位置信息，调用地图API 提供的移除层的方法将该标记点从地图中移除，并且根据所获取到的位置信息， 通过调用数组的spice函数，将对应的标记信息和经纬度信息从标记数组和经纬 度信息数组中删除。即通过markers Array. spl i c e(i, 1)将标记从标记数组中删除， 通过latLngs.splice(i, 1)将该点的经纬度信息从经纬度数组中删除。
当用户对地图上的标记点拖拽时，将触发该标记点的拖拽监听事件函数。在 该事件函数中，首先，循环读取标记数组中的数据，将读取的数据与拖拽前该点 的标记比较，找到拖拽标记点在标记数组中的位置，根据所得的位置信息，更新 经纬度信息数组。即通过latLngs[i]=e.point;将拖拽后点经纬度信息更新到经纬度 数组中。最后，判断标记数组中元素的个数是否等于2个。如果是，则调用画圆
36


图3-19拖拽标记前后对比
步骤三、保存巡回区域信息
用户在地图上画好区域后，通过点击确定按钮向服务器发送添加请求，服务 器端的TAreainfbController将接受该服务请求，指派业务逻辑层的areainfo Service 和tAreainfbDAO处理该请求，tAreainfbDAO通过Ibatis的配置文件将区域信息 插入到数据库中。根据插入的成功与否，TAreainfoController返回两种不同的 ModelAndView。
成功添加巡回玆路信息	ylx	添加遂回线路信息失败
. - < - : - ■ ■- - - "
图3-20区域添加提示框
部分核心代码如下：
Controller端的核心代码：
public class TAreainfbController extends MultiActionController
public ModelAndView areainfbAdd(HttpServletRequest request, HttpServletResponse response) throws Exception
{
areainfb.setAreaidCrequest.getParameterC^reaid"));
〃从请求参数中获取区域编号 areainfo.setAreaname(request.getParameter("areaname"));
〃从请求参数中获取区域名称 areainfb.setArearadius(Float.parseFloat(request.getParameter("arearadius"))); 〃请求参数中获取半径 areainfb.setMemo(request.getParameter("memo"));
〃请求参数中获取宣传内容
String latLng=request.getParameter("point");
〃请求参数中获取经纬度信息
latLng=latLng.replace("(",””).replace。')"，"").replace(" ",
StringO cc=latLng.split(",")； areainfd.setArealng(Float.parseFloat(cc[0])); areainfb.setArealat(Float.parseFloat(cc[l]));
try
{ this.areainfbService.addAreainfo(areainfb); retMap.put("message",”成功添加区域信息”)； retMap.put("layoutflash", "true");
return new ModelAndView(this.successView, retMap);
} catch (Exception e)
{retMap.put("message",”添加区域巡回信息失败，
return new ModelAndView(this.fhilVew, retMap);}
)
}
Model端Service层核心代码：
public class AreainfoServicelmpl implements AreainfoService
public void addAreainfb(TAreainfb record) throws DataAccessException
{
this.tAreainfbDAO.insert(record);//调用 Dao 插入数据
}
}
38
Model端Dao层核心代码
public class TAreainfoDAOImpl extends SqlMapCIientDaoSiqjport implements
TAreainfoDAO (
public void insert(TAreainfo record)
{getSqlMapClientTemplateO-insert("T_AREAINFO.insert", record);}
〃将区域信息插入数据库中
User areainfoQueryaredii儡A也漪p	TAfeainfeCentroller AreainfbS^vice | TAreatoibDAO
rJ-
1.增加巡回区域信&	!	!	!	：
；	.-	■	I	t	•
i	：	i	i	i
；	；2.fKBentJocation.href ；	'	'	；
!	s	—	h	:	i	：
!	:	^	：	:	I
；	；	L/pm/areainfoAdd.pm ；	；	I
!	: y fi ：丨
•	:	；	4一调用 areainfoService 中的 addAreaiufbO方法	!
；	；	\	\	5调用tAreainfbDAO中insert ()方法
图3-21添加巡回区域流程图
3.4小结
本章根据智能巡检系统中管理人员对地图模块的页面管理和操作的功能需 求，结合页面设计的一些基本原则和要求，从用户体验的角度出发，设计了平台 端地图模块的三大功能子模块：实时监控、线路巡回、区域巡回。通过HTML、 JSP、脚本语言等相关技术，给出了实现这三个功能子模块的一些关键步骤。本 文所提出的方法很好地满足了智能巡检系统中平台端的设计需求,为管理人员提 供了有效且简单的操作。
39





























































40


第四章Android端地图模块的设计与实现
4. 1 Android端地图模块的设计
在本智能巡检系统中，为了实现巡检人员和监控中心的交互，我们开发了一 个Android应用程序(Patrolsystem)。巡检人员携带安装有该应用程序的智能手机 进行巡检工作，根据作业现场情况，实时的向监控中心上报；监控中心根据上报 的信息，向巡检人员下发相应的指令；巡检人员接收到指令后作出相应的处理。
为了使得巡检人员能够实时的查看自己的地理位置信息以及查看自己的巡 检路线、巡回区域，在智能终端的应用程序设计时，我们考虑了一个地图模块， 该模块提供一下的功能：
(1)在地图界面的顶端显示用户的地理位置信息，包括经纬度信息和地址 信息。在地图界面的地图上添加图标显示用户的当前位置，且当用户位置变化时， 能在界面上实时的更新地理位置信息。
(2)在地图界面的地图上显示巡检人员的巡检任务(巡检线路或巡回区域)。 用户将自己当前的位置与巡检任务对比，调整自己的巡检路线，提高巡检效率。
(3)提供精确定位功能，即巡检人员手动输入目的地的经度和维度信息， 根据该信息在地图上查找到目的地并显示出来。
为了实现上述第一个功能，我们将通过智能手机的GPS模块来获取巡检人 员的当前位置信息的。然而，通过GPS设备获取的经纬度信息是WGS-84椭球 下的大地坐标，与地图的平面直角坐标不同，因此，我们要进行坐标转换，以便 用于智能巡检系统中地图模块。目前，世界各国均釆用的是高斯投影实现该转换。 即通过巳知的大地坐标系中的大地经纬度(B,L),运用高斯投影正算公式，可 得到相应的地图直角坐标系的经纬度(x,y)o设参考椭球的长半轴为a,第一偏 心率为e,高斯投影正算公式的表达式如下SH29,
x = X + 告岫 + 土 (5 -12 + 9寸 + " )Ntm：
1
+——(61-58t2 + t4)Ntmo
■	720	]丿。	(4-D
y = Nm0 + -(l-t2 + r)2)Nm0
6
+ j^(5-18t2 + t4+14n2- 58t2T]2)Nm'
41
其中，t = tanB , 1 = L - Ln , mn = IcosB, N = .	=
Vl - e2sin2B
■ e2
H2 = 	2 cos2B , L、B为转换前的经纬度坐标，X、Y为转换后的高斯坐标，Lo
1 - e
为投影带的中央经线坐标。
在Android端应用程序的地图模块中，利用上述变换公式，将收到的GPS 大地坐标位置信息转换为地图上的经纬度信息，通过该经纬度信息查询用户所在 地的地址信息。在应用程序的模块界面设置两个个文本框显示分别用来显示经纬 度信息和地址信息，以便于用户的查看。同时，我们还提供可视化的査看方式， 通过在模块界面里加载百度地图，调用地图API接口中的函数对获取到的经纬 度信息加标记，并将该标记添加到地图的图层上，可视化地显示用户当前的位置。 在实际巡检工作中，巡检人员进行寻巡检任务时会不停的移动。因此，为了实时 获取位置信息，我们需要对巡检人员的移动设置监听函数。在该监听函数中，判 断用户位置是否发生变化，如果是，则获取变化后的经纬度信息，并通过更新后 的经纬度信息查询地址信息，然后在文本框中更新经纬度信息和地址信息，同时， 通过经纬度信息更新地图上的标记。
获取GPS经纬度
A信息并转换为地
图经纬度信息


图4-1 Android端地图界面实时位置信息
在实现上述第二个功能时，为了便于用户的使用，以及避免用户每次查看任 务时，都得向服务器发送服务请求。在设计应用程序时，我们将把监控中心下发 的巡检任务存储到Android手机中，这样用户再次查看巡检任务时，只需要读取 出智能终端中存储的巡检任务，有效地减小了 Android端应用程序和服务器之间 的数据传输量，避免了传输所造成的用户等待时间。尤其是当巡检人员在网路状 况不佳的地点时，采用这种方式优点更明显。具体地：巡检人员通过用户名和密
42 码向发服务器发起登录请求，服务器检査该巡检人员是否为合法用户，若是，在 服务器的数据库中査询巡检人员当日的巡检任务，将任务返回给客户端程序，客 户端程序将收到的巡检任务存储到手机中。为了实现上述存储功能，我们将使用 Android系统中自带的SQLite数据库。
SQLite是一款轻量级的遵循ACID的关联式开源数据库，主要由SQL编译 器、内核、后端及附件组成也】。SQLite数据库与其它类型的数据库最大的差别 在于其对数据类型的支持具有“弱类型”，即我们可以将任何数据类型放入任何 的列中，如可以把String型的数据插入到Integer型的列中。此夕卜，SQLite还具 有以下一些优点：
・所占用的系统资源非常低，一般只需要几百K的内存就可以满足了。
・ 接口支持多种开发语言，如C、Java、PerR Ruby等等。
・高效率，执行速度比大部分主流的数据库都要快。
・很好的独立性，没有任何的额依赖。
•跨平台，除支持主流的操作系统外，还支持一些其他不常用的操作系统 Android系统提供了一整创建和使用SQLite数据库的接口，包括创建数据 库、删除数据库、打开数据库、关闭数据库、创建数据库表、删除数据库表等等。 表4-1列出了数据库中最常用的几种方法。其中，Cursor类用来表示查询返回 的结果集，提供了 moveToFirst ()、moveToNext ()等方法。
表4-1 SQLite中常用方法
(返回值)方法	方法描述
create(SQLitedb)	实现创建数据库功能
open(SQLitedb)	实现打开数据库功能
getReadableDatabase()	创建或者打开_个査询数据 库
getWritableDatabase()	创建或者打开一个可写数据 库
OnUpgrade(SQLiteDatabsedb> int old, intnewVersion)	实现更新数据库功能
(long) insert(String table,String nullColumnHack^ContentValues values)	添加数据行的便捷方法
(int) deleteQ	删除数据行的便捷方法
(int) update(String table, Content Values values, String whereClause, String[] whereArgs)	更新数据行的便捷方法
(void) execSQL(String sql)	执行一个SQL语句，可以是 一个select或其他的sql语句
(Cursor) query (String table, String[] columns, String selection, String[] selectionArgs, String groupBy, String having, String orderBy, String limit)	查询指定的数据表返回一个 带游标的数据集
43
根据智能巡检系统的需求分析，在Android客户端，我们设计了巡回线路和巡回区域两 张数据库表，分别用来存储巡回线路和巡回区域的相关信息。表的设计如下：
表4-2 Android端巡回线路信息表


表4-3 Android端巡回区域信息表
表名	T Circle
署主	YDS
说明
主键	circleid
字段名称	　　　字段含义	字段类型	默认值	备注
regionid	　　K域的序号	　　1 varchar(4)		区域的标识
circlelng	　　　中心经度	float	0	»	玄域中心经度’
circlelat	　　　中心纬度	　　1	float	0		区域中心纬度
circleradius	　　　区域半径	float	0		　区域半径

4. 2Android端地图模块的实现
根据上述Android端地图模块的设计需求，我们将分一下三个子模块来实现 地图模块，这么做的好处是，模块之间的耦合性低，便于开发人员的后期维护。
＞精确定位到目的地位置模块：根据用户输入的目的地坐标（经纬和维度 信息），在地图上查找并显示目的地。
＞实时定位模块：在地图界面中文本框中实时显示用户当前的经纬度信息 和地址信息，在地图界面的地图上实时显示用户的位置。
＞巡检任务显示模块：在地图上显示用户当日的巡检任务（线路或者区 域）。
1.精确定位到目的地位置模块的实现
步骤一、界面布局
在以经纬度查找目的地位置的页面布局文件中，我们采用了绝对布局方式。 在该页面布局中，我们设置了两个文本控件，用户通过在这两个文本框中输入要 定位到的目的地的经度和纬度信息，设置了三个按钮控件，分别用作查询按钮和 地图放大、地图缩小按钮，以及一个地图控件用来加载地图。在实际开发时，必
44 须注意的是，由于我们要在界面中加载地图，因此，必须在布局文件中添加用户 申请的地图apiKey属性，否则无法加载地图。同时，必须在配置文件中添加访 问互联网的权限，以便通过网络下载地图，否则，页面上的地图将呈现成白色的 方格。
步骤二、对査询按钮设置监听
由于模块需要通过地图组件来加载地图，因此，该模块的AddressActivity 类必须继承地图类。在该AddressActivity函数中，通过findViewByld (R.id.Buttonquery)方法来找到页面布局中的査询按钮，并对该查询按钮设置监 听函数，当用户输入经纬度后点击查询按钮时，将触发监听事件函数在该监听事 件函数中，通过 if(mEditTexLatgetText().toString().equals( ““))方法判读文本框 中用户输入的经纬度信息是否为空，如果为空，则提示用户；否则，首先，获取 文本框中的经纬度信息并转换成Double型的数据；其次，将转换后的经纬度信 息再度转换为适合智能终端屏幕的经纬度信息点；然后，找到界面布局中的地图 对象，调用该对象的getController ()方法实例化一个控制器(mMapController)； 最后，通过实例化的控制器的animateTo。方法设置地图的中心位置为转换得到 的经纬度信息点，同时，设置地图的图层级。在本文中，考虑到智能巡检系统中 智能终端的屏幕大小，基于为了便于用户的操作的准则，我们将地图的放大层级 初始化为十七。
步骤三、对放大和缩小按钮设置监听
考虑到在实际操作情况中，用户需要对地图进行放大或缩小操作。因此，为 了满足用户的需求，我们在布局中设置了两个按钮分别用做地图的放大和缩小。 为了使按钮具备上述功能，需要对这两个按钮设置监听事件函数，以响应用户对 其的操作。然而，智能终端上加载的地图层级是有一定的取值范围的(位于0 到17之间)，因此，在监听事件函数中，我们首先应当判断用户的操作是否会导 致地图的层级越界，如果没有越界，则设置地图的层级为放大(或缩小)后的地 图层级；如果越界，则通过showDialog()方式提醒用户地图不能再放大或缩小。
45



图4-2 Android端精确定位到目的地位置模块算法流程
2.实时定位模块的实现
步骤一、实时定位界面的布局
在实时定位的页面布局中，我们采用了一种相对布局方式。在页面的顶端我 们设置了两个文本框控件，分别用来实时的显示用户的当前位置的经纬度信息， 以及地址信息。设置两个按钮控件，用作地图放大和缩小。设置了一个MapView 控件用来加载地图，在该控件中，需要设置地图的相关属性，如宽度、高度、局 域界面的位置等等。值得注意的时，还需要设置apiKeyo由于该模块涉及位置 信息服务，需要用到智能终端的GPS模块，为此，我们必须在配置文件中添加 访问的一些相关权限文件，以便支持其对硬件的访问。
步骤二、获取位置信息服务
由于该子模块中包含有地图定位功能，因此，该模块的控制类必须继承地图 类。在这个类的中，首先，设置该类所关联到的页面布局。然后，可通过位置管 理类所提供的系统位置服务来获取用户的位置信息。具体地，我们需要通过实例 化一个位置管理类来获取和调用系统位置服务。由于实际存在很多的位置提供 商，因此，在获取到位置管理类的实例后，还需要根据一定的准则选取一个位置 提供商，获取到某一特定的位置提供商后，通过调用提供的方法得到用户当前的
46 位置信息。本应用程序通过标准集合法来选取最佳位置提供器，即通过一个标准 集合，让系统根据次标准集合匹配最适合的位置提供器。在本系统中，考虑到巡 检行业的特性和目前智能终端的性能，我们在标准集合设置了经纬度的粗略精确 度、电量消耗等级、是否需要返回海拔方位信息等准则。
步骤三、对用户位置设置监听函数
巡检人员在进行巡检工作时，其位置是不断变化的。因此，我们应当对用户 的位置设置监听函数，监听用户位置是否改变，并根据监听结果做出相应响应。 具体地，通过 locationManager.requestLocationUpdates (provider, 3000, 0, locationListener)注册了一个周期性的更新。在本文中，考虑到用户的巡检行业巡 检人员的位置变化快慢，釆用3000ms更新一次。其中，最后一个参数是一个位 置监听事件函数，在该事件函数中，我们写入了一个监听位置改变的方法，当用 户的位置改变时，将触发该方法。在该方法中，获取到用户新的位置信息，并调 用refieshMap ()函数，通过该函数更新用户在地图上的图标。
步骤四、在地图上实时地放置标记
为了放置定位图标的功能，我们专门设计了一个xianunderlay类，它继承了 Overlay,主要用来在一个地图组件中显示当前的位置和方向。在xianunderlay类， 我们写入了一个在地图上添加更新标记的draw ()函数。在该draw ()函数中， 首先，根据传递进来的位置信息参数获取到用户的当前经纬度信息；其次，把获 取到的经纬度信息转换为一个安卓系统的地理位置点；然后，通过地图组件提供 的投影将该地理位置点转换为终端屏幕上的一个点；最后，对画笔进行相关属性 的设置，并将位置图标绘制在画布上。
利用上述xianunderlay类，我们可以实时在地图上添加标记。具体地，首先， 判断获取到的位置信息是否为空，如果是，则提示用户无法获取到位置服务，请 检查是否打开了 GPS服务；否则，以获取到的位置信息为参数调用refreshMap ()函数，在地图上标记用户的当前位置。在re任eshMap ()函数中，为了利用 上述的xianunderlay类添加标记，我们通过ccaddress =new xianunderlay 0创建了 一个实例，然后，通过组件提供的方法获取界面的地图层;最后，将该xiammderlay 中draw ()方法所做的标记添加到终端地图的图层上，成功地将定位图标显示 在地图上。
47

图4-3 Android端实时定位模块的算法流程
3.巡检任务显示模块的实现
巡检人员当日第一次通过用户名和密码向服务器发送登录请求时，服务器通 过鉴权后会向智能终端返回巡检人员当日的巡检任务。Android端解析报文，将 巡回线路(巡检区域)信息插入到SQLite数据库的巡回线路信息(巡回区域信 息)表中，设置全局变量mission_indicator为0 ( 1 )。巡检人员点击查询按钮时, 首先判断该全局变量mission_indicato是否等于0,如果等于零，则查询巡回线路 信息表，将巡回线路显示在地图上；否则，查询巡回区域信息表，将巡回区域显 示在地图上。
在实现巡回任务加载之前，首先应当实现将服务器返回的巡回任务解析后存 储到相应SQLite数据库表中。巡回线路和巡回区域的存储流程类似，下面我们 以巡回线路为例，给出存储的实现方法。
第一步、在SQLite数据库中新建了一张巡回线路信息表(TJine)o具体地, 我们设计了一个Database SQlite类。在该类中，我们写入了一onrong ()方法, 用以实现新建一张数据库表。
因此，用户通过应用程序向服务器发送登录请求后，将接收到服务器返回的 特定格式的报文，根据相应的准则解析报文并获取到验证码和巡回线路信息，通
48
过验证码判断用户是否具有登陆程序的权限，如果有，则实例化一个 Database_SQlite对象，并调用该对象的onrong ()方法，实现在SQLite数据库 中新建一张巡回线路信息表(T_line)。
第二步、将解析的巡回路线信息存储到数据库表中。具体地，我们在 Database_SQlite类中写入了一个插入函数，该函数实现将传入的参数插入到相应 的数据库表中。具体代码如下：
public long insert(Strmg tl,String t2)
{
SQLiteDatabasedb=this.getWritableDatabase();
Contentvalues cv=new ContentValues();
cv.put( FIELDqiao, tl);
cv.put( FIELD_rong,t2);
long row=db.insert(TABLE^NAME, null, cv);
return row;
)
同上，循环读取经纬度信息数组，并调用实例化对象的插入方法将获取到的 巡回线路关键点的经纬度信息存储到SQLite数据库中。
/巡回线路显示的实现
步骤一、读取SQLite中的信息、转换后存储到GeoPoint型的ArrayList中
在 Database SQlite 类中，我们设计了—public Cursor select()函数，通过 该函数査询数据库中的巡回线路信息表，得到巡检人员当日巡回路线上关键点的 经纬度信息及并按点的顺序升序排列。
为了查询巡回线路信息，在巡回线路的显示的类中，我们实例化了一个 Database_SQlite对象，调用该对象的select ()方法，得到一个游标类的结果集 (line_cursor)»调用游标类的moveToNext ()方法循环读取出每一记录点的地 理位置信息，再对每一个点分别读取出它的经度信息，维度信息可通过相同的方 法得到。由于在查询时，设置了査询结果按升序排列，因此，按先后顺序，循环 获取到的经纬度信息刚好就是它在线路中的顺序。将得到的经纬度信息转换为安 卓地理位置类型的数据，并存储到列表型的gpoint数组中。最后，关闭SQLite 数据库。 -
步骤二、根据数组中的经纬度信息画巡回路线
为了在地图上添加巡回线路，我们设计了一个继承了 Overlay的LineOverlay 类。在该类中，我们写入了一个public boolean drawline()函数，通过该函数在地 图上画线。具体地，在该函数中，首先、声明了一个画笔变量，设置了画笔的相
49
关属性，如颜色、风格、粗细等等。其次，获取到页面布局文件中的地图组件， 利用该地图组件获取它的投影以便实现经纬度和智能终端屏幕的一一映射，然后, 声明了一条路径变量，循环读取经纬度数组中的数据，通过上述所得的投影将经 纬度映射到终端屏幕上一点，同时，将所得的点添加到路径中。最后，通过画布 的画路径方法将路径添加到画布上。
为了在地图上显示巡回线路信息，在巡回线路的显示的类中，我们实例化了 一个LineOverlay,该实例化对象会自动重载drawline ()方法，获取到一个画有 巡回线路的画布，然后获取地图组件的地图层，利用地图曾添加方法将该画布的 lineOverlay添加到地图上，实现了在地图上显示巡回线路。

图4-4巡回线路显示的算法流程
/巡回区域显示的实现
步骤一、查看复选框控件的实现
在实时地位界面，我们在顶端设置了一个查看复选框控件，用户通过点击该 复选框控件选择是否查看巡回任务。在类中，首先在页面布局文件中找到该复选 框，并对复选框设置监听事件函数，以响应用户的操作。在该监听事件函数中， 通过判断复选框是否被选中，来决定是否加载巡回任务。
步骤二、查询SQLite数据库巡回区域表中任务信息
该部分的实现与上述的巡回线路相同，在此不再赘述。
步骤三、在地图上画巡回区域
为了在地图上添加巡回区域，我们设计了一个继承了 Overlay的yuanunderlay 类。在 yuanunderlay 类中，我们写入了一个 public boolean drawcircle()®数，通 过该函数在地图上画圆。具体地，在drawcircle函数中，首先、我们声明了一个
50 画笔，并设置了画笔的一些属性，如颜色、风格、粗细等等。其次，获取到页面 布局文件中的地图组件，获取所得地图组件的投影以便实现经纬度和智能终端屏 幕的之间映射关系。然后，根据查询获取到的圆心经纬度，将其转换为一个安卓 地理位置点。获取到该地理位置点后，通过调用上述获取到的投影将其映射为终 端屏幕上的一点。同理，通过调用上述获取到的投影将半径映射到终端屏幕上。 最后，画布上画圆。
为了在地图上展现用户的巡回区域信息，在巡回区域的显示的类中，我们实 例化了一个yuanunderlay,这个实例化对象会自动重载drawcircle ()方法，获 取到一个画有巡回区域的画布，然后获取地图组件的地图层，利用获取到的地图 层的添加方法将该画布的circleOverlay添加到地图上，实现了在地图上显示巡回 区域。

▼
读取SQLite中数据

中心经纬度和半径转换 为终端屏幕坐标

图4-5巡回区域显示的算法流程

4.3小结
本章根据智能巡检系统中巡检人员对智能终端地图模块的界面管理和操作 的功能需求，结合设计的一些基本原则和要求，从用户体验的角度出发，设计了 安卓应用程序端地图模块的三大功能子模块：精确定位到目的地位置子模块、实 时定位子模块、巡检任务显示子模块。考虑到GPS信息坐标系与地图坐标系的 不匹配，为了实现坐标转换，我们介绍了高斯投影正算公式；在设计巡回任务的 显示子模块时，为了实现巡回任务的存储以减小安卓应用程序端与服务器的数据 交互量，我们介绍了 SQLite数据库并设计两张数据库表。最后，根据上述设计 与背景知识，给出了实现这三个功能子模块的一些关键步骤。本文所提出的方法
51


很好地满足了智能巡检系统的设计需求，为巡检人员提供了有效且简单的操作。
52









































第五章模块测试结果及分析
5.1测试环境
在完成地图模块的开发后，需要与智能巡检系统的其他模块进行联调测试 时。本智能巡检系统由智能终端（Android）和巡检平台两部分构成，在测试时， 测试参数的具体配置如下：
智能终端配置：
1.操作系统：Android 4.0
2.测试环境：室外开阔环境
3.测试速度：步行和车载
4.GPRS服务提供商：中国移动和中国电信
平台端配置：
1.网络环境：学校的局域网
2.服务器：一台支持Red Hat Linux的服务器，用来运行开发的web应用 软件和MYSQL数据库软件。
3.客户端：一台普通Window 7笔记本电脑，浏览器版本IE7.0及其以上， 为测试人员提供一个测试的平台。
4.数据库：MySQL 5.0
5. 2测试内容
本框架的测试重点是测试地图模块的功能是否完善，是否符合设计要求。因 此本章的测试只涉及地图模块内的部分，不涉及智能巡检系统的其他业务功能。 测试内容包括实时监控、线路或区域的制定、任务的显示等等。
/平台端地图模块的测试
1.实时监控模块的测试
管理人员通过用户名和密码登录到智能巡检系统，在实时监控页面中选择要 监控的时间段和监控的巡检人员，巡检人员某一时间段的巡回路线将在百度地图 上实时的展现出来。
53


图5・1实时监控
通过图5-1的测试结果表明，在其他业务模块和实时监控模块的配合下，实 时监控模块的设计能够实现将服务器中接收到的智能终端上传的位置信息实时 发送给web端浏览器，为智能巡检系统的监控用户提供必要的监控信息。
2.线路巡回模块的测试
用户登录到巡检系统后，打开线路信息页面点击添加按钮进入到添加线路信 息页面。在页面的右边，输入线路的基本信息：线路编号为0001、线路起点为 大钟寺、线路终点为北邮、宣传内容为爱护光纤。在左边的百度地图中，通过双 击鼠标产生出线路的关键标记点，通过这些标记点构成线路。在制定线路时，可 双击标记点取消该标记或拖拽标记点改变线路轨迹。


在线路信息页面，用户通过鼠标双击某一行线路信息时，将在页面的下半部 分详细的展示该条线路。例如，当双击第二行信息是，将在下方详细展现该条线 路轨迹。

图5-3线路详细信息的展示

对于错误制定的线路信息，只需要选中该条线路信息的选择框，点击删除线 路按钮，弹出删除的提示框，选择确定后，就删除该条线路，并提示成功删除线 路。







图5-4删除巡回线路
另外，为了便于用户的快速查找，我们提供通过线路编号这一关键字段快速 查询线路。
侦添to笛，冬 删除线路	　　　添加线路匡幡线路
线路编号：0004	畋阪 重责;	线路编号：	y Sig q S3
O	0001
O	0002		线路塢号
0004

-
图5-5线路快速查询

55

通过以上的测试表明，线路巡回模块提供了线路的添加、删除、查询、详细 展示等功能，达到了智能巡检系统的设计需求。
3.区域巡回模块的测试
用户登录到巡检系统后，打开区域信息信息管理页面，点击添加按钮区域进 入到添加区域巡回信息面。在页面的右边，输入区域的基本信息：区域编号为 0002、区域名称为北邮、备注信息为悬挂爱护光纤的标语。在左边的百度地图中， 通过双击鼠标产生出圆心和圆环上一点。通过这两个标记点构成一个巡回区域。 在制定区域时，可双击标记点取消该标记或拖拽标记点改变区域的大小。

图5-6巡回区域的添加
通过上述测试表明，巡回区域的添加达到了智能巡检系统的设计要求，用户 可通过该区域巡回模块方便简单地添加巡回区域。
/ Android端地图模块的测试
1.精确定位到目的地位置模块的测试
巡检人员通过用户名和密码登录到Android端应用程序(Patrolsystem),进 入到精确定位界面，手动输入经纬度信息，根据输入的经纬度信息在百度地图上 定位到目的地。
56

在百度地图上实时标记用户的当前位置，并界面的上方显示用户当前的经纬
度信息。



3.巡检任务显示模块的测试
在地图界面加载巡检人员当日的巡检任务（巡回线路或巡回区域）
57


图5-9巡回任务的显示
通过上述对Android应用程序地图模块的全面测试，表明了 Android端的地 图模块能很好地满足智能巡检系统的实际需要，功能完善，性能良好，界面友好 且符合巡检人员的操作习惯，可以很好地协助巡检人员完成巡检工作。
58
第六章总结与展望
6. 1总结
随着社会的不断发展，各种网络的结构变得越来复杂，为了维持网络的正常 运行，企业不得不派遣巡检人员对网络的线路进行维护和检査。例如，在燃气行 业，管道作为城市天然气传输的主要载体，由于地下环境的自然侵蚀、人为因素 等会造成管道损坏，为了避免影响人们的生活，天然气公司将安排巡检人员对管 道进行巡检。为了提高巡检的效率和实时的了解巡检的现场作业情况，监控中心 需要知道巡检人员的实时位置信息，这种需求在物流行业更为迫切。因此，智能 巡检系统应运而生，它旨在解决巡检行业中监控与调度需求。在本智能巡检系统 的开发中，通过深入学习SpringMVC+Ibatis Web开发框架、JavaScript、百度Map 及Java等相关技术，并对巡检行业进行调研，最后从平台端和Android端两个 维度设计并实现了地图模块的开发和维护。
本文的主要工作内容如下：
1.简要地介绍了智能巡检系统的研究背景和研究意义，给出了系统的整体 框架。
2.熟悉并掌握了 SpringMVC+Ibatis开发框架，百度地图API技术、Ajax 技术、Mysql数据库、Android平台的系统框架及重要组件的使用方法、 以及SQLite数据库。并给出了釆用这些技术实现系统开发的详细理由。
3.设计并实现了实时监控模块，管理人员可通过该模块对特定的巡检人员 某一特定时间段的巡检工作进行监控，以提高巡检的效率和巡检的到位 率，同时，便于调度中心的监控管理。
4.设计并实现了线路巡回模块，管理人员可根据巡检的实际需要在百度地 图上可视化地制定巡检人员的巡检线路，为了便于用户的操作，在制定 线路时，实现了可以拖动标记点改变线路，删除已有的标记点等功能。
5.设计并实现了区域巡回模块，管理人员可根据巡检的实际需要在百度地 图上可视化地制定区域巡回信息。为了便于用户的操作，在制定区域时, 用户可以根据需求拖动圆心或圆环上的一点改变区域的中心和区域的 大小。
6.设计并实现了 Android端的精确定位到目的地模块，通过巡检人员手动 输入的经纬度信息在地图上地位到目的地；同时，也提供更具数据的地 址信息获取经纬度信息。
59
7.设计并实现了 Android端的实时定位模块，在界面的文本框中实时的显 示用户的经纬度信息和地址信息，在界面的百度地图中实现的显示用户 当前所在的位置。
8.设计并实现了 Android端的巡回任务显示模块，在该模块中，为了减小 Android端与服务器端之间数据量的交互，我们设计了两张数据库表分 别用来存储巡回线路和巡回区域信息。当巡检人员要査看巡回任务时， 通过査询Android终端中的SQLite数据库中的信息，将当日的巡回任务
（巡回线路或巡回区域）展现在界面的地图上。
6.2展望
在信息化高速发展的今天，随着计算机和通信技术的不断发展，任何系统都 需要不断地改进和完善，巡检系统亦是如此；同时，鉴于时间和作者水平的限制， 本文还有许多不足的地方，还需要进一步的研究和完善。具体有以下几个方面：
1.系统平台端的粒度还需要进一步细化。目前，在系统参数方面灵活性不 是很高，在今后的研究中还需要改进。
2.平台端巡检任务的制定、管理和执行还有需要改善的地方。包括任务中 断等事务的处理可以更加完善，不规则多边形巡回区域的制定等。
3.在Android端应用程序中提供交通路线査找的功能，对获取到的交通线 路的每个路段进行信息提示；同时，结合上述开发的自身定位功能，实 时地矫正用户的方向和路线，使其成为一种自助的导航系统。
4.在Android端，将巡检人员的巡检轨迹保存到智能终端的SQLite数据库 里，在网络状况好的地方（如有WLAN）读取数据中的信息，将其上传 到服务器端，这样能很好地保证数据传输的可靠性。
5.随着IOS操作系统大行其道，开发苹果IOS系统的巡检软件将是下一步 的重点。
鉴于作者水平有限，时间仓促，文中存在一些缺点和不足，甚至还有谬误的 地方，敬请各位老师，专家批评指正。谢谢！
60
参考文献
[1]IDC. Worldwide Quarterly Mobile Phone Tracker[EB / OL]. [2012-11], http： //www. ide. com / getdoc. jsp?containerld=IDC_P8397#. UO_-T283uTk.
[2]Eric Armstrong, Jennifer Ball> Stephanie Bodoff. TheJ2EEl. 4 Tutorial. SunMierosystems. Inc. 2005 ： 2-25
[3]James L. Weaver, Kevin Mukhar, and Jim Crume. Beginning J2EE 1. 4： From Novice to Pmfessional. Press. 2007： 280_310
[4]刘军,戴金山.基于SpringMVC与iBATIS的轻量级Web应用研究计算机应用.2006. 5, 26(4)： 1.
[5]孙卫琴.精通Struts：基于MVC的Java Web设计与开发.电子工业出版社,2004.p321〜 324
[6]张龙祥.数据库原理与设计。人民邮电出版社，2002年1版，p50 - 60
[7]晏磊，闻辉，刘岳峰，白耕，郑江华，桂智明.基于LBs的嵌入式GIS研究一以北京 市综合交通信息平台设计为例卩].全球定位系统，2005, (03).
[8]谢吉红.浅谈城市旅游电子地图的发展前景一以厦门市为例.商业经济，2010, 11： 111—112.
[9]张永福，柳锦宝，穆扬.基于WebGIS和虚拟现实技术的城市旅游信息系统分析与设 计.航空计算技术，2008, 38(1)： 77-80.
[10]Ed Burnette. Hello, Android: introducing Google's mobile development platform.2009
[11]韩超，梁Android系统原理及开发要点详解.北京:电子工业出版社,2010.
[12]靳岩，姚尚朗.Google Android开发入门与实战.人民邮电岀版社.2009
[13]LobertL.Kruse.数据结构与程序设计.机械工业出版社.2003
[14]Bruce Eckel. Java编程思想 陈昊鹏译.北京.机械工业岀版社
[15]余志龙，陈昱勋，郑名杰等.GoogleAndroid SDK开发范例大全(第3版).人民邮电出 版社2011
[16]林宏，刘辉.Ajax核心技术及其研究应用.《山西电子技术》.2007年1期
[17]李艳红.浅谈JavaBean组件及其在JSP中的使用.《价值工程》.2012年6期
[18]卫宇.考虑地球曲率情况下两点距离问题的求解.航空兵器.2008, 03： 7-12.
[19]袁安存.全球定位系统(GPS)原理与应用.大连：海事大学出版社，1999. 11
[20]结城浩.Java多线程设计模式。中国：中国铁道出版社，2006
[21]韩延风.即用即查JavaScript核心对象参考手册.北京：人民邮电出版社，2007.
[22]安宁.基于SVG的旅游电子地图设计与发布.测绘与空间地理信息,2009,3(32)： 73〜75.
[23]朱晓华，间国年.地理信息系统技术在我国的应用及存在的问题.科技导报，2001, 5： 37—39
61
［24］	Brian D. Andrews. Techniques for GIS modeling of coastal dunes. Geomorphology. 2002, 48(1-3)289—308
［25］	齐超，何新华.车辆监控地理信息系统中的地图控制及实现.计算机自动测量与控制, 2001. 9： 33—35
［26］	陶鹏.基于GPS / GIS的车辆监控系统的设计与实现.微型机与应用，2001, 6： 40-41
［27］	冯帅.绘中集中常用坐标之间的转换［邛 硅谷，2008, (13) 56-97
［28］	石玉泉.GPS坐标与地方独立测量坐标系的转换问题研究卩］。三进测绘，2013,10 (01)：
35-36
［29］	徐悦，吴玉德，冯仲科.手持式GPS坐标转换参数解算方法卩］。林业调査规划，2009,34
(02)： 5-8
［30］	王荣.基于LBs的无线定位应用解决方案研究［硕士论文］.华东师范大学2005.
62
