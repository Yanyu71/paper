5.3网络应用内容聚类分析审计
在进行网络应用内容审计时，部分需求可以实时的完成，如本文进行的网络 终端分布情况检测，以及对网络终端实时流量检测，这都是需要实时完成的任务。 同时，有大量的网络审计需要对一个相对较长的时间段内的信息数据进行分析, 这往往就意味着需要对大量的数据进行分析。另一方面，在本文中提到的，无论是在HTML文档中提取的元素信息数据，还是对网络流量中的HTTP报文中釆 集到的用户网络信息内容数据都是可以达到TB(Terabyte)甚至是PB(Petabyte) 级别，在网络应用审计的过程中，需要通过对这些网络数据进行分析，来获取目 标网络的关键特征。当对如此巨大的数量级别数据分析时对数据分析工具以及分 析方法都提出了极高的要求，传统的数据分析工具在进行如此大数量级的数据分 析时，表现的越来越捉襟见肘。为了提高分析的准确性，提升分析的效率，分布 式大数据分析平台Hadoop的引入都是有必要和非常明智的。
网络流量中的HTTP报文广泛的应用于服务器与客户机之间进行数据传输 和信息交互。随着智能移动设备的迅速发展，因HTTP简单、快速的特点，智能 移动端的软件应用与服务器之间也广泛的使用HTTP作为数据传输，信息传递的 手段。因为智能移动设备与用户日常生活、工作有着更加紧密的联系。针对智能 移动设备产生的网络流量进行分析，更能反映网络用户的行为特征。
图5-4日志数据格式
使用网络审计设备对网络中的HTTP报文进行抓去、解析，并按照图5-4的 格式保存为日志记录，共有11个字段分别为：HTTP方法、审计设备编号、网 络终端MAC地址、网络终端IP地址、远端主机IP地址、远端主机端口号、报 文时间戳、主机地址、主机路径、Referer、Cookie。其中利用MAC来区分代表 各个用户。
对网络用户应用行为进行分析，就需要先将网络中报文特征进行提取。利用 MapReduce长于文本数据的优势进行提取，并存储为[终端操作系统类型、通讯 社交应用、购物应用]结构的记录。其中终端操作系统类型检测Windows、Android、 IOS三种类型的操作系统；通讯社交应用统计微信、QQ、微博三类；购物类应 用统计京东、淘宝这两类应用。对应某个终端系统记录中若检测不到则标记为“0 ”。 分别在原始报文中的主机地址、Referer以及Cookie中对上述字段进行匹配检测。
本文中对用户行为的分析使用了 k-modes聚类算法[281, k-modes是对经典的 聚类算法k-means的扩展。不同于k-means主要面向数值型数据处理，k-modes 长于对分类属性数据进行聚类分析。
假设两个可进行分类的对象A、B,这两个对象分别拥有n个可进行分类的 属性。则A、B可以表示为A=[ai,…，a」、B=[bi，…，bn]?那么可以用下式对A、B的相异度进行测量。
d(A,B)=￡*N(aj, bj)
如果将可分类对象中的每个属性出现的频率考虑进来，可以按照chi-square 距离【29】的定义方式将式(5-1)重新定义为
dx2(A,B)=Sj=i ma.m-6(ai- 0)	(5-3)
式(5-3)增大了对象中某个属性出现频率低的值对相异度的权重。充分利 用了低频属性信息量高的特点，提高相异度计算的准确性。
将一个可分类对象集合A中的所有元素与一个给定元素G (G是与集合中 元素同类型的可分类对象)的相异度最小，则G即为对象集合A的modeo
寻找G的方法，查找G中每个属性乡的所有可选值的组合，当满足/(gi)>/(Ci) 时(G为集合A中任意可能对象的与gi对应属性)，则G即为对象集合A的modeo 式(5-4)是函数f(x)的定义。
/应眄=勺	(5-4)
k-modes聚类定义式(5-5)为综合相异度。其中ygh是在文献［30］中定义的划 分矩阵丫朴中的一个元素。k-modes聚类的最终结果应实现式(5-5)的最小化。
E=Zg=i Sh=i yghd(Ag, Gh)	(5-5)
k-modes聚类算法步骤：
?从待处理数据中随机选择k个对象，将它们作为聚类的簇中心。
?利用上文中的相异度计算公式，遍历计算数据集中元素与簇中心间的差异度。
将元素与与其最小相异度的簇中心归为一个簇。
?利用上文中分类对象集合mode的查找方法，重新设置各个簇的中心。
?对2, 3步进行迭代，直至每个簇的中心都不再发生变化，整个计算结束。
图5-5 MapReduce实现k-modes聚类流程图
目前，大数据的聚类已经有许多研究。但是，由于聚类本身循环迭代的特征， 常规工具实现聚类算法很难达到很高的效率。本文利用Hadoop的MapReduce 计算框架分布式并行计算的特点，对上述算法进行实现，在map阶段读取用户 记录数据以及设置为DistributedCache簇中心文件，计算样本对象与簇中心间的 差度，并根据最小差异度分配到相应的簇。Reduce阶段用于重新设置簇中心， 并判断簇中心是否不再变化，或者综合相异度满足设定的阈值。当簇中心不再变 化，或者合相异度小于设定的阈值时，则输出聚类结果。否则进行下一轮迭代。利用MapReduce计算框架分布式并行计算的特点达到了较好的运算性能。将上 文中整理的数据聚为四类，得到了如下的聚类结果：
聚类结果的簇中心：
1) [Windows、QQ> 0] 2) [Windows> 微博、淘宝]
3) [Android、微信、淘宝] 4) [IOS、微信、京东]
表5-1聚类各个簇样本数
类别	1	2	3	4
数量	2573	1200	4122	1245
根据上述的聚类结果可以得出本文研究的目标网络中的终端特征如下，PC 以日常办公为主，生产工具的特性已经非常突出。网络用户的娱乐、购物行为正 大规模向移动端迁移。微信的使用量已经有很大的规模，淘宝与京东用户有一定 的分化。根据微博与淘宝之间较强的共存关系，可以推测微博对淘宝起到了较强 的流量导入效果。
