3.2.1IP报文结构分析
IP协议是网络中最为重要的协议之一。IP协议无连接、不提供可靠，转而 将这些功能交由上层协议完成。IP协议支持多种协议。IP协议将需要传输的报 文添加IP协议头后封装为IP报文后，将报文在协议栈中向下传递，进一步封装 成相应的数据组成形式，最终实现数据在网络中的传递。在不同结构类型的网络 中传输时，IP报文会封装成相应的分组在数据链路层进行传输。在目前应用最 为广泛的局域网类型——以太网中，IP报文通过封装在以太网帧的方式，在数 据链路层中传输。
如图3-1, IP报文的头部包含了丰富的信息，用于数据在网络中的传输。IP 报文头部各部分的具体含义为：版本(4bit)报头长度(4btt)优先級tlB賜细(8bft) 总长度(16bit)
标识(16bit)	标志(3bft)分段偏移(13btt)
存活鄭(8brt)	协议〈8bit)	报头模绘和(16bit)
源IP地址＜32bit)
目的IP地址＜32bit)
迭项《0或32bit,若有的话)
数据《可変)
图3-1 IP报文结构
IP报文的头部包含了非常丰富的信息，其中本文中算法使用到的部分是：
版本一4比特，用以表明IP协议的版本，根据不同的版本，IP报文具有不 同的格式。	五
IP报头长度一4比特，该字段指示整个IP报头的长度，单位是32位。因为 IP头部中存在“任选项”与“填充”两个可变的字段，所以整个IP头部的长度 也是可变的。其中，IP报头的固定长度是20个字节。所以“任选项”与“填充” 的总长度最大是40个字节。
服务类型一8比特，服务类型定义了该IP报文被处理的方式。该字段可用 于配置IP报文的优先级，当IP报文被配置了较高的优先级的情况下？如果网络 发生拥塞，报文可以被优先转发。服务类型字段可以具体配置的类型，包括，吞 吐量、时延、可靠性、费用等。
总长度一16比特，本字段指定了整个IP报文的长度，也即是报头与有效载 荷的长度之和。报文总长的单位是字节。在以太网等多种类型的数据链路中，需 要对上层的报文分组进行数据填充以达到最小帧长度的要求。那么，通过总长度 字段就可以标记实际数据的大小。
标识号一16比特，这个字段是发送者在数据报中做的一个标记。同时，该 字段也被定义为一个递增的标志，即每发送一份报文，这个字段所对应的值也会 相应的加一。这样，当IP报文被分片之后，具有相同的标识号的分片就可以认 为是来自于相同的IP报文。从而可以被正确的重新组装。该字段在下文中的终 端检测算法中也会被重点使用。
标志一3比特，标志本IP报文是否分片，以及标志本条报文在正通信数据 流中的位置。
生存期一即TTL, 8比特，用于报文的存活时间的控制。在实际的协议实现 中，大多以经过的路由器的跳数表示，报文每经过一个路由器，则TTL会相应的减一，当TTL的值变为零后，则报文就会被丢弃。同时，返回错误信息。从 而避免了报文在网络中无限传递的现象，防止了网络资源的浪费。
协议一8比特,用于表示本条IP报文的载荷是对哪种具体上层协议的封装。 如应用最为广泛的传输层协议，TCP对应的是6, UDP对应的是17。
报头校验和一16比特，用于报头正确性的检查。通过对IP报文头部每16 比特经过运算之后，将获得的校验值设置于该字段中。接受方收到报文后进行相 同的位运算，即可对报文完成完整性检验。
源IP地址一32比特，IP报文发送方的IP地址。
目的IP地址一32比特，IP报文接收方的IP地址。
可选项一可变长度，用于定义如特殊路由、时间戳、错误报告等信息。
填充一可变长度，用以保证IP报头始终TCP/IP标准所定义的头部长度必须 是32比特的整数倍。
IP头部后面就是IP报文的实际载荷的数据。IP报文的理论最大长度为65535 字节，但是，在实际的网络环境中，报文出错后，依据网络传输的纠错机制，需 要重传整个报文，如果，报文的长度过大，进行报文重传时，将会造成极大的网 络资源浪费。因此，IP报文的最大值大都限制在1500字节之下，这也是本文中 算法所要用到的一个条件。
