3.3.3IPID轨迹分析
对网络IP报文中IPID的轨迹进行分析可以得到网络中终端的数量、分布等 信息，是网络终端检测的核心组成部分。同时，因为不同系统对IP有不同的实 现，IP报文的标识号字段在不同的实现中会有不同的定义。又因为网络中存在 多种多样的终端，网络又存在多种多样的拓扑，对IPID的轨迹分析带来了极大的挑战。
根据上述IPID字段特征的分析，并通过实际检测的经验，提出了如图3-3 的IPID轨迹分析算法。
1）抓取、处理IP数据包，得到IP报文的IPID字段值以及IP报文所负荷的 传输层数据报的源端口号等信息，并存储用于下一阶段的分析处理。根 据NAT的实现，存在〈地址，端口〉对的映射，端口映射记录端口与终端 连接间的关系，且一一对应0传输层协议所使用的端口号的取值区间为[0, 65535],所以当NAT设备进行地址转换的端口映射时，端口会被循环复用。 即NAT设备对一次通信进行的地址转换，通信结束后，用于映射的端口 就有可能被循环复用,意味着端口与终端IPID轨迹对应关系存在时效性, 过期之后会端口可能被复用。于是，端口与轨迹间的对应关系也就无效
19
了。同时，考虑检测系统的性能，存储一个100个节点的序列存储报文 的端口信息，用以后期的IPID轨迹的区分。
2）	将新获取的IPID值依次与已存储的IPID值序列的末尾的值进行比较，如 果差值不大于30 （该值为工程实现中多次实验得到的网络终端数量小于 100的以太网的经验值。会根据网络的出口带宽，网络中的终端数量、拓 扑结构等的变化，进行相应的调整），则将新的IPID值加到差值最小的 序列尾部。
3）	如果岀现与多个序列差值相等的情况，出现冲突的节点开始构建新的队 列，将后续值随机插入一个序列。随后的序列按照2）中的方法进行轨迹 的构建。
4）	当出现与任意存在的轨迹序列的末尾值的差值都大于30的IPID值时， 即认为出现了一个新的终端，建立一个新的序列进行后续IPID值的存储。
5）	对3）、4）中新构建的序列，在新建立的轨迹序列中査找端口号，并与原 始序列轨迹中的端口号进行比较，发现相同的序列后，就将新建序列合 并入有相同端口号的原始序列。
6）	IPID字段有16比特，所以IPID的最大值为216-1（65535）,无论IPID值 的递增方式是针对整个操作系统，还是针对应用程序，IPID的值都是循环 使用的，也就意味着，IPID的值是循环复用的，IPID值的序列在理想状 况下会呈现周期性。设定，网络环境为目前较为常见的传输速率为 100Mbps的以太网，在平均IP包大小为150字节的情况下，则每秒网络 最多可以向外网发送83333个IP数据包，但是，考虑到拥塞控制，实际 中终端的流量状况，以及网络的实际负载能力，并根据在实际网络环境中 测试得到IPID值的循环周期约为600秒，所以以600秒为统计周期对数 据进行统计检测网络终端数。
因为，每个网络终端的活动状态具有阶段性，为了防止活跃主机，网络活动 处于一段时间的静默之后，重新开始处于网络活跃状态之后被误判为新加入主机, 故而设置主机列表的刷新时间，即为建立的IPID序列与主机的对应表对应关系 的生存时间，根据上文中的终端统计周期，并根据时间的统计经验，定义两个终 端统计周期为一个检测列表的刷新周期。
