3.3.4图相似性分析
每一个新的样本经过预处理都会生成一个此样本的权值矩阵。图的相似性比 对的目的是通过对比样本同签名数据库中的恶意家族权值矩阵的相似度来判断 此样本是否属于相应的恶意家族。图相似性比对过程又细分为以下两步：
首先，经过数据预处理，得到样本文件的权值矩阵，把这个矩阵同恶意家族 权值矩阵进行匹配,分别计算样本文件与签名库中各恶意家族签名矩阵的相似性, 此处使用样本的库函数调用矩阵。样本矩阵中的元素Wij的值为：
"=｛摄端	公式3-3
恶意家族F的库函数调用矩阵中相同位置的元素的j(F)的值为：
衙(月=備當	公式3-4
此处的相似性计算使用了 Jaccard系数，具体对应公式2,其中a与b交集的计 算公式为：
\anb\=薩鴛(Wij+啄F))/2
a与b并集的计算公式为：
|aub| =(辭眨田(Wij* 缁j(F)))/(窮:球：(Wij+%(F))) 恶意样本同每个恶意蹇族F的签名相似性SF的计算公式为：
s 」血1
F ~\aub\
SF >= 20%,则认为此样本可能具有相应的恶意特征，否则不具备这样的特征。 下面将通过伪代码的形式对相似性比较进行描述。
SIMILARITY-COMPARE
1for i inm line
2for j inmrow
3ifm[i]B]>0
4do = 1
5ifm(F)[i][j]>0
6—	dom(F)[i][j]，= l
7do mixedm[i][j]	= (m[i][j],+m(F)[i][j],)/2
8unionm[i][j] = (m[i] [j]，+m(F)[i] [j] ?)%2
9for i in m line
10for j inmrow
11do mixedSum += mixedm[i][j]
12unionSum += unionm[i][j]	.
13return mixedSum/unionSum
然后，若相似度(公共部分所占比例)大于20%,那么将计算这个样本相对于 恶意家族权值矩阵的偏移量。由于正常程序可能与恶意代码共享部分代码，所以 本系统引入了偏移量的概念。偏移量的思想体现了样本的波动性。若干大小接近 的样本在具有相同公共比例代码的前提下，若其偏移量过大，则表明此样本的波 动性较大，检测结果具有较大起伏，相应的，其检测的准确性也会较低。具体到 ACS系统中，通过计算样本权值矩阵与恶意家族权值矩阵每个对应位置元素对 应边的偏差值来计算总体的偏移量O,其计算公式如下：
o =羽驾塁聳(Vij - Vy sS 2	公式3-8
在公式3-8中，。是样本的偏移量，为是恶意家族签名矩阵中第i条命令与第j 条命令偏序的权值，Vijsample是待测样本签名矩阵中第i条命令与第j条命令的偏 序数目。我们需要统计每个恶意样本相对于恶意家族权值矩阵的偏移量，最终得 到恶意变种的置信区间(。湖，0gx)，若样本按照偏移算法得出的偏移量在这个 范围内，则说明样本可能具有恶意特征，如若不然，则说明样本的偏差过大，不 属于此恶意家族。相似性比对的流程图如下所示：
32
图3-5图相似性比对流程图
由图3-5所示，图相似性比对主要分两步执行。首先，样本的库函数调用矩 阵与恶意家族k的库函数调用矩阵进行相似性比对，若相似性小于20%则将样本 的库函数矩阵同数据库中的下一个恶意家族库函数调用矩阵进行比较，重复这一 步骤；若相似性大于20%,则计算样本的偏移量，若此偏移量落在由训练集训练 生成的置信区间，则可判定此样本属于第k个恶意家族，退出比较程序。相反， 若此偏移量落在训练集生成的置信区间之外，则继续与下一个恶意家族的库函数 调用矩阵进行对比。
