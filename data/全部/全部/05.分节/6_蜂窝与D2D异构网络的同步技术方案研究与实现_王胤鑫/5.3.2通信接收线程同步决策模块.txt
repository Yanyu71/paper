5.3.2通信接收线程同步决策模块
经过同步搜索模块后， Cell 同步和 Sync 同步搜索的结果已经存储在对应 Buffer中，同步决策模块获取相应的搜索结果信息，根据状态机的状态条件，进
行联合决策，并根据决策结果建立同步关系。
同步决策模块总体逻辑和流程如图5-3所示，同步决策模块由两部分组成， 一  是状态决策，根据状态标志和第四章分析的状态条件，完成上行状态和下行状态  的判定；二是同步建立，在状态机状态已确定的基础上，对存储于Buffer中的同  步搜索结果数据，采用相应选择算法，完成同步建立。首先判定状态标志  CELL STATE, 若为Active, 则网络中存在基站，将上行和下行置为相应状态，并  通过下行同步结果选择算法选择可靠的搜索结果完成同步建立。若为Idle, 则继  续判定状态标志D2D STATE,   若为Active, 则可同步发现其他D2D 终端，根据  上行Sync 步结果选择算法选择优先级最高的D2D 终端和搜索结果完成同步建立。
若依然为 Idle, 则确立本机为D2D 网络主机，以自身定时为基准建立同步。
42
(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net
状态决策
图5-3 通信接收线程中同步决策模块架构
由5.3.1小节已知存储同步结果的Buffer有两个， 一个用于存储Cell下行同 步搜索的结果，另一个用于存储 Sync 同步搜索的结果。用于存储同步结果的
Buffer的结构如下：
1) Cell同步搜索结果Buffer
根据5.2.1小节所介绍，小区同步搜索函数 Cell Search 函数的输出是一个存 储类型为Cell Sync Res大小为3的数组。由于同步搜索模块会循环24次，因
此设计一个二维数组Sync Res Buffer[24][3]用于存储Cell同步搜索的结果。
2) Sync 同步搜索结果Buffer
由5.2.3节所介绍的Sycn Search同步函数的接口，本方案设计Sync Res 结  构体作为存储Sync 同步搜索结果的数据类型，由于同步搜索模块会循环24次， 因此使用以该结构体为存储类型，大小为24的数组Sync Res Buffer[24]作为
Sync同步搜索结果Buffer。
43
(C)1994-2022  China  Academic  Journal  Electronic  Publishing  House.Allrights  reserved.  http://www.cnkinet
表5-10 Sync Res结构体定义
名字	数据类型	描述
sync Foffset	int16 t	频偏值
sync Toffset	int16 t	时偏值
syne Info	Struct	带外同步信息
当同步搜索模块循环24次后，将对同步状态进行决策，而此时各同步Buffer
会存有24次搜索结果的缓存数据，需要适当算法选择相应结果。
3) Cell同步搜索结果选择算法
Sync 同步搜索结果算法的过程如图5-5所示：
图5-4 Cell同步搜索结果选择算法过程示意
首先根据Buffer中数据，进行功率的判定比较，对每次搜索返回的三个结果 选择功率最大的结果。其次根据小区ID,统计24次搜索结果中，同一小区出现的 次数，即频率，选择出现次数最多的小区作为同步源。最后根据所确定的同步源 小区 ID 对每次结果进行取均值操作作为最后系统用于建立同步关系的时偏和频
偏值。
4) Sync 同步搜索结果算法
Sync 同步搜索结果算法的过程如图5-5所示，首先根据 Buffer 中 SyncInfo 数据的ID 信息，统计每个D2D 终端成功被发现的次数，由于循环24次，相当 于每个D2D 终端最多可以被发现3次，因此如果某D2D 终端被成功发现两次以
上，则认为是稳定存在的备选同步源。当存在多个稳定备选D2D 终端同步源时，
44
(C)1994-2022 China Academic Journal Electronic Publishing House.All rights reserved.   http://www.cnki.net
则根据第四章所确定的同步优先级选择根同步源优先级为相对最高的 D2D 终端 作为本机直接同步源，并根据其 ID 选择 Buffer 中存储的与该同步源进行 Sync 同步所获取的时偏和频偏值，并分别做取均值处理作为最后系统用于建立同步关 系的时偏和频偏值。
经过同步决策模块后， D2D 终端已完成开机同步搜索和建立，在此基础上， 通过发送和接收链路处理模块则可完成基本的D2D 直通通信。
图5 - 5 .Sync 同步搜索结果选择算法过程示意
