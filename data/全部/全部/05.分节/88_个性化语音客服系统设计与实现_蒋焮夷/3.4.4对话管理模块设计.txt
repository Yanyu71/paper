3.4.4对话管理模块设计
Rasa对话管理模块紧接着RasaNLU模块，负责处理的是对话上下文信息的 管理和最终回复的生成，本模块为生成文字回复的关键模块，其中Action服务 器负责的为需要用到上下文插槽信息和知识图谱结构信息的意图，而简单的意图, 如问好、再见等无需经过该服务器复杂处理，直接调用写好的模板结构输出即可。 这里主要的结构如图3-14所示。
图3-14 Rasa对话管理模块功能设计图
依托Rasa框架已有的基础能力，可以生成固定句式的回复，所以本文在实
现的时候将简单的闲聊语句使用固定的句式来回复，对于复杂的句式则需要依靠
34
Action服务器来进行更细致的处理，这里的一些基本设计分析如表3-2所示。
表3-2意IS
类型设计表
意图类型
意图回复类型
意图语料示例
意图描述
问好
简单回复
你好、你好啊
简单的开场问候语
再见
简单回复
再见、拜拜
简单的结束语
询问菜品属性
Action服务器处理回 复
米饭的价格是多少？
询问具体菜品的具体 属性
验证菜品属性
Action服务器处理回 复
干锅鸡是辣的嘛？
验证具体菜品的属性
点餐
Action服务器处理回 复
我要点一碗米饭
核心点餐功能
取消订单
Action服务器处理回 复
少要一碗米饭、不要 米饭了
取消某项菜品具体数
量或整体取消
结账
Action服务器处理回 复
老板，结下账
表明结账意图
菜品推荐
Action服务器处理回 复
你们这里都有什么辣 的菜啊
询问带属性的菜品信 息（也可不带属性）
默认回复
简单回复
意图识别失败时的兜 底回复
其中主要包含了闲聊部分、用餐部分和默认回复三个部分，闲聊部分就是上 表中的基本问好和结束等可以用固定回复来处理的简单情况，用餐部分的意图需 要用到Action服务器来处理，这个下文会详细介绍，最后就是关于意图识别失 败或置信率太低导致的默认回复，通过再次询问能让用户提供更详细信息，这里 也是简单的固定回复。
Action服务器是为了处理复杂的问句而必要的逻辑处理模块，依托于前文中 介绍的RasaNLU模块对于句意的理解、实体的提取和意图的识别，该服务器的 主要工作就是在已知意图和单句实体的情况下，管理上下文的插槽部分，对关键 的上下文信息进行存储和更新，并能在需要的时候提取出来，生成符合要求的回 复文本，其基本的逻辑处理包含了单句的信息和上下文信息整合、关键信息的存 储更新、回复的生成三个部分，其基本的流程图如下图3-15所示。
35
图3-15 Action服务器处理流程图
如图可以看出点餐机器人回复部分主要还是分为了三种情况，一种是关于单
个菜品的信息回复，这里包括了询问菜品的属性、验证菜品的属性等意图，生成
的回复模板为将菜品名、属性名以及属性具体数值留空的一个模板，只需要传递
进去这三项就能生成该回复。第二种回复模板为多个菜品回复模板，包括询问有
36
什么菜品，推荐菜品等意图，处理时需要列举出满足条件的所有菜品信息，所以 传入的参数应该为需要满足的条件（当然也可以不包含条件表示列举出所有的菜 品）。第三种回复模板为依据插槽中已有信息将多个菜品的某项属性一起展示， 本文实现的只有结账的意图使用该回复模板，将己点的菜品数量和菜品的价格以 及所有的总价进行输出，未来可能根据需要进行扩展使用，这里不需要再传入额 外信息，因为信息已经在插槽中保存完整。
作为Action服务器后备数据支撑的知识图谱构建也是设计的重要环节，这 里本文采用Rasa框架推荐的做法采用代码结合Json文件的方式构建一个小型的 知识图谱系统，首先基于本文点餐机器人的应用背景，需要对应设计出各项菜品 作为本文的实体，其中每种菜品的基本属性结构结构如下表3-3所示。
表3-3知识图谱实体属性表
知识图谱实体属性
实体数据类型
实体描述
唯一标识ID
数值类型
用于唯一标识菜品
口味
字符串类型
标识菜品的口味，如甜、咸、辣
菜品类型
字符串类型
标识菜品的烹饪方式，如主食、干锅
价格
数值类型
标识菜品的价格，用阿拉伯数字表示
菜品名
字符串类型
标识菜品的中文名称
可以看出这里的知识图谱实体设计跟Rasa NLU实体设计有很多重合的地方, 但是在RasaNLU模块中还有额外的如菜品属性的设计，这也是为了方便和插槽 相互配合，如果在插槽中存储有之前询问的菜品属性名称那么后续的对话出现了 询问其他菜品的问法时，如询问“那XX菜品呢？，沱样明显的属性询问意图时， 可以直接调用存储的菜品属性名称生成对应的回复，而在知识图谱的标识ID的 作用是为了作为除了名称外更便于存储和区分的属性。
除了 Json文件中的实体信息外，整个知识图谱还需要构建一些函数来支持 Rasa对话管理模块的调用和处理，同时和该模块形成高度解耦的结构方便以后 扩展到需要数据库上层的代码也可以不用改动，将必要的东西封装在知识图谱的 内部，这里主要需要考虑重点函数如下表3-4所示。
37
表3-4知识图谱基本函数表
函数描述
传入参数信息
输出参数信息
初始化函数，完成知识图谱 系统的初始化
初始的配置信息或配置文件地 址等必要的初始化信息
无
加载函数，载入具体的数据 信息
Json文件地址
无
设置显示属性函数，设置该 实体对外显示时使用的属性
实体名，属性名
无
设置唯一标识函数，设置该 实体的唯一标识属性
实体名，属性名
无
获取属性函数，得到该实体 的所有属性值
实体名
属性名列表
获取多个实体对象函数，获 得该实体类型满足条件的多 个具体对象
实体名，属性列表
实体对象列表
获取单个实体对象函数，根 据实体唯一标识获取具体的 单个实体对象
实体名，标识属性具体值
单个实体对象
上表展示的知识图谱基本函数可以看出与本文中使用的实体菜品其实是高 度解耦的，未来在添加额外的任务型对话场景系统时，也完全可以用到这样的知 识图谱，只是具体的Json文件有变化，同时，如果实体的对象数量或者属性非 常多，非常复杂，也完全可以脱离Json文件的构建方式在加载函数里面通过调 用数据库驱动的方式直接从数据库完成初始化加载，在获取信息和设置信息里面 也可以添加上对于数据库的操作。针对特别的系统需求还可以通过改变初始化函 数的方式做到更好的适配性和灵活度。
