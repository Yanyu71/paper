4.3.3FPGA实现
本项目的FPGA实现通过硬件描述语言Verilog HDL,在ISE开发环境下开发完 成，发射机的各级模块（主要包括数据采集、Turbo编码、速率匹配、QPSK映射、 空时块编码、成帧、RRC成型滤波）的信号处理流程如图4-8所示：
56
数据采集
S ource_data_v 盟
S°urce-datw
Turbo 编 石马器
urbo aata val id
Turbo data
Qpsk data valid
H>i-------------
Qpsk data	STBC 编码
Q-'nd 宜。
I 舄 pg'二
I I ▼ 0EPI06SI01
I I ▼ Iwpgslol
OWPJqls4
*3 趁 E-WPIBSEUI PUPAIBlBpyBJIUI
Interface pulse
接口单元
data valid
成帧状态机
与 amedataval id
TO rrc datal
frame datal
DA
工 OrrcdataQ
RRC滤 波
frame dataQ
c datal
tl frame datal
T1 rrc dataQ
，JYame dataQ
图4-8发射端FPGA设计流程图
由于硬件资源有限，为尽可能地节省资源，并提高数据流的处理效率，MIMO SC-FDE硬件实现过程中采用流水和并行处理技术，从上图的设计流程图可看出发射 端的FPGA实现过程中采用模块化设计，下面从数据流经过各模块的时序角度进行 分析。
接口单元控制速率切换和数据采集，采集的低速率比特流根据成帧模块返回的 采数标志信号，周期性地流入Turbo编码器。进入Turbo编码器的比特数据先经过 QPP交织器完成信号交织，再经过编码器完成Turbo编码，输出比特流扩展为原来 的6倍，再加上尾比特28bit。由于各模块运行的时间不等，为避免相邻的数据块在 时序上发生冲突，Turbo编码器的输出信号turbo_code根据标志信号turbo_valid,通 过乒乓操作存入位宽为两块输入位宽为1位输出位宽为2位深度为65536的缓冲 ram,即turbo_ramO和turbo_ram 1 0之后通过成帧模块给出的指示标志信号，从该两 块ram中读取2048个2bit的数据同时完成QPSK,通过每次顺序循环读数完成对应 系统传输速率的速率匹配，之后根据标志信号qpsk_code_valid遵循乒乓操作送入两 块独立的STBC单元，两个STBC单元的设计分别采用8块深度为1024位宽为2位
57
的RAM完成。不同于之前几个模块的缓存RAM,考虑到硬件资源上的节省和平衡, STBC模块采用分布式RAMo STBC模块完成编码的数据流流入成帧模块，根据时 序从ROM中读出对应的帧头序列和导频，结合数据部分完成成帧。
在成帧模块实现中，为方便匹配时序操作，根据帧结构的划分对应设置状态机, 在成帧过程中，每切换一个状态机，此状态成帧所需的数据已完成前阶段的调制处 理存于缓存RAM中。按照上文给出的帧结构，本文的成帧状态机划分为8个不同的 状态，分另!J 是 IDLE、FRAME_HEAD、FRAME_DAIA1、FRAME_PILOT1 > FRAME_CP1、FRAME_DATA2、FRAME_PILOT2> FRAME_CP2o 每个状态转换之 间注意数据乒乓操作的切换以及时序的匹配，具体成帧状态机的状态转化如图4-9
图4-9成帧状态机的状态转化流程图
下面将对状态机的8种不同状态的工作机制与状态转换做出介绍：
IDLE：状态机的初始状态，当工程发射端全局复位时进入初始状态，等到成帧 开始标志 frame_begin_pulse 进入 FRAME_HEAD 状态。
58
FRAME_HEAD：此状态下从ROM中顺序读取8192长的格雷互补序列，循环 读取两段相同相位的帧头序列构成帧头，之后直接进入FRAME_DATA1状态。此状 态结束之前提前给出业务数据读数指示标志，传送给前级STBC模块。
FRAME_DATA1：进入此状态前，业务数据已完成前阶段的编码调制存入STBC 模块中的缓存RAM中，从前级模块中读取200个1040长度的数据时隙，只需提前 两个数据时隙即可，数据读出到传送给成帧模块，数据流从时序上对接之前的帧头 序列，200个数据时隙之间穿插读取导频，故按照子状态机在FRAME_DATA1和 FRAME_ PILOT1状态之间跳转。
FRAME_PILOT1 ：本状态对应导频状态，从ROM中读取8192长度的格雷互补 序列，导频序列的相位区别于帧头序列的相位，防止同步定位偏差。
FRAME_CP1：该状态用于在前10ms的数据帧后插入较长的帧CP,完成后即 进入FRAME_ DATA2状态。此状态结束之前提前给出业务数据读数指示标志，传送 给前级STBC模块。
FRAME DATA2：进入此状态前，业务数据已完成前阶段的编码调制存入STBC 模块中的缓存RAM中，从前级模块中读取200个1040长度的数据时隙，只需提前 两个数据时隙即可，数据读出到传送给成帧模块，数据流从时序上对接之前的帧头 序列，200个数据时隙之间穿插读取导频，故按照子状态机在FRAME_DATA2和 FRAME_PILOT2状态之间跳转。
FRAME_PILOT2：本状态对应导频状态，从ROM中读取8192长度的格雷互补 序列，导频序列的相位区别于帧头序列的相位，防止同步定位偏差。
FRAME_CP2：该状态用于在后10ms的数据帧后插入较长的帧CP,完成后即 进入FRAME_DATA2状态。此状态结束之前提前给出业务数据读数指示标志，传送 给前级STBC模块。
