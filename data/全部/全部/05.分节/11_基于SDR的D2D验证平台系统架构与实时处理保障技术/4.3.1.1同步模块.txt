4.3.1.1同步模块
物理层的同步功能模块由接收主线程和同步状态监听线程共同实现。由接收 主线程维护D2D终端当前的同步状态。其提供的主要函数接口如表4-13所示：
47
表4-13 PHY同步功能接口
函数接口定义
CellSearch(CellSearchOut t *CellSearchOut) UlSyn_subRsSearch(CellSearchOut_t *RsSearchOut)
物理层使用CellSearchO函数和UlSyn_subRsSearch0函数进行蜂窝小区搜索 和D2D网络搜索，其输入数据均为帧格式未对齐的一个无线帧，分别通过 CellSearchOut和RsSearchOut结构体传出同步结果。若终端当前由于刚刚开机或 发生切换处于未同步状态时，主线程启动其同步功能，调用CellSearchO函数以尝 试与蜂窝小区基站信号同步。若小区搜索多次失败，终端则放弃与蜂窝小区进行 同步，开始调用UlSyn_subRsSearchO函数以尝试与其它D2D终端信号同步。若 D2D网络搜索也多次失败，终端则放弃与其它信号源进行同步，以当前时间作为 时间基准建立帧格式进行信号的接收与发送。
若终端当前已经处于已同步状态，则主线程不再进行同步尝试，转而由同步 状态监听线程每秒钟调用CellSearchO函数和UlSyn_subRsSearch0函数以检测终 端当前的同步源是否仍存在，若同步源发生了丢失，则终端将中断当前的物理层 和协议栈活动，重新进行同步。由于在蜂窝信号存在的情况下，D2D通信必须考 虑与蜂窝系统之间的干扰避免问题，因此若当前终端工作在自组织网络模式下， 且同步状态监听线程小区搜索执行成功，终端也会进行重同步，切换到混合网络 模式。
同步模块在终端同步状态发生转换时，使用Sync_mode Core Msg向协议栈报 告同步状态的切换。支持的同步状态类型如表4-14所示：
表4-14 Sync mode Core Msg携带的同步状态列表
同步状态	同步状态值	同步状态说明
D2D Master	0	自组织模式主机
D2D Slave	1	自组织模式从机
Mix Slave	2	混合网络模式
Out of Sync	Oxff	未同步模式
物理层同步模块的执行逻辑如图4-17所示:
48
图4-17物理层同步模块逻辑
此外，当终端出于已同步状态时，会利用来自同步源的信号进行时频域的跟 踪，以保持自身与同步源之间定时和频率的一致性，抵消系统硬件晶振频率不一 致等原因带来的釆样率或频点差异。混合网络模式和自组织网络模式下的时频域 跟踪函数接口分别为SymTrackingO和Ul_RsTracking(),其输入数据均为已同步的 一个子帧的数据，分别通过SymTrackCtrl结构体和pFoffsets pToffset的数值传出 跟踪结果，如表4-15所示：
表4-15 PHY跟踪功能接口
函数接口定义
SymTracking(uERxSymTrackCtrl„t *SymTrackCtrl)
Ul RsTracking(int32 t *pFoffset, int32 t *plbffset)
对于跟踪得到的时间偏差，物理层将在数据缓存处调整时间戳与帧号的对应 关系以进行时域校正，该对应关系将在4.4节进行详述。对于跟踪得到的频率偏 差，则由接收链路主线程中的频率补偿函数进行补偿。
49
