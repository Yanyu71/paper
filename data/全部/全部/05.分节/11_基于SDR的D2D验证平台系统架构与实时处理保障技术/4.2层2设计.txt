4.2层2设计
层2是D2D验证平台软件系统的协议栈部分。协议栈部分的基本功能是，将 基于IP的业务数据与D2D物理层及以下提供的传输服务进行对接。具体功能包 括：
1、与物理层的通信接口 ..2、与网络层的通信接口 .
3、	数据的拆包与重组
4、	CSMA/CA流程的管理
5、	HARQ功能的实现
6、	系统消息和测量信息的处理
7、	无线资源调度功能的实现
8、	路由策略的提供
9、	演示平台数据源的提供
ETE的协议体系已经实现了功能1、2、3、5,其中，MAC层［明实现了功能 1和5, RLC层〔29］实现了功能3, PDCP层〔3°］实现了功能2o本论文中D2D协议 栈部分也沿袭了 ETE协议栈PHY-MAC-RLC层的体系结构，但相比于ITE, D2D 协议栈部分进行了一些结构性和功能性的修改。
首先，由于不需要接入核心网，也不与基站进行真正的接入、鉴权、链路控 制等信令交互，D2D协议栈不对ETE协议栈中的RRC层进行实现。同时，D2D 协议栈中增加了一个RRM实体，以实现分布式自主无线资源管理功能
第二，D2D协议栈的MAC层增加了对CSMA/CA流程管理的功能支持，并 将HARQ功能嵌入CSMA/CA流程中，同时还取消了不需要的下行业务信道数据 传输等功能。
第三，在ITE系统中，PDCP层的主要功能是对IP包头进行数据压缩，并维 护无线承载的序列号。本论文为了简化系统设计，没有进行包头压缩，也没有根 据业务建立无线承载。D2D协议栈中的“无线承载”是与通信的D2DID相对应 的，即在一个ITE终端中，D2D网络内的每一个其它D2DID都对应着两个接收 RLC实体和一个发送RLC实体，两个接收RLC实体分别处理来自该终端的点对 点通信数据和广播数据，而不同业务来源的数据则不作区分地混合在一起。因此， D2D协议栈中使用一个IP接口层取代了 ETE的PDCP层，通过虚拟网卡TUN实 现了操作系统网络层与协议栈RLC层的对接。此外，该层还通过集成开源路由软 件babeld实现了自主路由和中继转发功能。
至此，D2D协议栈中各层级与本节中提到的9个功能的对应关系为，MAC 层实现功能1、4、5, RLC层实现功能3, IP接口层实现功能2、8, RRM实体
29
实现功能6、7。而功能9则由所有需要进行监控的层级共同提供。
若以驱动方式进行区分，D2D协议栈要实现的功能可分为两种，即时序驱动 和消息驱动。时序驱动是指系统的该行为由时间触发，比如在预定的子帧向物理 层下发发送数据的指令；而消息驱动是指系统的该行为由消息的接收触发，比如 接收来自物理层的信息上报和接收来自网络层的数据下发等。操作系统的非硬实 时性决定了协议栈无法通过操作系统获取微秒级别精度的定时中断，但USRP的 硬件部分则可以提供系统所需的定时精度。本系统通过对UHD的封装，可以在 层0实现1毫秒1次的精确时钟节拍，并以消息的形式上报给层2。于是，时序 驱动也可以通过消息驱动的形式实现。
至此，整个D2D协议栈就可以以消息处理机的形式进行组织，其需要处理的 消息可以分为4类：
Heartbeat Msg：层0向层2提供的每毫秒1次的定时信号，用于触发协议栈 时序驱动的任务。
Sched Msg：协议栈需要处理的时序驱动的任务描述，主要是协议栈向物理层 下发数据的操作。
Core Msg：协议栈需要处理的消息驱动的任务的驱动源，主要是物理层向协 议栈上报的数据。
Display Msg：协议栈向演示平台提供数据服务的载体。
以上4类消息中，对前3类消息的处理即构成了 D2D协议栈的运行流程，如 图4-2所示。在收到Heartbeat Msg后，协议栈由Heartbeat等待模式唤醒，检查 Sched Msg队列和Core Msg队列，并对相应任务进行逻辑处理。
Display Msg产生于对其它消息的处理过程中，因此D2D协议栈可以在脱离 Display Msg正常运行。
Heartbeat(Ims/time)
图4-2 D2D协议栈消息处理的状态机模型
出于系统一致性和可扩展性的考虑，Sched Msg和Core Msg具有固定的消息
30
头格式，这样就可以为其处理提供统一的接口，即Sched_msghandler和Core msg handler,不同的Sched Msg和Core Msg使用消息头中的Type格式进行区分。
Core Msg消息由32字节的消息头和不定长度的消息负载组成，其格式如表 4-1所示。
表4-1 Core Msg消息格式
字段名	字段意义	字段长度
Send Time	消息写入协议栈Core Msg队列的时间	8byte
Type	消息类型编号	.	〔	Ibyte
Frame Number	携带消息的子帧的第一个采样值被USRP接收的 物理层时间戳，用于系统处理时间的测量	2byte
Subframe Number	携带消息的子帧的子帧号	Ibyte
HWTime	携带消息的子帧的第一个采样值被USRP接收的 物理层时间戳，用于系统处理时间的测量	8byte
PHY Start Time	物理层开始对携带该消息的子帧进行处理的物理 层时间戳，用于系统处理时间的测量	8byte
Payload Len	消息负载的长度	4byte
Payload	消息负载	由 Payload Len 指定
由于Sched Msg涉及到物理层发送，因此Sched Msg在格式上比Core Msg 多了一个Config字段，用于在进行业务信道发送时，传递配置物理层发送数据时 使用的编码调制信息。此外，Sched Msg也不需要Core Msg中提供时间测量的字 段。因此Sched Msg包含一个16字节长的消息头，一个可选的Config字段以及 不定长的消息负载，其格式如表4-2所示。
表4-2 Sched Msg消息格式
字段名	字段意义	字段长度
Send Time	消息由调度器传递到物理层的时间	8byte
Type	消息类型编号	Ibyte
Frame Number	执行调度的子帧所在无线帧号	2byte
Subframe Number	执行调度的子帧的子帧号	Ibyte
Config&Payload Len	指定Config和消息负载字段的总长度	4byte
*Configuration	指明物理层发送时使用的MCS配置信息	20byte
Payload Len	消息负载的长度	4byte
Payload	消息负载	由 Payload Len 指定
可选的Config字段由两部分构成，包括：
1、	TxJD： 1字节，数据发送方的D2D终端ID
2、	Rx_ID： 1字节，数据接收方的D2D终端ID
3、	processID： 1字节，本次传输对应的HARQ进程ID
4、	rv： 1字节，本次传输的HARQ冗余版本
5、	RB_Start： 1字节，本次传输所使用的资源块的起始位置
6、	L_RB： 1字节，本次传输所使用的资源块的数量
31
7、	Qm： 1字节，基带信号调制方式，支持QPSK, 16QAM, 64QAM
8、	TBSize： 4字节，本次传输对应的MAC层TB块大小
9、	DataLen： 4字节，待发送数据中的有效负载长度
