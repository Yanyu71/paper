5.5基于流水线的单模块并行优化
USRP与D2D物理层之间进行的釆样率转换操作是系统中对实时性要求很高 的又一个模块。由于TDD ETE系统中每一个子帧的持续时间为1ms,因此该模块 包括滤波运算和上下层通信在内的所有处理操作，对于每个子帧的处理时间不能 超过1ms,否则将无法满足系统的实时性要求。同时，在数据的接收链路中，该 模块处于所有物理层模块的前端，该模块的延时将叠加在所有接收链路处理的延 时之上，在保证系统实时性的同时，也必须针对该模块的延时进行优化。
以层0的数据接收服务为例，在执行5.2节所述的优化前，该模块的处理粒 度是1个子帧，即从USRP获取长度为25000个釆样值后，一次性对这25000个 釆样值进行采样率转换。此时采样率转换模块已经经过算法效率和SSE指令集优 化，每个子帧的处理时间在300us左右。这样的延时可以满足系统对于该模块实 时处理的要求，但叠加在物理层接收链路处理的延时之上，将会对物理层接收链 路的实时性带来巨大的压力。
执行5.2节所述的优化后，该模块的处理粒度由1个子帧减小到1个 packet（l/40子帧）,.在数据等待的时延被降低的同时，单次滤波运算带来的延时也 被切分。但同时，每个packet的处理必须在25us内完成。
理论上，滤波运算对一个子帧带来的延时也会降低到与300/40=7.5us的量级。 但由于受到程序调用开销等方面的影响，在处理粒度被降低到原来的1/40后，每 个packet的处理时间仅下降到约20~27us。根据分析，该模块的处理的处理延时 主要来自三个部分，即从USRP读取数据、进行变采样滤波运算、向物理层发送 数据，如图5-8所示。
67
<	20 27us	>
5us	13~20us	2us	5us	13~20us	2us
1 packet	:
图5-8单段式的层0接收链路的延时分析
根据时延分析，从USRP读取数据的操作造成的延时平均为5us,变釆样滤 波运算的延时在13us到20us之间，向物理层发送数据的延时平均为2us。虽然三 个部分的延时均小于25us,且前后两个操作的延时很小，但当packet处理的总延 时超过25us时，信号处理的延时将会发生持续累积，使得链路的延时越来越大， 最终导致系统崩溃。为了解决这一问题，这里将单段式的处理逻辑按照功能拆分 成三个线程，形成如4.3.1节所述的三段式处理逻辑。如图5-9所示，即使变采样 率波运算的时延为20us,也不会发生延时累积的现象。
层0接收数据流
-1			>
packet N	packet N+l
图5-9三段式的层0接收链路的延时分析
三段式的处理逻辑实现了单模块的流水线处理，模块对一个packet的处理总 延时将从原来的三段延时的累加和变为原来的三段延时中最长一段的延时，即从 22~27us降低到13~20us,不再会超过25us的门限。而实际上，在该模块优化后， 执行滤波运算操作的线程只进行数据运算，而不再进行设备访问操作，IO操作到 运算操作之间切换的开销降低也使得该模块的运算延时更小且更加稳定。
