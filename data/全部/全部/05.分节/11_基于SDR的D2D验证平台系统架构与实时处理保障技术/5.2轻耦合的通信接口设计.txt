5.2轻耦合的通信接口设计
在建立了多核多线程的并行流水架构后，层与层之间、线程与线程之间的通 信接口效率则成为了影响系统实时性的另一个关键因素。实时性对于通信接口的 性能要求主要包括两个方面，即延时小和稳定性高。延时小即消息从发送到被接 收之间的时间尽可能短，且延时稳定；稳定性高指数据在传递过程中不能发生丢
63
失和错误，特别是在多线程的环境下。
除了上文中已经叙述过的使用Zeromq进行线程间通信，以及物理层和协议 栈之间Core Msg和Sched Msg的消息机制外，物理层和层0之间的通信接口也是 影响系统性能的重要环节之一。
优化之前，层0接收链路进行釆样率转换的粒度为1个子帧，物理层完成数 据链路同步跟踪之后，将时域的补偿值告知层0,由层0维护帧格式的起始位置。 层0从USRP缓冲区读取25000个釆样点的数据后，对这25000个采样点升釆样 到30720个釆样点，并进行缓存，根据收到的时域补偿值对采样点按照帧格式进 行组合，再取出一个符合帧格式的子帧提交到物理层接收端。
图5-3优化前的物理层接收链路与层0之间接口
如图5-3所示，由于数据在进行变釆样之前进行了一次数据排队操作(等到缓 冲区中有一个子帧长度的釆样点再进行处理)，而在帧格式维护时又进行了一次数 据排队操作。一个子帧在空口的持续时间为1ms,但在最差的情况下，由于多余 的一次排队操作，这个子帧在到达物理层开始信号处理之前，就已经经历了 1ms 的排队延时。
为了解决这个问题，我们将层0接收链路的功能进行了重新定义，令其不再 进行帧格式的维护，转而提供流式的数据接收服务。层0与物理层接收端之间的 数据缓存和帧格式维护转移到物理层的接收接口进行。同时，将层0变釆样的处 理粒度由原来的一个子帧变为一个packet(l/40子帧)，层0每处理完一个packet 就上报到物理层的缓冲区。这样整个数据流程中就只进行一次数据排队操作即可， 大大缩短了接口带来的排队延时。同时，由于物理层不需要再向层0发送帧格式 维护的信令，这部分通信的开销也得到了节省。
