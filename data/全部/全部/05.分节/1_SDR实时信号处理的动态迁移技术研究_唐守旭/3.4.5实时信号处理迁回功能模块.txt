3.4.5实时信号处理迁回功能模块
当主控程序接收到输入终端输入的控制指令为“MB”时，主控程序将会跳 转到将实时信号处理相关的D2D进程和USRP进程从迁移目的端迁回到迁移发 起端的处理模块，并进行一系列的迁移操作工作。
首先动态迁移系统中迁移发起端主控程序将通过ZMQ机制分别向迁移目的 端发送获取迁移目的端虚拟网卡ip地址的“get_tun_ip”指令和获取迁移目的端 Control变量信息的“get_control”指令。然后莓待盘回结果。只要虚拟网卡ip 地址和Control变量信息市有…个的返回信息出现异常，则终止本次迁回操作， 打印迁回失败报告，并退出。
当接收到正确的虚拟网卡ip和Control变量信息，迁移发起端主控程序会将 虚拟网卡ip地址保存在tun_ip变量中，并调用ifconfig指令，将迁移发起端的虚 拟网卡ip地址配置为tun_ip；将返回的Control变量信息保存在迁移发起端的 Control变量中。
接下来，主控程序调用cmdProcess函数启动实时信号处理程序的D2D进程， 并将Control变量中的相关控制信息以参数的形式传入到D2D程序中。然后检测 启动结果。如果D2D进程启动成功，将会进行后续的迁回操作；如果启动失败， 则立即终止本次迁回操作，并打印迁回失败报告，退岀。
在启动完D2D进程之后，会调用UHD的API接口 uhd::usrp::multi usrp::make 来创建一个USRP实体，并同时■进行开辟本地缓存buffer,定义元数据操作。如 果创建失败，则将会调用killProcess函数结束前面启动成功的D2D进程，然后 打印迁回失败报告，并退出。如果创建成功，则进一步通过ZMQ机制向迁移目 的端发送结束USRP进程指令“kill_usrp”。
如果迁移目的端返回结束USRP进程成功，则主控程序将迁移发起端的eth3 端口 ip配置为192.168.10.1,然后调用uhd_find_devices指令探测USRP设备； 如果迁移目的端返回结束进程失败，则终止豆回為作，并调用killProcess函数分 别结束之前启动的D2D进程和USRP实体进程。
如果在规定的次数内仍然没有探测到USRP设备，则宣告失败，终止迁回操 作，调用killProcess函数结束已经启动的D2D进程和USRP实体进程，并将eth3 端口 ip修改为192.168.20.2,打印失败报告，退出。如果探测到USRP设备的存 在，则将调用uhd::usrp::multi_usrp::get_device建立USRP实体与USRP设备之间 的数据链路链接。	一 ~
USRP实体与USRP设备之间的数据链路建立起来之后，就可以正常就行数 据业务通信，迁回操作已经基本成功。但这时主控程序还需要向迁移目的端发送 kill_d2d指令，结束仍在运行的D2D进程。如果结束进程成功，则最后打印迁回 成场信息，退出本次处理模块；如果结束进程失败，则打印相关结束进程失败信 息，但本次成功仍然算是成功的，所以也打印迁回成功信息，然后退出本次处理 模块。
在实时信号处理程序从迁移目的端迁移回到迁移发起端的整个迁移流程中， 迁移发起端所进行的的相关操作流程如图3-13所示。
39
图3-13实时信号处理从迁移目的端迁回到迁移发起端的操作流程
