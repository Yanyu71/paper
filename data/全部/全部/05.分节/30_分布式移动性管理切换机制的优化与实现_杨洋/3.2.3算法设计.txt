3.2.3算法设计
那么控制器如何获得AP的负载呢？我们在前面已经介绍过VDMM方案中用户 的接入过程，主要过程为，首先是用户向AP发送申请接入消息，AP进行身份验 证之后通过绑定更新消息向控制器注册用户信息，控制器收到绑定更新消息后， 若判断用户是首次接入此网络，则控制器为用户分配唯一的虚拟AP,然后控制 器和AP更新映射表项，AP向用户返回确认消息。
从上面的接入过程可以看出，控制番会为每一个接入的用户分配一个唯一的 虚拟AP,并在控制器和AP中为用户和它的虚拟AP建立映射表缓存它们之间的 关系。因此我们可以知道每一个物理AP的负载就是所有接入它的用户的虚拟AP 的负载之和。为了得到每个虚拟AP的负载，我定义了一个叫做FORWARD-VAP-LOAD 的协议信令。格式如图3-18所示。信令头和虚拟AP负载值以长字符串的格式存 储。这个信令的功能是定期向控制器发送每一个虚拟AP的负载情况。然后由控 制器计算所有物理AP的负载。
Packet
Headroom	Message Header
ForWARD-NAP-LOAD	Message Dats- NAP
LOAD VALUE	Tail room
图 3-18 FORWARD-VAP-LOAD 信令格式
控制器每收到一个FORWARD-VAP-LOAD信令，就会将此虚拟AP的负载值、虚 拟AP标识和虚拟AP所在物理AP地址发送至中心管理模块。中心信息管理模块 保存有两个映射表，一个保存了虚拟AP标识、虚拟AP负载以及虚拟AP所造物 理AP地址之间的映射关系，另一个保存了物理AP地址和物理AP负载的映射关 系。中心管理模块收到FORWARD-VAP-LOAD协议信令后更新两个映射表的相应表 项。我们提出的自适应负载均衡算法（ALB算法）就是在控制器的中心管理模块 实现的。
由此可知，中心管理模块会得到所有虚拟AP的负载值，然后更新映射表， 并可以计算所有物理AP的负载值。一旦控制器判断得知AP负载的最大值和最小 值之间的差值大于之前我们设定的阈值，中心管理模块就会认为网络发生了 AP 负载不均衡的情况，然后开始执行负载均衡算法，控制器通过判断从负载最高的 AP上选择一个用户，将此用户的虚拟AP迁移到一个负载较低，RSSI值相对好的 AP上，重复执行上述迁移过程，直到网络中AP负载均衡。
控制器每隔固定周期（如20s）获取当前每个物理AP的关联用户和用户的虚 拟AP标识，为所有用户建立列表玖％ ,为所有用户的虚拟AP建立列表Lis% O 虚拟AP会定时向控制器发送虚拟AP的相关负载信息，包括虚拟AP标识，虚拟 A。负载以及虚拟AP所在的物理AP地址。控制器收到后，更新映射表，并计算 网络中所有物理AP的负载。然后控制器得到网络中所有AP的最大负载2。“7皿和 最小负载load讪，通过定义负载不均衡的条件（负载不均衡条件的设置是参考 文章［44］中自适应负载均衡算法），判断是否发生负载不均衡。若判断发生了负 载不均衡，则执行自适应负载均衡算法，重新分配乃如中的虚拟AP,对于每个 虚拟AP,寻找负载和RSSI都合适的AP,将其迁移过去，直到网络中的负载均衡， 具体执行步骤如下。
（1）	自适应负载均衡算法在控制器上作为应用部署，每隔20s询问获取当 前每个物理AP的关联用户和用户的VAP标识，为所有用户建立建立列表反sfg， 为所有用户的虚拟AP建立列表Lis%。
（2）	一旦获得了用户的列表，应用从中心信息管理模块获得AP的最大负载 值［。叽亦和最小负载值1。洞min。
（3）	判断是否发生负载不均衡。算法认为发生负载不均衡的条件是： Load血宓 > Loaded，并且（Loa、- Loadmm） >0. 6* Loadlhreshold …
第一个公式表示有最大负载的AP负载值超过负载阈值/。。《为瑚出；
第二个公式表示最大负载值和最小负载值得差大于负载阈值的60%,说明发 生了负载不均衡的情况。
若判断发生了负载不均衡，则跳到(4),否则返回(1) o
(4)若发生了负载不均衡，则执行自适应负载均衡算法。
算法执行过程如下：.
a.选择迁出AP,即APfmm ；
选择负载最大即Loadm宓的AP作为APfr6m ,即迁出AP；
b.选择迁出用户的虚拟AP,即泊乌；
在APfmm下选择虚拟AP负载Zoad”缨*/最大的用户MNj,用户的虚拟AP标识 是 NAPj。
c.选择迁入AP,即Zg。；
.首先选择负载最小的AP为他,即迁入AP。则它的RSSI值为RSSZ，。，将跡叫。 和RSSI阈值跆丑心湖进行比较，RSS7心湖提前设定为200。阈值的配置是参 考文章[44],考虑到RSSI对网络吞吐量的影响，文章中提出RSSI超过200时能 够提供相对较好的网络吞吐量。因此，可以保证用户被重新分配到负载低的AP 上后能够有一个好的QoE。实后RSSI,不大于RSSJd，则算法需要找到负载 第二小的AP做为，然后将它的RSSI值作为夫SS/,°。重复上述过程，比较商57,° 和RSSJm,直到码％° >RS必瑚汨，说明此AP的信号足够强能够提供好的 网络吞吐量，则确定此AP作为
(5)控制器发送切换指令切换用户；
控制器向&%“，发送切换指令，将用户MNj的虚拟NPNAPj歸Pf切换到这 个具体切换过程可以参考上面方案的切换过程。
算法持续重复上面(3) (4)的过程直到网络中的AP负载均衡，之后算法 将会休眠一个时间间隔冗屛r,再进行下一次的负载均衡判断，重复上述的过程。
如图3-19所示是ALB算法的执行代码。
7：	if i	此x > SsJ好 f 皿
身虬)x*矿
8： Get' ；A^ 如 jj缗
9:	for	e ￡境五如
W* 有袞彳琮寡密壬
此	邮戒I站
0	ttoiiW?画EL冬,，妈：,涵p
毋	t^e
14:	Ger t tie next	心吼
15：	野碎^>彻1族5
16：	5 而iA典妈 AP^ ,妃,NAP,)
17:	eadff
18:	.—關 if
图3-19 ALB算法
