3.1.3VDMM方法流程
针对上面提出的现有的分布式移动性管理方案中存在的切换时延长、隧道开 销等问题，我们设计了一个基于虚拟化的分布式移动性管理方案即VDMM方案来 对分布式移动性管理中的切换过程进行优化。
方案的主要思想是在传统的分布式移动性管理方案中引入虚拟化的思想。将 传统WLAN网络中的物理AP进行虚拟化设计，为每一个物理AP上接入的用户分 配一个唯一的虚拟AP,虚拟AP拥有链路层和网络层中连接建立所需的相关状态 信息，如BSSID, MAC地址，AP IP地址，UE IP地址等。用虚拟AP和用户之间 的信令和数据交互来代替用户和物理AP之间的信令和数据交互。这样对于用户 来说，虚拟AP在功能上和物理AP完全相同，用户感知不到虚拟AP的存在。因 此，当用户从一个AP切换到另一个AP时，无需为用户分配新的IP地址或者建 立双向隧道，只需将为用户分配的唯一的虚拟AP从用户原来接入的AP切换到新 的AP即可。将用户的切换转换为虚拟AP的切换，由于虚拟AP拥有链路层和网 络层中连接建立所需的相关状态信息，用户切换后能够迅速与新的网络建立连 接，缩短了用户重新建立连接的时间，减少了切换时延和隧道开销。
在一个物理AP上，可以创建多个逻辑上的虚拟AP,每个虚拟路由器都单独 地运行各自的路由协议实例，并且都有自己专用的I/O端口、缓存、路由表和网 络管理软件等。虚拟AP的架构与传统AP类似，包括与用户的交互模块，通过配 置实现OSPF, BGP, RIP作为动态路由协议，并可以通过配置文件的形式决定启 用哪一个动态路由协议。此外还有管理模块，负责配置管理的生成和更新路由表 等操作。
下面将介绍方案的详细流程，包括虚拟AP的创建过程、用户接入AP的具体 过程以及用户在不同AP之间切换时的的信令流程和数据通信过程。
(1)虚拟AP的创建过程
文章E54］中给出了在软件定义的WLAN中虚拟AP的创建、管理和迁移过程。 文中定义了两种虚拟AP, 一种是公共静态虚拟AP (PS-VAP)，作为网络的接入口，所有注册和非注册的用户都可以接入；另一种专用动态的虚拟AP (DD-VAP) 是当用户需要的时候专门为用户创建的。
公共静态虚拟AP (PS-VAP)的创建过程如下，首先在物理AP上安装一个程 序或固件，物理AP发送请求到集中处理器。集中处理器返回一个基本的配置给 物理AP,如公共静态虚拟AP的配置文件。这个配置文件包含服务设备标识符 (SSID)和操作信道。然后物理AP可以基于这个配置文件创建一个虚拟AP。这 个创建的VAP可以接入任意用户而不用身份验证。因为这种创建的VAP是物理 AP上创建的第一个VAP,能够一直存活直到物理AP关机，这种虚拟AP命名为公 共静态虚拟AP (PS-VAP) o专用动态的虚拟AP (DD-VAP)是当用户需要的时候 专门为用户创建的。
动态的虚拟AP (DD-VAP)的创建过程如下，当一个注册用户想要接入网络 时，它会监听控制信道，等待一个PS-VAP的信号。当用户监听到一个PS-VAP 的信号时，它知道那是一个可能的PS-VAPo用户发送一个包含注册的服务设备 标识和它的ID (如MAC地址)的请求消息。物理AP会转发一个VAP建立请求(请 求至少包含基站，SSID和物理AP的ID)到服务器。服务器通过使用基站ID和 SSID检查是否这个用户是一个有效的注册用户。如果用户是一个有效的用户， 服务器将会读取用户资料，检查现在的物理AP的资源是否足够支持这个用户。 如果足够，服务器将会返回一个VAP建立响应(包含用户信息)给物理APO PS-VAP 发送Probe Reply给用户。然后物理AP使用服务器提供的配置信息为用户创建 DD-VAP0用户和这个创建的DD-VAP进行身份验证，连接和数据通信。在身份验 证的过程中，DD-VAP是一个中继节点。真正的身份验证流程是在服务器上完成 的。
参考上面的创建虚拟AP的过程，如图3-2所示给出本文虚拟AP创建的信令 流程。
(a)首先用户发送一个包含注册的服务设备标识和它的ID的请求消息给物 理AP。
(b)物理AP收到用户的请求消息后，发送一个VAP建立请求(请求至少包 含用户ID, SSID和物理AP的ID至少)到控制器。
(c)控制器收到消息后，检查这个用户是否是一个有效的注册用户。如果用 户是一个有效的用户，控制器将会读取用户资料，检查现在的物理AP的资源是 否足够支持这个用户。如果足够，控制器将会返回一个虚拟AP建立响应(包含 用户信息)给物理AP。
(d)物理AP发送Probe Reply给用户。
(e)物理AP使用配置信息为用户创建虚拟AP0用户和虚拟AP之间可以进行身份验证，连接和数据通信。
Probe Request
(SS^D, UserJD)
VAP Setup Response
Probe Reply :	(User_profile)
图3-2虚拟AP的创建过程
(2)接入网络过程
和其他的移动性协议相同，本方案中为每一个接入的节点(Mobile Node, MN)分配一个主机标识，也可以称为家乡地址(Home Address, HoA)。当节点 发生移动的时候，家乡Milt HoA是不会变化的，因此家乡地址HoA可以作为节点 的主机标识。
也就是说当MN接入一个新的网络时，并不需要为MN重新分配地址，相关的 移动性工作由网络侧来完成，MN不需要参与移动性工作，即对终端是透明的。
从上面描述可以知道本方案是基于网络的，基于网络侧的方案有相较于基于 主机的方案来说有一定的好处。首先网络中的移动性工作对终端透明，那么就不 需要扩展终端的协议栈，降低了方案部署的复杂性，使得方案能够更好的兼容现 有的协议。
图3-3 VDMM方案接入过程
本方案中MNi的HoA分别为MNi-IP,以MN3为例，如图3-3所示，具体的 接入注册流程如下：
(a)MN3接入API,向API发送RS消息申请接入。
(b)API收到RS消息,检测到MN3的接入,API得到MN3的家乡地址MN3-IP。
(c)API査询映射表中没有MN3的映射表项，判断MN3是第一次接入API, API向控制器发送绑定更新消息PBU,将节点的IP地址和AP1-ID传给控制器。
(d)控制器收到API的PBU消息后，查询映射表中没有MN3的表项，判断MN3 是第一次接入这个域。因此控制器为MN3分配一个新的虚拟AP,即VAP3,虚拟 AP的标识为VAP3-ID。控制器为MN3新建一个表项，将MN3的IP地址、为MN3 分配的VAP的标识和MN3接入AP的地址〈MN3-IP, VAP-ID, AP1-IP＞存入映射表 中，如表3-1所示。
表3-1 Control ler的映射表项
MN	VAP	AP
MN1-IP	VAP1-ID	AP1-IP
MN2-IP	VAP2-ID	AP2-IP
MN3-IP	VAP3-ID	AP3-IP
MN4-IP	VAP4-ID	AP4-IP
MN5-IP	VAP5-ID	AP5-IP
(e)控制器向AP返回确认消息PBA。
(f)API收到控制器的消息后，为MN3分配一个虚拟AP,即MN3-VAP, MN3-VAP
拥有链路层和网络层中建立连接所需的相关状态信息，MN3的上行和下行数据都
由MN3-VAP进行处理。
(g)API为节点的IP地址和为节点分配的VAP标识建立缓存表项将MN3的 IP地址和为MN3分配的VAP的标识＜MN3-IP, VAP3-ID〉，存储在API的映射表中, 如表3-2所示。
表3-2 AP1的映射表项
MN	VAP
MN1-IP	VAP1-ID
MN2-IP	VAP2-ID
MN3-IP	VAP3-ID
(h)API向MN3返回申请确认消息RAo 具体的信令流程如图3-4所示。
图3-4 VDMM方案接入信令流程
(3)移动切换过程
上面介绍了本方案的用户接入流程，介绍了具体的切换过程和信令流程。下 面主要介绍当用户从一个AP移动到另一个AP时的切换过程和相应的信令流程。 我们上面介绍过，在部分分布式的移动性管理网络架构中，当用户从一个网络移 动到另一个网络时，新接入的MAAR需要向CMD通过PBU/PBA消息查询用户之前 的接入信息，并在用户之前接入的MAAR和用户当前MAAR之间建立双向隧道，之 前的会话需要先到达家乡MAAR,然后通过隧道转发给当前MAAR。
从上面的流程中可以看出，部分分布式移动性管理方案中仍然存在转发路径 非最优的问题，即会话需要先到达家乡锚点，再由隧道转发到用户当前接入的锚 点。其次在用户的家乡锚点和当前锚点之间需要建立双向隧道，而且随着用户不 断移动，隧道的数量不断增加，因此隧道开销也会不断增大，这在整个网络中来
看也是一笔不小的开销。且目前部分分布式移动性管理方案的切换时延较长。
VDMM方案主要是针对上面两个问题来设计的，方案中用户自始至终只有一个 地址，也可以成为家乡地址，这个地址标识了用户的身份和位置，当用户移动到 新的网络时不需要给用户分配新的IP地址，因此方案无需对终端进行扩展。方 案中为每一个用户分配唯一的虚拟AP,当用户移动后，虚拟AP也跟着用户移动， 这样对于用户来说接入的一直是同一个AP,因此可以降低切换过程中的时延， 而且无需建立双向隧道也减少了隧道开销。
在VDMM方案中，引入了虚拟化的思想，为每一个用户分配唯一的虚拟AP, 网络中有一个控制器。控制器管理着整个域内接入的用户信息，包括用户的IP 地址，为用户分配的虚拟AP的标识，以及用户当前接入的AP的IP地址。
当用户接入到网络后，它将会被分配一个唯一的虚拟AP。用户切换时，原 AP可以通过二层切换预测得知用户即将切换到的AP,并将新AP的信息发送给控 制器，控制器会通过信令控制它的的虚拟AP也从原物理AP切换到新的物理AP。 由于VAP中保存着链路层和网络层的相关信息，所以用户并不需要重新进行链路 层和网络层的配置，因此切换延迟将会大大降低。
为了获取用户切换后即将接入的AP的信息，方案借鉴了 FH-PMIPV6方案的 思想岡。用户在足够短的时间间隔内向其接入网汇报包含MN ID和AP ID的底层 信息报告。当用户移动到两个AP的重叠区域内时，接入网络在恰当的时间向用 户的接入AP发送特定的切换指示消息。用户接入AP可通过二层（L2）扫描预测 用户将要发生切换并推导出用户即将接入的AP的信息，并将信息报告给控制器， 控制器通过信令控制用户的虚拟AP进行切换。
如图3-5所示，以MN3的切换为例，具体的切换流程如下：
(a)MN3移动到API和AP2的重叠区域。
(b)API通过二层(L2)机制预测到用户即将切换到AP2；
(C)API向控制器发送VAP Move Request消息，消息携带MN3即将迁移到的 AP信息(AP2_IP)和MN3的虚拟AP (VAP3)的状态信息。
(d)控制器收到VAP Move Request消息后，得知用户即将移动到AP2,控 制器向AP2发送消息VAP Duplication消息，消息携带MN3的虚拟AP (VAP3) 的状态信息，状态信息包括BSSID,操作信道等信息。
(e)AP2收到VAP Duplication消息后，通过消息携带的VAP3的状态信息在 AP2上克隆一个VAP3。AP2更新它的映射表＜MN3-IP, VAP3-ID〉。
.(f)控制器更新它的映射表，将MN3当前所在AP更新为AP2-IP,映射 表项为＜MN3-IP, VAP3-ID, AP2-IP＞o
(g)AP2向控制器返回确认消息VAP Move Confirm。
(h)控制器向API发送VAP Release消息，API释放VAP3。
(i)MN3移动到AP2后，向AP2发送接入请求消息RS。AP2收到RS消息后， 由于此时AP2上已经存在MN3的虚拟AP,所以MN3可以直接与AP2建立连接而 无需再执行一次连接过程，不会产生额外的2层和3层的处理消息。AP2返回RA 消息。
至此，切换完成。
如图3-6所示，是切换过程的信令流程。
:NAP Move Request(AP2-IP,NAP3 Status) r~	' ?
NAP Duplication(NAP3 Status)
Cont rust gP for MM3
NAP Move Confirm
NAP Release
RS(MNAP):
RA
图3-6 VDMM方案切换信令流程
(4)切换过程中的数据通信
上面介绍了本方案中用户从一个AP切换到另一个AP时的切换流程以及信令 流程。在用户的切换过程中存在着数据通信，包括用户在切换前的AP上发起的 数据通信、用户切换到新的位置后原来未完成的数据通信以及用户在切换后的 AP上新发起的数据通信。下面分别介绍这三种数据通信的流程。
a.移动切换前的数据通信
图3-7 VDMM方案切换前的数据通信
这个部分介绍用户在切换前进行的通信，即用户在切换前的AP上发起的数 据通信。
仍然以MN3为例，MN3初始接入API, MN3向API及控制器完成接入注册，注 册过程见上文，由控制器为MN3分配了虚拟AP的MN3-VAP后，控制器和API中 都缓存了 MN3的映射表项。如图3-7所示，以MN5向MN3发送数据为例，用户切 换前的数据通信过程如下，红色箭头表示数据传输过程。
(a)MN5向MN3发送数据包，数据包首先到达MN5接入的AP3。
(b)AP3首先以MN3-IP查询本地缓存映射表，发现映射表中并没有MN3的相 关表项，说明MN3并没有接入AP3。
(c)AP3向控制器发送查询消息(携带MN3-IP)-
(d)控制器收到消息后，以MN3-IP査询缓存映射表，查到MN3的映射表项 为〈MN3-IP, VAP3-ID, AP1-IP〉，得知MN3当前接入API,控制器将MN3接入AP 的地址AP1-IP发送给AP3o
(e)AP3收到API的IP地址后，知道MN3当前接入API,因此AP3将发给MN3 的数据包转发到API。
(f)API收到数据包后，以MN3-IP查询映射表得到映射表项 <MN3-IP,VAP3-ID>,得知MN3接入了 API,并己为它分配了虚拟MN3-VAP,因此 将数据包交给虚拟MN3-VAP处理。
(g)MN3-VAP将数据包转发给MN3。
如图3-8所示，是切换前数据通信流程。
图3-8 VDMM方案切换前数据通信流程
b.移动切换过程中的数据通信
图3-9 VDMM方案切换过程中的通信
这个部分介绍用户切换过程中的数据通信，即用户切换到新的AP后，用户 在切换前的AP上发起的数据通信仍在继续，这些数据需要发送到用户。
仍然以MN3为例，如图3-8所示，MN3接入API时，MN5向MN3发送数据， 然后MN3从API移动到AP2,但通信并没有中断，MN5依然向MN3发送数据。用 户切换过程中的数据通信流程如下：
(a)如图3-9中虚线所示为MN3切换之前的数据流向，为 MN5->AP3->APl->MN3o
(b)MN3 从 API 切换到 AP2。
(c)MN3接入AP2后向AP2发送RS接入请求。
(d)具体的移动切换过程已在上文中描述，此时MN3的虚拟AP己经从API 切换到AP2,因此MN3能够直接接入AP2而无需再执行一次注册过程，不会产生 额外的2层和3层的处理消息。
(e)AP2向MN3返回RA消息。此时API、AP2和控制器的映射表已经更新完 成。控制器的映射表更新为<MN3-IP, VAP3-ID, AP2-IP>O同时控制器向域内的 AP发送广播消息通知它们MN3己经由API切换到了 AP2O
(f)之后来自MN5的数据包被转发到AP2,再由AP2发送到MN3。
如图3-10所示，是切换过程中的通信流程。
图3-10 VDMM方案切换过程中的通信流程
C.移动切换后的数据通信
这个部分介绍用户在切换后进行的通信，即用户在切换到新的AP后，新发 起的数据通信。
仍然以MN3为例，MN3从API移动到AP2, API, AP2和控制器上的映射表项 都己经更新完成。如图3-11所示，AP3上新接入一个用户MN6,以MN6向MN3 发送数据为例，用户切换后的数据通信过程如下，红色箭头表示数据传输过程。
(a)MN6向MN3发送数据包，数据包首先到达MN6接入的AP3。
(b)AP3首先以MN3-IP查询本地缓存映射表，发现映射表中并没有MN3的 相关表项，说明MN3并没有接入AP3o
(c)AP3向控制器发送查询消息(携带MN3-IP) o
(d)控制器收到消息后，以MN3-IP查询缓存映射表，查到MN3的映射表项 为〈MN3-IP, MN3-VAP, AP2-IP〉，得知MN3当前接入AP2,控制器将MN3接入AP 的地址AP2-IP发送给AP3o
(e)AP3收到AP2的IP地址后，知道MN3当前接入AP2,因此AP3将发给 MN3的数据包转发到AP2O
(f)AP2收到数据包后，以MN3-IP查询映射表得到映射表项
<MN3-IP, MN3-VAP>,得知MN3接入了 AP2,并已为它分配了虚拟MN3-VAP,因此 将数据包交给虚拟MN3-VAP处理。
(g)MN3-VAP将数据包转发给MN3。
如图3-12所示，是切换后的数据通信流程。
图3-12 VDMM方案切换后的数据通信流程
