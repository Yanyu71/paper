4.3基于DPM的低功耗解决方案实现
本章节在广域物联网环境下，基于上述章节(3.4.1)介绍的系统任务集合并结 合实际情况，对基于动态电源管理的低功耗解决方案进行硬件实现。针对的应用 环境为热力管网环境，其中具体的工作任务进程包括温度数据采集进程、压力数 据采集进程、流量数据采集进程以及异常震动监测进程等。
通过将动态电源管理技术的低功耗方案应用于热力管网的实际环境中，可以 得到热力领域的硬件系统实际任务调度方案。如图4-10所示，实际任务调度的 过程遵循超时策略，NB-IoT通信模块不工作时，根据预先设定的时限，由正常 的连接模式进入IDLE模式，并最终进入PSM低功耗模式。MCU的工作模式取 决于方案中存在的4个工作进程的状态，而对于其他工作进程的监控管理，则由 守护进程通过进程间的通信完成。当所有的工作进程处于正常工作状态并且传感 器处于高精度模式时，MCU为保证系统的性能处于高频工作模式；当系统中仅
43
存在部分工作任务时,MCU处于低频工作模式；当系统不存在任一工作进程时, MCU进入低功耗模式，同时将系统中确定与工作任务无关的I/O引脚全部关闭。
守护进程通过进程间j 的通信•实时监测系I 统中存在的其他工作;
进程的工作状态I
温度传感器模块处于 正常模式，对应的进 程处于运行状态
控制模块处于低功耗模式 通信模块处于待机模式 守护迸程处于运行状态
一除守护进程外，其他任务 进程是否都处于休眠状态一一
流量数据采集进程
是
所有任务模块完成初. 始化流程
拄制模块处于匿眼模式
该进程暂时挂起，对应，专感 器模块1处于休眠模式
ye感器是否需要高精度〉一＞
该进程昔时挂起,对应传感 器模块1处于休眠模式
该进程暂时挂起.对应传感 器模块n处于休眠模式
流量传感器模块处于 正常模式，对应的进f
程处于运行状态
传感器槿块处于低功耗模式
传感器模块n处于低功耗模式
是
震动数据采集进程进程是否进入休眠 嗨:
通信模块处于待机模式一 守护进程处于运行状态
调用通信进程发送不 同传感器模块的提供 的数据到对应网关
传感器模块n处丁•正： 区模式，对应的进f 程处于运行状态：
通过任务向通信嗓醒 通信模块，使其调整」
到主动模式
图4T0基于动态电源管理的任务调度方案
在控制模块、通信模块以及各种传感器模块均完成相应的初始化工作之后， 由于通信模块并不处于被激活的状态，因而NB-IoT通信模组会依次进入IDLE 状态以及PSM状态，此时来自服务器的命令下行数据不可达，同时，整个系统 的守护进程将一直处于运行状态，收集来自于其他工作进程的状态相关信息，为 系统的动态功耗调节提供参考依据。相关代码如图4-11以及图4-12所示。
低功耗模块配置函数
Begin
配置控制模块可由RTC时钟唤醒，也可由外部中断唤醒 调用PWR_EnterSTOPMode()使得控制模块进入停止模式 此处为控前模块唤醒之后的起点，进行唤醒之后的初始化配置 调用stop_Configuration()进行中断状态的相关管脚配置 stop_Configuration() Begin
设置PA分组和PB分组的时钟
PA组关闭除了工作进程所需以外的管脚
PB组关闭除了工作进程所需以外的管脚
End
End
图4-11低功耗模块配置函数伪代码
44
动态电源管理任务调度函数
Begin
int counter = 0;
rs485_conf iguration()；
adc_configuration()；
spi_configuration()；
NBIoT_configuration();
SysTick_lnit();
End
for系统中存在的每一个工作进程
Begin
如果工作进程处于工作状态并且需要高精度，counter = counter + 1；
否则，继续此循环
End
Begin
如果counter ==最大工作进程数，STM32高频运行
否则，检查counter的值是否为零
如果为零，系统进入低功耗状态，启动低功耗模块配置函数
如果大于零，系统低频运行
End
图4T2基于动态电源管理的任务调度方案伪代码
