5.2数据来源
企业网是指一个企业内部网络。由于企业的特殊性，内部数据一般不与外部 流通，有一定的区域性，因此可以认为是一个局域网。企业网内部数据流通多样, 但是一般连接外网的网口只有一个，所有员工的网络流量数据都将通过该网口与 外网进行通信交换。因此，我们只需将数据采集的设备安置在该网口处，即可采 集到该企业的所有上网流量，这个设备即我们实验室的网络流量检测设备。釆集 到的数据统一的处理平台，称为网监平台，如下图所示。
图5-1网监平台布局
数据采集设备被部署在超过200个企业网的网口处，总计有接近2000台设 备。采集设备随时收集用户的网络流量数据，并将收集到的数据进行处理，并上 传到一个总的服务器进行汇总，以进行后续处理。为了更好的对这些数据进行分析，我们将数据进行自定义的字段处理，并称之为“复合会话”。复合会话由一 个四元组作为唯一标识的实体，包括源IP,目的IP,网络协议和目标端口。相 较于传统的五元组，四元组可以更有效的汇总流量并进行传输。
数据采集设备持续不断的釆集数据，在这过程中，网络流量可能会分时段的 空闲和忙碌。因此，我们为复合会话定义了相应的忙期和闲期。当釆集设备检测 到上行或者下行的流量数据时，意味着此时为忙期，相应的忙期计数器增加一。 当两个上行或者下行的流量数据包被检测到的时间间隔超过一个阈值，如一秒或 者两秒，则可以认为此时为闲期，相应的闲期计数器增加一。
如图5-2所示，探测器以10MIN为周期，规律性的将采集到的数据（由宏 观、中观、微观三个维度的24个统计参数组成）形成一个文件，时间累积到一 定时间（即一个报告期时间，通常为3小时）后，所有的文件将被上传到中央服 务器，并作为一个新的文件存储。
V	汇总上报周期	A
图5.2周期上报示意图
复合彝
复合会话是我们在研究企业网流量数据时，为了便于分析而自定义的一种数 据格式。复合会话所包含的字段分为三个层面，即宏观层、中观层以及微观层， 每个层面又具化为多个统计量。宏观层主要统计了一个统计周期内的总流量、报 文等信息。中观层主要统计了一个统计周期内忙期和闲期的流量，此外还包含一 些简单的数学计算量。微观层主要统计了忙期时流量内的上下行报文数，并包含 更多的复杂的数学计算量。复合会话具体的统计信息如下图所示：
44
表5-1复合会话数据格式
类别	名称	描述
宏观层	TUP/TDP	上下行报文数
TUB/TDB	上下行字节数
TSE/TSR/TA
S	周期内新建/结束/活跃
中观层	BT/IDT	忙期/闲期总数
BE/IDE	忙期/闲期平均时长
v_bd/v_id	忙期/闲期标准差系数
微观层	E_TS	忙期内发言切换平均次数
E_DT/E_UT	忙期内上下行发言平均次数
E_DTP/E_U
TP	上下行发言平均报文数
E_DTB/E_U
TB	上下行发言平均字节数
V_DTP/V_U
TP	上下行发言报文数标准差系数
V_DTB/V_U
TB	上下行发言字节数标准差系数
当服务器接收到探针上传来的复合会话文件后，再对复合会话针对主机进行 进一步分析，得到主机流量的实时表、日表、月表。实时表是对复合会话即时的 记录，日表是对复合会话跨度一天内的流量数据进行统计记录，月表是对复合会 话跨度一个月内的流量数据进行统计记录。本实验用的数据为主机的实时表。实 时表的统计字段基本和复合会话一致，只是添加了部分字段。此处不多加介绍了。
在设备的一个统计周期结束后，复合会话的统计数据也会随之更新。但是此 时数据并不会上报，而是等一个汇总周期以后才会汇总上报。因此，考虑某些极 端情况，比如某次复合会话持续了一个汇总周期，则受限于设备的内存，复合会 话产生的数据可能会超过设备内存，从而导致设备崩溃。为了解决此类问题，研 究组设定了两个方案。一是针对复合会话的忙期闲期设定一个上限，即65535, 当超过该阈值时，则会将该复合会话的闲期、忙期统计量清零，重新开始进行数 据统计。其次是规定，当一个复合会话连续超过两小时没有产生流量数据，则将 该复合会话从设备中删除。只有当设备再次检测到该复合会话，才会对其重新记 录。
但是这样处理之后，可能存在一个问题，即将一个复合会话拆分记录到2 个统计文件中。因此需要对此2个文件中的同一会话记录进行合并。
假设复合会话被分成的两个文件分别包含m条记录和n条记录。
个部分的平均值和方差记为饥、e“和&、v?o则统计算法为：
（JYI _	+（72 _ l）Vn 4	_ e^）2
i =	*
7W +〃一 1
mem + nen
Cm + ■=
m-\~n
以此来计算整个复合会话的相关统计量。
