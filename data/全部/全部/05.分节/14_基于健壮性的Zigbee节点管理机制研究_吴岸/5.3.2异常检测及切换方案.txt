5.3.2异常检测及切换方案
Zigbee网络作为一种低成本低功耗的无线自组织网络，协议结构简单，节点处理能 力较弱。在设计网络冗余备份机制时，优先考虑机制的复杂度和开销。
协调器定时向全网广播心跳帧。所有其他节点启用定时器Timerl,在一定时间内没 有收到心跳帧（暂设为连续三个周期均未收到心跳帧）即判断当前网络情况可能出现异 常。此时节点以单播的方式主动向协调器请求心跳帧，若收到应答，定时器归零，继续 正常工作；若未收到应答，则判断网络状态出现异常。
网络状态出现异常后，节点需要判断是否是自身掉网导致无法接收心跳帧。此时节 点向自身父节点请求心跳帧，若无父节点，则选择邻居表链路状态最优的邻居节点。若 收到邻居节点应答，则可判断协调器出现异常。未收到邻居节点应答消息，则判断为节 点自身掉网，按节点预先配置，启动重接入流程。该步骤创新性地将节点的掉网检测和 协调器异常检测相结合，利用一次心跳检测，对网络当前节点状况进行了双重检测，流 程设计简单，节约网络开销。
当备用协调器确认当前协调器发生异常之后，启动网络切换流程。将网络重建标志 位Flag_rebuild置为1。进入切换协商过程。以两个冗余备份协调器为例。在网络配置 阶段预设置备份优先級Coor Backup Level,此例中为0x00和0x01。设立一组原语用 于处理网络切换协商过程。首先备用协调器向对端备份协调器发送网络重建协商请求原 语 NWK_REBUILD_NEGOTIATION.request。
表 5-1 NWK_REBUILD_NEGOTLATION.request 原语参数
名称	类型	有效值	说明
DeviceAddress	IEEE地址	任何有效的
64bitIEEE 地址	原语发送设备自身的IEEE地址
CoorBackupLevel	BYTE	0x00~0xFF	请求协商的备份协调器的优先级
发送网络重建协商原语后，备用协调器启动定时器Timer2,等待应答。如果相应
的NWK_REBUILD_NEGOTIATION.confirm原语状态值为SUCCESS,将存储的网络备
份协调器信息的协商状态标记为TRUEo若所有优先级小于自己的备份协调器协商状态
33
均为TRUE （本例中为优先级为0x00的备份协调器），则向全网广播网络重建帧。否则 放弃重建。
表 5-2 NWK_REBUILD_NEGOTIATION.confirm 原语参数
名称	类型	有效值	说明
DeviceAddress	IEEE 地
址	任何有效的64bitIEEE地
址	经协商后，同意网络切换的备份协
调器IEEE地址
Coor Backup Level	BYTE	0x00~0xFF	同意切换的备份协调器的优先级
Status	状态	SUCCESS
INVALID_REQUEST
UNKNOW_DEVICE
NEGOTIATION„FAILED	相应的请求状态
设备在发送网络重建协商原语后，备用协调器启动定时器Timer2,等待应答。若规 定时间收到对端备份协调器的应答，则将Status置为SUCCESS；若协商请求发送失败， 则将Status置为INVALID_REQUEST；若DeviceAddress不匹配设备存储的网络冗余备 份协调器地址，将Status置为UNKNOW_DEVICE；若超时未收到应答，则将Status置 为NEGOTIATION_FAILED。当且仅当状态为SUCCESS时，备份协调器才会向全网广 播网络重建帧。为了保证网络中所有设备都能收到网络重建帧，设置重启时间T_Restart, 然后备份协调器重启并新建网络。其中T_Restart是备份协调器重启需要的时间。
在网络重建过程中，所有设备同时加入新网络，会带来协调器的处理压力，影响网 络的玉.常重建。收到网络重建帧的其他网络节点设备会随机等待一段时间T_Random再 启动网络接入流程。其中T_Random = T_Restart+X/10, X为0-100的随机数。
网络异常检测及切换方案流程如图5-2。
34
是.
count++, count>3
放弃重建流程，更
新T_Sleep
其他设备收到忡络
更建慎
等待 T_Restart, 再&诚避一段时 fuJGiK新加入网结
.否—►
继续正常工作
'■-疋-►
给PAN协调器单播
心跳帧
仝网广播网络重建 帧,设置重启时间
T_Restart
垂启，成为新的
PAN协调器
图5-2网络异常检测及切换方案流程示意图
35
网络对端备份协调器在收到备用协调器发来的协商请求后，向上层递交网络重建协
商指示原语 NWK_REBUILD_NEGOTIATION.indication。
表 5-1 NWK_REBUILD_NEGOTIATION. indication 原语参数
名称	类型	有效值	说明
DeviceAddress	IEEE地址	任何有效的
64bitIEEE 地址	发起协商请求的设备的IEEE地址
Coor Backup Level	BYTE	0x00〜OxFF	请求协商的备份协调器的优先级
在收到该原语后节点进行判断。首先判断自身是否也在进行网络重建协商，即 Flag_rebuild是否为1。若不为1,则自身没有进行网络重建，发送协商请求应答帧；若 为1,则进行优先级判断。和自身优先级比较，若小于自身优先级字段值，放弃重建流 程，将Flag_rebuild置为0,并发送协商请求应答帧；若大于自身优先级字段值，则不 发送应答，继续自身的重建流程。网络备份协商机制流程如图5-3。
图5-3网络重建协商机制流程示意图
36
