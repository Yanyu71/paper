5.4.2实验结果分析
方案测试包括以下四个步骤。
(1)协议软件植入节点硬件
首先在MPLAB X IDE vl.8开发环境中创建一•个新工程，将安装5.3节所示的方案 设计修改过的Microchip Zigbee Pro协议软件的文件导入到工程中，其中检测周期设置 为5s<>然后用Microchip C30编译器编译生成可下载到目标单片机中执行的.hex文件。
最后，用PICKit3下载调试工具将运行MPLAB X IDE vl.8的PC机与节点硬件系 统相连，点击“下载”按钮将协议软件下载到硬件中。
(2)Zigbee无线网络搭建
由于条件有限，本次测试只用5个节点组网。一个协调器，两个备份协调器，两个 路由器节点。按照正常网络建立模式进行组网。
(3)节点掉网检测验证
保持正常网络状态5min,再让其中一个路由器节点移出网络通信范围。保持该状态 20s (大于三次检测周期)，观察路由器是否能发现自身掉网。再将路由器移入网络正常 通信范围内，看能否进行网络重新接入。
(4)网络重建机制验证
38
重启网络，保持正常网络状态5min。再关闭协调器。观察备用协调器能否进行网 络重建，其余路由节点能否正常加入新网络。图5-4为掉网检测实验结果。
图5-4路由器掉网检测工作日志
从路由器工作日志中可以看出，路由器在初始加入网络后，能够正常收发数据。之 后检测到路由器掉网后，能够自动启动网络重接入流程，重新加入网络。在重新加入网 络后，能够正常收发数据。	-
图5-5为备份协调器进行网络异常检测和网络切换的实验结果图。从下图中可以看 出，备份协调器在网络正常工作状态下，能够以路由器的身份进行网络通信。一旦检测 到协调器发生异常，将启动网络协商切换机制。利用系统重载，将自身切换为协调器, 重新建立网络。
39
图5-5备用协调器网络切换工作日志
实验结果表明，利用该套协调器冗余备份机制能够及时检测节点掉网并能在协调器 失效时，自动完成网络的重建和节点的迁移过程。该机制能够让网络在故障发生后及时 自我修复，仍然保持通信服务质量，提高了网络的健壮性。
现有的一些协调器冗余备份机制需要主协调器持续给备用协调器发送心跳帧，一旦 备用协调器不能收到心跳帧，则判断主协调器失效，启动备份机制，切换网络。但是这 种方案没有考虑到当备用协调器自身出现异常，如处于掉网状态，此时若错误启动备份 机制将导致形成新的网络，影响原有网络的正常工作。本文中提出的方案有双重判断机 制，在初步判断主协调器处于异常状态后，会进行二次判断，尝试和邻居节点通信，检 査自身状态是否正常。当自身状态正常时才会判断主协调器异常，重建网络。相比之下 更为可靠。
同时现有的协调器冗余备份机制通常只设立了一个备用协调器，容错性不强。本文 引入了优先级机制，当存在多个备用协调器时能够进行自主协调，避免冲突。
同时该机制还具有以下优点：
(1)将掉网检测帧和休眠帧进行复用。利用网络原有的定时发送的休眠帧来检测 网络是否正常，减小网络开销。
(2)在关键判定条件下叠加了计数机制，增大检测次数，保证检测的可靠性。
(3)将节点本身的掉网检测和协调器异常相结合，分别进行不同的处理，减少误 判可能，保证网络通信稳定，进一步增强网络的健壮性。
40
(4)在网络重建流程中增加冲突检测和协商机制，设立优先级，以小成本进行网 络重建协商。同时其余收到网络协商请求的备用协调器，如果自身处于未检测到协调器 异常的状态，将发送应答，同时保持自身的Flag_rebuild为0 一段时间。这是为了防止 在发送应答帧后，立刻检测到网络异常，启动网络重建流程，造成冲突。
(5)所有节点在收到广播的网络重建帧后等待时间T_Restart加上一段随机时间后， 再重启并接入新的网络。重建等待时间T_Restart可以保证节点在备用协调器完成新网 络的重建工作后再接入新网络，降低接入失败的可能性。考虑到节点新加入网络时会有 大量的交互过程，在等待T_Restart后再多等待一段随机时间，使其余网络节点错峰加 入重建的网络。避免同时处理大量交互信息，减小网络处理负荷和可能的错误。
41
