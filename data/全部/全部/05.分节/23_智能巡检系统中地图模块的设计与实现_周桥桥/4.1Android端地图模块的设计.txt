4.1Android端地图模块的设计
在本智能巡检系统中，为了实现巡检人员和监控中心的交互，我们开发了一 个Android应用程序(Patrolsystem)。巡检人员携带安装有该应用程序的智能手机 进行巡检工作，根据作业现场情况，实时的向监控中心上报；监控中心根据上报 的信息，向巡检人员下发相应的指令；巡检人员接收到指令后作出相应的处理。
为了使得巡检人员能够实时的查看自己的地理位置信息以及查看自己的巡 检路线、巡回区域，在智能终端的应用程序设计时，我们考虑了一个地图模块， 该模块提供一下的功能：
(1)在地图界面的顶端显示用户的地理位置信息，包括经纬度信息和地址 信息。在地图界面的地图上添加图标显示用户的当前位置，且当用户位置变化时， 能在界面上实时的更新地理位置信息。
(2)在地图界面的地图上显示巡检人员的巡检任务(巡检线路或巡回区域)。 用户将自己当前的位置与巡检任务对比，调整自己的巡检路线，提高巡检效率。
(3)提供精确定位功能，即巡检人员手动输入目的地的经度和维度信息， 根据该信息在地图上查找到目的地并显示出来。
为了实现上述第一个功能，我们将通过智能手机的GPS模块来获取巡检人 员的当前位置信息的。然而，通过GPS设备获取的经纬度信息是WGS-84椭球 下的大地坐标，与地图的平面直角坐标不同，因此，我们要进行坐标转换，以便 用于智能巡检系统中地图模块。目前，世界各国均釆用的是高斯投影实现该转换。 即通过巳知的大地坐标系中的大地经纬度(B,L),运用高斯投影正算公式，可 得到相应的地图直角坐标系的经纬度(x,y)o设参考椭球的长半轴为a,第一偏 心率为e,高斯投影正算公式的表达式如下SH29,
x = X + 告岫 + 土 (5 -12 + 9寸 + " )Ntm：
1
+——(61-58t2 + t4)Ntmo
■	720	]丿。	(4-D
y = Nm0 + -(l-t2 + r)2)Nm0
6
+ j^(5-18t2 + t4+14n2- 58t2T]2)Nm'
41
其中，t = tanB , 1 = L - Ln , mn = IcosB, N = .	=
Vl - e2sin2B
■ e2
H2 = 	2 cos2B , L、B为转换前的经纬度坐标，X、Y为转换后的高斯坐标，Lo
1 - e
为投影带的中央经线坐标。
在Android端应用程序的地图模块中，利用上述变换公式，将收到的GPS 大地坐标位置信息转换为地图上的经纬度信息，通过该经纬度信息查询用户所在 地的地址信息。在应用程序的模块界面设置两个个文本框显示分别用来显示经纬 度信息和地址信息，以便于用户的查看。同时，我们还提供可视化的査看方式， 通过在模块界面里加载百度地图，调用地图API接口中的函数对获取到的经纬 度信息加标记，并将该标记添加到地图的图层上，可视化地显示用户当前的位置。 在实际巡检工作中，巡检人员进行寻巡检任务时会不停的移动。因此，为了实时 获取位置信息，我们需要对巡检人员的移动设置监听函数。在该监听函数中，判 断用户位置是否发生变化，如果是，则获取变化后的经纬度信息，并通过更新后 的经纬度信息查询地址信息，然后在文本框中更新经纬度信息和地址信息，同时， 通过经纬度信息更新地图上的标记。
获取GPS经纬度
A信息并转换为地
图经纬度信息
图4-1 Android端地图界面实时位置信息
在实现上述第二个功能时，为了便于用户的使用，以及避免用户每次查看任 务时，都得向服务器发送服务请求。在设计应用程序时，我们将把监控中心下发 的巡检任务存储到Android手机中，这样用户再次查看巡检任务时，只需要读取 出智能终端中存储的巡检任务，有效地减小了 Android端应用程序和服务器之间 的数据传输量，避免了传输所造成的用户等待时间。尤其是当巡检人员在网路状 况不佳的地点时，采用这种方式优点更明显。具体地：巡检人员通过用户名和密
42 码向发服务器发起登录请求，服务器检査该巡检人员是否为合法用户，若是，在 服务器的数据库中査询巡检人员当日的巡检任务，将任务返回给客户端程序，客 户端程序将收到的巡检任务存储到手机中。为了实现上述存储功能，我们将使用 Android系统中自带的SQLite数据库。
SQLite是一款轻量级的遵循ACID的关联式开源数据库，主要由SQL编译 器、内核、后端及附件组成也】。SQLite数据库与其它类型的数据库最大的差别 在于其对数据类型的支持具有“弱类型”，即我们可以将任何数据类型放入任何 的列中，如可以把String型的数据插入到Integer型的列中。此夕卜，SQLite还具 有以下一些优点：
・所占用的系统资源非常低，一般只需要几百K的内存就可以满足了。
・ 接口支持多种开发语言，如C、Java、PerR Ruby等等。
・高效率，执行速度比大部分主流的数据库都要快。
・很好的独立性，没有任何的额依赖。
•跨平台，除支持主流的操作系统外，还支持一些其他不常用的操作系统 Android系统提供了一整创建和使用SQLite数据库的接口，包括创建数据 库、删除数据库、打开数据库、关闭数据库、创建数据库表、删除数据库表等等。 表4-1列出了数据库中最常用的几种方法。其中，Cursor类用来表示查询返回 的结果集，提供了 moveToFirst ()、moveToNext ()等方法。
表4-1 SQLite中常用方法
(返回值)方法	方法描述
create(SQLitedb)	实现创建数据库功能
open(SQLitedb)	实现打开数据库功能
getReadableDatabase()	创建或者打开_个査询数据 库
getWritableDatabase()	创建或者打开一个可写数据 库
OnUpgrade(SQLiteDatabsedb> int old, intnewVersion)	实现更新数据库功能
(long) insert(String table,String nullColumnHack^ContentValues values)	添加数据行的便捷方法
(int) deleteQ	删除数据行的便捷方法
(int) update(String table, Content Values values, String whereClause, String[] whereArgs)	更新数据行的便捷方法
(void) execSQL(String sql)	执行一个SQL语句，可以是 一个select或其他的sql语句
(Cursor) query (String table, String[] columns, String selection, String[] selectionArgs, String groupBy, String having, String orderBy, String limit)	查询指定的数据表返回一个 带游标的数据集
43
根据智能巡检系统的需求分析，在Android客户端，我们设计了巡回线路和巡回区域两 张数据库表，分别用来存储巡回线路和巡回区域的相关信息。表的设计如下：
表4-2 Android端巡回线路信息表
表4-3 Android端巡回区域信息表
表名	T Circle
署主	YDS
说明
主键	circleid
字段名称	　　　字段含义	字段类型	默认值	备注
regionid	　　K域的序号	　　1 varchar(4)		区域的标识
circlelng	　　　中心经度	float	0	»	玄域中心经度’
circlelat	　　　中心纬度	　　1	float	0		区域中心纬度
circleradius	　　　区域半径	float	0		　区域半径
