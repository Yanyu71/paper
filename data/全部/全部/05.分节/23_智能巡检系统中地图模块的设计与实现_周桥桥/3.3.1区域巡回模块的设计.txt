3.3.1区域巡回模块的设计
在实际中，一些企业为了保护它的基础设施，通常会在一些重点的区域内设 置宣传标语。例如，在通信行业，运营商会指派巡检人员在某一区域悬挂宣传标 语“爱护光纤，人人有责”。通常，这些宣传区域是由企业的管理者事先规划制 定好的，.然后分配给相关的巡检人员，巡检人员接受该区域宣传任务后，将宣传 标语带到相应的区域。在该区域内寻找一个比较适合的点（例如：人流量最大的
30 地点或该区域内设施损坏频率最严重的地点）悬挂宣传标语。在巡检人员工作的 过程中，随身携带的智能终端会随时向监控中心的服务器上传它的经纬度信息， 服务器根据上传的经纬度信息检测他是否越界。如果越界，服务器将向智能终端 推送通知，提醒巡检人员。另外，巡检人员亦可通过智能终端向监控中心上报作 业情况，以便管理人员了解宣传的作业情况。
基于上述需求分析，在智能巡检系统的设计时，考虑一个区域巡回模块是很 有必要的。在该模块中，我们做如下的功能设计：（1）用户可通过百度地图可视 化地制定区巡回区域。（2）把所有制定好的巡回区域以列表的形式将其关键字段 呈现出来，当用户单击某一具体行时，将详细的展现该巡回区域信息。（3）对已 制定好的巡回区域提供修改和删除。（4）用户可通过一个或多个关键字段的组合 快速查询巡回区域。
图3-14区域巡回模块流程图
在制作巡回区域过程中，为了直观、方便以及精确的制定巡回区域，管理人 员可直接在百度地图上双击产生两个点。其中，第一个点为圆心，第二点为圆上 的一点。通过这两个点，我们可以形成了一个以二者的距离为半径，第一个点为 圆心的圆。用户通过拖动这两个点，可动态的调整区域范围，形成所需巡回区域。
为了便于用户的查看，在制定巡回区域时，我们还需要添加了一些其它信息, 用以描述该巡回区域。具体地，每一个巡回区域都由区域的基本信息和地理化信 息组成。基本信息主要包括区域的编号，区域的名称、宣传内容组成。其中，区 域的编号是用户在制定线路时必须输入的字段，它作为该条巡回区域在数据表中 的主键，是该区域的唯一标示。且一旦该巡回区域信息存储到数据库后，区域的
31
编号将无法更改。区域的名称则是通过文字阐述该区域的地名。宣传内容用来描 述巡检人员在该宣传区域内要进行哪些宣传工作或是宣传标语的悬挂。地理化信 息主要包括该巡回区域的圆心的经纬度信息及该区域的半径。当用户在地图制定 区域时，我们在页面设计了两个信息框，用以动态的显示区域的中心经纬度信息 和区域的半径。对于精确度要求很高的区域巡回，用户也可以直接在这两个信息 框中输入圆心的经纬度和半径。
根据上述区域制定的方法，在制定区域时，我们需要通过计算地图两点之间 的距离来得到圆的半径。即我们需要通过这两点的经纬度信息来计算它们之间的 球面距离。在实际情况中，巡回区域的半径远小于地球半径，因此，在本系统中， 我们不考虑圆心与圆上的点在地球的不同半球上，只考虑两点位于同一半球的情 况。对于地球表面上两点A(w】,jj)、B(w2, j2),其中Wj为纬度，/为经度。 它们之间的球面距离做如下的推导［坷：
如图3-15所示，a、b为A、B两点所在的经线平面，1为地轴，MO、NO 为赤道平面与此二面角的交线，0为地心，地球半径为R ,过A作AC11,过 C 作 DC丄 1, BD〃1。
B
图3・15球面上两点
在 ZiACD 中，AC =7?-cos Wj , DC=7? -cosw2, ZACB=y1 - j2
据余弦定理可得：
AD2 =(R・cos叫T +(R・cos*2)2 —2R2.COs w,cosw2 cos(7j -j2)	(3-1)
•/ DB = DE+BE = J?・ sin 叫 + R • sin w2
又•- AABD^RtA,
/. ab2=ad2+db2
AB2 =2R2 — 2R2 cos叫 cos w2 cos(- J2) + 2J?2 sin叫 sinmz2	(3-2)
在AAOB 中，知道了 AB,且 AO=BO=R» 设ZAOB=。
由余弦定理可得：cos a = coswj cos w2 cos(Jt — j2 )—sin W] sinw2	(3-3)
a = arccos (cosW]COSW2Cos(j] - j2) - sinWjSinWj)	(3-4)
a为A、B两点所成的球心角
A、B两点之间的球面距离即为过A、B两点的大圆的劣弧，即：
球面距离=^^^2俎	(3-5)
特殊情况，当丄=&时，a= W]-w2 =
利用上面的球面距离公式，我们可以通过获取地图上两点的经纬度信息来计 算出以他们作为圆心和圆上的点的圆的半径大小。以区域圆心的经纬度和半径作 为参数，调用百度地图API提供的画圆函数，则可以在地图上画出相应的巡回 区域。具体地，在添加区域巡回信息页面，我们对加载到页面的地图的添加地图 双击监听事件，当用户双击地图时，将触发该监听事件，在该监听事件函数中，首先 判断标记数组中的元素个数，如果大于1个测弹框提示已有两个点；否则，获取 该点的经纬度信息并存储到经纬度数组中，对该点添加标记并存储到标记数组 中。然后，判断标记数组中的元素个数是否等于2,如果是，则读取经纬度度数 组中的这两个经纬度信息，利用上述的球面距离公式，计算出半径，以第一个点 的经纬度和所得半径为参数，调用百度地图API中画圆函数实现区域制定。
在管理人员在实际制定巡回区域时，为了提高精确度，需要动态的调整这两 个点位置。因此，为了便于管理人员的操作和实现对所制定的区域巡回进行修改, 我们还需要对地图上双击产生的标T己点设置一些其他的监听事件。在本系统中， 考虑到用户的实际情况。我们将对地图上的标记点设置双击的监听事件和拖拽的 监听事件。当用户对地图上的标记点双击时，将触发该标记点双击监听事件，在 该事件中，我们首先在要清理地图上的图层，然后，将该标记删除。具体做法是, 循环读取标记数组中的数据，把读取出来的数据与双击的标记比较，判断该标记 在数组中的位置，通过数组的spice函数将对应位置的数据从标记数组和经纬度 数组中删除，并在地图上移除该标记[20][2,]o当用户对地图上的标记点拖拽时， 将触发该标记点的拖拽监听事件，在该事件函数中，同上，我们首先要清理地图 上的图层，其次，记录标记点拖拽后的经纬度，循环读取标记数组中的数据，将 读取出的数据与拖拽前的标记点比较，找到该标记点在标记数组中的具体位置， 用拖拽后的标记点及其经纬度信息更新标记数组和经纬度数组中的数据。最后， 判断更新后的标记数组中的元素个数是否等于2,如果是，以经纬度数组中的数 据为参数，调用地图的画圆方法在地图上制定巡回区域。
33
个数小于
"2个
创建标记 保存经纬度和标记至U —相应数组中
'无拖拽
有拖拽
循环读取标记数组中
的数据
不相等
与拖拽的前的标记 做比较
不相等/ " '
L /与双击的标记做
比较
相等
相等
* ..1
在地图上删除该标记，
添加标记的拖拽和双
击监听事件
i更行经纬義数组和标
记数组对应位置的数
I .据］
冊4除标记数组和经纬
度数组中对应位置的
数据
不是
判断标记数组中元
素是否为z个
是
根据经纬度数组画圆
图3-16巡回区域制定的算法流程
在区域巡回模块中，客户端与服务器端之间的交互影响均是通过对数据库中 相应表的增加、查询、修改、删除等操作实现的。因此，区域巡回模块中数据库 表的设计是实现区域巡回模块必不可缺的一部分。根据上述功能需求和业务分 析，我们设计了一张区域信息表(T_AreaInfo)：保存区域信息，包括唯一标识id、 区域的圆心、区域的半径等重要信息。数据库表的详细设计如下所示：
表3-4巡回区域信息表
表名 署主 说明
回区域信息表
主键
34
