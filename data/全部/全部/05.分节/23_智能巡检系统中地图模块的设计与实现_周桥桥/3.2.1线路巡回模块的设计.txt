3.2.1线路巡回模块的设计
- 随着社会的不断发展，电信、银行、物流、天然气、邮政、消防等网络的规 模不断扩大，维护工作变的日益重要。为了确保这些线路的正常运行，公司需派 出工作人员到线路上检査，以便及时的发现隐患，釆取相应的措施防患于未然。 例如：在通信行业中，需定期指派巡检人员对基站、易受到人为破坏的光纤线路 进行检查。如果发现问题，巡检人员将通过所携带的智能终端向监控中心上报隐 患以便采取相应的措施，保证通信网络的正常运行。因此，在系统的整体设计时，
22 考虑一个线路巡回模块是很有必要的。
在智能巡检系统中，考虑到线路巡回的需求以及行业的特点，基于用户可操 作、开发人员易维护的原则，线路巡回模块主要包括巡回线路信息和巡回线路计 划两个部分，具体作如下的功能设计：
(1)在线路巡回信息子模块中，用户可通过百度地图这一可视化地理显示 工具制定线路，对己制定好的巡回线路进行修改或者删除，提供通过关键字段快 速查询线路，提供详细查看巡回线路信息。
(2)在线路巡回计划子模块中，用户可以将已制定好的巡回路线指派给相 关的巡检人员，并设置该计划任务执行的开始时间和结束时间。对错误的线路巡 回任务提供修改或删除,提供通过一个或者多个甚至全部关键字段快速查询已制 定好的巡回线路，提供详细查看己制定好的巡回线路计划。
「开始)
图3-6线路巡回模块流程图
根据上述的功能设计，线路巡回模块分成两个页面，一个页面负责巡回线路 信息子模块，另一个页面负责巡回线路计划子模块。在巡回线路信息管理页面， 以列表的形式给出了所有制定好的巡回线路的一些关键信息，当用户双击某一行 时，将在页面下半部分展现制定好的巡检路线。提供了选择框，用户可以通过选 中一个或多个选择框，将对应的巡回线路删除。提供了快速查询功能，用户可通 过线路编号这一关键字段快速的查询线路。此外，还提供了添加线路按钮，点击 它，将跳转到添加线路信息子页面，该子页面借助了百度地图这一可视化地理显 示工具，用户可以很方便的制定巡回线路。在巡回计划管理页面，以列表的形式 列出了所有制定好的巡回线路计划的一些关键信息。当用户双击某一行时，将在 页面的下半部分展现规划好的线路巡回计划。每一行信息前面有一个选择框，用 户可以通过选中一个或多个选择框，将对应的线路巡回计划删除。提供了快速查 询功能，用户可通过一个或多个甚至全部关键字段对线路巡回计划进行过滤与筛
23 选。另外，在页面上设置了一个添加计划按钮，点击该按钮将弹出一个对话框， 用户通过在该对话框中填写相应的信息实现线路巡回计划的制定。
在添加巡回线路过程中，为了直观、方便及精确的制定巡回路线，用户可以 直接在百度地图上双击产生一系列的标记点，用直线连接这些标记点形成用户所 需的线路；同时，允许用户通过拖拽制定好的线路上的标记点来改变线路轨迹； 对于产生的错误的标记点，用户只需在该标记点上双击就可以在地图上取消该标 记点，同时该标记点的前后标记点会自动连接成一条直线。
为了便于用户的查看，在制定巡回线路时，我们还需要添加了一些线路的基 本信息，用以描述该条线路或巡检人员在执行该任务是应当着重查看的地段。具 体地，每一条巡检线路都由线路的基本信息和标记点信息组成。基本信息主要包 括线路的编号，线路的起点、线路的终点、备注信息组成。线路的编号是用户必 须输入的字段，该项作为该条巡回线路在数据表中的主键，是本条线路的唯一标 示。一旦该条线路巡回信息存储到数据库后，线路的编号将无法再更改。标记点 信息为该条线路上的标记点的经纬度信息，当用户通过鼠标双击地图时，会获取 到该点的经纬度信息.我们在页面设计了一个具体信息框，用以显示各个点的经 纬度信息.对于精确度要求很高的线路巡检，用户也可以直接在该具体信息框中输 入标记点的经纬度信息。
在线路巡回模块中，百度地图画线是重点，也是难点。为了实现上述添加线 路的功能，我们必须要使用数组，通过数组来记录各个点的的经纬度、地图标记 等信息。并且按照数组中的经纬度信息来绘制巡回线路，同时通过事件侦听函数 来完成对数组数据的修改，然后通过更新后的数组来重新绘制巡回线路。具体地， 我们需要对在加载到页面的百度地图设置地图双击的监听事件，当用户通过鼠标 双击地图时，将触发该监听事件函数，在该监听事件函数中，我们首先将该点压 入到点数组中，同时，获取该点的经纬度信息，将其拼装成特定的形式存储到经 纬度数组中，然后，调用百度地图API提供的方法对该点添加标记，将该标记 存储到标记数组中，并在地图上显示出来。最后，调用画线函数，在该函数中， 我们首先判断，点数组中是否只存在一个点，如果是，则结束。否则，循环读取 出经纬度数组中的GPS信息，通过调用百度地图API将这些点通过直线连接起 来形成一条巡检线路。在用户的实际操作中，用户有可能在画线时做修改。因此, 为了便于用户的操作和实现对所画的巡检路线进行修改，我们还需要对每一个双 击产生的标记点设置一些其他的监听事件。在本智能巡检系统中，考虑到实际需 求情况。我们将对地图上的标记点设置双击的监听事件和拖拽的监听事件。当用 户对地图上的标记点双击时，将触发该标记点双击监听事件，在该事件中，我们 首先在要清理地图上的图层，眞次，将该标记删除。具体做法是，循环读取标记
24
数组中的数据，将读取出的数据与双击的标记比较，如果是，则该标记点从地图 中移除以及通过数组的spice函数将相对应的点从点数组、标记数组和经纬度数 组中删除。最后，调用画线函数，根据更新后的经纬度数组重新连线。当用户对 地图上的标记点拖拽时，将触发该标记点的拖拽监听事件，在该事件函数中，同 上，我们首先要清理地图上的图层，其次，记录标记点拖拽后的经纬度，循环读 取标记数组中的数据，将读取的数据与拖拽前的标记点比较，找到该标记点在原 来点数组和标记数组中的位置，用拖拽后的标记点及其经纬度替换原来的数据。 最后，调用画线函数，根据更新后的经纬度数组重新画线。
删除标记数组和经纬
度数组中相应的数据
根据经纬度和标记
数组画线
图3-7地图画线算法流程图
在线路巡回模块中，浏览器端与服务器端的交互影响均是通过对数据库表字 段的增加、删除、修改、查询等操作实现的。因此，线路巡回模块中数据库表的 设计是实现线路巡回模块必不可缺的一部分。根据上述的功能需求和业务分析， 我们设计了三张数据库表：巡回线路信息表(T_Patrollineinfo)、巡回线路标记 点信息表(T_P.atrollinepoint)、巡回线路计划信息表(T_Patrolrule)。巡回线路 信息表用来存储一条巡回线路的基本信息，巡回线路标记点信息表用来存储一条
25
巡回线路的GPS信息及其先后顺序，巡回线路计划信息表用来存储一条线路巡 回计划信息。由此可见，一条巡回线路的所有信息是通过两张表的存储来联合表 示的。这么做的好处是可以有效地提高存储效率，因为，在一条巡回线路中，存 在很多个标记点，由于这些标记点都属于同一条巡回线路，因此，它们的基本信 息是一样的。如果通过一张表的存储将会存在很多基本信息的冗余导致存储效率 较低。数据库中表的设计如下所示：
表3-1巡回线路基本信息表
表名	T Patrollineinfo
署主	YDS	　■汶】二1龍;「云
说明
主键	patrollineid
字段名称	　　字段含义	字段类型	默认值	备注
patroll ineid	　　线路的编号	varchar(4)	n	线路的唯i标识
beginpoint	　　线路的起点	varchar(20)		线路的起点信息
endpoint	　　线路的终点	varchar(20)		线路的终点信息
memo	备注	tinytext	If	线路的备注信息
表3-2巡回线路标记点信息表
表名	T Patrol 1 i nepoint
署主	YDS
说明	巡回线"信息表
主键	patrol Line id
字段名称	字段含义	字段类型	默认值	备注
patrollineid	线路编号	varchar(4)		　　线路编号
pointorder	线路点编号	int	0	线路中标记点的 顺序编号
longitude	经度	float	0	　　点的经度
latitude	纬度	float	0	　　点的纬度
表3-3巡回线路计划信息表
表名	T Patrolrule
署主	YDS
说明	土E龙项""二口表
主键	lineplanid
字段名称	　　字段含义	字段类型	　　　默认值	备注
lineplanid	　　计划编号	int
； ■	　　　"""		线路巡回计'划的 唯一标识
driverid	　　司机编号	varchar(4)		执行计划的巡检 人员编号
patrollineid	　　线路编号	varchar(4)		该计划线路编号
starttime	　　开始时间	datetime	2014-01-01
00:00:00	计划开始时间
26
（续上表）
字段名称		字段含义	字段类型	默认值	备注
endtime	结束时间	datetime	2014-01-00
23:59:59	计划结束时间
memo	　　　计划备注	varchar(200)	it	计划的备注信息
