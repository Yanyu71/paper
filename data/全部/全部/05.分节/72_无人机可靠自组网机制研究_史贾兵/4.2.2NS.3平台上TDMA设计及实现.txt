4.2.2NS.3平台上TDMA设计及实现
时分多址是一种无竞争的媒体访问协议。网络中所有节点共享的信道带宽被 划分为这些节点中专用的时隙。每个节点仅在分配给它的专用时隙期间传输数据。 传输时隙通常是固定的时间间隔。每个传输时隙由一个保护间隔隔开，以便传输 不重叠。保护间隔的值由简单无线信道模型决定。这通常是数据包传输距离所规 定的距离所需的时间。在这个简单的TDMA模型中，假定节点的时钟是同步的。
TDMA的NS-3实现有一个集中的TDMA控制器，为网络中的各个节点分 配传输时隙。图4-5是TDMA模块的架构图，在这个架构中主要的类有“NS-3 :: TdmaControlIer,,, “NS-3 :: TdmaCentralMac"和"NS-3： TdmaMacQueue"。NS-3 :: TdmaController 控制协议的调度。NS-3 :: TdmaCentralMac 功能有 TDMA 帧 处理，创建MAC头和尾部以及MAC回调机制。NS-3 :: TdmaMacQueue负责数 据包的入队和出队。
图4-5 TDMA模块架构图
33
TdmaCentralMac类的基类是TdmaMac。目前的实施考虑简单的集中式 TDMAMAC协议。但是，考虑到分布式TDMA模型的其他可能实现，在这里 创建了一个通用基类，以便可以从中派生出其他实现。所有准备好由节点传输 的数据包都从网络层发送到TdmaCentralMac。接收到数据包后，将它们排入队 列并等待数据被发送的时隙发送数据包。节点等到自己发送的时隙， TdmaCentralMac类查找自己队列TdmaMacQueue的数据包发送数据。然后迭代 地将数据包出队，附加MAC头部和尾部，并将它们发送到 SimpleWirelessChannelo在发送之前，TdmaCentralMac根据数据包大小和数据 速率计算所需的传输时间。将所有发送数据包的传输时间相加，并将其与由 TdmaControlIer分配给它的时隙SlotTime进行比较。如果无法在该时隙中传输 更多的数据包，则停止传输。简单无线信道将数据包转发给所有的节点，节点 可以通过在仿真开始时由用户指定的MaxRange属性值判断是否接受。 TdmaCentralMac也负责从简单无线信道接收数据包。它删除附加的MAC头和 尾部，并将数据包转发给网络层。
TdmaMacQueue用来维护一个数据包队列，存储从网络层收到的数据包， 直到到达它的传输时隙。可以修改这个类的属性是队列长度MacQueueLength 和数据包在队列中的持续时间MacQueueTimeo因此，在队列大小达到 MacQueueLength之后，所有试图进入队列的数据包被丢弃，并且存储在队列 中的数据包长于MacQueueTime的时间间隔也被丢弃。
TdmaControlIer负责协议的所有调度方面。它启动TDMA会话并授权节点 在其指定的时隙中传输。它用来给节点设置时隙持续的时间和控制全局时隙的 数目，作为节点在仿真开始时指定的属性。时隙默认值为UOOus,保护时间为 lOOuso
在仿真过程中主要包括两方面的过程，首先在仿真开始后TdmaControDer会 对每个节点分配各自的时隙。然后通过调度函数去不断地周期性轮询时隙来让 对应的节点发送数据在每次轮询到一个时隙则会调用TdmaCentralMac类中的 StartTransmission函数去发送数据，此时通过判断队列中是否有数据还需要判断 传输数据所需时间是否小于时隙剩余的时间，只有这两个方面同时成立才能讲 数据传输到TdmaMacLow进而传输到信道。当传输到目的节点时判断数据包传 输到距离是否超出了设定的通信范围，如果没有超出则像图5一样一步一步地向 上层传输。其次在节点有数据发送的时候，网络层讲数据发送给TdmaNetDevice 然后在发送到TdmaCentralMac类并不是将数据包直接发送出去，而是先存到队 列当中，这时候就用到了TdmaMacQueue来维护数据包队列，这个类中的功能 34
有出队，入队，清空队列，获取队列长度等。通过判断队列中数据的多少和每 个数据包存放的时间过期与否来删除数据包。
