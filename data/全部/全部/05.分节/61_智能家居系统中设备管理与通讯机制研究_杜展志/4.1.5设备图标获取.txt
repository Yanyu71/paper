4.1.5设备图标获取
根据第三章设备图标的获取，可以知道为了保障每个设备显示最优的图标，本 智能家居系统为每个设备配备了默认图标、静态图标和动态图标，这三种图标在显 示优先级上为动态图标大于静态图标，静态图标大于默认图标。但由于动态图标需 要控制设备根据url从外网获取数据，而静态图标可以通过与设备建立会话从设备端 获取，默认图标则只要发现设备就可以获取。这三种的响应速度可以看出分别为默 认图标大于静态图标，静态图标大于动态图标。为了同时保证每个设备图标的质量 和响应速度，本智能家居系统在获取图标和显示图标采用两套截然相反的方法。其 中显示图标严格按照显示优先级来执行，只要存在质量更高的图标就进行替换，但 是在获取的时候会依据响应速度获取，当获取到更优质量的图标时，会发出系统通 知更换控制设备上响应的设备图标。
考虑到设备每次都需要建立新的线程去获取设备的静态图标和动态图标，其中 静态图标的内容、大小以及动态图标url的获取都需要和设备建立会话获取，因而可 以将静态图标和动态图标的获取线程放置在同一个线程中，且将与设备建立会话获 取的信息存储起来，防止获取图标失败时，每次需要建立新的会话来获取这些信息
65
以减少控制设备的资源损耗和提高响应速度。
本智能家居系统在开发的过程中，通过半个布尔字节来标志设备图标的获取状 态，0位为About Icon接口支持位，代表设备是否支持about,为false代表不支持 aboutlcon,为true代表支持Aboutlcon； 1位为About元数据获取位，代表控制设备 与设备建立会话获取icon元数据状况,为true代表获取成功,为false代表获取失败； 2位为静态图标获取位，代表静态icon获取情况，为true代表静态图标获取成功， 为false则代表静态图标获取失败；3位动态图标获取位代表根据url下载动态图标状 态，为ture代表动态图标下载成功，为flase代表动态图标下载失败。
本智能家居系统设备图标获取的实现逻辑如图4-7所示：
a）目标设备是否支持Aboutlcon,是跳转到b；否结束，设备显示默认图标
b）将About Icon接口支持位标记为1
c）与目标设备建立会话，成功跳到步骤e,失败跳到重试逻辑
d）与目标设备建立会话次数是否小于10,是跳转到步骤c,否跳转到重试逻辑 e）根据AboutlconProxy获取设备图标的元信息，包括静态图标数据内容和动 态图标的url,失败跳转到重试逻辑
f） About元数据获取标记位置为1
g）获取静态图标并表存，失败跳转到重试逻辑
h）静态图标获取位标记为1
i）更新设备显示图标为静态图标
j）根据获取的url地址下载动态图标，失败跳转到重试逻辑
k）动态图标获取位标记为1
1）更新设备为动态图标 重试逻辑流程
a）	About Icon接口标记位是否为L否跳转到获取逻辑a
b）	About元数据获取标记位是否为1,否跳转到获取逻辑c
c）静态图标获取位标记是否为1,否跳转到获取逻辑g
d）动态图标获取位标记是否为1,否跳转到获取逻辑j
66
图4-7设备图标获取逻辑流程
67
