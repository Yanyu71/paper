3.6.9心跳机制
由于智能家居系统需要实时监控设备的状态以响应特定时间点对于某一个单独 设备的控制。所以本智能家居系统在控制设备端实现了专门的心跳机制来监控网络 中的设备在线状态。由于智能家居系统操作的主要对象为上线的标准设备和瘦客户 端设备以及未配置入网的瘦客户端设备，因而本文针对这两种情况设计了不同的心 跳机制实现方式。
由于未配置上线的设备在本质上是一个软AP,所以对于未配置上线设备的心跳 机制通过控制设备的Wi-Fi模块来实现，具体来说，控制设备会通过Onboarding的 scan( )API对于控制设备网络的附近的AP进行周期性扫描，具体时间通过 DEFAULT_HAERTBEAT决定。控制设备会注册相应的监听器来保持对Onboarding 的扫描结果的监听，如果接收到Onboarding九个状态之一的 OnboardingManager.EXTRA_ONBOARDEES_AP,且携带的设备列表消息不为空，则 代表控制设备周围存在未配置入网的瘦客户端设备。将这些扫描到的设备跟控制设 备在上一轮监听到的设备列表进行比较，就可以获取设备的新状态，
对于已经上线的标准设备和瘦客户端设备心跳机制的设计需要考虑系统内设备 底层的AllSeen通信方式。因为本智能系统中采用的部分硬件为市场上已有的AllSeen 设备，而另外一部分是智能家居系统开发的新的硬件，这些设备运行的AllSeen服务 框架版本存在一定的差异性，因而底层的通信流程也存在一定的差异，有的采用NS 进行服务的广播和发现，有的采用NGNS进行服务的广播和发现。为了保证本文设 计的智能家居系统能兼容这些采用不同底层通信方式的AllSeen服务框架的设备。本 文决定采用AllSeen服务框架的NGNS来设计本文的心跳机制从而满足对不同版本 硬件的心跳检测。
对于运行14.02版本或是基于NS的AllSeen设备，可以通过接收该设备的IS-AT 消息来实现。如果接收到IS-AT消息则认为该设备在线，如果连续三次都没有接收 到设备发送的IS-AT消息，则代表设备已经处于离线状态。服务客户端就会触发 LostAdvetisedName()方法将设备离线的状态传送到应用端。
由于AllSeen服务框架中，IS-AT消息的默认重传间隔为30s,基于IS-AT消息 机制的设备状态检测方式将导致90〜120s的时延，这对于绝大多数应用是无法容忍 的。因而在14.06版本中，AllSeen通过NGNS提出了一种更有效的设备状态检测方 法。这种方法由服务客户端通过单播信号实现。当近邻网络中某个服务被服务客户
51
端发现，服务客户端就可以通过调用相应的API来检测这个服务是否处于在线状态。
考虑到每个应用程序都有不同的设计逻辑，开发人员可能需要在不同的时间点 和逻辑点去检测其它设备的在线状态。AllSeen的NGNS将有关设备状态检测的部分 直接以独立接口的方式暴露出来以方便应用程序开发人员根据自己应用的逻辑去检 测设备状态。NGNS的检测API支持同步和异步两种模式，但从总线协议的角度来 看，这两种模式具有一样的消息序列。
本智能家居系统考虑到标准设备本身的硬件条件以及业务需求，最终决定采用 异步模式设计该系统的心跳机制，具体来说，控制端设备会开发一个设备管理器， 该管理器将存储发现的每一个服务端设备，并且周期性地利用AllSeen的Ping( )API 去检测每个设备的状态，并且会注册相应的监听机制，一旦发现某个设备掉线，该 设备管理器就会从设备列表中移除该设备。具体来说，对于已经配置了入网信息的 标准设备和瘦客户端，本系统框架对于单一设备单状态检测的消息序列主要如图 3-18所示：
消费端应用(NGNS)
图3-18控制设备检测基于NGNS的服务端设备在线状态流程
控制设备的设备管理器通过调用Ping接口根据WKN来检测某一服务设备是否 在线。如果服务端基于NGNS进行服务的广播和发现，那么标准设备将把网络中广
52
播的服务提供端的所有WKN记录在AllSeen的路由表中，在检测某一服务端是否在 线的时候，标准设备会通过单播消息查询服务端的状态；如果服务端在线，在接收 到该mDNS消息时，服务端的AllSeen路由就会通过D-Bus的Ping () API连接相 应的总线附件从而检测该服务应用的在线状态。如果连接成功，则通过mDNS回复 标准设备服务在线，否则将回复设备不在线。
另外一种情况是服务端的广播与服务采用基于名字系统的方式，那么该服务端 的路由就不支持Ping ()接口。此时服务端会给标准设备返回一个Ping接口没有实 现的异常，标准端设备的应用在接收到该异常之后就会调用基于NS系统的 FindAdvertisedName ()接口来检测该服务的在线状态，如图3-19所示。
服务端应用(NS)
消费端应用(NGNS)
AllSeen 应用
AdvertiseName ()
AllSeen核心库
Fi ndAdvert i sedName () LostAdvert isedName ()
AllSeen 应用
AllSeen核心库
命名服务
AllSeen 路由
NGNS
AllSeen 路由
周期IS-AT (名称)
通过NS找到名称：依靠周 期IS-AT信息确认存在
图3-19控制设备检测基于NS的服务端设备在线状态流程
