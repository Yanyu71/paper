3.6.11AllSeen分布式代理
AllSeen是基于Client/Server的点对点的模型，因而在开发基于AllSeen服务框 架的移动应用时，需要通过在设备间建立会话进行通讯，下图3-25-a和图3-25-b分 别描述了 Wi-Fi协议和蓝牙协议下的AllSeen会话结构。
56
图3-25 a) Wi-Fi多点会话结构b)篮牙多点会话结构
如图3-25-a所示，当AllSeen服务框架采用Wi-Fi作为底层接入技术建立多点会 话时，会话拓扑结构成星型。在主机创建会话后，其后陆续加入的成员会按如上结 构分别与会话中先前的成员分别建立连接。由于链路的完整性，当会话中某一成员 可以按需选择是通过单播信号还是多播信号给其它成员或其它多个成员发送信号。 当AllSeen服务框架采用蓝牙作为底层接入技术建立多点会话时，会话拓扑结构如图 3-25-b所示会成发散型。在服务端创建会话后，其余陆续加入的控制设备会按上述 结构与服务端建立会话。当客户端需要给其它成员或其它多个成员发送信号时，则 需要通过主机进行单播或是多播转发，相对于Wi-Fi协议而言，采用蓝牙协议作为底 层通讯技术时，服务端在信息交流时损耗资源更多。
由于AllSeen服务框架采用的是服务端-客户端模式而非对等模式，充当服务端 和客户端的设备往往承担不一样的工作量，服务端需要比客户端承担更繁重的信息 交互，尤其在开发某些特殊的应用时，建立会话的主机在功能需求上也比加入会话 的客户端更多，比如主机需要承担交互系统的数据存储和逻辑功能的开发等相对耗 费资源的任务。如果此时采用的底层通信协议为蓝牙而非Wi-Fi,对于充当服务端的 设备硬件性能要求将更高。然而基于AllSeen服务框架的交互系统内的设备不是哑设 备，就是交互性较强的移动性可便携式设备，这些设备由于体积和成本方面的原因， 往往在CPU,内存，电量等资源方面都受到了一定的限制。
如果基于现有的AllSeen服务框架解决这一问题，可以将某些资源损耗性比较高 的工作移植到其它资源相对丰富的设备上，然后由这些设备承担数据存储、计算和 处理等工作，服务端和客户端只需要访问这些计算和处理结果即可。但该方案会增 加整个网络框架的通讯成本和结构的复杂性，并且也会降低应用的移动性，这是得 不偿失的。而且这种解决方式也没有实现网络中各设备资源使用的相对均衡。随着 开发应用越来越丰富的业务需求，资源损耗问题还是会暴露出来，影响到AllSeen服 务框架的进一步发展。
57
为了解决上述问题，本文提出了一种基于AllSeen服务框架的分布式代理方法, 如图3-26所示。该方法主要通过利用网络中其它设备的路由来分担服务端路由的工 作量。具体来说，网络中的设备路由会维护网络中所有可代理对象的列表（注：这 里的设备包括服务端设备和客户端设备）。在该方案中，认定只要两个路由都实现了 同一应用这两个路由就具备相互代理资格，由于该方案采用分布式结构，所以网络 中的每个可代理路由和服务端路由是等效的，在下文直接用主机应用代表当前正在 承担服务端功能的服务端或是代理客户端应用。
图3-26分布式代理流程
应用路由在运行时会实时检测自己设备的资源情况。在总线接收到总线方法的 调用或是总线信号的触发请求前，应用路由都会先判断自己的资源是否充足并根据 监测结果做出相应的处理。如果应用路由资源充足，那么应用路由就会自行响应相 应的业务请求。如果应用路由判断自己的资源不充足，那么应用路由就会进入请求
58
代理环节。路由不会将方法调用或是信号直接转发给应用而是会通过不针对会话的 信号在近邻网络中发送请求代理对象进行代理的请求信号，在发送完请求信号后， 该请求设备会在请求后保持120s的监听状态，等待网络中的可用代理设备响应。近 邻网络中可以代理的对象在接收到请求代理后将会判断自己是否具备代理条件：相 应资源是否在代理门限值以上，如果可以代理，代理客户端设备就会通过单播信号 对请求设备进行代理响应。请求设备端的路由在接收到代理对象的请求响应后将在 响应的代理对象中选择最佳代理对象进行代理。其中最佳对象的选择策略有两种， 一种是根据响应速度判断最佳对象，速度最快即为最佳，另一种是根据主项资源最 充足判断最佳对象。选定代理设备后，代理设备就会开始进行代理，并每隔30s便 向设备发送代理状况，直至代理工作完成。如果在120s的等待时间没有其余设备请 求代理，那么请求设备将自己进行处理。
通过该方法可以让闲置设备替代资源紧张设备承担部分工作量，从而达到平均 近邻网内各设备的资源使用情况，较少交互时间，提升交互速率，增强用户体验的 目的。
