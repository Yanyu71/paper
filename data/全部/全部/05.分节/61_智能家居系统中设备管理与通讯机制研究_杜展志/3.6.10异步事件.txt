3.6.10异步事件
目前AllSeen的事件-动作(Event-Action )机制只支持事件同步触发多个动作。 比如说，如果用户回到家把门打开，将门开当作一个事件，那么用户就可以根据自 己的需求为门开这个事件绑定相应的动作，现在假设用户为门开绑定了如下动作序 列，门开的同时，智能家居系统自动打开客厅的灯、电视和空调以及开启卫生间的 热水器。那么根据现在AllSeen支持的事件-动作机制，当门打开的时候，所有这些 动作会在瞬间被同时触发，也就是说用户会同时看到客厅的灯、电视和空调以及卫 生间的热水器被同时开启。这种联动机制虽然为智能家居的场景提供了更灵活丰富
53
的体验，但这种联动方式是单调的。如果用户想基于当前的事件-动作机制实现事件 在时间序列上离散触发动作则无法实现。但这种离散触发在现实生活场景发生频率 是极高的，比如用户在回家后需要打开客厅的灯、电视和空调，但是想要休息一个 小时后再进行洗浴，那就需要卫生间的热水器在半个小时候后再开启。那么此时， 标准设备就不能通过现有的事件-动作机制实现上述用户需求。因为现有的事件-动作 机制是同步触发模式，无法在该事件对应触发的动作组中添加半个小时后开启热水 器和关闭空调这两个动作。基于现有的机制，用户只能将开启卫生间热水器和关闭 空调这两个功能从门开这个事件绑定的动作组合中抽离出来，并在回家半个小时后 再手动操作这两个行为。显然这种同步模式下纷繁琐碎的离散操作要求较高的用户 参与度，这在某种程度上降低了智能家居系统的智能性。除了这个问题，现有的事 件-动作机制也不支持对事件绑定的动作组进行增、删、改、查的功能，考虑到用户 生活情景的多样性和易变性，对于这一功能的需求性不小。还是以上边的例子来阐 述，如果用户在休息十分钟之后，突然决定临时外出，那么用户就需要推迟卫生间 热水器的加热时间和提早关闭空调。然而，基于目前AllSeen中服务框架的事件-动 作机制，上述情景式是无法实现的。
为了解决上述问题，本文提出了一种基于AUSeen的具有CRUD功能的异步事 件-动作触发方法（CRUD： Create. Retrieve. Update. Delete代表增删改查）。该方 法为每一个事件创建一个带有计时器的动作组合，用户可以根据自己的需求为该动 作组合中的每个动作设定相应的触发时间，然后网关会根据每个动作设定的时间去 依次触发相应的动作，从而实现用单一事件在时间序列上离散异步触发多个动作。 除了引入计时器控制每个动作的执行时间。该方法还允许用户通过调用相应的接口 对特定事件绑定的动作组中的动作进行增、删、改、查的操作。使得AUSeen的事件 -动作机制更加灵活，为用户带来更好的服务体验。
为了实现该异步触发方法，需要网关暴露网络中各个设备的总线方法和总线信 号，并且提供基于事件创建相应动作组的接口，且网关需要携带一个计时器来帮助 网关在特定时间触发相应的动作，实现事件异步控制动作。网关创建时间-动作接口、 参数及实例分别如图3-20、3-21所示。
54
Action组创建接口	参数
creat eAct ionsGroup	triggerEvent
act ions []—
timers[]—
触发事件	异步Ac tion列			触发时间列
Event A	Action A	Action B	Action C	A 0s	B 0s	C1800s
门开	打开卧	打开客	打开卫生	相对	相对	相对
室灯	厅空调	间热水器	时间	时间	时间
图3-20网关时间-动作创建接口	图3-21网关时间-动作接口实例
需要指出的是图3-21中的动作组和计时组对于同一下标位置具有对应关系，即 相应下标的动作会在相应下标的时间后被网关触发。此外，网关还需要提供根据特 定事件查询相应动作组，并对该动作组的动作进行增、册k改等的接口，如图3-22 所示。在此需要注意的是，之所以选择在网关上开发相应的接口而不是在控制设备 上，是为了保证当控制设备离开网络时，网络也能根据设备设定的时间-动作组规则 进行特定的操作。
图3-22动作组管理接口	图3-23网关创建动作-事件组方案
图3-23描述了网关创建相应的事件-动作组的方案图。具体创建步骤如下：
(1)控制设备连入网关；
(2)控制设备和网关建立单点会话；
(3)网关将网络中设备的事件和动作接口暴露给控制设备；
(4)用户通过控制设备选择相应的事件和动作组，并为动作组中的动作设置 好相应触发时间并将这些参数传递给网关。
(5)网关接收到控制设备的请求和参数，调用网关的事件-动作组创建接口创 建相应的规则，并且将生成的规则绑定到规则引擎(RuleEngine)
(6)当网络中的设备触发事件-动作组中的事件，规则引擎和计时器根据创建
55
的接口参数开始同时制约和触发相应的动作。
下图3-24描述了事件-动作组的对动作的修改方案。具体修改步骤如下：
(1)控制设备连入网关；
(2)控制设备和网关建立单点会话；
(3)控制设备根据要修改的事件调用网关的事件-动作组查询接口，获取相应 的事件一动作组；
(4)用户通过控制设备输入事件-动作组的修改信息，并将这些信息传送给网 关；
(5)网关根据传送的数据信息调用网关的事件-动作组创建接口，根据新的数 据信息创建事件-动作组；
(6)网关将新创建的事件-动作组添加到规则引擎，并根据事件-动作组的触 发事件覆盖原有的事件-动作组，并实施新规则
图3-24网关修改动作-事件组中动作方案
