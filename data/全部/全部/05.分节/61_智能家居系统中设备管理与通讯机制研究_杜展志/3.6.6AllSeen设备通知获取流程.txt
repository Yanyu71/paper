3.6.6AllSeen设备通知获取流程
根据2.6.2所介绍的AllSeen通知服务框架，可以得知AllSeen设备可以通过不 针对会话的消息进行消息传递。然而AllSeen的通知服务框架并不完全适用于本文搭 建的智能家居系统，因而需要对其改善。在介绍具体的方案之前，首先了解一下现 有的通知服务框架所存在的弊端。弊端主要体现在两个方面：
1.	AllSeen原有的通知服务框架根据消息的紧急程度将通知分为普通、一般警告和 严重异常三类，并且规定对于每一个设备的不同紧急程度的通知在通知发送端只 能保存一条，当控制设备在消息覆盖时间不在网络中时很容易造成消息的丢失。
图3-15通知获取与TTL的关系
47
2.	AllSeen现有的通知服务框架为每条消息设置了存活时间TTL,并规定通知接收 方只有在消息存活期内才能从发送端获取通知，一旦通知的存活期失效，那么通 知接收方就无法再获取相应的通知，具体示意图如图3-15所示。
由于这两点机制，如果控制端设备不能保证时时处于网络中，将导致控制设备 丢失网络中的许多通知。这对于网络中的严重异常信息和一般警告信息是不可以接 受的。如果将AllSeen的通知接收模块放置在控制设备，为了解决这一问题，通知发 送端就必须延长严重异常和一般警告通知的存活时间。由于AllSeen的底层通知机 制在发送通知时采用UDP组播，延长TTL会造成重复包发送，浪费资源也增加网络 的负载。
基于以上的考虑，本智能家居系统最终决定将AllSeen的通知接收模块放置在网 关，利用网关来接受网络中发送的通知，并且将接收到的通知按照紧急程度分别存 储，对于严重异常信息和一般警告信息，路由器会全部存储，直到用户发送相应的 删除指令。对于设备的普通通知存储，网关开发了相应的总线方法允许用户根据个 性化需求设定存储条数。此外，网关还暴露了通知查询、删除的接口。标准设备可 以根据相应的总线方法查询某一特定设备的通知或是网络中的所有通知，也可以单 独或是批量删除设备通知。
当智能家居系统的设备发送通知时，服务端设备上的AllSeen框架发出一个无会 话信号广播的通知消息。该信号这会被网关的AllSeen通知框架所接收。然后网关通 过和服务端设备建立单点会话从服务端获取通知消息并将其传递给网关消息管理模 块。本智能家居系统不仅仅支持文本通知的发送和接收、也支持多媒体通知和动作 通知，其中文本通知指的是只携带文字内容的通知，多媒体通知指的是通知内容中 携带图标或是音频，动作通知中则携带包含动作信息的对象路径，用户可以通过该 通知调用相应设备的功能。下图3-16描述了网关接收通知的具体流程：
图3-16网关接收通知流程
48
除了解决现有通知机制存在的问题，本文还利用AUSeen的通知服务框架开发了 如下三个进阶功能，一是实现通知的本地系统化；二是实现通知的回撤；三是支持 带动作的通知。
通知的本地系统化主要是在控制设备也实现通知机制，这样在控制设备接收到 的通知的时候，就可以利用安卓开发的API将接收到的通知内容以系统通知发送出 来以保证接收消息的实时性，而控制设备在进入通知页面获取系统的设备通知时， 则通过总线方法从网关获取。
由于底层通知的发送采用UDP机制，会造成底层网络资源的浪费，因而在本系 统中控制设备针对接收的通知实现了撤回功能，如图3-17所示。当用户在某一控制 端设备上阅读某一通知并确定撤回通知时，控制端设备会尝试根据通知中包含的发 送端信息与相应的通知发送端建立会话连接，如果会话建立成功，消息发送端会根 据控制端设备传送的消息ID撤销形影的通知，并以不针对会话的信号告知网络中的 其它设备该消息通知已经撤销，此时，通知会从其它已经获取该通知的设备端撤销， 如果设备还没有获取相应的通知，那么就不会再获取相应的通知。如果会话建立不 成功，那么用户确认撤销的通知客户端就直接代替通知发送端告知外界该通知已经 被撤销。
＜初始化通知接收
服务端应用	服务端服务
~1~ I
| 发送通知|
1	1	发送通知	发送通知	.发送通知,发送通知.
1	1	忽略通知	1		1	J	J
1报销通知（通知发送1	1	1
1	1	1	端，消息ID） |	|	|
1	［建立会话
I	M	-	1	1	1	1
1	1会话建立成功1	1	1	1
।	1撤销通知（通知ID）’।	1	1	1
1	H	1	1	1	1
1	।取消 I	1	1	1
1	s销通知	।	撤销通知	1撤销通知1撤销通知1
■	I
3	*1	*1
1	1	1	如果无法连	| 撤销通知 |	撤销通知J
1	1	1	接到发送端 1
1	1	1	1	1	1
图3-17通知撤销流程
49
本智能家居系统不仅支持文本通知、多媒体通知也支持动作通知，网关和控制 设备在解析通知的时候，会根据通知中携带的响应对象路径是否为空来判定接收到 的通知是否为动作通知，如果为动作通知，在点击通知的时候，控制设备会通过 Control Panel调用总线方法响应通知。
