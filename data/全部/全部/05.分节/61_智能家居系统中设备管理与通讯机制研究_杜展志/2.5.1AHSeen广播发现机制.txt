2.5.1AHSeen广播发现机制
AHSeen的广播机制主要负责将服务端提供的服务广播到近邻网络中，发现机制 则负责从近邻网络寻求客户端感兴趣的服务PL通过AllSeen的广播和发现机制可以 帮助物理相隔离的设备彼此发现各自的应用和服务。目前AUSeen的广播和发现机制 支持通过WKN或unique名称和通过AHSeen的About接口两种方式。
1	.基于名字服务的广播和发现
由于AHSeen路由本身支持名字服务，因而,AHSeen服务框架可以通过WKN或unique 名称进行广播和发现。路由的名字服务采用UDP/IP协议，包括“IS-Ar用“WHO-HAS” 两种消息类型。AllSeen路由通过使用IP组播技术在近邻网络中广播这两种消息类型 从而实现AUSeen的广播和发现机制，其中IPv4的组播地址为224.0.0.113, IPv6的 组播地址为FF0X::13A,端口号为9956。图2-15描述了这两种消息类型的基本报文 格式。SVer表示消息发送方使用的AHSeen发现协议版本号，MVer表示消息发送方 的名字服务版本号，QCount表示寻求的服务数量，Acount表示提供的服务数量， Timer表示IS-AT回答的有效时间期（以秒为单位）。Timer的取值由WKN广播设定 的周期时间 Adv_Validity_Period 和消息有效期 Adv_Infinite_Validity_Value 共同决定。 如果Timer值被设为0,则代表消息发送端的路由将回撤广播消息。
字节	0	12	3
比特	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Sver	MVer	QCount	ACount	Timer
WHO-HAS消息中的Qcount数量
IS-AT消息中的Acount数量
图2-15名字服务消息格式
图2-16描述了 IS-AT消息的具体报文格式，当服务端采用IPV4的TCP协议或 UDP协议时，R4和U4会被分别置为E同理，如果服务端采用IPV6的TCP协议
22
或UDP协议，则R6和U6会被分别置为1。StringData描述了需要被广播的WKN, 一个StringData代表一个WKN。Count负责统计消息中包含的StringData个数。C 代表是否将StringData描述的所有WKN向外广播，G代表路由的GUID长度是否可 变。M代表消息类型，IS-AT消息M值为1。TransportMask代表代表广播协议的掩 码。
字节	0	12	3
比特	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
R U R U C G 4 4 6 6	M	Count	Transport Mask
R4IPv4Address （当 4R4'字段=1 时有效）
R4 Port （当'R4'字段=1时有效）			U4 IPv4Address （当'U4'字段=1 时有效）
U4 IPv4 Address （当'U4'字段=1 时有效）			U4 Port （当，U4'字段=1时有效）
R6 !Pv6Address （当'R6'字段=1 时有效）
R6 Port （当'R6'字段=1时有效）
U6 1Pv6Address （当			'U6'字段=1时有效）
U6 Port （当'U6'字段=1时有效）
路由GUID的StringData （当'G'字段=1时有效）
StringDala记录的数H
图2-16 IS-AT消息报文格式
图2-17描述了 WHO-HAS消息报文格式，其中Reserved为保留字段，M代表 消息类型,WHO-HAS消息类型M为2。StringData描述了客户端路由感兴趣的WKN。 Count代表WHO-HAS消息中包含的StringData项的个数。
字节	0	12	3
比特	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Reserved	M	Count
寻求的服务WKN数目
图2-17 WHO-HAS消息报文格式
在发现和广播过程中，服务端的路由会根据服务端的信息生成相应的IS-AT消 息，并将服务端的WKN名称填充在IS-AT消息中进行周期性广播，具体来说，IS-AT 消息可以通过配置Adc_Validity_Period参数来指定well-known名称广播的有效期限 和Adv_Msg_Retransmit_Interval来指定广播周期在网络中进行周期性广播。为了减 少客户端寻找服务的时间，当服务端接收到寻找其所支持服务的WHO-HAS消息时， 可以主动发出IS-AT消息进行响应。同理，客户端路由会通过
23
FindAdvertiseName（WKN/WKN前缀）获取客户端感兴趣的服务名称或是名称前缀， 并生成相应的WHO-HAS消息，然后通过AllSeen的IP组播地址将WHO-HAS消息 发送到广播中，并且保持监听，当收到IS-AT消息之后，会对IS-AT消息中的WKN 名称和WHO-HAS消息中广播的WKN名称或是前缀进行匹配，如果匹配成功，则 通过FoundAdvertiseame API向客户端反馈已经找到相关服务,否则将一直保持监听。 为了避免产生冲突而导致多播的包被丢失，WHO-HAS消息则可以通过指定 Disc_Msg_Number_Of_Retries 和 Disc Msg Retry, Interval 这两个参数来决定发送 WHO-HAS消息的次数及间隔时间从而避免产生冲突而导致多播包丢失。具体的广 播和发现流程如图2-18所示。
1应一用	服务端应用 | AS楚心库
|服务端AS路由
消费端应用
| AS核合库|	应■用1
|消费端AS路由
连接	、	次挂	.	一.
1	.」年	)|	|	1 连接 1
| ,唯一标识符，|	■ ,	连接
| <	:		1	1
1	1	|	唯一标识符	4	J
|
r请求名称 （WKN）	1	।	1	1	1
1	1	1
4
、加绑段端口	、.	1 I	1	1 I	I
广播名称	X	1 |	1	1 |	|
(WKN)	）!广播名称（wkn»		苻找广播名称:
1寻找广播名称	! (WKN) 1
1 , (WKN)	r	1
:	"IS-AT （通过IP组播）
1	z-r			> /	1	।
1	/ 1	1	_>|	>1
；।WHO-HAS （通过IP组播）		1	।
；		 1重传间隙：	1 IS-AT （通过IP组播） 1	、	r—	1 |	I	। ।	।
\ 1	\ 找到广播名称
X iIS-AT (通过IP组播)	I	I找到广播名%
1- -»
图2-18基于名字发现的广播和发现流
2	.基于About的广播和发现
图2-19描述了基于About的广播和发现的具体流程，服务端通过About模块从 应用中获取服务信息并通过这些服务信息生成多播信号存储在SLS模块的缓存中。 除了和About模块进行交互，SLS （SessionLess-Signal）信号模块还会和路由中的名 字服务进行通讯从而获取服务的WKN/unique名称并将其添加到SLS信号中以发送
24
到近邻网络中。SLS模块在生成不针对会话的信号时，会将信号的名称指定为符合 org.alljoyn.sLx<GUID>.x<changeJd>.格式的WKN。当客户端接收到这个IS-AT的消 息后，客户端的SLS模块就会以会话的形式连接到服务提供端的SLS模块，获取服 务端提供的额外消息。
服务端应用
|应丁 1 1 AS,心库J
连接
|<-----
］注册总线对象
消费端AS路由
连接
唯一标识符
I服务端AS路由
q生成广播信息 ］发送SLS信号
捆绑段端口
建立AS会话
获取声明信息
传送声明信息
找到广播名称 （SLS WKN前缀）
生成一条带有
SLS WKN的 IS-AT信息
WHO-HAS （SLS WKN前缀）
添加匹配以获得平会话信号
IS-AT （包含 SLS WKN）
在SLS缓存中 存储信号 生成SLS WKN
唯一标识符 >
寻找广播名称 （SLS WKN前缀）
消费端应用
AS核心库
连接
|应用
图2-19基于About的广播和发现的具体流程
使用About进行广播和发现时可以通过设置表2-5所示的参数修改About广播和 发现效果：
表2-5发现配置参数
参数	默认值	描述
Adv_Validity Period	120秒	IS-AT广播的有效期
Adv_Infinite_Validity_Value	255	表明广播永远有效的时间值
Adv_Msg_Retransmit_Interval	40秒	发送IS-AT消息的间隔秒数
Disc_Msg_Number_Of^Retries	2	WHO-HAS消息的重发次数
Disc_Msg_Retry_Interval	5秒	WHO-HAS消息的重发间隔秒数
基于About的广播和发现会在广播消息中提供一系列的信息，这些信息如表2-6
25
所示，既包括应用中总线对象的路径和实现的总线接口，也包括设备和应用的元信 息，比如，设备的制造商等等。为了减少网络的负载和提高网络资源利用率，AllSeen 服务框架只会周期性广播部分消息，对于其它的额外信息则在About接口中提供了 一个总线方法，当服务客户端需要获取这些额外信息时，服务客户端可以和服务端 建立会话从而获取相关信息。
表2-6广播字段
字段名称	是否需要	是否广播	是否局部	签名
应用ID	是	是	否	ay
默认语言	是	是	否	S
设备名称	否	是	是	S
设备ID	是	是	否	S
应用名称	是	是	是	S
制造商	是	是	是	S
型号	是	是	是	S
支持语言	是	否	否	as
描述	是	否	是	s
制造日期	否	否	否	s
软件版本	是	否	否	s
AllSeen 版本	是	否	否	s
硬件版本	否	否	否	s
帮助UH	否	否	否	s
根据上边的介绍，可以发现基于About的广播和发现都是基于多播消息，这对 于网络资源的利用率较低，也容易造成对网络的过高负载。而且IP路由可以阻塞多 播IP地址和端口，因此这种方式的发现能力是有限的。因而，AUSeen服务框架在 14.06版本中提供了一种基于mDNS的发现协议-NGNS (Next Generation Name System),这种协议通过使用AllSeen的多播地址和端口来发送基于多播的DNS来发 现支持某些特定接口的设备和应用，而且该协议的发现响应是单播的，这样可以提 高发现协议的性能和减少AllSeen发现过程所产生的多播数据量。NGNS使用的IPv4 多播地址、IPv6多播地址和端口号分别为224.0.0.251、FF02::FB和5353。
假设客户端的AllSeen路由支持原先的名字服务行为,消息序列如图2-20所示，
26
首先客户端发送FindAdvertisedName （）初始化消息序列；NGNS通过多播DNS发 送基于DNS-SD的查询消息以及名字服务支持的WHO-HAS消息；任何与搜索名字 匹配的服务提供端通过单播方式发送DNS-SD消息响应客户端；14.02版本以前的服 务提供者如果和WHO-HAS消息匹配则通过IS・AT消息响应。
服务端应用	服务端应用	消费端应用
（带有 NS）	（带有 NGNS）	（带 <NGNS）
AllSeen 应用
寻找广播名称（名称前缀）
回复：
寻找广播名称（名称前缀）
NGNS
A” Seen路由
WHO-HAS 版本表明了 mDNS询问 也会被询问 齐］持 门之乂刹 mDNS询问 的应答：之 后的mDNS 询问部分会 同样的爆发 式忽略
名以匹消被 有可确的会送 只称准配息发
-niDNSfli-
WHO-HAS 按 照相同的
NGNS传输表
WHO-HAS信息（版本,支持版本,WKN前缀） <-------------------------
mDNS询问（问题：PTR. addl： "sender-
infb" , "search”文本记录）
nDNS应答(回答：PTR, TXT. SRV； addl： "sender____infb" . "advertise n …“ 文本i己录)	、
IS-AT （名称）
图2-20基于NGNS的服务客户端和基于名字系统的服务提供端之间的消息时序
3	. WKN VS About
以上介绍的两种方式都可以用于广播和发现服务，在此，也给出关于这两种方 法的使用情景建议：一般来说，推荐使用About广播机制来进行广播，因为About 广播机制为应用提供了一种通用的方式来向可能对该应用感兴趣的其他应用来广播, 而且广播数据中包含一些通用的元数据，比如说制造商、支持接口、图标以及其它 等等，这也是在本文中最后选择使用以About方式进行服务广播的原因。从底层原 理，也可以发现，通过WKN或是unique名称进行广播是一种更为基础的方式，事 实上使用About进行广播时采用的就是用WKN/unique名称广播的底层机制。由于 这种方式对于底层的封装性较About要原始，因而对于应用开发人员对AllSeen服务 框架的了解要求相对比较高，所以在不需要涉及到底层技术细节的时候，不建议使
27
用WKN或是unique名称的方式进行服务的广播和发现。
