4.3.1载波同步的FPGA实现
在硬件实现上，本文选取N=4,即利用802.1 Ip规定的短训练序列中的其中 5个完成相应的计算。首先对5个短训练符号两两做相关得到4组相关结果，并 对每个相关结果中的16个点的值做累加，得到4个累加结果。然后对这4个累 加结果进行角度估计，得到的结果即为角度频率偏差，将4个角度偏差结果做平 均得到的即为估计的频偏值。个之所以选取5个短训练符号做相关平均，是因为 这样在求平均时可以直接右移两位，实现除以4的运算，方便硬件实现。
35
载波频率同步的硬件实现框图如图4-4所示，整个硬件实现模块分为数据分 流、数据缓存、载波频偏估计、频偏补偿、数据联合输出5个部分。数据在整个 模块中的处理步骤是：首先输入的数据根据计数器计数区分出短训练序列和长训 练序列符号、数据符号，分别做不同的处理，这是数据分流模块；载波频偏估计 模块利用提取的5个短训练序列符号做延时相关累加并求平均得到频率偏移估 计值；然后利用得到的频偏估计值计算补偿因子，同时按照补偿因子对之前输出 的长训练序列符号和数据符号做相应的频偏补偿；最后将补偿之后的长训练序列 和数据符号加上之前没有经过补偿的短训练序列重新组合成完整的数据帧进行 输出。
图4*4载波频率同步模块实现框图
（1）	数据分流模块
数据分流模块主要完成对输入数据的分流工作，区分出短训练序列、长训练 序列和数据符号。在硬件实现上，对输入数据用计数器进行计数，当计数值大于 等于1且小于等于160时为短训练符号，将其送入数据缓存子模块；当计数值大 于等于1且小于等于80时为前5个短训练符号，将其送入载波估计子模块用于 频率偏差估计；当计数值大于160时为待补偿的长训练序列符号和数据符号，将 其送入频偏补偿子模块。
（2）	载波频偏估计子模块
整个实现模块中最关键的模块是载波频偏估计模块，其利用数据分流模块提 取的5个短训练序列符号，根据式（4-6）对频率偏差进行估计。如图4-5所示, 在硬件实现上，载波频偏估计模块可分为延迟相关、相关累加和补偿估计三个部 分。
图4-5载波頻偏估计子模块框图
36
1）延迟相关子模块
利用数据分流模块提取的5个短训练符号，采用移位寄存器做缓存，计算相 邻两个短训练符号的相关值，如图4-6所示，将当前短训练符号的样值和前一个 短训练符号相同位置的样值同步输出，然后调用复数乘法器完成两个训练序列符 号的相关运算，得到式（5-6）中的各个相关值。
图4-6短训练符号延迟相关子模块框图
2）相关累加计算子模块
在得到5个短训练符号的4组相关值后，需要进行每组16个数据的求和运 算。如图4-7所示，在硬件实现上采用滑动窗口的思想实现。滑动窗口累加的计 算公式为
Sum = Sum+ BufferData- ShiftData	（4-14）
其中，Sum为累加和，BufferData为当前输入数据，ShiftData为经移位寄存 器移位后的数据，实际上也就是前一组短训练符号同一位置的取样值。对于第一 组相关值累加来说，ShiftData的值为0,因此在求Sum时直接将当前的输入数 据即BufferData进行累加即可；对于之后的几组相关累加计算，由于累加和Sum 中已经包含了前一组的相关值累加结果，且ShiftData的值也变为经移位寄存器 之后的前一组的16个数据，因此在计算相关累加和时，累加和Sum在加上当前 输入数据BufferData后还需要减去移位寄存的前一组的数据ShiftData,因此在第 32个点处的Sum值正好是第二组的相关累加结果。以此类推，在第48和第64 点处的Sum值分别为第三组和第四组的短训练序列相关值的累加和。由于在相 关累加之前进行了延迟相关计算，实际上第一组相关值也向后延迟了 16个点， 因此，5个短训练符号的4组相关值累加和分别位于第32、48、64、80点处。
图4-7短训练符号相关累加子模块框图
3）偏差估计子模块
偏差估计子模块利用相关累加和提取相位信息，并根据式（4.6）计算出频率
37
偏差，其硬件实现结构如图4-8所示。
图4-8频率偏差估计子模块框图
从图中我们可以看出，其过程是得到上一级的相关累加值后输入CORDIC核 完成arctan运算，得到相位值，然后使用CORDIC核计算得到4个角度值，利 用累加器将4次结果累加，然后通过移位求平均。另外，角度平均后还需要除以 短训练符号的长度DSTS,对于802.11p来说，。"=16,因此在硬件实现上右移 4位即可。
(3)载波频偏补偿子模块
载波频偏补偿子模块主要根据前面得到的频率偏差计算频偏补偿因子『商'， 通过式(4-13)对待补偿数据进行频偏补偿：
rn=rnx e~Jn^ =rn~x. e~J6" =r*x [sin (—8“)4- j cos (-0 )]	(4-15)
在硬件实现上，载波频偏补偿模块主要分为补偿因子计算和数据补偿两部分。由 于补偿因子早于待补偿数据即长训练序列符号和数据符号出现，故需将补偿因子 做相应的延迟，其流程图如图4-9所示，包括补偿因子计算、数据缓存和数据补 偿三个子模块。
图4-9载波频偏补偿子模块框图
对于补偿因子的计算，当获得频率偏差的估计值介后，利用补码器对九取 反，利用累加器实现相角的计算-％=-畝，而求取补偿因子实际上就是求 sin(-%*)和cos(-q*)。当待补偿数据(长训练序列符号和数据符号)到达时， 将缓存中的补偿因子e-丿戒输出并利用用复数乘法器进行载波频偏补偿。
(4)数据联合输出子模块
数据联合输出子模块是整个载波同步模块的最后子模块，主要是将没有经过 频率偏差补偿的短训练序列符号和经过频率偏差补偿的长训练序列符号和数据 符号重新组合成数据帧之后进行输出。由于短训练符号是在数据分流模块之后就 直接送到数据联合输出模块而长训练符号和数据符号需经过频率偏差补偿模块 补偿模块补偿后才送至数据联合输出模块的，为了确保短训练符号和补偿后的长
38
训练符号及数据符号连续输出，硬件实现上需通过移位寄存器将短训练符号做相 应的延时。
