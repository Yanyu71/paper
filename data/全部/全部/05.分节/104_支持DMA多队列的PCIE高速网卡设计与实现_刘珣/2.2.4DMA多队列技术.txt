2.2.4DMA多队列技术
网卡在进行数据处理后需要将数据快速的搬移到主机内存，目前高速智能网卡 普遍采用DMA方式进行数据搬移a〕，即当网卡需要进行数据搬移时，通过中断或 者轮询机制通知CPU,然后再发起DMA操作进行数据搬移。DMA可在外部设备和 存储器之间进行高速的数据搬移，因此数据只需要少量的CPU参与或者不需要CPU 参与[J】。如图2-8所示。减少CPU的参与可释放CPU的资源，同时将数据传输的 功能通过DMA控制器实现，将工作负载分担，可提高效率。由于DMA技术在网卡 中进行实现，而目前网卡与内存进行数据交互时在主机侧的接口普遍采用PCIE总 线，因而目前DMA的工作方式基于PCIE总线协议实现a〕。
15
系统总线
PCIE
图2-8 DMA工作方式示意图
目前PCIE DMA技术在高速智能网卡应用广泛，作为与主机端连接的部分，其 传输速率影响着网卡整体的效率【刃，一直以来是网卡系统高速传输中的研究重点。 因此本部分内容的研究重点在于设计一种高效的DMA传输方式。目前DMA的传输 方式分为两种：一种是基于寄存器的传输方式，一种是基于描述符的传输方式，下面 将对这两种传输方式进行分析。
(1) 基于寄存器的DMA传输
基于寄存器的传输方式主要面向连续的内存地址空间，尤其当面对大块的数据 需要连续的地址空间来储存时。因为这种方式DMA控制器只会完成一次DMA请求 响应。当有数据需要传输时，CPU进行初始化等一系列操作通知网卡启动DMA操 作，网卡随之将内存中指定的数据进行搬移，结束后中断CPUo因此这种方式适合 一次性传送大量连续的数据。如图2-9所示。
(2) 基于描述符的DMA传输
基于描述符的传输方式主要面向内存地址空间不连续的大量的数据，相比于基 于寄存器的DMA传输方式，即CPU发起一次DMA请求，DMA控制器执行一次数 据传输，基于描述符的传输方式，即CPU在发起DMA操作前，驱动在内存中初始 化多个描述符网。如图2-10所示。这样CPU要传输数据时，只需要发送一次DMA 请求，DMA控制器先将指向这些数据的描述符取到硬件中进行解析，然后再将这些
描述符所指向的数据从内存中搬移到网卡中。
图2-10基于描述符的DMA传输方式
描述符是一种信息载体，它描述了数据所在内存的地址以及数据本身的信息， 同时还带有一些标志位。一个描述符可以描述一个非常小的内存片段，也可以描述 非常大的内存片段。为了合理利用内存空间，以及面对密集性的网络流量，相比于寄 存器式的传输方式，这种方式更为灵活［旳。本文的目的在于完成高速数据的搬移， 从而应对更复杂更密集的网络数据。基于上述两种传输方式，在本文中决定采用基 于描述符的DMA传输方式。
同时数据流量在lOGbps高速率的传输背景下，单队列网卡模式已无法满足数据 转发的时延需求。网卡中的队列一直以来与CPU核进行绑定，早期的多数计算机, 处理器可能只有一个核，从网卡上收到的以太网报文都需要这个处理器处理。随着 半导体技术发展，CPU核的数量在不断增加，通过可以增加网卡中队列的数量并绑 定到不同的核上来满足高速流量的需求，如图2-11所示。
17
图2-11队列与应用的逻辑对应
多队列技术发展至今已经和DMA技术相结合来支持网络虚拟化，即每条收发 队列都以DMA的方式通过PCIE总线与内存进行数据交互，并且通过队列绑定核的 形式对网络虚拟化进行支持。每个虚拟应用通过驱动可以绑定到不同CPU核上，使 得每个虚拟应用逻辑对应队列［旳，从而使得数据在经过对数据包头处理后转发每个 应用对应的队列中，然后通过DMA传输机制完成数据的快速搬移，从而在硬件层面 完成了数据的分流。利用该技术，可以做到分而治之，应用可以根据自己的需求对数 据包进行控制【"I,本文采用描述符多队列机制完成数据的分流。
