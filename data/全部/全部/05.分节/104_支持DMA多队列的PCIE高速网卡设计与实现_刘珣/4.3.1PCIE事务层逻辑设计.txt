4.3.1PCIE事务层逻辑设计
(1) PCIE IP核设计
本文采用Xilinx公司提供的7系列FPGA解决方案R9],如附图3所示，用于配 置PCIE的7系列FPGA集成模块。该集成模块遵循PCIE基础规范，包括物理层、 数据链路层和事务层，通过使用TLP包在各层之间交换信息。
IP核需要通过Vivado下的IP核例化工具Customize IP进行例化设计。如图4- 16所示，在①中设置成PCIE端点设备，因为网卡作为端点设备Endpoint接入设备 与主机中根复合体Root Complex相连，选择对应的实际开发板KC705 REVA；在② 中设置成8个通道，以及速率设置成5.0GT/S,因为此IP核最高支持5.0GT/S速率， 且在8个通道数才可实现此速率。而实际带宽在8个通道下可达到4GB/S,满足万 兆以太网中线速率的要求；在③中将AXI-Stream接口的时钟频率设置为250MHz, 数据位宽设置为128bit；在④中将参考时钟设置为lOOMHzo
图4-16 PCIE IP核配置图
在图4-17中主要对PCIE的BAR空间进行配置。在①中配置PCIE端点设备的 BAR0空间，Type类型为Memory,寻址位宽为32bit,大小为1MB；在②中配置PCIE 端点设备的BAR1空间，与BAR0空间的配置参数一致。在本文中，BAR0负责与 DMA相关的寄存器，如DMA描述符基地址，DMA描述符的头尾指针等。BAR1空 间用以存放控制FPGA其他相关寄存器地址信息。
45
图4-17 PCIE IP核BAR空间配置界面
(2) PCIE发送引擎设计
PCIE发送引擎的主要功能是发送TLP包，根据PCIE总线事务对于TLP包的 定义，其主要发送三种类型的TLP：存储器读、存储器写以及完成数据包。本文按 照TLP包的类型设计三种状态：SIART_READ和 WRITE_READ_TLP状态， S1ART_WRITE、WRITE_DAIA 和 WRITE_BD 状态,START_CMPL 和 WRITE_CMPL_TLP状态，在这三种状态下分别完成存储器读、存储器写以及CMPL 包的发送处理。
处理工作主要包括将DMA控制器要发送的数据添加头尾组成TLP格式的包进 行发送，通过PCIE发送引擎对这三种类型的TLP发送。其状态所表述的具体定义 在表4-1中给出了具体的描述信息。其状态转换设计如图4-18所示。
表4-1 PCIE发送引擎模块状态机描述
状态名
状态定义
TX IDLE
空闲状态，请求完成和等待请求
SIART READ
使能存储器读请求
WRITE READ TLP
开始发送读请求
START WRITE
使能存储器写请求
WRITE DAIA
开始发送需要写入的数据
WRITE BD
回写描述符，通知驱动
START CMPL
使能CMPL包发送请求
WRITE CMPL TLP
开始发送CMPL包
46
如上图所示，PCIE发送引擎状态机分为三种状态READ、WRITE以及CMPL。 不同的状态对应不同的请求，下面做详细的介绍。
TX_CMPL状态表示发送CMPL包。当PCIE控制器收到来自己驱动发出的存储 器读请求后，PCIE控制器会向PCIE发送引擎发出CMPL使能信号，PCIE发送引 擎在之后的时间里接收到从PCIE控制器模块传输过来的数据，将数据组装成TLP 包发送给RCo
TX_READ状态用于发送读请求的TLP包，DMA读操作将开启此状态。在驱动 完成对DMA控制器中DMA寄存器的配置后，DMA寄存器向PCIE发送引擎发出 读请求使能信号，之后PCIE发送引擎开始组装并且发送。
TX_WRITE状态用于发送写请求的TLP包，DMA写操作将开启此状态。DMA 控制器会向PCIE发送引擎模块发送写请求使能信号，先将网络上传送过来的数据 进行发送，然后回写描述符。
(3) PCIE接收引擎设计
PCIE接收引擎模块的主要功能是接收TLP包，同样根据接收的TLP包类型将 状态设计为:RX_READ 和 RX_RD_WAIT 状态，RX_WRITE> RX_WR_WAIT 状态， RX_CMPL_DATA状态，在这三种状态下分别完成存储器读、存储器写以及CMPL 包的接收处理。其状态所表述的具体定义在表4-2中给出了具体的描述信息。其状态 转换设计如图4-19所示。
47
表4-2 PCIE接收引擎模块状态机描述
状态名
状态定义
RXIDLE
空闲状态，请求完成和等待请求
RXREAD
存储器读请求，读取PCIE控制器或DMA控制器中的相关寄 存器信息
RX_WRITE
存储器写请求，对PCIE控制器或DMA控制器的相关寄存器 进行写入
RX_WR_WAIT
若发起DMA读写操作的写请求，则通知DMA控制器准备 进行读写操作
RXRDWAIT
等待发送CMPL包
RXCMPLDATA
CMPL包，有两种情况：收发BD和用户数据
图4-19 PCIE接收引擎模块状态转换图
RX_READ状态表示接收来自驱动对PCIE控制器或DMA控制器中相关寄存器 的读请求。读请求发送到PCIE控制器或DMA控制器，然后PCIE控制器或DMA 控制器通知PCIE发送引擎模块准备发送CMPL包，并返回状态机RX_IDLE状态。
RX_WRITE状态表示驱动对PCIE控制器或DMA控制器中相关寄存器的写请 求。驱动在初始化DMA控制器时，通过此操作完成初始化工作，包括对相关寄存器 进行配置并使能DMA读写操作，若发起DMA读写操作的写请求，则通知DMA控 制器准备进行写操作。
RX_CMPL状态表示用来接收主机端发送到网卡的数据。主要会收到带有收发 BD和用户数据的TLP包，当主机端驱动准备好了在内存中的数据，包括收发BD信 息和用户数据。PCIE发送引擎发送完读请求后，PCIE接收引擎模块会收到此类信
48
息。
(4) PCIE控制器设计
PCIE控制器模块主要用于对PCIE接收引擎模块收到的TLP包做进一步处理。 当收到读请求信息后，将相关寄存器的值通过PCIE发送引擎进行发送以及当收到 写请求后，对相关寄存器进行写入。PCIE控制器模块的状态机描述信息如表4-3所 示。PCIE控制器模块的状态机设计如图4-20所示。PCIE控制器的状态机详细介绍 如下：
H2F_WR表示在进行写请求时所进入的状态。如果为存储器写请求，进入到该 状态并根据指定的寄存器地址信息找到相应寄存器进行写入。
F2H_RD状态表示完成读请求。如果为读请求，进入到该状态并根据指定的寄 存器地址信息找到相关寄存器的配置信息，同时通知PCIE发送引擎准备发送带数 据的CMPL包。在随后的时间将所要读取的寄存器信息发送至PCIE发送引擎模块 组成TLP包进行发送。
RECV状态表示监控PCIE接收引擎接收到的信息，PCIE接收引擎模块将收到 的信息发送至PCIE控制器模块，PCIE控制器模块进入此状态。PCIE控制器模块对 收到的信息进行判断，当收到的数据为写请求时，进入H2F_WR状态；当收到的数 据为读请求时，进入F2H_RD状态。
PCIE控制器工作流程如下：
1. 在RECV状态持续收到PCIE接收引擎模块传送过来的数据，并根据Fmt 和Type进行事务类型的判断；
2. 当判断为读请求时，进入到F2H状态。此时，PCIE控制器模块根据寄存器 地址信息寻址到指定的寄存器读取相应的数据并使能PCIE发送引擎模块 进行组包，完成CMPL包的发送。
3. 当判断为写请求时，进入到H2F状态。则按照具体寻址信息找到指定的寄 存器完成写入。
4. 当完成请求时，则进入RECV状态继续等待数据的到来。
表4-3 PCIE控制器模块状态机描述
状态名
状态定义
H2F IDLE
初始状态，初始化配置信息
H2F RECV
根据PCIE接收引擎收到的信息进行判断
H2F WR
当TLP包为写请求时进入此状态，根据具体地址信息完成写请求
F2H_RD
当TLP包为读请求时进入此状态，根据具体地址信息完成读请求 工作，并通知PCIE发送引擎发送CMPL包
49
