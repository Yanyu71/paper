2.2.2硬件卸载加速技术
目前高速智能网卡普遍提供硬件卸载加速功能，比如前文提到的TCP/UDPBS］ 等网络协议卸载功能以及RSS和OVS等硬件加速技术，这些加速技术通常是可编 程的，可完成网卡的智能化操作。业界将这部分的功能全部或部分下移到硬件网卡 中去实现［44］,从而减轻协议栈的工作压力，释放CPU的资源，如图2-4所示。
图2-4协议栈功能卸载示意图
目前硬件卸载加速技术主要面向数据密集型的网络流量，这种网络流量需要高 速智能网卡至少具备3个特点［9〕： 1.减少网卡到主机侧对数据搬移的开销；2.向用户 提供可编程接口，满足用户级的处理需求，以提高网卡的智能化；3.将软件编程和硬 件架构之间进行合理的映射，以实现对数据流进行高效的流水处理。关于硬件卸载 加速技术主要有两种典型的架构：微软提出的ClickNP架构味］和基于可重构匹配表 (Reconfigurable Match Table, RMT)架构〔佝。
(1)基于ClickNP架构
微软针对Catapult架构提出了 ClickNP编程架构，主要用于商用服务器中，以 提供高性能的网络功能，如防火墙、网关等。ClickNP向用户提供了类似C语言语 法，并且提供了近100个处理单元(elements)库，如图2-5所示。编写的程序经过 编译后会由FPGA提供的后端编译器和主机CPU的程序进行编译处理，将不同的任 务分配到FPGA和CPU中，使其协同工作。FPGA内部采用模块化设计，多个elements 并行加速处理，通过缓冲通道连接。
图 2-5 ClickNP 架构
13
(2)基于RMT架构
FlexNIC【8］的设计继承了 RMT架构，是目前典型的流水线操作处理形式。目前 的网络I/O加速方法是将固定功能卸载特性放到网卡［何中，虽然有用，但这些卸载 绕过应用程序和操作系统，只能执行低级功能，如校验和处理和通常使用的标准协 议(例如，UDP和TCP)的包分割，无法做到更高级别的卸载。FlexNIC提供了一个灵 活的DMA可编程接口的网络I/O,允许应用程序和操作系统在网卡上安装数据包包 处理规则，如图2-6所示。对数据包的处理分为入口流水线和出口流水线两部分，每 一部分都含有包解析、Match-Action、数据包整合3个处理阶段，可编程的功能以 Match-Action的形式映射到多核处理器中，对数据包中自定义的域进行流水处理，并 且增加了 DMA引擎来降低数据搬移的开销。
图 2-6 FlexNIC 架构
综上，对于ClickNP架构，其设计之初主要面向商用服务器中网络功能加速的 应用场景，更强调用户可编程性。而FlexNIC作为高效的流水线处理架构，具有更 灵活的匹配查找方式和简易的编程特点，本文基于FlexNIC架构对硬件卸载加速技 术进行设计，但可以看出当面对复杂的操作时，需要的Match-Action操作数量过多 时会大大增加处理时延，本文考虑到入口流水线的操作已完成包处理的匹配过程， 因此将出口流水线进行简化，减少Match-Action次数；同时在DMA引擎中将数据 包队列替换成描述符队列，以更小的信息内容作为载体进行传递，减少处理时延。
