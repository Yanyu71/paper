3.3.3基于DMA描述符多队列的读取设计
描述符是一种信息载体，指向一块缓冲区，其内容包含这块缓冲区的内存地址 以及大小等〔61],如图3-10所示。描述符由驱动部分进行创建分配，对于硬件网卡来 说，需要关注如何读取描述符以及如何使用描述符。
30
图3-10内存描述符缓冲区
驱动部分与硬件网卡通过读写寄存器进行交互，描述符的交互也通过此类方式。 考虑到描述符信息需要循环利用，描述符在硬件中的缓冲区采用环状的结构。为了 实现环形描述符队列，需要设计两个指针用来指示队列的头尾，头和尾之间的距离 为描述符的数量，并且头尾随着网卡不断使用描述符而变化。因此本文将关于描述 符的寄存器设计为基地址寄存器(BASE),用来指示描述符在内存中的位置；描述 符头指针寄存器(HEAD),用来指示当前描述符的起始位置；描述符尾指针寄存器 (TAIL),用来指示当前描述符的结束位置；描述数量寄存器(SIZE),用来指示网卡一 次需要读取的描述符数量；描述符使能寄存器(CTRL),用来使能该描述符队列。其 中描述符头指针寄存器由网卡进行写入，其他寄存器由驱动部分完成写入，如图3- 11所示。
图3-11环形描述符队列
31
具体接收数据过程如下：
1. 驱动首先在内存中分配描述符缓冲区，并创建好相应的描述符；
2. 驱动写BASE基地址寄存器，通知网卡描述符在内存中的基地址；
3. 驱动写TAIL寄存器，写入0x04,表示有4个描述符需要网卡进行读取；
4. 网卡根据BASE基地址寄存器信息，向主机发起DMA读描述符操作，读回 4个描述符；
5. 根据描述符中的具体内容将接收数据写入到内存中，每用掉一个描述符，网 卡会写入HEAD寄存器进行移位，如图3-12所示；
6. 当SIZE小于某个数值时，驱动会再次对TAIL寄存器进行写入，增加新的 描述符，以保证网卡中有足够的描述符进行使用。
图3-12队列工作示意图
采用DMA描述符多队列技术可以在硬件中做到数据分流处理，从而可以支持 不同的应用。在本文多队列特指描述符的多队列，即在网卡中有多条接收描述符队 列，发送描述符队列不需要进行分流处理，单队列可满足需求，如图3-13所示。当 数据包经过MAC地址卸载加速后，可以根据MAC地址决定使用不同的接收队列， 接收队列的数量受硬件资源限制，每个接收队列的长度也与应用需求有关。
32
图3-13描述符多队列示意图
本模块基于FPGA中的FIFO模块进行设计，重点研究描述符队列的数量以及 长度。如果不受计算机资源限制，描述符队列的数量和长度的取值尽可能的大。但由 于计算机内存每页大小为4KB,为了减少上下文切换并且提高数据包的命中率，理 论上一个描述符指向一页，即128bit的描述符指向缓冲区为4KB的内存空间。32GB 的内存空间理论上可创建8192个描述符。
不考虑其他应用所占内存，假设共有8192个描述符，其中4096个描述符用于 接收。在硬件中需要4096X128bit=64MB的存储器空间。硬件中RAM存储器以 18Kbit为一块进行分布，即在一块18Kbit的RAM里最多可以存放140个描述符 (18K 十 128^140)。
对于4096个描述符来说，共需要30块RAM ( 4096-140 « 29.2 ),为了使得每 块RAM中的接收描述符数量一致,将每块RAM的接收描述数量设定为128。此时， 正好需要32块RAM (4096十128 = 32),即接收描述符队列的数量为32个，每个接 受描述符队列长度为128,这种描述符队列的平均分配如图3-14所示。
对于不同应用需要做到数据流的分类处理，即在网卡中提供这种分类处理功能, 本文通过接收描述符队列进行支持。对于不同类型的应用所需内存缓冲区以及描述 符的数量不同，比如在线视频数据这类信息，需要细粒度更小的缓冲区空间，更多的 描述符数量；而电子邮件数据这类信息，需要细粒度更大的缓存区空间，较少的描述 符数量。描述符队列的平均分配无法满足不同应用的需求，因此本文设计三种针对 不同类型应用的接收队列：第一种，在线视频类应用，这种应用实时性要求高，缓冲 区小；第二种，音频类应用，这种应用实时性要求不高，缓冲区空间要求不高；第三 种，下载类应用，这种应用实时性要求很低，但需要很大的缓冲区空间。目前以太网 上的最大报文大小不超过1500bytes,而又因为计算机内存每页大小为4K,为了减少 上下文切换并且提高数据包的命中率，理论上不应该将数据包放到两页去储存，即 缓冲区大小最大不超过4K字节。
在本文中设计三种不同大小的缓冲区空间，分别是64bytes, 512bytes, 2048bytes, 与三个不同的接收描述符队列进行绑定。当数据包小于等于64bytes时，使用接收描 述符队列x,对应着第一种在线视频类应用；当数据包大于64bytes但小于等于 512bytes时，使用接收描述符队列y,对应着第二种音频类应用；当数据包大小超过 512bytes时，使用接收描述符队列z,对应着第三种下载类应用。
对于三个接收描述符队列总共需要384个接收描述符(3x128 = 384),但根据 Internet流量特征指导［旳，数据包大小在0到64bytes的约占50%；数据包大小在 64bytes到512bytes的约占30%；数据包大小在512bytes到4096bytes约占20%,即 第一种应用按照比例分布需要192个接收描述符(384x50% = 192)；第二种应用需要 115个接收描述符(384x30% = 115 )；第三种应用需要76个接收描述符 (384x20%®76),如图 3-15 所示。
对于描述符数量平均分配来说，总共需要328KB内存空间，如下式(3-5)
128x64B + 128x512B + 128x2048B
1024
对于基于应用需求的分配方式，总共需要221.5KB内存空间，如下式(3-6)
192x64^ + 115x512B +76x20483
1024
根据应用需求对接收描述符队列的长度进行分配，可以有效的利用描述符的数 量，并且在这种分配方法下，会占用更少的内存缓冲区空间。
