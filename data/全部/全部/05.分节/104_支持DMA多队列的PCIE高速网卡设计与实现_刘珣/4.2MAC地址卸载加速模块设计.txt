4.2MAC地址卸载加速模块设计
本部分将对协议栈对于数据包头的匹配查找和转发功能进行卸载，这一功能放 在MAC层中进行设计。在与基于软件的查找方式做比较后，选择了基于硬件的CAM 存储器技术。以其灵活高效查找匹配方式可减少网卡的处理时延。本小节将基于此 技术进行设计。
（1）解析模块
解析模块主要负责对数据包进行解析，并且进行关键域的提取。然后将关键域 发送到匹配查找模块。对于MAC帧，如图4-11所示，此模块将通过移位寄存器从 帧头向后移位8bytes进行MAC地址的获取（前导域为8bytes）。假设MAC目的地 址=AA:BB:CC:DD:EE:FFO
> MAC目的地址 	A
图4-11提取数据包头关键域
（2）匹配查找模块
匹配查找模块为MAC地址卸载加速模块中的核心，在匹配查找模块中基于 CAM存储器进行具体设计，具体设计如图4-12所示。当8bits数据进入CAM1中， 若此8bits为AA （170）,则将170地址中的32bits值读出，之后再经过32-5编码, 若输出00001,则表示成功匹配，如图4-13 （左）所示；当8bits为任意其他数，则 将此数地址中的32bits值读出并进行编码，由于并未配置此数的规则，其地址的值 为0,如图4-13 （右）所示。将6个CAM读出的值进行与操作，最终的5bits数不 为0,则代表此MAC目的地址匹配成功；如果为0,则表示匹配失败。最后，将5bits 的信息作为地址输出到动作模块。
42
图4-12 MAC目的地址匹配查找设计框图
（3）配置模块
在预处理阶段，驱动会通过此模块向CAM写入匹配查找规则，CAM初始全为 0o此模块主要包括如图4-12虚线部分。首先驱动会发送32bits的Index,这里的 Index指向CAM空间一段长度为256bits的块，每块代表一条流表项，但不需要全部 写满，根据具体需要匹配的字段进行写入。对于32bits位宽的CAM而言，最多可添 加32条流表项。随后，将具体规则写入，每次写入32bits。对于AA来说，换算成 十进制为170,将CAM1地址为170的寄存器次低位置1,如图4-14所示。BB将 CAM2地址为187的寄存器次低位置1,以此类推。
43
Index
0
1
0
0
0
0
0
1
0
0
170
255
图4-14写入匹配规则
1 0
31
（4）动作模块
此模块同样基于CAM存储器进行实现。将收到的5bits的进行译码操作，同样 将CAM的宽度设计为32bits,深度也为32bitso本文设计了两种动作，一种是转发， 01表示丢弃。其中转发是转发到不同 可1, 01表示转发到队列2, 10表示转
31
0
1
嫂发到队列2
1 0
31
图4-15转发
（左）丢弃（右）
44
